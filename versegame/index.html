<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Status-like RP Prototype</title>

  <style>
    :root{
      --bg:#f4f4f7;
      --card:#ffffff;
      --card-border:#d5d8df;
      --text:#111217;
      --muted:#6b6f79;
      --primary:#111217;
      --accent:#111217;
      --positive:#31a24c;
      --negative:#e5535e;
    }

    *{box-sizing:border-box;}
    html,body{
      margin:0;
      padding:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,system-ui,sans-serif;
    }

    a{color:var(--primary);}
    button{
      cursor:pointer;
      border-radius:999px;
      border:1px solid rgba(0,0,0,0.07);
      padding:.6rem 1.1rem;
      background:#fff;
      font:inherit;
      color:var(--text);
    }
    button.primary{
      background:var(--text);
      color:#fff;
      border-color:var(--text);
    }
    button.secondary{
      background:#f3f3f7;
    }
    button.ghost{
      background:transparent;
    }

    #app{
      max-width:430px;
      margin:0 auto;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* TOP BAR */
    .topbar{
      position:sticky;
      top:0;
      z-index:10;
      padding:.6rem .9rem;
      background:var(--bg);
      border-bottom:1px solid #e1e4ec;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .brand{
      font-weight:700;
      letter-spacing:.02em;
    }
    .player-switch select{
      border-radius:999px;
      border:1px solid #d0d3dc;
      padding:.25rem .7rem;
      background:#fff;
    }

    main{
      flex:1;
      padding:.8rem .9rem 4.8rem;
    }
    .view{
      display:none;
    }
    .view.active{
      display:block;
    }
    .view-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:.7rem;
    }
    .view-head h1{
      margin:0;
      font-size:1.2rem;
    }

    /* FEED */
    .feed-list{
      list-style:none;
      margin:0;
      padding:0;
    }
    .post{
      background:var(--card);
      border-radius:24px;
      border:1px solid var(--card-border);
      padding:.9rem .95rem;
      margin-bottom:.8rem;
    }
    .post-head{
      display:flex;
      align-items:center;
      gap:.7rem;
      margin-bottom:.4rem;
    }
    .avatar{
      width:42px;
      height:42px;
      border-radius:50%;
      border:1px solid #cfd2da;
      background-color: #e1e4ec;
      background-size: cover;
      background-position: center;
    }
    .meta .name{
      font-weight:700;
      font-size:.98rem;
    }
    .meta .username{
      font-size:.86rem;
      color:var(--muted);
    }
    .post-content{
      margin-top:.3rem;
      font-size:.93rem;
      line-height:1.4;
      white-space:pre-wrap;
    }
    .badge{
      display:inline-block;
      margin-left:.3rem;
      padding:.1rem .5rem;
      border-radius:999px;
      border:1px solid #e0e3eb;
      font-size:.75rem;
      color:var(--muted);
      background:#f6f7fb;
    }
    .post-actions{
      display:flex;
      align-items:center;
      gap:.8rem;
      margin-top:.55rem;
      font-size:.82rem;
      color:var(--muted);
      flex-wrap:wrap;
    }
    .post-actions .icon{
      display:inline-flex;
      align-items:center;
      gap:.25rem;
    }

    .filters{display:flex;gap:.4rem;}
    .chip{
      border-radius:999px;
      padding:.25rem .8rem;
      font-size:.8rem;
      background:#f2f3f7;
    }
    .chip-on{
      background:#111217;
      color:#fff;
    }

    /* RELATIONS */
    .relations{
      display:flex;
      flex-direction:column;
      gap:.7rem;
    }
    .rel-card{
      background:var(--card);
      border-radius:24px;
      border:1px solid var(--card-border);
      padding:1rem;
      cursor:pointer;
    }
    .rel-top{
      display:flex;
      gap:.85rem;
      align-items:center;
      margin-bottom:.6rem;
    }
    .rel-name{
      font-weight:700;
    }
    .username{
      font-size:.86rem;
      color:var(--muted);
    }
    .progress{
      margin-top:.15rem;
      height:12px;
      border-radius:999px;
      background:#f3f4f8;
      overflow:hidden;
      border:1px solid #e1e4ec;
    }
    .progress>span{
      display:block;
      height:100%;
      background:linear-gradient(90deg,#3bc76b,#70e08c);
    }
    .rel-thought{
      margin-top:.45rem;
      font-size:.86rem;
      color:var(--muted);
    }

    /* CHARACTER PROFILE */
    .char-view{
      max-width:430px;
      margin:0 auto;
    }

    .char-cover{
      height:120px;
      background:#d8dadf;
      border-radius:24px 24px 0 0;
    }

    .char-header{
      background:#fff;
      border-radius:24px;
      border:1px solid var(--card-border);
      margin-top:-48px;
      padding:1.2rem 1.1rem 1rem;
    }

    .char-header-top{
      display:flex;
      align-items:flex-end;
      gap:1rem;
    }

    .char-avatar{
  width:96px;
  height:96px;
  border-radius:50%;
  border:3px solid #fff;
  background:#ccc;
  overflow:hidden;
  flex-shrink:0;
  cursor:pointer;
  position:relative;
    }

    .char-avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
    }


.char-avatar-btn{
  margin-top:.4rem;
  font-size:.8rem;
  padding:.3rem .7rem;
}

    .char-name{
      font-size:1.4rem;
      font-weight:700;
    }

    .char-username{
      font-size:.9rem;
      color:var(--muted);
    }

    .char-bio{
      margin-top:.9rem;
      font-size:.9rem;
      line-height:1.5;
      white-space:pre-wrap;
    }

    .char-bio-edit{
  width:100%;
  margin-top:.6rem;
  border-radius:18px;
  border:1px solid var(--card-border);
  padding:.7rem .8rem;
  font:inherit;
  resize:vertical;
    }

    .char-rel-block{
      margin-top:1.2rem;
    }

    .char-rel-label-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:.86rem;
      color:var(--muted);
      margin-bottom:.35rem;
    }

    .char-rel-bar{
      height:16px;
      border-radius:999px;
      background:#f3f4f8;
      border:1px solid #e1e4ec;
      overflow:hidden;
    }

    .char-rel-bar > span{
      display:block;
      height:100%;
      background:linear-gradient(90deg,#3bc76b,#70e08c);
    }

    .char-rel-title{
      margin-top:.7rem;
      font-size:.95rem;
      font-weight:600;
    }

    .char-actions-row{
      margin-top:1rem;
      display:flex;
      gap:.5rem;
      flex-wrap:wrap;
    }

    .char-rel-thought{
  margin-top:.4rem;
  font-size:.86rem;
  color:var(--muted);
}


    /* COMPOSE */
    .compose textarea{
      width:100%;
      border-radius:18px;
      border:1px solid var(--card-border);
      padding:.7rem .8rem;
      resize:vertical;
      font:inherit;
      background:#fff;
    }
    .compose .label{
      font-size:.82rem;
      color:var(--muted);
      margin-bottom:.2rem;
      display:block;
    }
    .section{margin:.7rem 0;}
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:.4rem;
    }
    .chips label{
      padding:.25rem .7rem;
      border-radius:999px;
      border:1px solid #dde0ea;
      background:#f6f7fb;
      font-size:.82rem;
    }
    .chips input{
      margin-right:.25rem;
    }
    .file-btn{
      display:inline-block;
      padding:.4rem .8rem;
      border-radius:999px;
      border:1px dashed #d0d3dd;
      background:#f7f7fb;
      font-size:.86rem;
      cursor:pointer;
    }
    .photo-preview img{
      max-width:100%;
      margin-top:.5rem;
      border-radius:18px;
      border:1px solid var(--card-border);
    }

    .idea-box{
      display:flex;
      align-items:center;
      gap:.4rem;
      border-radius:18px;
      border:1px solid var(--card-border);
      background:#f7f7fb;
      padding:.4rem .6rem;
      font-size:.86rem;
    }
    .idea-text{
      flex:1;
      color:var(--muted);
    }

    .row{
      display:flex;
      align-items:center;
      gap:.5rem;
    }
    .row.end{justify-content:flex-end;}

    .hint{
      font-size:.8rem;
      color:var(--muted);
      margin-top:.4rem;
    }
    .muted{
      color:var(--muted);
      font-size:.82rem;
    }

    /* DM */
    .dm-thread{
      background:var(--card);
      border-radius:24px;
      border:1px solid var(--card-border);
      min-height:260px;
      padding:.7rem;
      display:flex;
      flex-direction:column;
      gap:.3rem;
    }
    .bubble{
      max-width:80%;
      padding:.45rem .7rem;
      border-radius:20px;
      font-size:.9rem;
    }
    .bubble.me{
      align-self:flex-end;
      background:#111217;
      color:#fff;
    }
    .bubble.them{
      align-self:flex-start;
      background:#f4f5fa;
    }
    .dm-input{
      display:flex;
      gap:.45rem;
      margin-top:.6rem;
    }
    .dm-input input{
      flex:1;
      border-radius:999px;
      border:1px solid var(--card-border);
      padding:.6rem .8rem;
      font:inherit;
      background:#fff;
    }

    /* REACTIONS */
    .reactions{
      display:flex;
      flex-direction:column;
      gap:.7rem;
    }
    .react-card{
      background:var(--card);
      border-radius:24px;
      border:1px solid var(--card-border);
      padding:.8rem .9rem;
      font-size:.9rem;
    }
    .react-item{
      display:flex;
      justify-content:space-between;
      gap:.5rem;
      margin-top:.35rem;
    }
    .delta.pos{color:var(--positive);}
    .delta.neg{color:var(--negative);}

    /* TABBAR */
    .tabbar{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:.6rem;
      width:100%;
      max-width:430px;
      padding:.25rem .35rem;
      background:rgba(255,255,255,0.96);
      border-radius:999px;
      box-shadow:0 8px 24px rgba(15,16,26,.18);
      display:flex;
      gap:.35rem;
      z-index:20;
    }
    .tab{
      flex:1;
      border-radius:999px;
      padding:.45rem 0;
      font-size:1rem;
    }
    .tab.active{
      background:#111217;
      color:#fff;
    }

    /* MODAL */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .modal.hidden{display:none;}
    .modal-card{
      width:min(420px,92vw);
      background:#fff;
      border-radius:22px;
      padding:1rem;
      box-shadow:0 18px 40px rgba(0,0,0,.25);
    }
    .modal-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:.5rem;
    }

    /* –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫–∏ */
    button:active, .tab:active {
      transform: scale(0.97);
      opacity: 0.9;
      transition: transform 50ms ease, opacity 50ms ease;
    }

    /* –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ (—Å–ø–∏–Ω–Ω–µ—Ä) */
    button.loading {
      position: relative;
      /* –°–∫—Ä—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç, –ø–æ–∫–∞ –≥—Ä—É–∑–∏—Ç—Å—è */
      color: transparent !important; 
      /* –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –Ω–∞–∂–∞—Ç–∏—è */
      pointer-events: none; 
    }
    button.loading::after {
      content: '';
      position: absolute;
      left: 50%;
      top: 50%;
      width: 20px; /* –†–∞–∑–º–µ—Ä —Å–ø–∏–Ω–Ω–µ—Ä–∞ */
      height: 20px;
      border-radius: 50%;
      /* –°–ø–∏–Ω–Ω–µ—Ä –±—É–¥–µ—Ç –±–µ–ª—ã–º, —Ç.–∫. –∫–Ω–æ–ø–∫–∏ .primary —É –Ω–∞—Å —Ç–µ–º–Ω—ã–µ */
      border: 3px solid rgba(255,255,255,0.3); 
      border-top-color: #fff;
      /* –ê–Ω–∏–º–∞—Ü–∏—è –≤—Ä–∞—â–µ–Ω–∏—è */
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: transform –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∏ translate, –∏ rotate –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏ */
      from { transform: translate(-50%, -50%) rotate(0deg); }
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è "—Ç—Ä–µ—Ö —Ç–æ—á–µ–∫" –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏ */
    .loader-dots, .loading-status {
      text-align: center;
      font-size: 1rem;
      padding: 0.5rem 0;
      color: var(--muted);
    }
    
    /* –£–≤–µ–ª–∏—á–∏–º —Ä–∞–∑–º–µ—Ä —Ç–æ—á–µ–∫ –≤ –º–æ–¥–∞–ª–∫–µ */
    .modal .loader-dots {
        font-size: 1.5rem;
        padding: 1rem 0;
    }

    .loader-dots::after, .loading-status::after {
      content: '.';
      animation: dots 1.4s steps(5, end) infinite;
    }
    
    @keyframes dots {
      0%, 20% {
        color: rgba(0,0,0,0);
        text-shadow:
          .25em 0 0 rgba(0,0,0,0),
          .5em 0 0 rgba(0,0,0,0);
      }
      40% {
        color: var(--muted);
        text-shadow:
          .25em 0 0 rgba(0,0,0,0),
          .5em 0 0 rgba(0,0,0,0);
      }
      60% {
        text-shadow:
          .25em 0 0 var(--muted),
          .5em 0 0 rgba(0,0,0,0);
      }
      80%, 100% {
        text-shadow:
          .25em 0 0 var(--muted),
          .5em 0 0 var(--muted);
      }
    }

  </style>
</head>
<body>
  <div id="app">
    <header class="topbar">
      <div class="brand">Verse</div>
      <div class="player-switch">
        <button id="myProfileBtn" class="secondary" style="padding:.25rem .7rem; margin-right:.5rem;">
          –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
        </button>
        <label>
          –Ø ‚Äî 
          <select id="activePlayerSelect"></select>
        </label>
      </div>
    </header>

    <main>
      <div id="loadingStatus" class="loading-status" style="display: none;">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤ –º–∏—Ä–∞</div>

      <section id="view-feed" class="view active">
        <div class="view-head">
          <h1>–õ–µ–Ω—Ç–∞</h1>
          <div class="filters">
            <button class="chip chip-on" data-filter="all">–í—Å–µ</button>
            <button class="chip" data-filter="social">–û–±—ã—á–Ω—ã–µ</button>
            <button class="chip" data-filter="story">–°—é–∂–µ—Ç–Ω—ã–µ</button>
          </div>
        </div>
        <ul id="feedList" class="feed-list"></ul>
      </section>

      <section id="view-relations" class="view">
        <div class="view-head">
          <h1>–û—Ç–Ω–æ—à–µ–Ω–∏—è</h1>
        </div>
        <div id="relationsList" class="relations"></div>
      </section>

      <section id="view-character" class="view">
        <div class="view-head">
          <h1>–ü—Ä–æ—Ñ–∏–ª—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h1>
        </div>
        <div id="characterView" class="char-view"></div>
      </section>

      <section id="view-compose" class="view">
        <div class="view-head">
          <h1>–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç</h1>
        </div>
        <div class="compose">
          <textarea id="composeText" rows="6" placeholder="–û —á—ë–º –¥—É–º–∞–µ—à—å?"></textarea>

          <div class="section">
            <label class="file-btn">
              <input id="composePhoto" type="file" accept="image/*" hidden />
              –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            </label>
            <div id="composePhotoPreview" class="photo-preview"></div>
          </div>

          <button id="publishSocialBtn" class="primary">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        </div>
      </section>

      <section id="view-story" class="view">
        <div class="view-head">
          <h1>–°—é–∂–µ—Ç–Ω—ã–π –ø–æ—Å—Ç</h1>
        </div>

        <div class="compose">
          <div class="section">
            <label class="label">–ò–¥–µ–∏ –¥–ª—è –ø–æ—Å—Ç–∞ (–ø—Ä–æ—Ç–æ—Ç–∏–ø)</label>
            <div class="idea-box">
              <button id="ideaPrev" class="ghost">&larr;</button>
              <div id="ideaText" class="idea-text">–ù–∞–∂–º–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å –∏–¥–µ–∏¬ª</div>
              <button id="ideaNext" class="ghost">&rarr;</button>
            </div>
            <div class="row">
              <button id="ideaRefresh" class="secondary">–û–±–Ω–æ–≤–∏—Ç—å –∏–¥–µ–∏</button>
              <button id="ideaUse" class="secondary">–í—Å—Ç–∞–≤–∏—Ç—å –≤ –ø–æ–ª–µ</button>
            </div>
          </div>

          <textarea id="storyText" rows="12" placeholder="–î–ª–∏–Ω–Ω—ã–π —Å—é–∂–µ—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç..."></textarea>
          <button id="publishStoryBtn" class="primary">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å—é–∂–µ—Ç–Ω—ã–π –ø–æ—Å—Ç</button>
          <p class="hint">–°—é–∂–µ—Ç–Ω—ã–µ –ø–æ—Å—Ç—ã –Ω–µ –∫–æ–º–º–µ–Ω—Ç–∏—Ä—É—é—Ç—Å—è, –Ω–æ —Å–∏–ª—å–Ω–µ–µ –≤–ª–∏—è—é—Ç –Ω–∞ –º–∏—Ä –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è.</p>
        </div>
      </section>

      <section id="view-dm" class="view">
        <div class="view-head">
          <h1 id="dmTitle">–õ–°</h1>
          <div class="row">
            <label>–ü–µ—Ä—Å–æ–Ω–∞–∂: 
              <select id="dmSelect"></select>
            </label>
            <label style="margin-left:1rem;">
              <input type="checkbox" id="dmAutoToggle" checked />
              –ë–æ—Ç –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å —Å–∞–º
            </label>
          </div>
        </div>

        <div id="dmThread" class="dm-thread"></div>

        <div class="dm-input">
          <input id="dmInput" type="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." />
          <button id="dmSend" class="primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </section>

      <section id="view-reactions" class="view">
        <div class="view-head">
          <h1>–†–µ–∞–∫—Ü–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</h1>
        </div>
        <div id="reactionsList" class="reactions"></div>
      </section>
    </main>

    <nav class="tabbar">
      <button class="tab active" data-target="feed" title="–õ–µ–Ω—Ç–∞">–õ–µ–Ω—Ç–∞</button>
      <button class="tab" data-target="relations" title="–û—Ç–Ω–æ—à–µ–Ω–∏—è">–û—Ç–Ω–æ—à–µ–Ω–∏—è</button>
      <button class="tab" data-target="compose" title="–ü–æ—Å—Ç">‚úèÔ∏è</button>
      <button class="tab" data-target="story" title="–°—é–∂–µ—Ç">–°—é–∂–µ—Ç</button>
      <button class="tab" data-target="dm" title="–õ–°">–õ–°</button>
      <button class="tab" data-target="reactions" title="–†–µ–∞–∫—Ü–∏–∏">–†–µ–∞–∫—Ü–∏–∏</button>
    </nav>
  </div>

  <div id="reactionModal" class="modal hidden">
    <div class="modal-card">
      <div class="modal-head">
        <h3>–†–µ–∞–∫—Ü–∏–∏ –Ω–∞ –ø–æ—Å—Ç</h3>
        <button id="modalClose" class="ghost">‚úï</button>
      </div>
      <div id="modalReactions"></div>
      <div class="row end">
        <button id="openReactionsBtn" class="secondary">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
        <button id="modalOk" class="primary">–û–∫</button>
      </div>
    </div>
  </div>

<script>
const $  = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
const uid = (p='id') => `${p}_${Math.random().toString(36).slice(2,9)}`;
const nowIso = () => new Date().toISOString();
const clip = (s, n=160) => (s.length>n ? s.slice(0,n) + '‚Ä¶' : s);
const fmtTime = (iso) => new Date(iso).toLocaleString();
const randint = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const choice = (arr)=>arr[Math.floor(Math.random()*arr.length)];
const clamp=(x,min,max)=>Math.max(min,Math.min(max,x));

// –°–æ–±–∏—Ä–∞–µ–º –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–≤—è–∑–µ–π –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ —Å –¥—Ä—É–≥–∏–º–∏
function buildRelationsSummary(char) {
  if (!char) return '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ.';

  const lines = [];
  
  // –î–æ–±–∞–≤–ª—è–µ–º —Å–≤—è–∑–∏ –∏–∑ relations
  if (char.relations) {
      for (const [otherId, value] of Object.entries(char.relations)) {
        let other = state.characters.find(c => c.id === otherId);
        if (!other) {
          other = state.players.find(p => p.id === otherId);
        }
        const name = other?.name || otherId;
        lines.push(`${char.name} –∏ ${name}: —É—Ä–æ–≤–µ–Ω—å –≤–∑–∞–∏–º–Ω–æ–π –±–ª–∏–∑–æ—Å—Ç–∏ ${value} –∏–∑ 100.`);
      }
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º –º–Ω–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –æ–± –∏–≥—Ä–æ–∫–∞—Ö (approval), –µ—Å–ª–∏ –æ–Ω–æ –Ω–µ –±—ã–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ relations
  if (char.approval) {
      for (const [playerId, value] of Object.entries(char.approval)) {
          if (isPlayerId(playerId) && (!char.relations || !(playerId in char.relations))) {
              const player = state.players.find(p => p.id === playerId);
              const name = player?.name || playerId;
              lines.push(`–ú–Ω–µ–Ω–∏–µ ${char.name} –æ–± –∏–≥—Ä–æ–∫–µ ${name}: ${Math.round(value)} –∏–∑ 100.`);
          }
      }
  }


  if (!lines.length) return '–ù–µ—Ç —è–≤–Ω—ã—Ö —Å–≤—è–∑–µ–π.';

  return lines.join('\n');
}

// === –ò–ò (Gemini) ===

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ AI –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
let activeAiRequests = 0;

function updateLoadingStatus() {
    const statusEl = $('#loadingStatus');
    if (!statusEl) return;
    if (activeAiRequests > 0) {
        statusEl.style.display = 'block';
    } else {
        statusEl.style.display = 'none';
    }
}

async function askAI(promptText) {
  console.log("–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ AI...");
  activeAiRequests++;
  updateLoadingStatus();

  try {
    const res = await fetch('/api/gemini', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: promptText })
    });

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ HTTP
    if (!res.ok) {
        console.error('AI API network error: HTTP status', res.status);
        return null;
    }

    const data = await res.json();

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞ API
    if (!data.ok || !data.answer) {
      console.error('AI error response (API –≤–µ—Ä–Ω—É–ª fail –∏–ª–∏ –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç)', data);
      return null;
    }

    return data.answer.trim();
  } catch (err) {
    console.error('AI network error (API /api/gemini –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ?)', err);
    return null;
  } finally {
    activeAiRequests--;
    updateLoadingStatus();
  }
}


async function aiReplyToDm(charId) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—á–∞—é—â–∏–π - —ç—Ç–æ –Ω–µ –∏–≥—Ä–æ–∫
  if (isPlayerId(charId)) return;

  const char = state.characters.find(c => c.id === charId);
  if (!char) return;

  const me = currentPlayer();
  const key = threadKey(charId);
  const history = state.dms[key] || [];

  const historyText = history.map(m => {
    const whoName = m.from === state.activePlayerId ? me.name : char.name;
    return `${whoName}: ${m.text}`;
  }).join('\n');

  const relationsSummary = buildRelationsSummary(char);

  const prompt = `
–¢—ã ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–∂ ${char.name} (${char.username}) –≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –≤—ã–º—ã—à–ª–µ–Ω–Ω–æ–π —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏.

–ö–ê–ù–û–ù–ò–ß–ï–°–ö–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–ï–†–°–û–ù–ê–ñ–ï:
- –ë–∏–æ–≥—Ä–∞—Ñ–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (–∏—Å–ø–æ–ª—å–∑—É–π –∫–∞–∫ –±–∞–∑—É, –æ–Ω–∞ –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∞–≤—Ç–æ—Ä–æ–º):
${char.bio}

- –°–≤—è–∑–∏ –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏:
${relationsSummary}

–≠—Ç–∏ —Ñ–∞–∫—Ç—ã –æ —Å–≤—è–∑—è—Ö —Å—á–∏—Ç–∞—é—Ç—Å—è –∏—Å—Ç–∏–Ω–æ–π. 
–ù–ï –ü–ï–†–ï–ü–£–¢–´–í–ê–ô, –∫—Ç–æ –∫–æ–º—É –∫–µ–º –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è, –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π –Ω–æ–≤—ã–µ —Ä–æ–¥—Å—Ç–≤–∞ –∏ –Ω–µ –º–µ–Ω—è–π —Ä–æ–ª–∏.
–ï—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –∏–≥—Ä–æ–∫–∞ –µ—Å—Ç—å –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ —ç—Ç–∏–º —Ñ–∞–∫—Ç–∞–º ‚Äî –º—è–≥–∫–æ –ø–æ–ø—Ä–∞–≤—å –µ–≥–æ –∏–ª–∏ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –Ω–∞–º–µ–∫–Ω–∏, –Ω–æ —Å–∞–º –∫–∞–Ω–æ–Ω –ù–ï –º–µ–Ω—è–π.

–¢–æ–Ω –æ–±—â–µ–Ω–∏—è: ${char.tone}.
–¢–µ–∫—É—â–µ–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –∏–≥—Ä–æ–∫—É ${me.name}: ${char.approval[state.activePlayerId] ?? 50} –∏–∑ 100.

–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –º–µ–∂–¥—É —Ç–æ–±–æ–π –∏ –∏–≥—Ä–æ–∫–æ–º:
${historyText}

–°–µ–π—á–∞—Å, –æ—Ç –ª–∏—Ü–∞ ${char.name}, –æ—Ç–≤–µ—Ç—å –Ω–∞ –ü–û–°–õ–ï–î–ù–ï–ï —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞.
–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
- –ø–æ-—Ä—É—Å—Å–∫–∏
- –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞
- 1‚Äì3 –∫–æ—Ä–æ—Ç–∫–∏–µ —Ä–µ–ø–ª–∏–∫–∏
- –±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π, —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
- —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä—É –∏ –∫–∞–Ω–æ–Ω–∏—á–Ω—ã–º —Å–≤—è–∑—è–º.
`;

  const aiText = await askAI(prompt);
  if (!aiText) return;

  pushMessage(charId, charId, aiText);
}

let state = {
  players: [
    { id:'player1', name:'–ì—Ä–µ–π—Å–æ–Ω',  username:'@LiqueurD',   followers:320 },
    { id:'player2', name:'–õ–æ—Ä–∞–Ω—Ç–∏—Å', username:'@tinktloran', followers:340 }
  ],
  activePlayerId: 'player1',
  characters: [],
  posts: [],
  dms: {},
  reactions: [],
  npcs: [],        // –∂–∏—Ç–µ–ª–∏ (–æ–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ª–µ–Ω—Ç—ã)
  outlets: [],     // –º–µ–¥–∏–∞
  world: {         // –∏–Ω—Ç–µ—Ä–µ—Å—ã –º–∏—Ä–∞
    topics: ['horses','music','university','nightlife','family','gossip','sports','tech','citylife']
  }
};

// –í–ù–ï state (–æ—Ç–¥–µ–ª—å–Ω–æ!)
function migrateStateSchema(){
  if(!state.npcs)       state.npcs = [];
  if(!state.outlets)    state.outlets = [];
  if(!state.world)      state.world = { topics:['horses','music','university','nightlife','family','gossip','sports','tech','citylife'] };
  if(!state.dms)        state.dms = {};
  if(!state.reactions)  state.reactions = [];

  // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è AI-—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
  state.characters.forEach(c => {
      if (!c.profileThought) c.profileThought = {};
      if (!c.relationTitles) c.relationTitles = {};
  });
}


const LS_KEY = 'verse_state_v2_grayson_loran';

// === –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏ —Å—Ç–∞—Ä—Ç–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤ ===
function seedIfEmpty(){
  if(state.characters.length) return;

  // –ë–∞–∑–æ–≤—ã–π —à–∞–±–ª–æ–Ω –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
  const baseChar = () => ({
      lastThought: '',
      avatar: '',
      profileThought: {},
      relationTitles: {}
  });

  // –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
  state.characters = [
    { ...baseChar(), id:'player1', name:'–ì—Ä–µ–π—Å–æ–Ω', username:'@LiqueurD', tone:'stoic', followers:320, bio:'(–í–ø–∏—à–∏ —Å—é–¥–∞ –∫–∞–Ω–æ–Ω –ì—Ä–µ–π—Å–æ–Ω–∞)', relations:{}, approval:{ player2: 50, kristian: 60, vivien: 70 } },
    { ...baseChar(), id:'player2', name:'–õ–æ—Ä–∞–Ω—Ç–∏—Å', username:'@tinktloran', tone:'warm', followers:340, bio:'(–í–ø–∏—à–∏ —Å—é–¥–∞ –∫–∞–Ω–æ–Ω –õ–æ—Ä–∞–Ω—Ç–∏—Å–∞)', relations:{}, approval:{ player1: 50, kristian: 40, aurora: 75 } },
    { ...baseChar(), id:'kristian', name:'–ö—Ä–∏—Å—Ç–∏–∞–Ω –í–æ–ª—å—Ç', username:'@shiningshining', tone:'warm', followers:1500, bio:'–û–º–µ–≥–∞ —Å –ø–ª–∞—Ç–∏–Ω–æ–≤—ã–º–∏ –≤–æ–ª–æ—Å–∞–º–∏ –∏ –æ–±–µ–∑–æ—Ä—É–∂–∏–≤–∞—é—â–µ–π —É–ª—ã–±–∫–æ–π; —Ö–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω—ã–π —Å—Ç—É–¥–µ–Ω—Ç –ø–µ–¥—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞, —Å–∞–º —Å–µ–±—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç, –ª—é–±–∏—Ç –¥–µ—Ç–µ–π –∏ —Å–ª–∞–¥–∫–æ–µ. –í –ø—Ä–æ—à–ª–æ–º —Å–ø–∞–ª —Å –ì—Ä–µ–π—Å–æ–Ω–æ–º –∏ —Å–µ–π—á–∞—Å —Å–Ω–æ–≤–∞ –∏–º –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω.', relations:{ vivien:40, eve:20, alexi:25 }, approval:{ player1:65, player2:35 } },
    { ...baseChar(), id:'vivien', name:'–í–∏–≤—å–µ–Ω –ë–ª–µ–π–¥–º–æ—Ä', username:'@WildFret', tone:'chaotic', followers:900, bio:'–ë–µ—Ç–∞, –≥–∏—Ç–∞—Ä–∏—Å—Ç–∫–∞ –≥—Ä—É–ø–ø—ã Ash&mercury, —É–ø—Ä—è–º–∞—è —à—É–º–Ω–∞—è —Ä–æ–∫–µ—Ä—à–∞, –ø—Ä–∏–∫—Ä—ã–≤–∞–µ—Ç –º–ª–∞–¥—à–∏—Ö –∏ —Å–ø–æ—Ä–∏—Ç —Å –ö–∞–π–ª–∞–Ω–æ–º. –í –ø–æ–ª–∏–∞–º–æ—Ä–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö —Å –ï–≤–æ–π –∏ –ê–ª–µ–∫—Å–∏.', relations:{ alexi:80, eve:70, grayson:65, aiden:60, ember:60 }, approval:{ player1:70, player2:55 } },
    { ...baseChar(), id:'aiden', name:'–≠–π–¥–µ–Ω –ë–ª–µ–π–¥–º–æ—Ä', username:'@404NotFound', tone:'chaotic', followers:600, bio:'–î–æ–º–∏–Ω–∞–Ω—Ç–Ω—ã–π –æ–º–µ–≥–∞-—à–∞–ª–æ–ø–∞–π: –æ–±–∞—è—Ç–µ–ª—å–Ω—ã–π –∞–≤–∞–Ω—Ç—é—Ä–∏—Å—Ç, —Ç–∞–∫—Ç–∏–∫ –¥—É—ç—Ç–∞ —Å —Å–µ—Å—Ç—Ä–æ–π –≠–º–±–µ—Ä. –û–±–æ–∂–∞–µ—Ç –ø—Ä–∞–Ω–∫–∏, —Ç–µ–∞—Ç—Ä –∏ –≤–ª—é–±–ª—ë–Ω –≤ —É—á–∏—Ç–µ–ª—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã –ò—Ç–∞–Ω–∞ –•–æ–≥–≥–∞—Ä—Ç–∞.', relations:{ ember:90, vivien:60, eve:40, ethan:75 }, approval:{ player1:65, player2:50 } },
    { ...baseChar(), id:'ember', name:'–≠–º–±–µ—Ä –ë–ª–µ–π–¥–º–æ—Ä', username:'@500InternalServerError', tone:'stoic', followers:580, bio:'–î–æ–º–∏–Ω–∞–Ω—Ç–Ω–∞—è –æ–º–µ–≥–∞, —Ñ–ª–µ–≥–º–∞—Ç–∏—á–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫; –º–æ–∑–≥ –¥—É—ç—Ç–∞ —Å –≠–π–¥–µ–Ω–æ–º, –ª—é–±–∏—Ç —Å–æ–±–∞–∫ –∏ —Ä–∞—Å—Ç–µ–Ω–∏—è. –°–∫–µ–ø—Ç–∏—á–Ω–∞, –Ω–æ –æ—á–µ–Ω—å –∑–∞–±–æ—Ç–ª–∏–≤–∞.', relations:{ aiden:90, vivien:60, eve:40 }, approval:{ player1:60, player2:50 } },
    { ...baseChar(), id:'aurora', name:'–ê–≤—Ä–æ—Ä–∞ –ë–ª—ç–∫–≤–æ–ª–ª', username:'@ABlackwall', tone:'stoic', followers:800, bio:'–î–æ–º–∏–Ω–∞–Ω—Ç–Ω–∞—è –∞–ª—å—Ñ–∞, —Å–ø–æ–∫–æ–π–Ω–∞—è –∏ —Å–æ–±—Ä–∞–Ω–Ω–∞—è, –±—É–¥—É—â–∞—è –Ω–∞—Å–ª–µ–¥–Ω–∏—Ü–∞ —Å–µ–º–µ–π–Ω–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞. –õ—é–±–∏—Ç –ø–æ—Ä—è–¥–æ–∫, —Ç–æ—á–Ω—ã–µ –Ω–∞—É–∫–∏ –∏ —é–≤–µ–ª–∏—Ä–Ω–æ–µ –¥–µ–ª–æ, –∫–æ–≥–¥–∞-—Ç–æ –∑–∞–Ω–∏–º–∞–ª–∞—Å—å –∫–æ–Ω–Ω—ã–º —Å–ø–æ—Ä—Ç–æ–º –≤–º–µ—Å—Ç–µ —Å –ì—Ä–µ–π—Å–æ–Ω–æ–º.', relations:{ eve:70, loran:75, derek:80, noel:70 }, approval:{ player1:65, player2:80 } },
    { ...baseChar(), id:'eve', name:'–ï–≤–∞ –ë–ª—ç–∫–≤–æ–ª–ª', username:'@EveLuxe', tone:'sharp', followers:1000000, bio:'–ì—Ä–æ–º–∫–∞—è —Å—Ç–µ—Ä–≤–æ–∑–Ω–∞—è –¥–æ–º–∏–Ω–∞–Ω—Ç–Ω–∞—è –∞–ª—å—Ñ–∞-–±–ª–æ–≥–µ—Ä—à–∞; –º–µ–Ω–µ–¥–∂–µ—Ä —Ä–æ–∫-–≥—Ä—É–ø–ø—ã –í–∏–≤—å–µ–Ω –∏ –ê–ª–µ–∫—Å–∏ –∏ —á–∞—Å—Ç—å –∏—Ö –ø–æ–ª–∏–∞–º–æ—Ä–Ω–æ–π —Ç—Ä–æ–∏—Ü—ã. –õ—é–±–∏—Ç –≤–µ—á–µ—Ä–∏–Ω–∫–∏, —Å–µ–∫—Å –∏ –ø–æ–±–µ–∂–¥–∞—Ç—å –≤ —Å–ø–æ—Ä–∞—Ö.', relations:{ aurora:80, loran:85, vivien:75, alexi:70, aiden:50, ember:50 }, approval:{ player1:75, player2:70 } },
    { ...baseChar(), id:'derek', name:'–î–µ—Ä–µ–∫ –ë–ª—ç–∫–≤–æ–ª–ª', username:'@BlackDiamond', tone:'warm', followers:12000, bio:'–î–æ–º–∏–Ω–∞–Ω—Ç–Ω—ã–π –∞–ª—å—Ñ–∞, –æ—Ç–µ—Ü –ï–≤—ã, –ê–≤—Ä–æ—Ä—ã –∏ –õ–æ—Ä–∞–Ω—Ç–∏—Å–∞, –≤–µ—Ä–Ω—ã–π –º—É–∂ –ù–æ—ç–ª—è –∏ –≤–ª–∞–¥–µ–ª–µ—Ü —é–≤–µ–ª–∏—Ä–Ω–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞. –û–±–æ–∂–∞–µ—Ç —Å–µ–º—å—é, —à—É—Ç–∏—Ç –∏ –ø–µ—Ä–µ–∂–∏–≤–∞–µ—Ç –∏–∑-–∑–∞ –æ—Ç—ä–µ–∑–¥–∞ –õ–æ—Ä–∞–Ω–∞ –≤ –ì–µ—Ä–º–∞–Ω–∏—é.', relations:{ noel:95, aurora:90, eve:85, loran:95, dante:80, grayson:70 }, approval:{ player1:70, player2:85 } },
    { ...baseChar(), id:'dante', name:'–î–∞–Ω—Ç–µ –ë–ª–µ–π–¥–º–æ—Ä', username:'@dSever', tone:'warm', followers:18000, bio:'–î–æ–º–∏–Ω–∞–Ω—Ç–Ω—ã–π –∞–ª—å—Ñ–∞-—Å–µ–º—å—è–Ω–∏–Ω –∏ –ø–æ–∂–∞—Ä–Ω—ã–π-—Å–ø–∞—Å–∞—Ç–µ–ª—å, –º—É–∂ –ö–∞–π–ª–∞–Ω–∞, –æ—Ç–µ—Ü –í–∏–≤—å–µ–Ω, –ì—Ä–µ–π—Å–æ–Ω–∞, –≠–º–±–µ—Ä –∏ –≠–π–¥–µ–Ω–∞. –°–ø–æ–∫–æ–π–Ω—ã–π —Ñ–ª–µ–≥–º–∞—Ç–∏–∫, –æ–±–æ–∂–∞–µ—Ç —Å–≤–æ—é ¬´—Å—Ç–∞—é¬ª –∏ –≤–æ–∑–∏—Ç—Å—è —Å –º–∞—à–∏–Ω–∞–º–∏.', relations:{ kaylan:95, vivien:90, grayson:90, aiden:85, ember:85, alexi:75 }, approval:{ player1:85, player2:60 } },
    { ...baseChar(), id:'kaylan', name:'–ö–∞–π–ª–∞–Ω –ë–ª–µ–π–¥–º–æ—Ä', username:'@meowgneticc', tone:'sharp', followers:25000, bio:'–î–æ–º–∏–Ω–∞–Ω—Ç–Ω–∞—è –æ–º–µ–≥–∞-–∞–¥–≤–æ–∫–∞—Ç, –≥–ª–∞–≤–∞ Blademore K.D. –°—Ç—Ä–æ–≥–∏–π, —Ö–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω—ã–π, –≤–æ—Ä—á–ª–∏–≤—ã–π –≥–µ–Ω–∏–π —é—Ä–∏—Å–ø—Ä—É–¥–µ–Ω—Ü–∏–∏, –æ—á–µ–Ω—å –∑–∞–±–æ—Ç–∏—Ç—Å—è –æ —Å–µ–º—å–µ –∏ —Ö–æ—Ç–µ–ª –¥–ª—è –¥–µ—Ç–µ–π ¬´—é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –±—É–¥—É—â–µ–µ¬ª.', relations:{ dante:95, vivien:80, grayson:75, aiden:80, ember:80 }, approval:{ player1:55, player2:65 } },
    { ...baseChar(), id:'alexi', name:'–ê–ª–µ–∫—Å–∏ –£–æ–∫–µ—Ä', username:'@mercuryAl', tone:'warm', followers:3000, bio:'–ë–µ—Ç–∞, —Å–æ–ª–∏—Å—Ç –∏ –æ—Å–Ω–æ–≤–∞—Ç–µ–ª—å —Ä–æ–∫-–≥—Ä—É–ø–ø—ã ¬´Ash&mercury¬ª, –≤—ã—Ä–æ—Å –≤ –±–µ–¥–Ω–æ—Å—Ç–∏, –Ω–æ –±—ã–ª —É—Å—ã–Ω–æ–≤–ª—ë–Ω –ë–ª–µ–π–¥–º–æ—Ä–∞–º–∏. –ü—Ä–µ–¥–∞–Ω–Ω—ã–π, –¥–æ–±—Ä—ã–π –±—É–Ω—Ç–∞—Ä—å, –≤ —Å–ª–æ–∂–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö —Å –í–∏–≤—å–µ–Ω –∏ –ï–≤–æ–π.', relations:{ vivien:85, eve:80, dante:70, grayson:80 }, approval:{ player1:80, player2:55 } },
    { ...baseChar(), id:'evelyn', name:'–≠–≤–µ–ª–∏–Ω –•–∞—Ä—Ç', username:'@drHart', tone:'sharp', followers:22000, bio:'–ê–ª—å—Ñ–∞, –±—ã–≤—à–∏–π —Å—É–¥–º–µ–¥—ç–∫—Å–ø–µ—Ä—Ç, —Å–µ–π—á–∞—Å –≤–ª–∞–¥–µ–ª–∏—Ü–∞ –∫–ª–∏–Ω–∏–∫–∏ Family Hart. –ò—Ä–æ–Ω–∏—á–Ω–∞—è, –¥–µ—Ä–∑–∫–∞—è, –¥–∞—ë—Ç –ª—é–¥—è–º –ø—Ä–æ–∑–≤–∏—â–∞ –∏ —Å—Ç–∞–≤–∏—Ç –¥–∏–∞–≥–Ω–æ–∑—ã –ø–æ —Ç–≤–∏—Ç–∞–º; –æ—Å–æ–±–µ–Ω–Ω–æ –±–ª–∏–∑–∫–∞ —Å –õ–æ—Ä–∞–Ω–æ–º –∏ –ê–≤—Ä–æ—Ä–æ–π.', relations:{ loran:90, aurora:85, eve:50, kaylan:70, derek:70 }, approval:{ player1:55, player2:85 } },
    { ...baseChar(), id:'ellean', name:'–≠–ª–ª–µ–∞–Ω –ë–ª–µ–π–¥–º–æ—Ä', username:'@EllyMurrr', tone:'chaotic', followers:26000, bio:'–ñ—É—Ä–Ω–∞–ª–∏—Å—Ç –∏ –∏–∑–¥–∞—Ç–µ–ª—å BladeM, —à—É–º–Ω—ã–π –∏ —Ç–∞–∫—Ç–∏–ª—å–Ω—ã–π –¥–µ–¥—É—à–∫–∞ –ë–ª–µ–π–¥–º–æ—Ä–æ–≤. –õ—é–±–∏—Ç –ø—Ä–∞–Ω–∫–∏ —Å –≠–π–¥–µ–Ω–æ–º –∏ –≠–º–±–µ—Ä, —Ç–µ–ø–ª–æ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –ì—Ä–µ–π—Å–æ–Ω—É –∏ –ø—Ä–æ—Å–∏—Ç –õ–æ—Ä–∞–Ω–∞ –±—ã—Ç—å —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω–µ–µ.', relations:{ kaylan:90, grayson:85, aiden:70, ember:70, loran:75 }, approval:{ player1:90, player2:75 } },
    { ...baseChar(), id:'dohyun', name:'–ö–∞–Ω –î–æ—Ö—ë–Ω', username:'@RRentGen', tone:'stoic', followers:8000, bio:'–ê–ª—å—Ñ–∞-–º–µ–¥–∏–∫-–∏–Ω—Ç–µ—Ä–Ω, —Ç–∏—Ö–∏–π –≥–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –∫–ª–∏–Ω–∏–∫–µ –≠–≤–µ–ª–∏–Ω. –°—Ç–∞—Ä—ã–π –¥—Ä—É–≥ –õ–æ—Ä–∞–Ω—Ç–∏—Å–∞, —Ä–∞–∑–¥–µ–ª—è–µ—Ç —Å –Ω–∏–º –ª—é–±–æ–≤—å –∫ –∑–Ω–∞–Ω–∏—è–º –∏ –∞–Ω–∏–º–µ, —Å—á–∏—Ç–∞–µ—Ç –ì—Ä–µ–π—Å–æ–Ω–∞ –Ω–µ–¥–æ—Å—Ç–æ–π–Ω—ã–º –õ–æ—Ä–∞–Ω–∞.', relations:{ loran:90, evelyn:70 }, approval:{ player1:30, player2:85 } },
    { ...baseChar(), id:'ethan', name:'–ò—Ç–∞–Ω –•–æ–≥–≥–∞—Ä—Ç', username:'@metaphoricalallegory', tone:'warm', followers:5000, bio:'–ê–ª—å—Ñ–∞-—É—á–∏—Ç–µ–ª—å –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã –∏ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å —Ç–µ–∞—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –∫–ª—É–±–∞. –î–æ–±—Ä—ã–π, —Ö–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω—ã–π, –ª—é–±–∏–º–µ—Ü —à–∫–æ–ª—å–Ω–∏–∫–æ–≤; –æ—Å–æ–±–µ–Ω–Ω–æ –≤–µ—Ä–∏—Ç –≤ —Ç–∞–ª–∞–Ω—Ç –≠–π–¥–µ–Ω–∞.', relations:{ aiden:90 }, approval:{ player1:60, player2:55 } },
    { ...baseChar(), id:'kassandra', name:'–ö–∞—Å—Å–∞–Ω–¥—Ä–∞ –ë–ª–µ–π–¥–º–æ—Ä', username:'@Kkassy', tone:'warm', followers:4000, bio:'–ê–ª—å—Ñ–∞-–≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä, –º–ª–∞–¥—à–∞—è —Å–µ—Å—Ç—Ä–∞ –ö–∞–π–ª–∞–Ω–∞, –≤–ª–∞–¥–µ–ª–∏—Ü–∞ —Ñ–µ—Ä–º—ã –∏ –∫–æ–Ω—é—à–µ–Ω. –û—á–µ–Ω—å –º—è–≥–∫–∞—è, –Ω–æ —Å–∏–ª—å–Ω–∞—è –¥—É—Ö–æ–º –∂–µ–Ω—â–∏–Ω–∞, –ª—é–±–∏—Ç –ø–ª–µ–º—è–Ω–Ω–∏–∫–æ–≤; —Å–µ–π—á–∞—Å –ì—Ä–µ–π—Å–æ–Ω —É –Ω–µ—ë —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ª–æ—à–∞–¥—å–º–∏.', relations:{ grayson:85, kaylan:80, dante:75 }, approval:{ player1:85, player2:60 } }
  ];

  state.posts = [
    postObj({
      type:'social',
      authorType:'character',
      authorId:'vivien',
      content:'–ö—Ç–æ –∏–¥—ë—Ç —Å–µ–≥–æ–¥–Ω—è –Ω–∞ —Ä–µ–ø–µ—Ç–∏—Ü–∏—é Ash&mercury? –ù—É–∂–Ω–æ –æ—Ç–æ–≥–Ω–∞—Ç—å –¥—É—Ä–Ω—ã–µ –º—ã—Å–ª–∏ –≥—Ä–æ–º–∫–æ–π –º—É–∑—ã–∫–æ–π.',
      relatedCharacters:['alexi','eve']
    }),
    postObj({
      type:'social',
      authorType:'character',
      authorId:'kristian',
      content:'–ò–Ω–æ–≥–¥–∞ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ –¥–µ—Ç–∏ –≤ —à–∫–æ–ª–µ –º—É–¥—Ä–µ–µ –≤–∑—Ä–æ—Å–ª—ã—Ö –Ω–∞ –≤–µ—á–µ—Ä–∏–Ω–∫–∞—Ö.',
      relatedCharacters:[]
    })
  ];
}

// === —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ / –∑–∞–≥—Ä—É–∑–∫–∞ ===
function save(){
  try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch(e){}
}

function load(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(raw) state = JSON.parse(raw);
  }catch(e){}

  // –ø—Ä–∏–≤–æ–¥–∏–º —Å—Ö–µ–º—É –∫ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π
  migrateStateSchema();

  // —Å–æ–∑–¥–∞—ë–º –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π/—Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –ø–æ—Å—Ç—ã, –µ—Å–ª–∏ –ø—É—Å—Ç–æ
  seedIfEmpty();

  function seedWorldAccounts(){
  if (state.npcs.length || state.outlets.length) return;

  const tones = ['warm','stoic','sharp','chaotic'];
  const topics = state.world.topics;

  const handleBits = {
    horses: ['horseslover','hoofbeats','stableaddict','ride4life','cavalier','coltwatch'],
    music:  ['ashfan','riffhunter','vinylcity','gigguide','ampjunkie'],
    family: ['familyfirst','blademorewatch','homevibes','parenttalk'],
    gossip: ['CityRumors','TeaSpill','SpiceWire','WhisperLane','DailyDust'],
    nightlife:['afterdark','clubtrail','midnightowl','citylights'],
    university:['campusbee','studyflow','libratalk'],
    sports:  ['varsitywatch','balltalk','arenaecho'],
    tech:    ['techpulse','devglance','codetips'],
    citylife:['urbansight','streetnotes','townsquare']
  };

  function makeHandle(topic){
    const pool = handleBits[topic] || ['feedline','localvoice','randomuser'];
    const base = choice(pool);
    const suffix = Math.random()<0.5 ? '' : Math.floor(10+Math.random()*89);
    return '@' + (base + suffix);
  }

  function makeName(){
    const first = ['–°–∞—à–∞','–ö–∏—Ä–∞','–ú–∞–∫—Å','–ê–Ω—è','–î–µ–Ω–∏—Å','–õ–∏—è','–ò–≥–æ—Ä—å','–ù–∏–∫–∞','–Ø–Ω','–ú–∏–ª–∞','–¢–∏–º—É—Ä','–†–∏—Ç–∞','–§–µ–¥—è','–Æ–ª—è','–ì–æ—à–∞'];
    const last  = ['–ò–ª—å–∏–Ω','–°–∞–≤–∏–Ω–∞','–¢—É–º–∞–Ω–æ–≤–∞','–õ–µ–±–µ–¥–µ–≤','–ì—Ä–æ–º–æ–≤–∞','–í–æ–ª–∫–æ–≤','–ú–µ–ª—å–Ω–∏–∫','–ö–æ—Ç–æ–≤–∞','–†—É–¥–Ω–µ–≤','–°–º–∏—Ä–Ω–æ–≤–∞','–ù–∞–∑–∞—Ä–æ–≤'];
    return `${choice(first)} ${choice(last)}`;
  }

  // 28‚Äì36 –æ–±—ã—á–Ω—ã—Ö NPC
  const npcCount = randint(28,36);
  for (let i=0;i<npcCount;i++){
    const t = choice(topics);
    state.npcs.push({
      id: uid('npc'),
      name: makeName(), // –î–∞–¥–∏–º NPC –∏–º–µ–Ω–∞ –¥–ª—è —Ä–µ–∞–ª–∏–∑–º–∞
      username: makeHandle(t),
      tone: choice(tones),
      topic: t,
      bio: `–û–±—ã—á–Ω—ã–π –∂–∏—Ç–µ–ª—å –≥–æ—Ä–æ–¥–∞, –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è: ${t}.`
    });
  }

  // –°–ú–ò: –Ω–æ–≤–æ—Å—Ç–∏ + —Ç–∞–±–ª–æ–∏–¥—ã
  const outlets = [
    { name:'–ì–æ—Ä–æ–¥ –°–µ–≥–æ–¥–Ω—è',   topic:'citylife', type:'news'   },
    { name:'–ö–∞–Ω—Ç–µ—Ä-–¢–∞—É–Ω News',topic:'citylife', type:'news'   },
    { name:'–°–≤–µ—Ç—Å–∫–∞—è –õ—É–ø–∞',   topic:'gossip',   type:'tabloid'},
    { name:'Daily Dust',      topic:'gossip',   type:'tabloid'}
  ];

  state.outlets = outlets.map(o=>({
    id: uid('outlet'),
    name: o.name,
    username: makeHandle(o.topic),
    tone: o.type==='news' ? 'stoic' : 'sharp',
    outletType: o.type,
    topic: o.topic,
    bio: o.type==='news'
      ? '–ú–µ—Å—Ç–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏, –∫–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É.'
      : '–ì—Ä–æ–º–∫–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏, —Å–ª—É—Ö–∏ –∏ —Å–ø–ª–µ—Ç–Ω–∏.'
  }));
}


  // —Å–æ–∑–¥–∞—ë–º NPC –∏ –º–µ–¥–∏–∞, –µ—Å–ª–∏ –∏—Ö –µ—â—ë –Ω–µ—Ç
  seedWorldAccounts();

  save();
}



// === –º–æ–¥–µ–ª–∏ –ø–æ—Å—Ç–æ–≤ / —Ä–µ–∞–∫—Ü–∏–π ===
function postObj({type, authorType, authorId, content, relatedCharacters=[], photoData=null}){
  return {
    id: uid('post'),
    type,
    authorType,
    authorId,
    content,
    relatedCharacters,
    photoData,
    createdAt: nowIso(),
    likes: randint(0,50),
    comments: []
  };
}
function reactionObj(postId, charId, text, delta){
  return { id:uid('rx'), postId, charId, text, delta, at: nowIso() };
}

// === –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–∫–ª–∞–¥–∫–∞–º ===
function setActiveView(key){
  $$('.view').forEach(v=>v.classList.remove('active'));
  document.querySelector(`#view-${key}`).classList.add('active');
  $$('.tab').forEach(t=>t.classList.toggle('active', t.dataset.target===key));
  if(key==='relations') renderRelations();
  if(key==='dm')        syncDmSelectors();
  if(key==='reactions') renderReactions();
  if(key==='feed')      renderFeed();
}
function setupNav(){
  $$('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>setActiveView(btn.dataset.target));
  });
}

// === –ª–µ–Ω—Ç–∞ ===
let feedFilter = 'all';

function renderFeed(){
  const ul = $('#feedList');
  const posts = state.posts
    .filter(p => feedFilter==='all' ? true : p.type===feedFilter)
    .slice().sort((a,b)=>b.createdAt.localeCompare(a.createdAt));

  ul.innerHTML = posts.map(p=>renderPostHtml(p)).join('');
  posts.forEach(p=>{
    if(p.type==='social'){
      const btn = document.querySelector(`[data-action="comment"][data-id="${p.id}"]`);
      if(btn) btn.onclick = ()=>addQuickComment(p.id);
    }
  });
}


function getAuthorByType(authorType, id){
  if (authorType==='player')    return state.players.find(x=>x.id===id);
  if (authorType==='character') return state.characters.find(x=>x.id===id);
  if (authorType==='npc')       return state.npcs.find(x=>x.id===id);
  if (authorType==='outlet')    return state.outlets.find(x=>x.id===id);
  return null;
}

function openReactionsForPost(postId) {
    lastReactionPostId = postId; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ ID –ø–æ—Å—Ç–∞
    setActiveView('reactions'); // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –≤–∫–ª–∞–¥–∫—É —Ä–µ–∞–∫—Ü–∏–π
}

function renderPostHtml(p){
  const author = getAuthorByType(p.authorType, p.authorId);
  const rawName = author?.name ?? '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
  const rawUsername = author?.username ?? '@user';

  const isMedia = p.authorType==='outlet';
  const isNpc   = p.authorType==='npc';

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ò–º—è –∏ –ù–∏–∫ –¥–ª—è –≤—Å–µ—Ö
  const name = rawName || rawUsername;
  const username = rawUsername;

  const badge = p.type==='story' ? `<span class="badge">–°—é–∂–µ—Ç</span>`
              : isMedia           ? `<span class="badge">–ú–µ–¥–∏–∞</span>`
              : isNpc             ? `<span class="badge">–ñ–∏—Ç–µ–ª—å</span>`
              : '';

  const photo = p.photoData ? `<div class="photo-preview"><img src="${p.photoData}" alt=""></div>` : '';
  
  // –ê–≤–∞—Ç–∞—Ä
  let avatarStyle = '';
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–≤–∞—Ç–∞—Ä –∏–∑ characters, –¥–∞–∂–µ –µ—Å–ª–∏ –∞–≤—Ç–æ—Ä player
  const charData = state.characters.find(c => c.id === p.authorId);
  if (charData && charData.avatar) {
      avatarStyle = `style="background-image: url('${charData.avatar}');"`;
  }


  const commentsRow = (p.type==='social')
    ? `<div class="post-actions">
         <span class="icon">üí¨ <span>${p.comments.length}</span></span>
         <button class="ghost" data-action="comment" data-id="${p.id}">–ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
       </div>`
    : `<div class="post-actions"><span class="badge">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã</span></div>`;

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ä–µ–∞–∫—Ü–∏–π, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
  const hasReactions = state.reactions.some(r => r.postId === p.id);

  const reactionBtn = `<div class="post-actions">
      ${hasReactions ? `<button class="secondary" onclick="openReactionsForPost('${p.id}')">–†–µ–∞–∫—Ü–∏–∏</button>` : ''}
      <span class="icon" title="${fmtTime(p.createdAt)}">üïí ${new Date(p.createdAt).toLocaleTimeString()}</span>
    </div>`;

  return `
    <li class="post" id="${p.id}">
      <div class="post-head">
        <div class="avatar" aria-hidden="true" ${avatarStyle}></div>
        <div class="meta">
          <div class="name">${name} ${badge}</div>
          ${username ? `<div class="username">${username}</div>` : ''}
        </div>
      </div>
      <div class="post-content">${p.type==='story'
        ? p.content.replace(/\n/g,'<br>')
        : clip(p.content, 600)}</div>
      ${photo}
      ${commentsRow}
      ${reactionBtn}
    </li>
  `;
}



function addQuickComment(postId){
  const p = state.posts.find(p=>p.id===postId);
  if(!p) return;
  // –ù–∞—Ö–æ–¥–∏–º –ø—Ä–æ—Ñ–∏–ª—å —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞ –≤ characters
  const who = state.characters.find(c => c.id === state.activePlayerId);
  if (!who) return;

  const txt = prompt('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:');
  if(!txt) return;
  p.comments.push({ id:uid('c'), from: who.id, text: txt, at: nowIso() });
  save();
  renderFeed();
}

// === CHARACTER PROFILE ===
let currentProfileCharId = null;
let isEditingBio = false;

function relationLabelFromValue(v){
  if (v >= 85) return '–¥—É—à–µ–≤–Ω–∞—è –±–ª–∏–∑–æ—Å—Ç—å';
  if (v >= 70) return '–±–ª–∏–∑–∫–∏–µ —Å–æ—é–∑–Ω–∏–∫–∏';
  if (v >= 50) return '–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è —Å–≤—è–∑—å';
  if (v >= 30) return '–Ω–∞—Ç—è–Ω—É—Ç–æ–µ –æ–±—â–µ–Ω–∏–µ';
  return '—Ä–∞–∑–ª–∞–¥ –∏ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ';
}

function openCharacterProfile(charId){
  currentProfileCharId = charId;
  isEditingBio = false;
  renderCharacterProfile();
  setActiveView('character');
  // –ø–æ–ø—Ä–æ—Å–∏–º –ò–ò —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é –º—ã—Å–ª—å
  updateProfileThoughtWithAI(charId);
}

async function aiGenerateRelationTitle(char, player, approvalNow, lastDelta){
  const prompt = `
–¢—ã –ø—Ä–∏–¥—É–º—ã–≤–∞–µ—à—å —ë–º–∫–∏–µ, –¥–µ—Ä–∑–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –æ—Ç–Ω–æ—à–µ–Ω–∏–π –º–µ–∂–¥—É –¥–≤—É–º—è –≤—ã–º—ã—à–ª–µ–Ω–Ω—ã–º–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏.
–î–∞–π –û–î–ù–£ —Ñ—Ä–∞–∑—É (3‚Äì7 —Å–ª–æ–≤) –ø–æ-—Ä—É—Å—Å–∫–∏, –±–µ–∑ –∫–∞–≤—ã—á–µ–∫, –±–µ–∑ —Ç–æ—á–µ–∫ –≤ –∫–æ–Ω—Ü–µ.

–ö–æ–Ω—Ç–µ–∫—Å—Ç:
- –ü–µ—Ä—Å–æ–Ω–∞–∂ A: ${char.name} (–¢–æ–Ω: ${char.tone})
- –ü–µ—Ä—Å–æ–Ω–∞–∂ B: ${player.name}
- –¢–µ–∫—É—â–µ–µ —Å–±–ª–∏–∂–µ–Ω–∏–µ (0‚Äì100): ${Math.round(approvalNow)}
- –ü–æ—Å–ª–µ–¥–Ω—è—è –¥–∏–Ω–∞–º–∏–∫–∞ (–¥–µ–ª—å—Ç–∞): ${lastDelta > 0 ? '+'+lastDelta : lastDelta}

–ö–ê–ù–û–ù –ü–ï–†–°–û–ù–ê–ñ–ê A (–¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞):
${char.bio}

–ü—Ä–∏–º–µ—Ä—ã —Å—Ç–∏–ª—è:
- –±—ã–≤—à–∏–µ –≤–æ–∑–ª—é–±–ª–µ–Ω–Ω—ã–µ —Å —à–∞–Ω—Å–æ–º –Ω–∞ –≤–æ—Å—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
- –ª—É—á—à–∏–µ –¥—Ä—É–∑—å—è –¥–æ –∫–æ–Ω—Ü–∞ –∂–∏–∑–Ω–∏
- —Å–µ–∫—Å—É–∞–ª—å–Ω—ã–µ –ø–∞—Ä—Ç–Ω—ë—Ä—ã —Å –Ω–∞–¥–µ–∂–¥–æ–π –Ω–∞ –±–æ–ª—å—à–µ–µ
- —Å–æ—é–∑–Ω–∏–∫–∏ –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –Ω–æ –Ω–µ –ø–æ —Å–µ—Ä–¥—Ü—É

–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ —Å–∞–º –∑–∞–≥–æ–ª–æ–≤–æ–∫.`;
  const txt = await askAI(prompt);
  const cleaned = (txt||'').replace(/[¬´¬ª"]/g,'').trim();
  if (!cleaned) {
    // –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî –ø–æ —à–∫–∞–ª–µ
    return relationLabelFromValue(approvalNow);
  }
  return cleaned;
}

async function updateProfileThoughtWithAI(charId){
  // –ù–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –º—ã—Å–ª–∏ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–µ–π –∏–≥—Ä–æ–∫–æ–≤
  if (isPlayerId(charId)) return;

  const c = state.characters.find(x=>x.id===charId);
  if (!c) return;
  const key = state.activePlayerId;

  // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å–≤–æ–π—Å—Ç–≤–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  if (!c.profileThought) c.profileThought = {};

  // –µ—Å–ª–∏ –º—ã—Å–ª—å —É–∂–µ –µ—Å—Ç—å ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞–µ–º (—á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∞—Ç–∏—Ç—å –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏)
  if (c.profileThought[key]) return;

  const text = await aiGenerateProfileThought(c);
  
  // –ï—Å–ª–∏ –ò–ò –≤–µ—Ä–Ω—É–ª null (–æ—à–∏–±–∫–∞), –º—ã –ø—Ä–æ—Å—Ç–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º –º—ã—Å–ª—å
  if (!text) return; 
  
  c.profileThought[key] = text;
  save();

  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å–µ –µ—â–µ —Å–º–æ—Ç—Ä–∏—Ç —ç—Ç–æ—Ç –ø—Ä–æ—Ñ–∏–ª—å, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
  if (currentProfileCharId === charId){
    renderCharacterProfile();
  }
}

function renderCharacterProfile(){
  if (!currentProfileCharId) return;
  const me = currentPlayer();
  
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ characters, —Ç–∞–∫ –∫–∞–∫ —Ç–∞–º —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–±–∏–æ, –∞–≤–∞—Ç–∞—Ä—ã, –æ—Ç–Ω–æ—à–µ–Ω–∏—è)
  let c = state.characters.find(x=>x.id===currentProfileCharId);

  if (!c) return;
  const box = $('#characterView');

  // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —É –æ–±—ä–µ–∫—Ç–∞ –µ—Å—Ç—å –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è
  if (!c.approval) c.approval = {};
  if (!c.profileThought) c.profileThought = {};
  if (!c.relationTitles) c.relationTitles = {};

  const appr = (c.approval?.[state.activePlayerId] ?? 50);

  // 3-–π —Å–ª–æ–π: –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–π
  const relTitle = c.relationTitles?.[state.activePlayerId] || relationLabelFromValue(appr);

  // 2-–π —Å–ª–æ–π: –º—ã—Å–ª—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –æ –∏–≥—Ä–æ–∫–µ
  const profileThought = c.profileThought?.[state.activePlayerId] || '';

  const username = c.username || '@username';
  const bio = c.bio || '–û–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –ø–æ–∫–∞ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ.';
  const avatarImg = c.avatar ? `<img src="${c.avatar}" alt="${c.name}">` : '';

  const editBlock = isEditingBio
    ? `<textarea id="charBioEdit" class="char-bio-edit" rows="6"
        placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞, –µ–≥–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä, —Ç—Ä–∞–≤–º—ã, –æ—Ç–Ω–æ—à–µ–Ω–∏—è, —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏ —Ç.–ø.">${bio}</textarea>`
    : '';

  const isOwnProfile = (c.id === state.activePlayerId);
  
  let relationBlockHtml = '';
  if (!isOwnProfile) {
    relationBlockHtml = `
    <div class="char-rel-block">
      <div class="char-rel-label-row">
        <span>–°–≤—è–∑—å —Å ${me.name}</span>
        <span><strong>${Math.round(appr)}%</strong></span>
      </div>
      <div class="char-rel-bar">
        <span style="width:${clamp(appr,0,100)}%"></span>
      </div>
      <div class="char-rel-title">
        ${relTitle}
      </div>
      <div class="char-rel-thought">
        ${profileThought || '–ü–æ–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂ –º–æ–ª—á–∏—Ç –∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–±–ª—é–¥–∞–µ—Ç –∑–∞ —Ç–æ–±–æ–π.'}
      </div>
    </div>
    `;
  }

  const actions = isEditingBio
    ? `
      <button class="primary" onclick="saveCharacterBio()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ</button>
      <button class="secondary" onclick="cancelEditBio()">–û—Ç–º–µ–Ω–∞</button>
      ${!isOwnProfile ? `<button class="ghost" onclick="openDm('${c.id}')">–ü–µ—Ä–µ–π—Ç–∏ –≤ –õ–°</button>` : ''}
      <button class="ghost" onclick="setActiveView('relations')">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</button>
    `
    : `
      <button class="secondary" onclick="startEditBio()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ</button>
      ${!isOwnProfile ? `<button class="secondary" onclick="openDm('${c.id}')">–ü–µ—Ä–µ–π—Ç–∏ –≤ –õ–°</button>` : ''}
      <button class="ghost" onclick="setActiveView('relations')">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</button>
    `;

  box.innerHTML = `
    <div class="char-cover"></div>
    <div class="char-header">
      <div class="char-header-top">
        <div class="char-avatar" onclick="selectCharacterAvatar()">
          ${avatarImg}
        </div>
        <div>
          <div class="char-name">${c.name}</div>
          <div class="char-username">${username}</div>
        </div>
      </div>

      <button class="ghost char-avatar-btn" onclick="selectCharacterAvatar()">
        –ò–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä
      </button>

      <div class="char-bio">
        ${isEditingBio ? '' : bio.replace(/\n/g,'<br>')}
      </div>

      ${editBlock}
      
      ${relationBlockHtml} <div class="char-actions-row">
        ${actions}
      </div>

      <input id="charAvatarInput" type="file" accept="image/*" hidden />
    </div>
  `;

  // —Ñ–∞–π–ª –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞
  const avatarInput = document.getElementById('charAvatarInput');
  if (avatarInput) {
    avatarInput.onchange = handleAvatarFile;
  }
}


function saveCharacterBio(){
  if (!currentProfileCharId) return;
  // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ characters
  let c = state.characters.find(x=>x.id===currentProfileCharId);

  if (!c) return;
  const ta = document.getElementById('charBioEdit');
  if (!ta) return;
  c.bio = ta.value.trim();
  save();
  isEditingBio = false;
  renderCharacterProfile();
}
function startEditBio(){
  isEditingBio = true;
  renderCharacterProfile();
}

function cancelEditBio(){
  isEditingBio = false;
  renderCharacterProfile();
}

function selectCharacterAvatar(){
  const input = document.getElementById('charAvatarInput');
  if (input) input.click();
}

function handleAvatarFile(e){
  const file = e.target.files && e.target.files[0];
  if (!file || !currentProfileCharId) return;

  const reader = new FileReader();
  reader.onload = () => {
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ characters
    let c = state.characters.find(x => x.id === currentProfileCharId);
    
    if (!c) return;
    c.avatar = reader.result;       // dataURL
    save();
    renderCharacterProfile();       // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
    renderFeed(); // –û–±–Ω–æ–≤–ª—è–µ–º –ª–µ–Ω—Ç—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –Ω–æ–≤—ã–π –∞–≤–∞—Ç–∞—Ä
  };
  reader.readAsDataURL(file);
}


// === –æ—Ç–Ω–æ—à–µ–Ω–∏—è ===
function renderRelations(){
  const box = $('#relationsList');
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è —Ç–µ–∫—É—â–∏–º –∞–∫—Ç–∏–≤–Ω—ã–º –∏–≥—Ä–æ–∫–æ–º
  box.innerHTML = state.characters.filter(c => c.id !== state.activePlayerId).map(c=>{
    const appr = (c.approval[state.activePlayerId] ?? 50);
    const thought = c.lastThought ? clip(c.lastThought, 180) : '‚Äî';

    // –ê–≤–∞—Ç–∞—Ä
    let avatarStyle = '';
    if (c.avatar) {
        avatarStyle = `style="background-image: url('${c.avatar}');"`;
    }

    return `
      <div class="rel-card" onclick="openCharacterProfile('${c.id}')">
        <div class="rel-top">
          <div class="avatar" ${avatarStyle}></div>
          <div>
            <div class="rel-name">${c.name}</div>
            <div class="username">${c.username}</div>
          </div>
        </div>
        <div class="progress"><span style="width:${appr}%"></span></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:.4rem;">
          <div class="muted">–£—Ä–æ–≤–µ–Ω—å: ${Math.round(appr)}%</div>
          <div class="rel-actions">
            <button class="secondary" onclick="event.stopPropagation(); openDm('${c.id}')">–õ–°</button>
          </div>
        </div>
        <div class="rel-thought">–ü–æ—Å–ª–µ–¥–Ω—è—è —Ä–µ–∞–∫—Ü–∏—è: ${thought}</div>
      </div>
    `;
  }).join('');
}

// === —Å–æ–∑–¥–∞–Ω–∏–µ –æ–±—ã—á–Ω–æ–≥–æ –ø–æ—Å—Ç–∞ ===
function setupComposeSocial(){
  
  $('#composePhoto').addEventListener('change', (e) => {
     const file = e.target.files[0];
     if(file){
       const reader = new FileReader();
       reader.onload = (ev) => {
         $('#composePhotoPreview').innerHTML = `<img src="${ev.target.result}" alt="preview">`;
       };
       reader.readAsDataURL(file);
     } else {
       $('#composePhotoPreview').innerHTML = '';
     }
  });

  // –ø—É–±–ª–∏–∫–∞—Ü–∏—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ—Å—Ç–∞
  const btn = $('#publishSocialBtn');
  
  btn.onclick = async ()=>{
    const content   = $('#composeText').value.trim();
    const photoData = $('#composePhotoPreview img')?.getAttribute('src') || null;

    if (!content && !photoData){
      alert('–ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏ —Ñ–æ—Ç–æ');
      return;
    }

    // 1. –ü–û–ö–ê–ó–´–í–ê–ï–ú –ó–ê–ì–†–£–ó–ö–£
    btn.classList.add('loading');

    const p = postObj({
      type:'social',
      // –ê–≤—Ç–æ—Ä –ø–æ—Å—Ç–∞ - —ç—Ç–æ –∏–≥—Ä–æ–∫, –Ω–æ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ ID, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å ID –≤ characters
      authorType:'character', 
      authorId: state.activePlayerId,
      content,
      relatedCharacters: [],
      photoData
    });

    state.posts.push(p);
    
    // –°—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ª–µ–Ω—Ç—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å—Ç
    save();
    renderFeed();
    setActiveView('feed');

    try {
      // 2. –ñ–î–ï–ú –ó–ê–í–ï–†–®–ï–ù–ò–Ø –†–ï–ê–ö–¶–ò–ô (–ò–ò –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∑–¥–µ—Å—å)
      await applyReactionsAndShowModal(p, false);
      // –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ—Ç–≤–µ—Ç–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ –º–∏—Ä–∞
      triggerNpcPostGeneration(p);
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–æ—Å—Ç–∞ (social):", e);
      alert("–ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω, –Ω–æ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∞–∫—Ü–∏–π (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ API).");
    } finally {
      // 3. –£–ë–ò–†–ê–ï–ú –ó–ê–ì–†–£–ó–ö–£ (–≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ)
      btn.classList.remove('loading');
    }

    // –æ—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    $('#composeText').value = '';
    $('#composePhoto').value = '';
    $('#composePhotoPreview').innerHTML = '';
  };
}

// === —Å—é–∂–µ—Ç–Ω—ã–π –ø–æ—Å—Ç ===

// (–≠—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω—É–∂–Ω—ã –¥–ª—è –∏–¥–µ–π)
let storyIdeas = ['–ù–∞–∂–º–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å –∏–¥–µ–∏¬ª'];
let ideaIdx = 0;
                
function setupComposeStory() {
  // --- –õ–æ–≥–∏–∫–∞ ¬´–ò–¥–µ–π¬ª (–ó–∞–≥–ª—É—à–∫–∏) ---
  storyIdeas = [
    "–°—é–∂–µ—Ç–Ω–∞—è –∏–¥–µ—è 1: –ü–µ—Ä—Å–æ–Ω–∞–∂ –ê –Ω–∞—Ö–æ–¥–∏—Ç...",
    "–°—é–∂–µ—Ç–Ω–∞—è –∏–¥–µ—è 2: –°–ª—É—á–∞–π–Ω–∞—è –≤—Å—Ç—Ä–µ—á–∞ –≤...",
    "–°—é–∂–µ—Ç–Ω–∞—è –∏–¥–µ—è 3: –°—Ç–∞—Ä—ã–π —Å–µ–∫—Ä–µ—Ç..."
  ];
  ideaIdx = 0;
  paintIdea();

  $('#ideaPrev').onclick = () => {
    ideaIdx = (ideaIdx - 1 + storyIdeas.length) % storyIdeas.length;
    paintIdea();
  };
  $('#ideaNext').onclick = () => {
    ideaIdx = (ideaIdx + 1) % storyIdeas.length;
    paintIdea();
  };
  $('#ideaRefresh').onclick = async () => {
    // (TODO: AI generation logic for ideas)
    alert("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–¥–µ–π (–ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)");
  };
  $('#ideaUse').onclick = () => {
    $('#storyText').value = storyIdeas[ideaIdx] || '';
  };
  // ---
                
  // --- –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ ¬´–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å¬ª ---
  const btn = $('#publishStoryBtn');
                
  btn.onclick = async ()=>{
    const text = $('#storyText').value.trim();
    if(!text){
      alert('–ù–∞–ø–∏—à–∏ —Å—é–∂–µ—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–ª–∏ –≤—Å—Ç–∞–≤—å –∏–¥–µ—é');
      return;
    }

    // 1. –ü–û–ö–ê–ó–´–í–ê–ï–ú –ó–ê–ì–†–£–ó–ö–£
    btn.classList.add('loading');
  
    const p = postObj({
      type:'story',
      // –ê–≤—Ç–æ—Ä –ø–æ—Å—Ç–∞ - —ç—Ç–æ –∏–≥—Ä–æ–∫, –Ω–æ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ ID, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å ID –≤ characters
      authorType:'character',
      authorId:state.activePlayerId,
      content: text,
      relatedCharacters: []
    });

    state.posts.push(p);

    // –°—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ª–µ–Ω—Ç—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å—Ç
    save();
    renderFeed();
    setActiveView('feed');

    try {
      // 2. –ñ–î–ï–ú –ó–ê–í–ï–†–®–ï–ù–ò–Ø –†–ï–ê–ö–¶–ò–ô (–ò–ò –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∑–¥–µ—Å—å)
      await applyReactionsAndShowModal(p, true);
      // –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ—Ç–≤–µ—Ç–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ –º–∏—Ä–∞
      triggerNpcPostGeneration(p);
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–æ—Å—Ç–∞ (story):", e);
      alert("–ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω, –Ω–æ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∞–∫—Ü–∏–π (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ API).");
    } finally {
      // 3. –£–ë–ò–†–ê–ï–ú –ó–ê–ì–†–£–ó–ö–£
      btn.classList.remove('loading');
    }

    $('#storyText').value = '';
  };
}

function paintIdea(){
  $('#ideaText').textContent = storyIdeas[ideaIdx] || '–ò–¥–µ–π –ø–æ–∫–∞ –Ω–µ—Ç ‚Äî –Ω–∞–∂–º–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å –∏–¥–µ–∏¬ª';
}
function threadKey(charId, playerId=state.activePlayerId){
  // –ö–ª—é—á –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –¥–ª—è –ø–∞—Ä—ã, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –ø–æ—Ä—è–¥–∫–∞ ID
  return [charId, playerId].sort().join('_');
}

function syncDmSelectors(){
  const sel = $('#dmSelect');
  const currentValue = sel.value;
  
  // –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ - –≤—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏, –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
  const contacts = state.characters.filter(c => c.id !== state.activePlayerId);
  
  sel.innerHTML = contacts.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  
  // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏–Ω–∞—á–µ –≤—ã–±–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ
  if(currentValue && contacts.some(c => c.id === currentValue)) {
      sel.value = currentValue;
  } else if (contacts.length > 0) {
      sel.value = contacts[0].id;
  } else {
      sel.value = '';
  }

  const current = state.characters.find(c=>c.id===sel.value);
  $('#dmTitle').textContent = '–õ–° ¬∑ ' + (current?.name || '');
  
  if (sel.value) {
    renderDmThread(sel.value);
  }
}

function openDm(charId){
  setActiveView('dm');
  // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –ø–µ—Ä—Å–æ–Ω–∞–∂ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ, –ø—Ä–µ–∂–¥–µ —á–µ–º –≤—ã–±–∏—Ä–∞—Ç—å
  if ($('#dmSelect option[value="' + charId + '"]').length > 0) {
      $('#dmSelect').value = charId;
  }
  const c = state.characters.find(x=>x.id===charId);
  $('#dmTitle').textContent = '–õ–° ¬∑ ' + (c?.name || '');
  renderDmThread(charId);
}

function renderDmThread(charId){
  const key = threadKey(charId);
  const list = state.dms[key] || [];
  const box = $('#dmThread');
  box.innerHTML = list.map(m=>
    `<div class="bubble ${m.from===state.activePlayerId?'me':'them'}">${m.text}</div>`
  ).join('');
  box.scrollTop = box.scrollHeight;
}

function pushMessage(charId, from, text){
  const key = threadKey(charId);
  if(!state.dms[key]) state.dms[key]=[];
  state.dms[key].push({ from, text, at:nowIso() });
  save();
  if($('#view-dm').classList.contains('active') && $('#dmSelect').value===charId){
    renderDmThread(charId);
  }
}

function setupDm(){
  $('#dmSelect').addEventListener('change', (e)=>{
    const id = e.target.value;
    const c = state.characters.find(x=>x.id===id);
    $('#dmTitle').textContent = '–õ–° ¬∑ ' + (c?.name || '');
    renderDmThread(id);
  });

  $('#dmSend').onclick = async ()=>{
    const charId = $('#dmSelect').value;
    if (!charId) return;
    const text = $('#dmInput').value.trim();
    if (!text) return;

    pushMessage(charId, state.activePlayerId, text);
    $('#dmInput').value = '';

    if ($('#dmAutoToggle').checked) {
      // –î–æ–±–∞–≤–∏–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ –æ—Ç–≤–µ—Ç–æ–º AI –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏
      setTimeout(async () => {
          await aiReplyToDm(charId);
      }, randint(1000, 3000));
    }
  };

  // –î–æ–±–∞–≤–∏–º –æ—Ç–ø—Ä–∞–≤–∫—É –ø–æ Enter
  $('#dmInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏
      $('#dmSend').click();
    }
  });
}

// ===================================================================
// === –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ù–´–ô –ö–û–î: AI-—Ä–µ–∞–∫—Ü–∏–∏, –º—ã—Å–ª–∏ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤ ===
// ===================================================================


// --- 1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∞–∫—Ü–∏–π (–ú—ã—Å–ª–∏ –æ –ø–æ—Å—Ç–µ) ---

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥–ª—É–±–æ–∫–æ–π —Ä–µ–∞–∫—Ü–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –Ω–∞ –ø–æ—Å—Ç (–í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–û)
async function aiGenerateReactionText(char, player, post, delta, isStory) {
  // –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –¥–µ–ª—å—Ç—ã
  const sentiment = delta > 0 ? '–ø–æ–∑–∏—Ç–∏–≤–Ω–∞—è' : (delta < 0 ? '–Ω–µ–≥–∞—Ç–∏–≤–Ω–∞—è' : '–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è');
  const intensity = Math.abs(delta) > 2.5 ? '—Å–∏–ª—å–Ω–∞—è' : '—É–º–µ—Ä–µ–Ω–Ω–∞—è';
  const relationsSummary = buildRelationsSummary(char);

  const prompt = `
–¢—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å —Ä–µ–∞–∫—Ü–∏—é –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ ${char.name} –Ω–∞ –ø–æ—Å—Ç –∏–≥—Ä–æ–∫–∞ ${player.name}.

–ö–û–ù–¢–ï–ö–°–¢ –ü–ï–†–°–û–ù–ê–ñ–ê (${char.name}):
- –ë–∏–æ: ${char.bio}
- –¢–æ–Ω: ${char.tone}
- –°–≤—è–∑–∏ (–ö–ê–ù–û–ù):
${relationsSummary}

–ü–û–°–¢ –ò–ì–†–û–ö–ê (${player.name}):
–¢–∏–ø: ${isStory ? '–°—é–∂–µ—Ç–Ω—ã–π (–≤–∞–∂–Ω—ã–π)' : '–°–æ—Ü–∏–∞–ª—å–Ω—ã–π (–æ–±—ã—á–Ω—ã–π)'}
–¢–µ–∫—Å—Ç: "${post.content}"

–†–ï–ê–ö–¶–ò–Ø (${char.name}):
–°–∏—Å—Ç–µ–º–∞ –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∞, —á—Ç–æ —Ä–µ–∞–∫—Ü–∏—è ${sentiment} –∏ ${intensity} (–¥–µ–ª—å—Ç–∞ ${delta.toFixed(2)}).

–ó–ê–î–ê–ß–ê:
–ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫—É—é –í–ù–£–¢–†–ï–ù–ù–Æ–Æ –ú–´–°–õ–¨ (1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –æ—Ç –ª–∏—Ü–∞ ${char.name}, –∫–æ—Ç–æ—Ä–∞—è –æ—Ç—Ä–∞–∂–∞–µ—Ç —ç—Ç—É —Ä–µ–∞–∫—Ü–∏—é –Ω–∞ –¥–∞–Ω–Ω—ã–π –ø–æ—Å—Ç.
–ú—ã—Å–ª—å –î–û–õ–ñ–ù–ê —Å—Ç—Ä–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä—É, –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–º —Å–≤—è–∑—è–º –∏ –≤—ã—á–∏—Å–ª–µ–Ω–Ω–æ–π –¥–µ–ª—å—Ç–µ.

–§–æ—Ä–º–∞—Ç: –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –º—ã—Å–ª–∏ –ø–æ-—Ä—É—Å—Å–∫–∏, –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞, –±–µ–∑ –∫–∞–≤—ã—á–µ–∫.
`;

  const aiText = await askAI(prompt);

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–µ –ø—É—Å—Ç–æ–π –∏ –Ω–µ —Å–ª–∏—à–∫–æ–º –æ–±—â–∏–π
  if (aiText && aiText.length > 5) {
      return aiText;
  }

  // –ï—Å–ª–∏ AI –Ω–µ —Å–ø—Ä–∞–≤–∏–ª—Å—è (API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –æ—Ç–≤–µ—Ç –ø–ª–æ—Ö–æ–π), –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É
  console.warn(`AI fallback used for reaction: ${char.name}. AI response: ${aiText}`);
  return generateThought(char, post, delta);
}

// --- 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º—ã—Å–ª–µ–π –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è ---

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º—ã—Å–ª–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –æ —Ç–µ–∫—É—â–µ–º –∏–≥—Ä–æ–∫–µ (–¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è) (–í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–û)
async function aiGenerateProfileThought(char) {
  const player = state.players.find(p => p.id === state.activePlayerId);
  const relationsSummary = buildRelationsSummary(char);
  const approval = char.approval[state.activePlayerId] ?? 50;

  // –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ–¥–∞–≤–Ω–∏—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π (–õ–°)
  const dmKey = threadKey(char.id);
  const recentDms = (state.dms[dmKey] || [])
      .slice(-3)
      .map(m => {
          const speaker = m.from === char.id ? char.name : player.name;
          return `${speaker}: ${m.text}`;
      })
      .join('\n');

  const prompt = `
–¢—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å —Ç–µ–∫—É—â–µ–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ ${char.name} –∫ –∏–≥—Ä–æ–∫—É ${player.name}.

–ö–û–ù–¢–ï–ö–°–¢ –ü–ï–†–°–û–ù–ê–ñ–ê (${char.name}):
- –ë–∏–æ: ${char.bio}
- –¢–æ–Ω: ${char.tone}
- –°–≤—è–∑–∏ (–ö–ê–ù–û–ù):
${relationsSummary}

–û–¢–ù–û–®–ï–ù–ò–ï –ö –ò–ì–†–û–ö–£ (${player.name}):
–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –±–ª–∏–∑–æ—Å—Ç–∏: ${Math.round(approval)} –∏–∑ 100.

–ù–ï–î–ê–í–ù–ò–ï –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–Ø (–ü–µ—Ä–µ–ø–∏—Å–∫–∞):
${recentDms || '–ù–µ–¥–∞–≤–Ω–æ –Ω–µ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–ª–∏—Å—å.'}

–ó–ê–î–ê–ß–ê:
–ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫—É—é, –∞–∫—Ç—É–∞–ª—å–Ω—É—é –º—ã—Å–ª—å (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –æ—Ç –ª–∏—Ü–∞ ${char.name} –æ ${player.name}.
–≠—Ç–∞ –º—ã—Å–ª—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ –∫–∞–∫ —Ç–µ–∫—É—â–µ–µ –º–Ω–µ–Ω–∏–µ –æ–± –∏–≥—Ä–æ–∫–µ.
–ú—ã—Å–ª—å –¥–æ–ª–∂–Ω–∞ —Å—Ç—Ä–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä—É, –∫–∞–Ω–æ–Ω—É, —Ç–µ–∫—É—â–µ–º—É —É—Ä–æ–≤–Ω—é –±–ª–∏–∑–æ—Å—Ç–∏ –∏ –Ω–µ–¥–∞–≤–Ω–∏–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è–º.

–§–æ—Ä–º–∞—Ç: –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –º—ã—Å–ª–∏ –ø–æ-—Ä—É—Å—Å–∫–∏, –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞, –±–µ–∑ –∫–∞–≤—ã—á–µ–∫.
`;

  const aiText = await askAI(prompt);

  if (aiText && aiText.length > 5) {
      return aiText;
  }
  
  console.warn(`AI failed to generate profile thought for: ${char.name}.`);
  return "–ü–æ–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂ –º–æ–ª—á–∏—Ç –∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–±–ª—é–¥–∞–µ—Ç –∑–∞ —Ç–æ–±–æ–π."; // Fallback
}


// --- 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤ –º–∏—Ä–∞ (NPC –∏ –ü–µ—Ä—Å–æ–Ω–∞–∂–∏) ---

// –°–æ–∑–¥–∞–Ω–∏–µ "—Å–Ω–∏–º–∫–∞ –º–∏—Ä–∞" - –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ò–ò (–í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–û)
function worldSnapshot(lookback=10, playerPost=null) {
  // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –ø–æ—Å—Ç–æ–≤
  const recent = state.posts.slice().sort((a,b)=>b.createdAt.localeCompare(a.createdAt)).slice(0, lookback);
  
  const lines = recent.map(p => {
      // –ï—Å–ª–∏ —ç—Ç–æ —Ç–æ—Ç —Å–∞–º—ã–π –ø–æ—Å—Ç –∏–≥—Ä–æ–∫–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –º—ã —Ä–µ–∞–≥–∏—Ä—É–µ–º, –ø–æ–º–µ—á–∞–µ–º –µ–≥–æ –æ—Å–æ–±–æ
      const prefix = (p.id === playerPost?.id) ? '–ù–û–í–´–ô –ü–û–°–¢ (–°–ï–ô–ß–ê–°): ' : '';
      return `${prefix}${authorName(p)} (${p.type}): ${clip(p.content, 150)}`;
  });

  return lines.join('\n') || '–í –ª–µ–Ω—Ç–µ –ø–æ–∫–∞ —Ç–∏—Ö–æ.';
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–∞ –æ—Ç –ö–ª—é—á–µ–≤–æ–≥–æ –ü–µ—Ä—Å–æ–Ω–∞–∂–∞ (–í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–û)
async function aiGenerateAmbientCharacterTweet(char, snapshot) {
  const relationsSummary = buildRelationsSummary(char);

  const prompt = `
–¢—ã ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–∂ ${char.name} (${char.username}) –≤ –≤—ã–º—ã—à–ª–µ–Ω–Ω–æ–π —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏. 
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞–ø–∏—Å–∞—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–π –ø–æ—Å—Ç (—Ç–≤–∏—Ç) –≤ –ª–µ–Ω—Ç—É.

–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–ï–†–°–û–ù–ê–ñ–ï (${char.name}):
- –¢–æ–Ω: ${char.tone}
- –ë–∏–æ–≥—Ä–∞—Ñ–∏—è: ${char.bio}
- –°–≤—è–∑–∏ –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è (–ö–ê–ù–û–ù):
${relationsSummary}

–¢–ï–ö–£–©–ê–Ø –°–ò–¢–£–ê–¶–ò–Ø –í –ú–ò–†–ï (–õ–ï–ù–¢–ê):
${snapshot}

–ó–ê–î–ê–ß–ê:
–ù–∞–ø–∏—à–∏ –û–î–ò–ù –∫–æ—Ä–æ—Ç–∫–∏–π –ø–æ—Å—Ç (1-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –¥–æ 280 —Å–∏–º–≤–æ–ª–æ–≤) –æ—Ç –ª–∏—Ü–∞ ${char.name}.
–ü–æ—Å—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ç–≤–æ–µ–º—É —Ö–∞—Ä–∞–∫—Ç–µ—Ä—É –∏ —Å–≤—è–∑—è–º.
–¢–µ–º–∞ –ø–æ—Å—Ç–∞:
1. (–ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ) –†–µ–∞–∫—Ü–∏—è –Ω–∞ –Ω–µ–¥–∞–≤–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –≤ –ª–µ–Ω—Ç–µ (–æ—Å–æ–±–µ–Ω–Ω–æ –Ω–∞ "–ù–û–í–´–ô –ü–û–°–¢").
2. –ò–õ–ò –ú—ã—Å–ª—å –æ –∫–æ–º-—Ç–æ –∏–∑ —Ç–≤–æ–∏—Ö —Å–≤—è–∑–µ–π (—Å–æ–±–ª—é–¥–∞—è –∫–∞–Ω–æ–Ω).
3. –ò–õ–ò –ß—Ç–æ-—Ç–æ –æ —Ç–≤–æ–µ–π –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π –∂–∏–∑–Ω–∏, –∏—Å—Ö–æ–¥—è –∏–∑ –±–∏–æ–≥—Ä–∞—Ñ–∏–∏.

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞, –ø–æ-—Ä—É—Å—Å–∫–∏, –±–µ–∑ –∫–∞–≤—ã—á–µ–∫, –±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π.
`;

  const aiText = await askAI(prompt);
  return (aiText && aiText.length > 5) ? aiText : null;
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–∞ –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ –ñ–∏—Ç–µ–ª—è (NPC) (–í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–û)
async function aiGenerateNpcWorldTweet(npc, snapshot) {
    const prompt = `
–¢—ã ‚Äî –æ–±—ã—á–Ω—ã–π –∂–∏—Ç–µ–ª—å –≥–æ—Ä–æ–¥–∞ (${npc.username}, –∏–º—è: ${npc.name}). –¢–≤–æ–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã: ${npc.topic}. –¢–≤–æ–π —Ç–æ–Ω: ${npc.tone}.
–ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –ø–æ—Å—Ç (—Ç–≤–∏—Ç) –≤ —Å–æ—Ü–∏–∞–ª—å–Ω—É—é —Å–µ—Ç—å.

–¢–ï–ö–£–©–ê–Ø –°–ò–¢–£–ê–¶–ò–Ø –í –ú–ò–†–ï (–õ–ï–ù–¢–ê):
${snapshot}

–ó–ê–î–ê–ß–ê:
–ù–∞–ø–∏—à–∏ –û–î–ò–ù –∫–æ—Ä–æ—Ç–∫–∏–π –ø–æ—Å—Ç (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –¥–æ 150 —Å–∏–º–≤–æ–ª–æ–≤).
–¢–µ–º–∞ –ø–æ—Å—Ç–∞:
1. –†–µ–∞–∫—Ü–∏—è –Ω–∞ –Ω–µ–¥–∞–≤–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –≤ –ª–µ–Ω—Ç–µ (–æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ –æ–Ω–∏ –∫–∞—Å–∞—é—Ç—Å—è –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Å–µ–º–µ–π –ë–ª–µ–π–¥–º–æ—Ä/–ë–ª—ç–∫–≤–æ–ª–ª –∏–ª–∏ —Ç–≤–æ–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤).
2. –ò–õ–ò –ß—Ç–æ-—Ç–æ –æ–±—â–µ–µ –ø–æ —Ç–µ–º–µ —Ç–≤–æ–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ (${npc.topic}).

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞, –ø–æ-—Ä—É—Å—Å–∫–∏, –±–µ–∑ –∫–∞–≤—ã—á–µ–∫.
`;
    const aiText = await askAI(prompt);
    return (aiText && aiText.length > 5) ? aiText : null;
}

// –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è NPC (–µ—Å–ª–∏ AI –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª)
function fallbackNpcTweet(npc) {
    const templates = {
        horses: ['–õ–æ—à–∞–¥–∏ —Å–µ–≥–æ–¥–Ω—è –ø—Ä–µ–∫—Ä–∞—Å–Ω—ã.', '–ü–æ—Ä–∞ –Ω–∞ –∫–æ–Ω—é—à–Ω—é.'],
        music:  ['–ù–æ–≤—ã–π —Ç—Ä–µ–∫ —Å–ª—ã—à–∞–ª–∏?', '–ò—â—É –±–∏–ª–µ—Ç—ã –Ω–∞ –∫–æ–Ω—Ü–µ—Ä—Ç.'],
        gossip: ['–°–ª—ã—à–∞–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ –æ –∑–Ω–∞–º–µ–Ω–∏—Ç–æ—Å—Ç—è—Ö?', '–û–ø—è—Ç—å —Å–∫–∞–Ω–¥–∞–ª.'],
        default: ['–í—Å–µ–º –ø—Ä–∏–≤–µ—Ç.', '–•–æ—Ä–æ—à–∏–π –¥–µ–Ω—å.']
    };
    return choice(templates[npc.topic] || templates.default);
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–∞ –æ—Ç –ú–µ–¥–∏–∞ (Outlet) (–í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–û)
async function aiGenerateOutletPost(outlet, snapshot) {
    const style = outlet.outletType === 'news' ? '–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π, –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π.' : '–ö–ª–∏–∫–±–µ–π—Ç–Ω—ã–π, —Å–∫–∞–Ω–¥–∞–ª—å–Ω—ã–π.';

    const prompt = `
–¢—ã ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏–∑–¥–∞–Ω–∏—è "${outlet.name}". –¢–∏–ø: ${outlet.outletType}. –¢–µ–º–∞—Ç–∏–∫–∞: ${outlet.topic}.

–¢–ï–ö–£–©–ê–Ø –°–ò–¢–£–ê–¶–ò–Ø –í –ú–ò–†–ï (–õ–ï–ù–¢–ê –°–û–¶–°–ï–¢–ò):
${snapshot}

–ó–ê–î–ê–ß–ê:
–ù–∞–ø–∏—à–∏ –û–î–ò–ù –ø–æ—Å—Ç (–∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–æ–≤–æ—Å—Ç–∏) –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–µ–¥–∞–≤–Ω–∏—Ö —Å–æ–±—ã—Ç–∏–π –≤ –ª–µ–Ω—Ç–µ, –æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ –æ–Ω–∏ –∫–∞—Å–∞—é—Ç—Å—è –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Å–µ–º–µ–π (–ë–ª–µ–π–¥–º–æ—Ä, –ë–ª—ç–∫–≤–æ–ª–ª).
–°—Ç–∏–ª—å: ${style}
–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫, –ø–æ-—Ä—É—Å—Å–∫–∏, –±–µ–∑ –∫–∞–≤—ã—á–µ–∫. 1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.
`;
    const aiText = await askAI(prompt);
    return (aiText && aiText.length > 5) ? aiText : null;
}

// –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –ú–µ–¥–∏–∞
function fallbackOutletTweet(outlet) {
    if (outlet.outletType === 'news') {
        return '–ì–ª–∞–≤–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ –≥–æ—Ä–æ–¥–∞ –∫ —ç—Ç–æ–º—É —á–∞—Å—É.';
    } else {
        return '–®–û–ö! –í—Å—è –ø—Ä–∞–≤–¥–∞ –æ –∑–Ω–∞–º–µ–Ω–∏—Ç–æ—Å—Ç—è—Ö –≥–æ—Ä–æ–¥–∞!';
    }
}


// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–æ–Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞ (–í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–û)
async function aiGenerateNpcPost(playerPost=null) {
  const snapshot = worldSnapshot(10, playerPost);
  
  // –†–µ—à–∞–µ–º, –∫—Ç–æ –±—É–¥–µ—Ç –ø–∏—Å–∞—Ç—å –ø–æ—Å—Ç (–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å)
  const r = Math.random();
  let post = null;

  if (r < 0.5) {
      // 50% —à–∞–Ω—Å: –ö–ª—é—á–µ–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–∂ (–Ω–µ –∏–≥—Ä–æ–∫)
      const availableChars = state.characters.filter(c => !isPlayerId(c.id));
      if (availableChars.length > 0) {
          const char = choice(availableChars);
          const content = await aiGenerateAmbientCharacterTweet(char, snapshot);
          if (content) {
              post = postObj({
                  type: 'social',
                  authorType: 'character',
                  authorId: char.id,
                  content: content
              });
          }
      }
  } else if (r < 0.85) {
      // 35% —à–∞–Ω—Å: –û–±—ã—á–Ω—ã–π –∂–∏—Ç–µ–ª—å (NPC)
      const npc = choice(state.npcs);
      let content = await aiGenerateNpcWorldTweet(npc, snapshot);
      if (!content) {
          content = fallbackNpcTweet(npc);
      }
      post = postObj({
          type: 'social',
          authorType: 'npc',
          authorId: npc.id,
          content: content
      });
  } else {
      // 15% —à–∞–Ω—Å: –ú–µ–¥–∏–∞ (Outlet)
      const outlet = choice(state.outlets);
      let content = await aiGenerateOutletPost(outlet, snapshot);
      if (!content) {
          content = fallbackOutletTweet(outlet);
      }
      post = postObj({
          type: 'social',
          authorType: 'outlet',
          authorId: outlet.id,
          content: content
      });
  }

  if (post) {
      console.log(`–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –Ω–æ–≤—ã–π –ø–æ—Å—Ç –æ—Ç ${authorName(post)}`);
      state.posts.push(post);
      save();
      // –ï—Å–ª–∏ –º—ã –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –ª–µ–Ω—Ç—ã, –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –µ—ë
      if ($('#view-feed').classList.contains('active')) {
          renderFeed();
      }
  }
}

// –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞–µ—Ç ¬´–≤–¥–æ–≥–æ–Ω–∫—É¬ª –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø–æ—Å—Ç–æ–≤ –ø–æ—Å–ª–µ –¥–µ–π—Å—Ç–≤–∏—è –∏–≥—Ä–æ–∫–∞ (–í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–û)
async function triggerNpcPostGeneration(playerPost) {
  console.log("–ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤...");

  // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã (1 –∏–ª–∏ 2)
  const count = Math.random() < 0.7 ? 1 : 2;

  for (let i = 0; i < count; i++) {
      // –°–ª—É—á–∞–π–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π (–æ—Ç 5 –¥–æ 15 —Å–µ–∫—É–Ω–¥)
      const delay = randint(5000, 15000);
      await new Promise(resolve => setTimeout(resolve, delay));
      
      try {
          // –ü–µ—Ä–µ–¥–∞–µ–º –ø–æ—Å—Ç –∏–≥—Ä–æ–∫–∞ –∫–∞–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞
          await aiGenerateNpcPost(playerPost);
      } catch (e) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ–Ω–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ—Å—Ç–∞:", e);
      }
  }
  console.log("–§–æ–Ω–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.");
}

// ===================================================================
// === –ö–û–ù–ï–¶ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ù–û–ì–û –ö–û–î–ê ===
// ===================================================================


// === —Ä–µ–∞–∫—Ü–∏–∏ ===
let lastReactionPostId = null;

// –∫—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥ –¥–µ–ª—å—Ç—ã: +0.25%, -3%, +4.75%
function formatDelta(delta){
  const sign = delta > 0 ? '+' : (delta < 0 ? '‚àí' : '');
  const abs  = Math.abs(delta);
  // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º 2 –∑–Ω–∞–∫–∞ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
  return `${sign}${abs.toFixed(2)}%`;
}

async function applyReactionsAndShowModal(post, isStory){
  lastReactionPostId = post.id;
  const wrap = $('#modalReactions');

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –º–æ–¥–∞–ª–∫–µ
  wrap.innerHTML = '<div class="loader-dots"></div>';
  $('#reactionModal').classList.remove('hidden');

  // —Å—á–∏—Ç–∞–µ–º ¬´–≤ —Ñ–æ–Ω–µ¬ª (–ò–ò –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ computeReactions)
  const rxList = await computeReactions(post, isStory);

  // –ì–æ—Ç–æ–≤–∏–º –∫–æ–Ω—Ç–µ–Ω—Ç –º–æ–¥–∞–ª–∫–∏
  if(!rxList.length){
    wrap.innerHTML = `<p>–ù–∏–∫—Ç–æ –∏–∑ –∫–ª—é—á–µ–≤—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –Ω–µ –æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª (–∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å AI).</p>`;
  }else{
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Å–∏–ª–µ —Ä–µ–∞–∫—Ü–∏–∏
    rxList.sort((a, b) => Math.abs(b.delta) - Math.abs(a.delta));

    wrap.innerHTML = rxList.slice(0,5).map(rx=>{
      const c = state.characters.find(k=>k.id===rx.charId);
      const cls = rx.delta >= 0 ? 'pos' : 'neg';
      return `<div class="react-item">
        <div><strong>${c?.name||'?'}</strong>: ${rx.text}</div>
        <div class="delta ${cls}">${formatDelta(rx.delta)}</div>
      </div>`;
    }).join('');
    
    if (rxList.length > 5) {
        wrap.innerHTML += `<p class="hint">–ò –µ—â–µ ${rxList.length - 5} —Ä–µ–∞–∫—Ü–∏–π...</p>`;
    }
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –ª–µ–Ω—Ç—É, —á—Ç–æ–±—ã –ø–æ—è–≤–∏–ª–∞—Å—å –∫–Ω–æ–ø–∫–∞ "–†–µ–∞–∫—Ü–∏–∏" –Ω–∞ –ø–æ—Å—Ç–µ, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
  renderFeed();
}

// —Å—á–∏—Ç–∞–µ–º —Ä–µ–∞–∫—Ü–∏–∏ –∏ –º–µ–Ω—è–µ–º –æ—Ç–Ω–æ—à–µ–Ω–∏—è
async function computeReactions(post, isStory){
  const relevant = getRelevantCharacters(post);
  // –ù–∞—Ö–æ–¥–∏–º –æ–±—ä–µ–∫—Ç –∏–≥—Ä–æ–∫–∞ –≤ —Å–ø–∏—Å–∫–µ players
  const playerObj = state.players.find(p => p.id === state.activePlayerId);
  const out = [];

  console.log(`–ù–∞—á–∏–Ω–∞–µ–º —Ä–∞—Å—á–µ—Ç —Ä–µ–∞–∫—Ü–∏–π –¥–ª—è ${relevant.length} –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π...`);

  for (const c of relevant){
    const currentAppr = c.approval[state.activePlayerId] ?? 50;

    // === –†–ê–°–ß–ï–¢ –î–ï–õ–¨–¢–´ (–ú–µ—Ö–∞–Ω–∏–∫–∞ –∏–≥—Ä—ã, –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ===
    // –±–∞–∑–æ–≤–∞—è —Å–∏–ª–∞ —Ä–µ–∞–∫—Ü–∏–∏
    const base   = isStory ? 1.5 : 0.6;   // —Å—é–∂–µ—Ç–Ω—ã–µ —Å–∏–ª—å–Ω–µ–µ
    const spread = isStory ? 3.0 : 2.0;   // —Ä–∞–∑–±—Ä–æ—Å

    // bias –æ—Ç —Ç–µ–∫—É—â–µ–π –±–ª–∏–∑–æ—Å—Ç–∏
    const moodBias = (currentAppr - 50) / 50;

    let raw = base + spread * (Math.random() - 0.5) + moodBias;

    // –æ—á–µ–Ω—å —Å–ª–∞–±—ã–µ —Ä–µ–∞–∫—Ü–∏–∏ –ø—Ä–∏–≥–ª—É—à–∞–µ–º
    if (Math.abs(raw) < 0.3) raw = raw / 4;

    // –∏–Ω–æ–≥–¥–∞ –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∑–Ω–∞–∫
    if (Math.random() < 0.25) raw = -raw;

    // —à–∞–≥ 0.25, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ [-5;5]
    let delta = Math.round(raw * 4) / 4;
    delta = clamp(delta, -5, 5);
    
    if (Math.abs(delta) < 0.25) continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ª–∏—à–∫–æ–º —Å–ª–∞–±—ã–µ —Ä–µ–∞–∫—Ü–∏–∏

    // === –ì–ï–ù–ï–†–ê–¶–ò–Ø –¢–ï–ö–°–¢–ê –†–ï–ê–ö–¶–ò–ò (AI) ===
    // (–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é)
    const text = await aiGenerateReactionText(c, playerObj, post, delta, isStory);

    // === –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–ô ===
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –º—ã—Å–ª—å (lastThought)
    c.lastThought = text;

    // –ø—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è
    const newAppr = clamp(currentAppr + delta, 0, 100);
    c.approval[state.activePlayerId] = newAppr;
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –º—ã—Å–ª—å –≤ –ø—Ä–æ—Ñ–∏–ª–µ, —á—Ç–æ–±—ã –æ–Ω–∞ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∞—Å—å –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
    if (c.profileThought) {
        delete c.profileThought[state.activePlayerId];
    }


    // –ù–ê–ó–í–ê–ù–ò–ï –æ—Ç–Ω–æ—à–µ–Ω–∏–π ‚Äî —á–µ—Ä–µ–∑ –ò–ò (—Å —Ñ–æ–ª–ª–±—ç–∫–æ–º)
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –Ω–µ –±–ª–æ–∫–∏—Ä—É—è –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ —Ä–µ–∞–∫—Ü–∏–π
    aiGenerateRelationTitle(c, playerObj, newAppr, delta).then(title => {
        if (title) {
            if (!c.relationTitles) c.relationTitles = {};
            c.relationTitles[state.activePlayerId] = title;
            save(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
        }
    }).catch(e => {
       console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –¥–ª—è ${c.name}:`, e);
    });

    const rx = reactionObj(post.id, c.id, text, delta);
    state.reactions.push(rx);
    out.push(rx);
  }

  save();
  renderRelations(); // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∫–ª–∞–¥–∫—É –æ—Ç–Ω–æ—à–µ–Ω–∏–π
  return out;
}


function renderReactions(){
  const wrap = $('#reactionsList');
  const items = state.reactions
    .filter(r=>!lastReactionPostId || r.postId===lastReactionPostId)
    .slice().sort((a,b)=>b.at.localeCompare(a.at));

  if(!items.length){
    wrap.innerHTML = `<p class="hint">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∞–∫—Ü–∏–π.</p>`;
    return;
  }

  // –î–æ–±–∞–≤–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∏–ª—å—Ç—Ä–µ –∏ –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞
  let filterInfo = '';
  if (lastReactionPostId) {
      const p = state.posts.find(p=>p.id===lastReactionPostId);
      filterInfo = `<div style="margin-bottom: 1rem; padding: 0.5rem; background: var(--bg); border-radius: 12px;">
          –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ—Å—Ç—É: "${clip(p?.content || '', 50)}" 
          <button class="secondary" onclick="clearReactionFilter()" style="padding: 0.2rem 0.5rem;">–°–±—Ä–æ—Å–∏—Ç—å</button>
      </div>`;
  }

  wrap.innerHTML = filterInfo + items.map(r=>{
    const c = state.characters.find(x=>x.id===r.charId);
    const p = state.posts.find(p=>p.id===r.postId);
    const cls = r.delta >= 0 ? 'pos' : 'neg';

    return `
      <div class="react-card">
        <div>
          <strong>${c?.name}</strong>
          –æ –ø–æ—Å—Ç–µ <em>${authorName(p)}</em>
          ¬∑ <span class="muted">${fmtTime(r.at)}</span>
        </div>
        <div class="react-item">
          <div>${r.text}</div>
          <div class="delta ${cls}">${formatDelta(r.delta)}</div>
        </div>
      </div>
    `;
  }).join('');
}

function clearReactionFilter() {
    lastReactionPostId = null;
    renderReactions();
}

// === –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –º—ã—Å–ª–µ–π / –±–æ—Ç–æ–≤ (–ó–∞–≥–ª—É—à–∫–∏/Fallback) ===

// –±–∞–∑–æ–≤—ã–µ –∑–∞–≥–æ—Ç–æ–≤–∫–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç,
// –∫–æ–≥–¥–∞ –ò–ò –æ—Ç–≤–µ—á–∞–µ—Ç —á–µ–º-—Ç–æ —Å—Ç—Ä–∞–Ω–Ω—ã–º –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –æ–±—â–∏–º
const thoughtPos = [
  '–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —à–∞–≥. –ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è.',
  '–≠—Ç–æ –∑–≤—É—á–∏—Ç —á–µ—Å—Ç–Ω–æ. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é.',
  '–ö–∞–∂–µ—Ç—Å—è, —Ç—ã –º–µ–Ω—è —É–¥–∏–≤–ª—è–µ—à—å ‚Äî –≤ —Ö–æ—Ä–æ—à–µ–º —Å–º—ã—Å–ª–µ.',
  '–õ–∞–∫–æ–Ω–∏—á–Ω–æ –∏ –≤ —Ç–æ—á–∫—É.',
  '–£–º–Ω–æ. –•–æ—á—É —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ.'
];
const thoughtNeg = [
  '–ù–µ —É–≤–µ—Ä–µ–Ω(–∞), —á—Ç–æ —ç—Ç–æ —Ö–æ—Ä–æ—à–∞—è –∏–¥–µ—è.',
  '–≠—Ç–æ –Ω–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ —Ç–µ–±—è.',
  '–°–æ–º–Ω–µ–≤–∞—é—Å—å, —á—Ç–æ —ç—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç.',
  '–°–ª–∏—à–∫–æ–º —Ä–µ–∑–∫–æ. –Ø –±—ã –ø—Ä–æ–º–æ–ª—á–∞–ª(–∞).',
  '–ú–Ω–µ —ç—Ç–æ –Ω–µ –±–ª–∏–∑–∫–æ.'
];

function toneWrap(tone, text){
  switch(tone){
    case 'cold':   return `–•–º. ${text}`;
    case 'warm':   return `–ó–Ω–∞–µ—à—å, ${text.toLowerCase()}`;
    case 'sharp':  return `–ü—Ä—è–º–æ —Å–∫–∞–∂—É: ${text}`;
    case 'stoic':  return `–û—Ç–º–µ—á—É –±–µ–∑ —ç–º–æ—Ü–∏–π: ${text}`;
    case 'chaotic':return `–õ–æ–ª, ${text.toLowerCase()}`;
    default: return text;
  }
}

// –§—É–Ω–∫—Ü–∏—è-–∑–∞–≥–ª—É—à–∫–∞ (Fallback)
function generateThought(char, post, delta){
  const base = delta>=0 ? choice(thoughtPos) : choice(thoughtNeg);
  const mention = post.relatedCharacters?.includes(char.id)
    ? ' (—ç—Ç–æ –∫–∞—Å–∞–µ—Ç—Å—è –º–µ–Ω—è)'
    : '';
  return toneWrap(char.tone, base) + mention;
}


// === —É—Ç–∏–ª–∏—Ç—ã ===

// –ü–æ–º–æ—â–Ω–∏–∫: —ç—Ç–æ id –∏–≥—Ä–æ–∫–∞?
function isPlayerId(id){
  return state.players.some(p => p.id === id);
}

// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –¥–ª—è —Ä–µ–∞–∫—Ü–∏–∏ (–æ—Ç 1 –¥–æ 5)
function getRelevantCharacters(post){
  // –ê–≤—Ç–æ—Ä –ø–æ—Å—Ç–∞
  const authorId = post.authorId;

  const txt = (post.content||'').toLowerCase();

  const scored = state.characters
    // –§–∏–ª—å—Ç—Ä—É–µ–º: –Ω–µ –∞–≤—Ç–æ—Ä –ø–æ—Å—Ç–∞, –∏ —Ç–æ–ª—å–∫–æ –±–æ—Ç—ã (–Ω–µ –∏–≥—Ä–æ–∫–∏) –¥–æ–ª–∂–Ω—ã —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    .filter(c => c.id !== authorId && !isPlayerId(c.id))
    .map(c => {
      let score = 0;
      // –û—Ç–Ω–æ—à–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (c) –∫ –∞–≤—Ç–æ—Ä—É –ø–æ—Å—Ç–∞ (authorId)
      const appr = c.approval?.[authorId] ?? 50;
      score += appr; // –∫—Ç–æ —Ç–µ–ø–ª–µ–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è ‚Äî –±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω–æ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç

      // –µ—Å–ª–∏ —É–ø–æ–º—è–Ω—É—Ç—ã –∏–º—è –∏–ª–∏ username ‚Äî —É—Å–∏–ª–∏–≤–∞–µ–º
      if (c.name && txt.includes(c.name.toLowerCase())) score += 80;
      if (c.username && txt.includes(c.username.slice(1).toLowerCase())) score += 60;

      // –ª—ë–≥–∫–∏–π –±–æ–Ω—É—Å, –µ—Å–ª–∏ —É–∂–µ –Ω–µ–¥–∞–≤–Ω–æ –¥—É–º–∞–ª/–ø–∏—Å–∞–ª
      if (c.lastThought) score += 5;
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏
      score *= (0.7 + Math.random() * 0.6);

      return { c, score };
    })
    .sort((a,b)=>b.score - a.score)
    .map(x=>x.c);

  // –í—ã–±–∏—Ä–∞–µ–º –æ—Ç 1 –¥–æ 5 –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
  const k = Math.min(scored.length, randint(1, 5));
  return scored.slice(0, k);
}


function authorName(p){
  if(!p) return '‚Äî';
  const author = getAuthorByType(p.authorType, p.authorId);
  return author?.name || author?.username || '–ê–≤—Ç–æ—Ä';
}

function currentPlayer(){ return state.players.find(p=>p.id===state.activePlayerId); }


function setupFilters(){
  const chips = $$('.filters .chip');
  chips.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      chips.forEach(b=>b.classList.remove('chip-on'));
      btn.classList.add('chip-on');
      feedFilter = btn.dataset.filter;
      renderFeed();
    });
  });
}

function setupPlayers(){
  const sel = $('#activePlayerSelect');
  sel.innerHTML = state.players.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
  
  // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ state.activePlayerId –≤–∞–ª–∏–¥–µ–Ω
  if (!state.players.some(p => p.id === state.activePlayerId) && state.players.length > 0) {
      state.activePlayerId = state.players[0].id;
  }
  
  sel.value = state.activePlayerId;
  sel.onchange = ()=>{
    state.activePlayerId = sel.value;
    save();
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å—ë –ø—Ä–∏ —Å–º–µ–Ω–µ –∏–≥—Ä–æ–∫–∞
    renderRelations();
    renderFeed();
    syncDmSelectors();
  };
}

function setupModal(){
  const mdl = $('#reactionModal');
  $('#modalClose').onclick = ()=> mdl.classList.add('hidden');
  $('#modalOk').onclick    = ()=> mdl.classList.add('hidden');
  $('#openReactionsBtn').onclick = ()=>{ mdl.classList.add('hidden'); setActiveView('reactions'); };
}

function setupMyProfileButton() {
  $('#myProfileBtn').onclick = () => {
    // –ü—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å —Å ID —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞ (–∫–æ—Ç–æ—Ä—ã–π —Ç–∞–∫–∂–µ –µ—Å—Ç—å –≤ characters)
    openCharacterProfile(state.activePlayerId);
  };
}

// --- –§–û–ù–û–í–´–ï –ü–û–°–¢–´ –ú–ò–†–ê (–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ï, –ü–û –¢–ê–ô–ú–ï–†–£) ---

// –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –í —ç—Ç–æ–º –∫–æ–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–∞–∫—Ç–∏–≤–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (triggerNpcPostGeneration).
// –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –¢–ê–ö–ñ–ï –≤–∫–ª—é—á–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø–æ —Ç–∞–π–º–µ—Ä—É (—Ä–∞–∑ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç), –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç –±–ª–æ–∫.

const AMBIENT_MIN_MS = 90000;   // –º–∏–Ω–∏–º—É–º 90 —Å–µ–∫—É–Ω–¥
const AMBIENT_MAX_MS = 240000;  // –º–∞–∫—Å–∏–º—É–º 4 –º–∏–Ω—É—Ç—ã

async function ambientPostsTick(){
  console.log("–¢–∏–∫ —Ñ–æ–Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∏–Ω–≥–∞ (–ø–æ —Ç–∞–π–º–µ—Ä—É)...");
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–Ω—è—Ç –ª–∏ AI —É–∂–µ —á–µ–º-—Ç–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø–æ—Å—Ç–∞ –∏–≥—Ä–æ–∫–∞)
  if (activeAiRequests > 0) {
      console.log("–ü—Ä–æ–ø—É—Å–∫ —Ç–∏–∫–∞, AI –∑–∞–Ω—è—Ç.");
      return;
  }
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ–¥–∏–Ω –ø–æ—Å—Ç –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –¥–µ–π—Å—Ç–≤–∏—è–º –∏–≥—Ä–æ–∫–∞
  await aiGenerateNpcPost(null);
}

function scheduleAmbientPosting(){
  const ms = randint(AMBIENT_MIN_MS, AMBIENT_MAX_MS);
  setTimeout(async ()=>{
    try { 
        await ambientPostsTick(); 
    } catch(e){ 
        console.error("–û—à–∏–±–∫–∞ —Ñ–æ–Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∏–Ω–≥–∞ (AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω?)", e); 
    }
    scheduleAmbientPosting();
  }, ms);
}


// === —Å—Ç–∞—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ===
document.addEventListener('DOMContentLoaded', ()=>{
  load();
  setupNav();
  setupPlayers();
  setupFilters();
  setupComposeSocial();
  setupComposeStory();
  setupDm();
  setupModal();
  setupMyProfileButton();
  renderFeed();
  renderRelations();
  
  // –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã –º–∏—Ä –∂–∏–ª —Å–≤–æ–µ–π –∂–∏–∑–Ω—å—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (—Ä–∞–∑ –≤ 1.5-4 –º–∏–Ω—É—Ç—ã), 
  // –≤ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫ —Ä–µ–∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ—Å—Ç–∞–º, —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É.
  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω–∞ —Ç–æ–ª—å–∫–æ —Ä–µ–∞–∫—Ç–∏–≤–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (triggerNpcPostGeneration).
  // scheduleAmbientPosting(); 
});
</script>

</body>
</html>
