<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Status-like RP Prototype</title>

  <style>
    :root{
      --bg:#f4f4f7;
      --card:#ffffff;
      --card-border:#d5d8df;
      --text:#111217;
      --muted:#6b6f79;
      --primary:#111217;
      --accent:#111217;
      --positive:#31a24c;
      --negative:#e5535e;
    }

    *{box-sizing:border-box;}
    html,body{
      margin:0;
      padding:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,system-ui,sans-serif;
    }

    a{color:var(--primary);}
    button{
      cursor:pointer;
      border-radius:999px;
      border:1px solid rgba(0,0,0,0.07);
      padding:.6rem 1.1rem;
      background:#fff;
      font:inherit;
      color:var(--text);
    }
    button.primary{
      background:var(--text);
      color:#fff;
      border-color:var(--text);
    }
    button.secondary{
      background:#f3f3f7;
    }
    button.ghost{
      background:transparent;
    }

    #app{
      max-width:430px;
      margin:0 auto;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* TOP BAR */
    .topbar{
      position:sticky;
      top:0;
      z-index:10;
      padding:.6rem .9rem;
      background:var(--bg);
      border-bottom:1px solid #e1e4ec;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .brand{
      font-weight:700;
      letter-spacing:.02em;
    }
    .player-switch select{
      border-radius:999px;
      border:1px solid #d0d3dc;
      padding:.25rem .7rem;
      background:#fff;
    }

    main{
      flex:1;
      padding:.8rem .9rem 4.8rem;
    }
    .view{
      display:none;
    }
    .view.active{
      display:block;
    }
    .view-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:.7rem;
    }
    .view-head h1{
      margin:0;
      font-size:1.2rem;
    }

    /* FEED */
    .feed-list{
      list-style:none;
      margin:0;
      padding:0;
    }
    .post{
      background:var(--card);
      border-radius:24px;
      border:1px solid var(--card-border);
      padding:.9rem .95rem;
      margin-bottom:.8rem;
    }
    .post-head{
      display:flex;
      align-items:center;
      gap:.7rem;
      margin-bottom:.4rem;
    }
    .avatar{
      width:42px;
      height:42px;
      border-radius:50%;
      border:1px solid #cfd2da;
    }
    .meta .name{
      font-weight:700;
      font-size:.98rem;
    }
    .meta .username{
      font-size:.86rem;
      color:var(--muted);
    }
    .post-content{
      margin-top:.3rem;
      font-size:.93rem;
      line-height:1.4;
      white-space:pre-wrap;
    }
    .badge{
      display:inline-block;
      margin-left:.3rem;
      padding:.1rem .5rem;
      border-radius:999px;
      border:1px solid #e0e3eb;
      font-size:.75rem;
      color:var(--muted);
      background:#f6f7fb;
    }
    .post-actions{
      display:flex;
      align-items:center;
      gap:.8rem;
      margin-top:.55rem;
      font-size:.82rem;
      color:var(--muted);
      flex-wrap:wrap;
    }
    .post-actions .icon{
      display:inline-flex;
      align-items:center;
      gap:.25rem;
    }

    .filters{display:flex;gap:.4rem;}
    .chip{
      border-radius:999px;
      padding:.25rem .8rem;
      font-size:.8rem;
      background:#f2f3f7;
    }
    .chip-on{
      background:#111217;
      color:#fff;
    }

    /* RELATIONS */
    .relations{
      display:flex;
      flex-direction:column;
      gap:.7rem;
    }
    .rel-card{
      background:var(--card);
      border-radius:24px;
      border:1px solid var(--card-border);
      padding:1rem;
      cursor:pointer;
    }
    .rel-top{
      display:flex;
      gap:.85rem;
      align-items:center;
      margin-bottom:.6rem;
    }
    .rel-name{
      font-weight:700;
    }
    .username{
      font-size:.86rem;
      color:var(--muted);
    }
    .progress{
      margin-top:.15rem;
      height:12px;
      border-radius:999px;
      background:#f3f4f8;
      overflow:hidden;
      border:1px solid #e1e4ec;
    }
    .progress>span{
      display:block;
      height:100%;
      background:linear-gradient(90deg,#3bc76b,#70e08c);
    }
    .rel-thought{
      margin-top:.45rem;
      font-size:.86rem;
      color:var(--muted);
    }

    /* CHARACTER PROFILE */
    .char-view{
      max-width:430px;
      margin:0 auto;
    }

    .char-cover{
      height:120px;
      background:#d8dadf;
      border-radius:24px 24px 0 0;
    }

    .char-header{
      background:#fff;
      border-radius:24px;
      border:1px solid var(--card-border);
      margin-top:-48px;
      padding:1.2rem 1.1rem 1rem;
    }

    .char-header-top{
      display:flex;
      align-items:flex-end;
      gap:1rem;
    }

    .char-avatar{
  width:96px;
  height:96px;
  border-radius:50%;
  border:3px solid #fff;
  background:#ccc;
  overflow:hidden;
  flex-shrink:0;
  cursor:pointer;
  position:relative;
    }

    .char-avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
    }


.char-avatar-btn{
  margin-top:.4rem;
  font-size:.8rem;
  padding:.3rem .7rem;
}

    .char-name{
      font-size:1.4rem;
      font-weight:700;
    }

    .char-username{
      font-size:.9rem;
      color:var(--muted);
    }

    .char-bio{
      margin-top:.9rem;
      font-size:.9rem;
      line-height:1.5;
      white-space:pre-wrap;
    }

    .char-bio-edit{
  width:100%;
  margin-top:.6rem;
  border-radius:18px;
  border:1px solid var(--card-border);
  padding:.7rem .8rem;
  font:inherit;
  resize:vertical;
    }

    .char-rel-block{
      margin-top:1.2rem;
    }

    .char-rel-label-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:.86rem;
      color:var(--muted);
      margin-bottom:.35rem;
    }

    .char-rel-bar{
      height:16px;
      border-radius:999px;
      background:#f3f4f8;
      border:1px solid #e1e4ec;
      overflow:hidden;
    }

    .char-rel-bar > span{
      display:block;
      height:100%;
      background:linear-gradient(90deg,#3bc76b,#70e08c);
    }

    .char-rel-title{
      margin-top:.7rem;
      font-size:.95rem;
      font-weight:600;
    }

    .char-actions-row{
      margin-top:1rem;
      display:flex;
      gap:.5rem;
      flex-wrap:wrap;
    }

    .char-rel-thought{
  margin-top:.4rem;
  font-size:.86rem;
  color:var(--muted);
}


    /* COMPOSE */
    .compose textarea{
      width:100%;
      border-radius:18px;
      border:1px solid var(--card-border);
      padding:.7rem .8rem;
      resize:vertical;
      font:inherit;
      background:#fff;
    }
    .compose .label{
      font-size:.82rem;
      color:var(--muted);
      margin-bottom:.2rem;
      display:block;
    }
    .section{margin:.7rem 0;}
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:.4rem;
    }
    .chips label{
      padding:.25rem .7rem;
      border-radius:999px;
      border:1px solid #dde0ea;
      background:#f6f7fb;
      font-size:.82rem;
    }
    .chips input{
      margin-right:.25rem;
    }
    .file-btn{
      display:inline-block;
      padding:.4rem .8rem;
      border-radius:999px;
      border:1px dashed #d0d3dd;
      background:#f7f7fb;
      font-size:.86rem;
      cursor:pointer;
    }
    .photo-preview img{
      max-width:100%;
      margin-top:.5rem;
      border-radius:18px;
      border:1px solid var(--card-border);
    }

    .idea-box{
      display:flex;
      align-items:center;
      gap:.4rem;
      border-radius:18px;
      border:1px solid var(--card-border);
      background:#f7f7fb;
      padding:.4rem .6rem;
      font-size:.86rem;
    }
    .idea-text{
      flex:1;
      color:var(--muted);
    }

    .row{
      display:flex;
      align-items:center;
      gap:.5rem;
    }
    .row.end{justify-content:flex-end;}

    .hint{
      font-size:.8rem;
      color:var(--muted);
      margin-top:.4rem;
    }
    .muted{
      color:var(--muted);
      font-size:.82rem;
    }

    /* DM */
    .dm-thread{
      background:var(--card);
      border-radius:24px;
      border:1px solid var(--card-border);
      min-height:260px;
      padding:.7rem;
      display:flex;
      flex-direction:column;
      gap:.3rem;
    }
    .bubble{
      max-width:80%;
      padding:.45rem .7rem;
      border-radius:20px;
      font-size:.9rem;
    }
    .bubble.me{
      align-self:flex-end;
      background:#111217;
      color:#fff;
    }
    .bubble.them{
      align-self:flex-start;
      background:#f4f5fa;
    }
    .dm-input{
      display:flex;
      gap:.45rem;
      margin-top:.6rem;
    }
    .dm-input input{
      flex:1;
      border-radius:999px;
      border:1px solid var(--card-border);
      padding:.6rem .8rem;
      font:inherit;
      background:#fff;
    }

    /* REACTIONS */
    .reactions{
      display:flex;
      flex-direction:column;
      gap:.7rem;
    }
    .react-card{
      background:var(--card);
      border-radius:24px;
      border:1px solid var(--card-border);
      padding:.8rem .9rem;
      font-size:.9rem;
    }
    .react-item{
      display:flex;
      justify-content:space-between;
      gap:.5rem;
      margin-top:.35rem;
    }
    .delta.pos{color:var(--positive);}
    .delta.neg{color:var(--negative);}

    /* TABBAR */
    .tabbar{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:.6rem;
      width:100%;
      max-width:430px;
      padding:.25rem .35rem;
      background:rgba(255,255,255,0.96);
      border-radius:999px;
      box-shadow:0 8px 24px rgba(15,16,26,.18);
      display:flex;
      gap:.35rem;
      z-index:20;
    }
    .tab{
      flex:1;
      border-radius:999px;
      padding:.45rem 0;
      font-size:1rem;
    }
    .tab.active{
      background:#111217;
      color:#fff;
    }

    /* MODAL */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .modal.hidden{display:none;}
    .modal-card{
      width:min(420px,92vw);
      background:#fff;
      border-radius:22px;
      padding:1rem;
      box-shadow:0 18px 40px rgba(0,0,0,.25);
    }
    .modal-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:.5rem;
    }
    /* ... (—Ç–≤–æ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π CSS) ... */

    /* –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫–∏ (–∫–∞–∫ —Ç—ã –ø—Ä–æ—Å–∏–ª) */
    button:active, .tab:active {
      transform: scale(0.97);
      opacity: 0.9;
      transition: transform 50ms ease, opacity 50ms ease;
    }

    /* –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ (—Å–ø–∏–Ω–Ω–µ—Ä) */
    button.loading {
      position: relative;
      /* –°–∫—Ä—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç, –ø–æ–∫–∞ –≥—Ä—É–∑–∏—Ç—Å—è */
      color: transparent !important; 
      /* –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –Ω–∞–∂–∞—Ç–∏—è */
      pointer-events: none; 
    }
    button.loading::after {
      content: '';
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 20px; /* –†–∞–∑–º–µ—Ä —Å–ø–∏–Ω–Ω–µ—Ä–∞ */
      height: 20px;
      border-radius: 50%;
      /* –°–ø–∏–Ω–Ω–µ—Ä –±—É–¥–µ—Ç –±–µ–ª—ã–º, —Ç.–∫. –∫–Ω–æ–ø–∫–∏ .primary —É –Ω–∞—Å —Ç–µ–º–Ω—ã–µ */
      border: 3px solid rgba(255,255,255,0.3); 
      border-top-color: #fff;
      /* –ê–Ω–∏–º–∞—Ü–∏—è –≤—Ä–∞—â–µ–Ω–∏—è */
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è "—Ç—Ä–µ—Ö —Ç–æ—á–µ–∫" –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
    .loader-dots {
      text-align: center;
      font-size: 1.5rem;
      padding: 1rem 0;
      color: var(--muted);
    }
    .loader-dots::after {
      content: '.';
      animation: dots 1.4s steps(5, end) infinite;
    }
    
    @keyframes dots {
      0%, 20% {
        color: rgba(0,0,0,0);
        text-shadow:
          .25em 0 0 rgba(0,0,0,0),
          .5em 0 0 rgba(0,0,0,0);
      }
      40% {
        color: var(--muted);
        text-shadow:
          .25em 0 0 rgba(0,0,0,0),
          .5em 0 0 rgba(0,0,0,0);
      }
      60% {
        text-shadow:
          .25em 0 0 var(--muted),
          .5em 0 0 rgba(0,0,0,0);
      }
      80%, 100% {
        text-shadow:
          .25em 0 0 var(--muted),
          .5em 0 0 var(--muted);
      }
    }

  </style>
</head>
<body>
  <div id="app">
    <!-- Top bar -->
<header class="topbar">
      <div class="brand">Verse</div>
      <div class="player-switch">
        <button id="myProfileBtn" class="secondary" style="padding:.25rem .7rem; margin-right:.5rem;">
          –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
        </button>
        <label>
          –Ø ‚Äî 
          <select id="activePlayerSelect"></select>
        </label>
      </div>
    </header>

    <!-- Views -->
    <main>
      <!-- FEED (–≠–∫—Ä–∞–Ω 1) -->
      <section id="view-feed" class="view active">
        <div class="view-head">
          <h1>–õ–µ–Ω—Ç–∞</h1>
          <div class="filters">
            <button class="chip chip-on" data-filter="all">–í—Å–µ</button>
            <button class="chip" data-filter="social">–û–±—ã—á–Ω—ã–µ</button>
            <button class="chip" data-filter="story">–°—é–∂–µ—Ç–Ω—ã–µ</button>
          </div>
        </div>
        <ul id="feedList" class="feed-list"></ul>
      </section>

      <!-- RELATIONS (–≠–∫—Ä–∞–Ω 2) -->
      <section id="view-relations" class="view">
        <div class="view-head">
          <h1>–û—Ç–Ω–æ—à–µ–Ω–∏—è</h1>
        </div>
        <div id="relationsList" class="relations"></div>
      </section>

      <!-- CHARACTER PROFILE (–≠–∫—Ä–∞–Ω 2.5) -->
      <section id="view-character" class="view">
        <div class="view-head">
          <h1>–ü—Ä–æ—Ñ–∏–ª—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h1>
        </div>
        <div id="characterView" class="char-view"></div>
      </section>

      <!-- COMPOSE SOCIAL (–≠–∫—Ä–∞–Ω 3) -->
      <section id="view-compose" class="view">
        <div class="view-head">
          <h1>–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç</h1>
        </div>
        <div class="compose">
          <textarea id="composeText" rows="6" placeholder="–û —á—ë–º –¥—É–º–∞–µ—à—å?"></textarea>

          <div class="section">
            <label class="file-btn">
              <input id="composePhoto" type="file" accept="image/*" hidden />
              –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            </label>
            <div id="composePhotoPreview" class="photo-preview"></div>
          </div>

          <button id="publishSocialBtn" class="primary">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        </div>
      </section>

      <!-- COMPOSE STORY (–≠–∫—Ä–∞–Ω 4) -->
      <section id="view-story" class="view">
        <div class="view-head">
          <h1>–°—é–∂–µ—Ç–Ω—ã–π –ø–æ—Å—Ç</h1>
        </div>

        <div class="compose">
          <div class="section">
            <label class="label">–ò–¥–µ–∏ –¥–ª—è –ø–æ—Å—Ç–∞ (–ø—Ä–æ—Ç–æ—Ç–∏–ø)</label>
            <div class="idea-box">
              <button id="ideaPrev" class="ghost">&larr;</button>
              <div id="ideaText" class="idea-text">–ù–∞–∂–º–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å –∏–¥–µ–∏¬ª</div>
              <button id="ideaNext" class="ghost">&rarr;</button>
            </div>
            <div class="row">
              <button id="ideaRefresh" class="secondary">–û–±–Ω–æ–≤–∏—Ç—å –∏–¥–µ–∏</button>
              <button id="ideaUse" class="secondary">–í—Å—Ç–∞–≤–∏—Ç—å –≤ –ø–æ–ª–µ</button>
            </div>
          </div>

          <textarea id="storyText" rows="12" placeholder="–î–ª–∏–Ω–Ω—ã–π —Å—é–∂–µ—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç..."></textarea>
          <button id="publishStoryBtn" class="primary">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å—é–∂–µ—Ç–Ω—ã–π –ø–æ—Å—Ç</button>
          <p class="hint">–°—é–∂–µ—Ç–Ω—ã–µ –ø–æ—Å—Ç—ã –Ω–µ –∫–æ–º–º–µ–Ω—Ç–∏—Ä—É—é—Ç—Å—è, –Ω–æ —Å–∏–ª—å–Ω–µ–µ –≤–ª–∏—è—é—Ç –Ω–∞ –º–∏—Ä –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è.</p>
        </div>
      </section>

      <!-- DIRECT MESSAGES (–≠–∫—Ä–∞–Ω 5) -->
      <section id="view-dm" class="view">
        <div class="view-head">
          <h1 id="dmTitle">–õ–°</h1>
          <div class="row">
            <label>–ü–µ—Ä—Å–æ–Ω–∞–∂: 
              <select id="dmSelect"></select>
            </label>
            <label style="margin-left:1rem;">
              <input type="checkbox" id="dmAutoToggle" checked />
              –ë–æ—Ç –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å —Å–∞–º
            </label>
          </div>
        </div>

        <div id="dmThread" class="dm-thread"></div>

        <div class="dm-input">
          <input id="dmInput" type="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." />
          <button id="dmSend" class="primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </section>

      <!-- REACTIONS HISTORY (–≠–∫—Ä–∞–Ω 6) -->
      <section id="view-reactions" class="view">
        <div class="view-head">
          <h1>–†–µ–∞–∫—Ü–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</h1>
        </div>
        <div id="reactionsList" class="reactions"></div>
      </section>
    </main>

    <!-- Tabbar -->
    <nav class="tabbar">
      <button class="tab active" data-target="feed" title="–õ–µ–Ω—Ç–∞">–õ–µ–Ω—Ç–∞</button>
      <button class="tab" data-target="relations" title="–û—Ç–Ω–æ—à–µ–Ω–∏—è">–û—Ç–Ω–æ—à–µ–Ω–∏—è</button>
      <button class="tab" data-target="compose" title="–ü–æ—Å—Ç">‚úèÔ∏è</button>
      <button class="tab" data-target="story" title="–°—é–∂–µ—Ç">–°—é–∂–µ—Ç</button>
      <button class="tab" data-target="dm" title="–õ–°">–õ–°</button>
      <button class="tab" data-target="reactions" title="–†–µ–∞–∫—Ü–∏–∏">–†–µ–∞–∫—Ü–∏–∏</button>
    </nav>
  </div>

  <!-- Modal: reactions after publish -->
  <div id="reactionModal" class="modal hidden">
    <div class="modal-card">
      <div class="modal-head">
        <h3>–†–µ–∞–∫—Ü–∏–∏ –Ω–∞ –ø–æ—Å—Ç</h3>
        <button id="modalClose" class="ghost">‚úï</button>
      </div>
      <div id="modalReactions"></div>
      <div class="row end">
        <button id="openReactionsBtn" class="secondary">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
        <button id="modalOk" class="primary">–û–∫</button>
      </div>
    </div>
  </div>

<script>
const $  = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
const uid = (p='id') => `${p}_${Math.random().toString(36).slice(2,9)}`;
const nowIso = () => new Date().toISOString();
const clip = (s, n=160) => (s.length>n ? s.slice(0,n) + '‚Ä¶' : s);
const fmtTime = (iso) => new Date(iso).toLocaleString();
const randint = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const choice = (arr)=>arr[Math.floor(Math.random()*arr.length)];
const clamp=(x,min,max)=>Math.max(min,Math.min(max,x));

// –°–æ–±–∏—Ä–∞–µ–º –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–≤—è–∑–µ–π –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ —Å –¥—Ä—É–≥–∏–º–∏
function buildRelationsSummary(char) {
  if (!char.relations) return '–ù–µ—Ç —è–≤–Ω—ã—Ö —Å–≤—è–∑–µ–π.';

  const lines = [];

  for (const [otherId, value] of Object.entries(char.relations)) {
    let other = state.characters.find(c => c.id === otherId);
    if (!other) {
      other = state.players.find(p => p.id === otherId);
    }
    const name = other?.name || otherId;
    lines.push(`${char.name} –∏ ${name}: —É—Ä–æ–≤–µ–Ω—å –±–ª–∏–∑–æ—Å—Ç–∏ ${value} –∏–∑ 100.`);
  }

  if (!lines.length) return '–ù–µ—Ç —è–≤–Ω—ã—Ö —Å–≤—è–∑–µ–π.';

  return lines.join('\n');
}

// === –ò–ò (Gemini) –¥–ª—è –õ–° ===
async function askAI(promptText) {
  try {
    const res = await fetch('/api/gemini', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: promptText })
    });

    const data = await res.json();

    // –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –ø—É—Å—Ç–æ–π –∏–ª–∏ —Å –æ—à–∏–±–∫–æ–π ‚Äî —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –ò–ò –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
    if (!data.ok || !data.answer) {
      console.error('AI error response', data);
      return null;              // <‚Äî –í–ê–ñ–ù–û: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null, –∞ –Ω–µ —Ç–µ–∫—Å—Ç
    }

    return data.answer.trim();
  } catch (err) {
    console.error('AI network error', err);
    return null;                // <‚Äî –∏ —Ç—É—Ç —Ç–æ–∂–µ null
  }
}


async function aiReplyToDm(charId) {
  const char = state.characters.find(c => c.id === charId);
  if (!char) return;

  const me = currentPlayer();
  const key = threadKey(charId);
  const history = state.dms[key] || [];

  const historyText = history.map(m => {
    const whoName = m.from === state.activePlayerId ? me.name : char.name;
    return `${whoName}: ${m.text}`;
  }).join('\n');

  const relationsSummary = buildRelationsSummary(char);

  const prompt = `
–¢—ã ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–∂ ${char.name} (${char.username}) –≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –≤—ã–º—ã—à–ª–µ–Ω–Ω–æ–π —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏.

–ö–ê–ù–û–ù–ò–ß–ï–°–ö–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–ï–†–°–û–ù–ê–ñ–ï:
- –ë–∏–æ–≥—Ä–∞—Ñ–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (–∏—Å–ø–æ–ª—å–∑—É–π –∫–∞–∫ –±–∞–∑—É, –æ–Ω–∞ –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∞–≤—Ç–æ—Ä–æ–º):
${char.bio}

- –°–≤—è–∑–∏ –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏:
${relationsSummary}

–≠—Ç–∏ —Ñ–∞–∫—Ç—ã –æ —Å–≤—è–∑—è—Ö —Å—á–∏—Ç–∞—é—Ç—Å—è –∏—Å—Ç–∏–Ω–æ–π. 
–ù–ï –ü–ï–†–ï–ü–£–¢–´–í–ê–ô, –∫—Ç–æ –∫–æ–º—É –∫–µ–º –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è, –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π –Ω–æ–≤—ã–µ —Ä–æ–¥—Å—Ç–≤–∞ –∏ –Ω–µ –º–µ–Ω—è–π —Ä–æ–ª–∏.
–ï—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –∏–≥—Ä–æ–∫–∞ –µ—Å—Ç—å –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ —ç—Ç–∏–º —Ñ–∞–∫—Ç–∞–º ‚Äî –º—è–≥–∫–æ –ø–æ–ø—Ä–∞–≤—å –µ–≥–æ –∏–ª–∏ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –Ω–∞–º–µ–∫–Ω–∏, –Ω–æ —Å–∞–º –∫–∞–Ω–æ–Ω –ù–ï –º–µ–Ω—è–π.

–¢–æ–Ω –æ–±—â–µ–Ω–∏—è: ${char.tone}.
–¢–µ–∫—É—â–µ–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –∏–≥—Ä–æ–∫—É ${me.name}: ${char.approval[state.activePlayerId] ?? 50} –∏–∑ 100.

–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –º–µ–∂–¥—É —Ç–æ–±–æ–π –∏ –∏–≥—Ä–æ–∫–æ–º:
${historyText}

–°–µ–π—á–∞—Å, –æ—Ç –ª–∏—Ü–∞ ${char.name}, –æ—Ç–≤–µ—Ç—å –Ω–∞ –ü–û–°–õ–ï–î–ù–ï–ï —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞.
–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
- –ø–æ-—Ä—É—Å—Å–∫–∏
- –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞
- 1‚Äì3 –∫–æ—Ä–æ—Ç–∫–∏–µ —Ä–µ–ø–ª–∏–∫–∏
- –±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π, —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
- —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä—É –∏ –∫–∞–Ω–æ–Ω–∏—á–Ω—ã–º —Å–≤—è–∑—è–º.
`;

  const aiText = await askAI(prompt);
  if (!aiText) return;

  pushMessage(charId, charId, aiText);
}

let state = {
  players: [
    { id:'player1', name:'–ì—Ä–µ–π—Å–æ–Ω',  username:'@LiqueurD',   followers:320 },
    { id:'player2', name:'–õ–æ—Ä–∞–Ω—Ç–∏—Å', username:'@tinktloran', followers:340 }
  ],
  activePlayerId: 'player1',
  characters: [],
  posts: [],
  dms: {},
  reactions: []
};

const LS_KEY = 'verse_state_v2_grayson_loran';

// === –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏ —Å—Ç–∞—Ä—Ç–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤ ===
function seedIfEmpty(){
  if(state.characters.length) return;

  state.characters = [
    {
      id:'player1', // <--- ID —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å player
      name:'–ì—Ä–µ–π—Å–æ–Ω',
      username:'@LiqueurD',
      tone:'stoic', // (–ú–æ–∂–µ—à—å –ø–æ–º–µ–Ω—è—Ç—å)
      followers:320,
      bio:'(–í–ø–∏—à–∏ —Å—é–¥–∞ –∫–∞–Ω–æ–Ω –ì—Ä–µ–π—Å–æ–Ω–∞. –ò–ò –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ –¥–ª—è —Ä–µ–∞–∫—Ü–∏–π)',
      relations:{}, // (–ú–æ–∂–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∑–∂–µ)
      approval:{
        // –ú–Ω–µ–Ω–∏–µ –ì—Ä–µ–π—Å–æ–Ω–∞ –æ –¥—Ä—É–≥–∏—Ö:
        player2: 50, // (–ú–Ω–µ–Ω–∏–µ –æ –õ–æ—Ä–∞–Ω—Ç–∏—Å–µ)
        kristian: 60,
        vivien: 70
        // ... (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã—Ö)
      },
      lastThought:'',
      avatar:'' // (–ê–≤–∞—Ç–∞—Ä –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ–∏–ª—å)
    },
    {
      id:'player2', // <--- ID —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å player
      name:'–õ–æ—Ä–∞–Ω—Ç–∏—Å',
      username:'@tinktloran',
      tone:'warm', // (–ú–æ–∂–µ—à—å –ø–æ–º–µ–Ω—è—Ç—å)
      followers:340,
      bio:'(–í–ø–∏—à–∏ —Å—é–¥–∞ –∫–∞–Ω–æ–Ω –õ–æ—Ä–∞–Ω—Ç–∏—Å–∞. –ò–ò –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ –¥–ª—è —Ä–µ–∞–∫—Ü–∏–π)',
      relations:{},
      approval:{
        // –ú–Ω–µ–Ω–∏–µ –õ–æ—Ä–∞–Ω—Ç–∏—Å–∞ –æ –¥—Ä—É–≥–∏—Ö:
        player1: 50, // (–ú–Ω–µ–Ω–∏–µ –æ –ì—Ä–µ–π—Å–æ–Ω–µ)
        kristian: 40,
        aurora: 75
        // ... (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã—Ö)
      },
      lastThought:'',
      avatar:''
    },
    {
      id:'kristian',
      name:'–ö—Ä–∏—Å—Ç–∏–∞–Ω –í–æ–ª—å—Ç',
      username:'@shiningshining',
      tone:'warm',
      followers:1500,
      bio:'–û–º–µ–≥–∞ —Å –ø–ª–∞—Ç–∏–Ω–æ–≤—ã–º–∏ –≤–æ–ª–æ—Å–∞–º–∏ –∏ –æ–±–µ–∑–æ—Ä—É–∂–∏–≤–∞—é—â–µ–π —É–ª—ã–±–∫–æ–π; —Ö–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω—ã–π —Å—Ç—É–¥–µ–Ω—Ç –ø–µ–¥—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞, —Å–∞–º —Å–µ–±—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç, –ª—é–±–∏—Ç –¥–µ—Ç–µ–π –∏ —Å–ª–∞–¥–∫–æ–µ. –í –ø—Ä–æ—à–ª–æ–º —Å–ø–∞–ª —Å –ì—Ä–µ–π—Å–æ–Ω–æ–º –∏ —Å–µ–π—á–∞—Å —Å–Ω–æ–≤–∞ –∏–º –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω.',
      relations:{ vivien:40, eve:20, alexi:25 },
      approval:{ player1:65, player2:35 },
      lastThought:'',
      avatar:''
    },
    {
      id:'vivien',
      name:'–í–∏–≤—å–µ–Ω –ë–ª–µ–π–¥–º–æ—Ä',
      username:'@WildFret',
      tone:'chaotic',
      followers:900,
      bio:'–ë–µ—Ç–∞, –≥–∏—Ç–∞—Ä–∏—Å—Ç–∫–∞ –≥—Ä—É–ø–ø—ã Ash&mercury, —É–ø—Ä—è–º–∞—è —à—É–º–Ω–∞—è —Ä–æ–∫–µ—Ä—à–∞, –ø—Ä–∏–∫—Ä—ã–≤–∞–µ—Ç –º–ª–∞–¥—à–∏—Ö –∏ —Å–ø–æ—Ä–∏—Ç —Å –ö–∞–π–ª–∞–Ω–æ–º. –í –ø–æ–ª–∏–∞–º–æ—Ä–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö —Å –ï–≤–æ–π –∏ –ê–ª–µ–∫—Å–∏.',
      relations:{ alexi:80, eve:70, grayson:65, aiden:60, ember:60 },
      approval:{ player1:70, player2:55 },
      lastThought:'',
      avatar:''
    },
    {
      id:'aiden',
      name:'–≠–π–¥–µ–Ω –ë–ª–µ–π–¥–º–æ—Ä',
      username:'@404NotFound',
      tone:'chaotic',
      followers:600,
      bio:'–î–æ–º–∏–Ω–∞–Ω—Ç–Ω—ã–π –æ–º–µ–≥–∞-—à–∞–ª–æ–ø–∞–π: –æ–±–∞—è—Ç–µ–ª—å–Ω—ã–π –∞–≤–∞–Ω—Ç—é—Ä–∏—Å—Ç, —Ç–∞–∫—Ç–∏–∫ –¥—É—ç—Ç–∞ —Å —Å–µ—Å—Ç—Ä–æ–π –≠–º–±–µ—Ä. –û–±–æ–∂–∞–µ—Ç –ø—Ä–∞–Ω–∫–∏, —Ç–µ–∞—Ç—Ä –∏ –≤–ª—é–±–ª—ë–Ω –≤ —É—á–∏—Ç–µ–ª—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã –ò—Ç–∞–Ω–∞ –•–æ–≥–≥–∞—Ä—Ç–∞.',
      relations:{ ember:90, vivien:60, eve:40, ethan:75 },
      approval:{ player1:65, player2:50 },
      lastThought:'',
      avatar:''
    },
    {
      id:'ember',
      name:'–≠–º–±–µ—Ä –ë–ª–µ–π–¥–º–æ—Ä',
      username:'@500InternalServerError',
      tone:'stoic',
      followers:580,
      bio:'–î–æ–º–∏–Ω–∞–Ω—Ç–Ω–∞—è –æ–º–µ–≥–∞, —Ñ–ª–µ–≥–º–∞—Ç–∏—á–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫; –º–æ–∑–≥ –¥—É—ç—Ç–∞ —Å –≠–π–¥–µ–Ω–æ–º, –ª—é–±–∏—Ç —Å–æ–±–∞–∫ –∏ —Ä–∞—Å—Ç–µ–Ω–∏—è. –°–∫–µ–ø—Ç–∏—á–Ω–∞, –Ω–æ –æ—á–µ–Ω—å –∑–∞–±–æ—Ç–ª–∏–≤–∞.',
      relations:{ aiden:90, vivien:60, eve:40 },
      approval:{ player1:60, player2:50 },
      lastThought:'',
      avatar:''
    },
    {
      id:'aurora',
      name:'–ê–≤—Ä–æ—Ä–∞ –ë–ª—ç–∫–≤–æ–ª–ª',
      username:'@ABlackwall',
      tone:'stoic',
      followers:800,
      bio:'–î–æ–º–∏–Ω–∞–Ω—Ç–Ω–∞—è –∞–ª—å—Ñ–∞, —Å–ø–æ–∫–æ–π–Ω–∞—è –∏ —Å–æ–±—Ä–∞–Ω–Ω–∞—è, –±—É–¥—É—â–∞—è –Ω–∞—Å–ª–µ–¥–Ω–∏—Ü–∞ —Å–µ–º–µ–π–Ω–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞. –õ—é–±–∏—Ç –ø–æ—Ä—è–¥–æ–∫, —Ç–æ—á–Ω—ã–µ –Ω–∞—É–∫–∏ –∏ —é–≤–µ–ª–∏—Ä–Ω–æ–µ –¥–µ–ª–æ, –∫–æ–≥–¥–∞-—Ç–æ –∑–∞–Ω–∏–º–∞–ª–∞—Å—å –∫–æ–Ω–Ω—ã–º —Å–ø–æ—Ä—Ç–æ–º –≤–º–µ—Å—Ç–µ —Å –ì—Ä–µ–π—Å–æ–Ω–æ–º.',
      relations:{ eve:70, loran:75, derek:80, noel:70 },
      approval:{ player1:65, player2:80 },
      lastThought:'',
      avatar:''
    },
    {
      id:'eve',
      name:'–ï–≤–∞ –ë–ª—ç–∫–≤–æ–ª–ª',
      username:'@EveLuxe',
      tone:'sharp',
      followers:1000000,
      bio:'–ì—Ä–æ–º–∫–∞—è —Å—Ç–µ—Ä–≤–æ–∑–Ω–∞—è –¥–æ–º–∏–Ω–∞–Ω—Ç–Ω–∞—è –∞–ª—å—Ñ–∞-–±–ª–æ–≥–µ—Ä—à–∞; –º–µ–Ω–µ–¥–∂–µ—Ä —Ä–æ–∫-–≥—Ä—É–ø–ø—ã –í–∏–≤—å–µ–Ω –∏ –ê–ª–µ–∫—Å–∏ –∏ —á–∞—Å—Ç—å –∏—Ö –ø–æ–ª–∏–∞–º–æ—Ä–Ω–æ–π —Ç—Ä–æ–∏—Ü—ã. –õ—é–±–∏—Ç –≤–µ—á–µ—Ä–∏–Ω–∫–∏, —Å–µ–∫—Å –∏ –ø–æ–±–µ–∂–¥–∞—Ç—å –≤ —Å–ø–æ—Ä–∞—Ö.',
      relations:{ aurora:80, loran:85, vivien:75, alexi:70, aiden:50, ember:50 },
      approval:{ player1:75, player2:70 },
      lastThought:'',
      avatar:''
    },
    {
      id:'derek',
      name:'–î–µ—Ä–µ–∫ –ë–ª—ç–∫–≤–æ–ª–ª',
      username:'@BlackDiamond',
      tone:'warm',
      followers:12000,
      bio:'–î–æ–º–∏–Ω–∞–Ω—Ç–Ω—ã–π –∞–ª—å—Ñ–∞, –æ—Ç–µ—Ü –ï–≤—ã, –ê–≤—Ä–æ—Ä—ã –∏ –õ–æ—Ä–∞–Ω—Ç–∏—Å–∞, –≤–µ—Ä–Ω—ã–π –º—É–∂ –ù–æ—ç–ª—è –∏ –≤–ª–∞–¥–µ–ª–µ—Ü —é–≤–µ–ª–∏—Ä–Ω–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞. –û–±–æ–∂–∞–µ—Ç —Å–µ–º—å—é, —à—É—Ç–∏—Ç –∏ –ø–µ—Ä–µ–∂–∏–≤–∞–µ—Ç –∏–∑-–∑–∞ –æ—Ç—ä–µ–∑–¥–∞ –õ–æ—Ä–∞–Ω–∞ –≤ –ì–µ—Ä–º–∞–Ω–∏—é.',
      relations:{ noel:95, aurora:90, eve:85, loran:95, dante:80, grayson:70 },
      approval:{ player1:70, player2:85 },
      lastThought:'',
      avatar:''
    },
    {
      id:'dante',
      name:'–î–∞–Ω—Ç–µ –ë–ª–µ–π–¥–º–æ—Ä',
      username:'@dSever',
      tone:'warm',
      followers:18000,
      bio:'–î–æ–º–∏–Ω–∞–Ω—Ç–Ω—ã–π –∞–ª—å—Ñ–∞-—Å–µ–º—å—è–Ω–∏–Ω –∏ –ø–æ–∂–∞—Ä–Ω—ã–π-—Å–ø–∞—Å–∞—Ç–µ–ª—å, –º—É–∂ –ö–∞–π–ª–∞–Ω–∞, –æ—Ç–µ—Ü –í–∏–≤—å–µ–Ω, –ì—Ä–µ–π—Å–æ–Ω–∞, –≠–º–±–µ—Ä –∏ –≠–π–¥–µ–Ω–∞. –°–ø–æ–∫–æ–π–Ω—ã–π —Ñ–ª–µ–≥–º–∞—Ç–∏–∫, –æ–±–æ–∂–∞–µ—Ç —Å–≤–æ—é ¬´—Å—Ç–∞—é¬ª –∏ –≤–æ–∑–∏—Ç—Å—è —Å –º–∞—à–∏–Ω–∞–º–∏.',
      relations:{ kaylan:95, vivien:90, grayson:90, aiden:85, ember:85, alexi:75 },
      approval:{ player1:85, player2:60 },
      lastThought:'',
      avatar:''
    },
    {
      id:'kaylan',
      name:'–ö–∞–π–ª–∞–Ω –ë–ª–µ–π–¥–º–æ—Ä',
      username:'@meowgneticc',
      tone:'sharp',
      followers:25000,
      bio:'–î–æ–º–∏–Ω–∞–Ω—Ç–Ω–∞—è –æ–º–µ–≥–∞-–∞–¥–≤–æ–∫–∞—Ç, –≥–ª–∞–≤–∞ Blademore K.D. –°—Ç—Ä–æ–≥–∏–π, —Ö–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω—ã–π, –≤–æ—Ä—á–ª–∏–≤—ã–π –≥–µ–Ω–∏–π —é—Ä–∏—Å–ø—Ä—É–¥–µ–Ω—Ü–∏–∏, –æ—á–µ–Ω—å –∑–∞–±–æ—Ç–∏—Ç—Å—è –æ —Å–µ–º—å–µ –∏ —Ö–æ—Ç–µ–ª –¥–ª—è –¥–µ—Ç–µ–π ¬´—é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –±—É–¥—É—â–µ–µ¬ª.',
      relations:{ dante:95, vivien:80, grayson:75, aiden:80, ember:80 },
      approval:{ player1:55, player2:65 },
      lastThought:'',
      avatar:''
    },
    {
      id:'alexi',
      name:'–ê–ª–µ–∫—Å–∏ –£–æ–∫–µ—Ä',
      username:'@mercuryAl',
      tone:'warm',
      followers:3000,
      bio:'–ë–µ—Ç–∞, —Å–æ–ª–∏—Å—Ç –∏ –æ—Å–Ω–æ–≤–∞—Ç–µ–ª—å —Ä–æ–∫-–≥—Ä—É–ø–ø—ã ¬´Ash&mercury¬ª, –≤—ã—Ä–æ—Å –≤ –±–µ–¥–Ω–æ—Å—Ç–∏, –Ω–æ –±—ã–ª —É—Å—ã–Ω–æ–≤–ª—ë–Ω –ë–ª–µ–π–¥–º–æ—Ä–∞–º–∏. –ü—Ä–µ–¥–∞–Ω–Ω—ã–π, –¥–æ–±—Ä—ã–π –±—É–Ω—Ç–∞—Ä—å, –≤ —Å–ª–æ–∂–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö —Å –í–∏–≤—å–µ–Ω –∏ –ï–≤–æ–π.',
      relations:{ vivien:85, eve:80, dante:70, grayson:80 },
      approval:{ player1:80, player2:55 },
      lastThought:'',
      avatar:''
    },
    {
      id:'evelyn',
      name:'–≠–≤–µ–ª–∏–Ω –•–∞—Ä—Ç',
      username:'@drHart',
      tone:'sharp',
      followers:22000,
      bio:'–ê–ª—å—Ñ–∞, –±—ã–≤—à–∏–π —Å—É–¥–º–µ–¥—ç–∫—Å–ø–µ—Ä—Ç, —Å–µ–π—á–∞—Å –≤–ª–∞–¥–µ–ª–∏—Ü–∞ –∫–ª–∏–Ω–∏–∫–∏ Family Hart. –ò—Ä–æ–Ω–∏—á–Ω–∞—è, –¥–µ—Ä–∑–∫–∞—è, –¥–∞—ë—Ç –ª—é–¥—è–º –ø—Ä–æ–∑–≤–∏—â–∞ –∏ —Å—Ç–∞–≤–∏—Ç –¥–∏–∞–≥–Ω–æ–∑—ã –ø–æ —Ç–≤–∏—Ç–∞–º; –æ—Å–æ–±–µ–Ω–Ω–æ –±–ª–∏–∑–∫–∞ —Å –õ–æ—Ä–∞–Ω–æ–º –∏ –ê–≤—Ä–æ—Ä–æ–π.',
      relations:{ loran:90, aurora:85, eve:50, kaylan:70, derek:70 },
      approval:{ player1:55, player2:85 },
      lastThought:'',
      avatar:''
    },
    {
      id:'ellean',
      name:'–≠–ª–ª–µ–∞–Ω –ë–ª–µ–π–¥–º–æ—Ä',
      username:'@EllyMurrr',
      tone:'chaotic',
      followers:26000,
      bio:'–ñ—É—Ä–Ω–∞–ª–∏—Å—Ç –∏ –∏–∑–¥–∞—Ç–µ–ª—å BladeM, —à—É–º–Ω—ã–π –∏ —Ç–∞–∫—Ç–∏–ª—å–Ω—ã–π –¥–µ–¥—É—à–∫–∞ –ë–ª–µ–π–¥–º–æ—Ä–æ–≤. –õ—é–±–∏—Ç –ø—Ä–∞–Ω–∫–∏ —Å –≠–π–¥–µ–Ω–æ–º –∏ –≠–º–±–µ—Ä, —Ç–µ–ø–ª–æ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –ì—Ä–µ–π—Å–æ–Ω—É –∏ –ø—Ä–æ—Å–∏—Ç –õ–æ—Ä–∞–Ω–∞ –±—ã—Ç—å —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω–µ–µ.',
      relations:{ kaylan:90, grayson:85, aiden:70, ember:70, loran:75 },
      approval:{ player1:90, player2:75 },
      lastThought:'',
      avatar:''
    },
    {
      id:'dohyun',
      name:'–ö–∞–Ω –î–æ—Ö—ë–Ω',
      username:'@RRentGen',
      tone:'stoic',
      followers:8000,
      bio:'–ê–ª—å—Ñ–∞-–º–µ–¥–∏–∫-–∏–Ω—Ç–µ—Ä–Ω, —Ç–∏—Ö–∏–π –≥–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –∫–ª–∏–Ω–∏–∫–µ –≠–≤–µ–ª–∏–Ω. –°—Ç–∞—Ä—ã–π –¥—Ä—É–≥ –õ–æ—Ä–∞–Ω—Ç–∏—Å–∞, —Ä–∞–∑–¥–µ–ª—è–µ—Ç —Å –Ω–∏–º –ª—é–±–æ–≤—å –∫ –∑–Ω–∞–Ω–∏—è–º –∏ –∞–Ω–∏–º–µ, —Å—á–∏—Ç–∞–µ—Ç –ì—Ä–µ–π—Å–æ–Ω–∞ –Ω–µ–¥–æ—Å—Ç–æ–π–Ω—ã–º –õ–æ—Ä–∞–Ω–∞.',
      relations:{ loran:90, evelyn:70 },
      approval:{ player1:30, player2:85 },
      lastThought:'',
      avatar:''
    },
    {
      id:'ethan',
      name:'–ò—Ç–∞–Ω –•–æ–≥–≥–∞—Ä—Ç',
      username:'@metaphoricalallegory',
      tone:'warm',
      followers:5000,
      bio:'–ê–ª—å—Ñ–∞-—É—á–∏—Ç–µ–ª—å –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã –∏ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å —Ç–µ–∞—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –∫–ª—É–±–∞. –î–æ–±—Ä—ã–π, —Ö–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω—ã–π, –ª—é–±–∏–º–µ—Ü —à–∫–æ–ª—å–Ω–∏–∫–æ–≤; –æ—Å–æ–±–µ–Ω–Ω–æ –≤–µ—Ä–∏—Ç –≤ —Ç–∞–ª–∞–Ω—Ç –≠–π–¥–µ–Ω–∞.',
      relations:{ aiden:90 },
      approval:{ player1:60, player2:55 },
      lastThought:'',
      avatar:''
    },
    {
      id:'kassandra',
      name:'–ö–∞—Å—Å–∞–Ω–¥—Ä–∞ –ë–ª–µ–π–¥–º–æ—Ä',
      username:'@Kkassy',
      tone:'warm',
      followers:4000,
      bio:'–ê–ª—å—Ñ–∞-–≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä, –º–ª–∞–¥—à–∞—è —Å–µ—Å—Ç—Ä–∞ –ö–∞–π–ª–∞–Ω–∞, –≤–ª–∞–¥–µ–ª–∏—Ü–∞ —Ñ–µ—Ä–º—ã –∏ –∫–æ–Ω—é—à–µ–Ω. –û—á–µ–Ω—å –º—è–≥–∫–∞—è, –Ω–æ —Å–∏–ª—å–Ω–∞—è –¥—É—Ö–æ–º –∂–µ–Ω—â–∏–Ω–∞, –ª—é–±–∏—Ç –ø–ª–µ–º—è–Ω–Ω–∏–∫–æ–≤; —Å–µ–π—á–∞—Å –ì—Ä–µ–π—Å–æ–Ω —É –Ω–µ—ë —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ª–æ—à–∞–¥—å–º–∏.',
      relations:{ grayson:85, kaylan:80, dante:75 },
      approval:{ player1:85, player2:60 },
      lastThought:'',
      avatar:''
    }
  ];

  state.posts = [
    postObj({
      type:'social',
      authorType:'character',
      authorId:'vivien',
      content:'–ö—Ç–æ –∏–¥—ë—Ç —Å–µ–≥–æ–¥–Ω—è –Ω–∞ —Ä–µ–ø–µ—Ç–∏—Ü–∏—é Ash&mercury? –ù—É–∂–Ω–æ –æ—Ç–æ–≥–Ω–∞—Ç—å –¥—É—Ä–Ω—ã–µ –º—ã—Å–ª–∏ –≥—Ä–æ–º–∫–æ–π –º—É–∑—ã–∫–æ–π.',
      relatedCharacters:['alexi','eve']
    }),
    postObj({
      type:'social',
      authorType:'character',
      authorId:'kristian',
      content:'–ò–Ω–æ–≥–¥–∞ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ –¥–µ—Ç–∏ –≤ —à–∫–æ–ª–µ –º—É–¥—Ä–µ–µ –≤–∑—Ä–æ—Å–ª—ã—Ö –Ω–∞ –≤–µ—á–µ—Ä–∏–Ω–∫–∞—Ö.',
      relatedCharacters:[]
    })
  ];
}

// === —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ / –∑–∞–≥—Ä—É–∑–∫–∞ ===
function save(){
  try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch(e){}
}
function load(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(raw) state = JSON.parse(raw);
  }catch(e){}
  seedIfEmpty();
  save();
}

// === –º–æ–¥–µ–ª–∏ –ø–æ—Å—Ç–æ–≤ / —Ä–µ–∞–∫—Ü–∏–π ===
function postObj({type, authorType, authorId, content, relatedCharacters=[], photoData=null, strangerName=null}){
  return {
    id: uid('post'),
    type,
    authorType,
    authorId,
    strangerName,
    content,
    relatedCharacters,
    photoData,
    createdAt: nowIso(),
    likes: randint(0,50),
    comments: []
  };
}
function reactionObj(postId, charId, text, delta){
  return { id:uid('rx'), postId, charId, text, delta, at: nowIso() };
}

// === –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–∫–ª–∞–¥–∫–∞–º ===
function setActiveView(key){
  $$('.view').forEach(v=>v.classList.remove('active'));
  document.querySelector(`#view-${key}`).classList.add('active');
  $$('.tab').forEach(t=>t.classList.toggle('active', t.dataset.target===key));
  
  if(key==='relations') renderRelations();
  if(key==='dm')        syncDmSelectors();
  if(key==='reactions') renderReactions();
  
  if(key==='feed') {
    renderFeed();
    // –ö–∏–¥–∞–µ–º –∫—É–±–∏–∫ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ –ª–µ–Ω—Ç—É
    triggerRandomNpcPost(); 
  }
}

// === –ª–µ–Ω—Ç–∞ ===
let feedFilter = 'all';

function renderFeed(){
  const ul = $('#feedList');
  const posts = state.posts
    .filter(p => feedFilter==='all' ? true : p.type===feedFilter)
    .slice().sort((a,b)=>b.createdAt.localeCompare(a.createdAt));

  ul.innerHTML = posts.map(p=>renderPostHtml(p)).join('');
  posts.forEach(p=>{
    if(p.type==='social'){
      const btn = document.querySelector(`[data-action="comment"][data-id="${p.id}"]`);
      if(btn) btn.onclick = ()=>addQuickComment(p.id);
    }
  });
}

function renderPostHtml(p){
  
  let name = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
  let username = '@user';
  let avatarHtml = '<div class="avatar" aria-hidden="true"></div>'; // –ê–≤–∞—Ç–∞—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

  if (p.authorType === 'player') {
    const author = state.players.find(pl=>pl.id===p.authorId);
    name = author?.name ?? '–ò–≥—Ä–æ–∫';
    username = author?.username ?? '@player';
    // (–ø–æ–∑–∂–µ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –∞–≤–∞—Ç–∞—Ä—ã –∏–≥—Ä–æ–∫–æ–≤)

  } else if (p.authorType === 'character') {
    const author = state.characters.find(c=>c.id===p.authorId);
    name = author?.name ?? '–ü–µ—Ä—Å–æ–Ω–∞–∂';
    username = author?.username ?? '@character';
    if (author?.avatar) { // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–≤–∞—Ç–∞—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
      avatarHtml = `<div class="avatar"><img src="${author.avatar}" alt="${name}"></div>`;
    }

  } else if (p.authorType === 'stranger') {
    name = p.strangerName;  // e.g., "–°–ø–ª–µ—Ç–Ω–∏—Ü–∞"
    username = p.authorId;  // e.g., "@GossipFiend"
    // (–ù–µ–∑–Ω–∞–∫–æ–º—Ü—ã –æ—Å—Ç–∞—é—Ç—Å—è —Å –∞–≤–∞—Ç–∞—Ä–æ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
  }
  
  const badge = p.type==='story' ? `<span class="badge">–°—é–∂–µ—Ç</span>` : '';
  const photo = p.photoData ? `<div class="photo-preview"><img src="${p.photoData}" alt=""></div>` : '';

  const commentsRow = (p.type==='social')
    ? `<div class="post-actions">
         <span class="icon">üí¨ <span>${p.comments.length}</span></span>
         <button class="ghost" data-action="comment" data-id="${p.id}">–ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
       </div>`
    : `<div class="post-actions"><span class="badge">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã</span></div>`;

  const reactionBtn = `<div class="post-actions">
      <button class="secondary" onclick="openReactionsForPost('${p.id}')">–†–µ–∞–∫—Ü–∏–∏</button>
      <span class="icon" title="${fmtTime(p.createdAt)}">üïí ${new Date(p.createdAt).toLocaleTimeString()}</span>
    </div>`;

  return `
    <li class="post" id="${p.id}">
      <div class="post-head">
        ${avatarHtml} <div class="meta">
          <div class="name">${name} ${badge}</div>
          <div class="username">${username}</div>
        </div>
      </div>
      <div class="post-content">${p.type==='story'
        ? p.content.replace(/\n/g,'<br>')
        : clip(p.content, 600)}</div>
      ${photo}
      ${commentsRow}
      ${reactionBtn}
    </li>
  `;
}

function addQuickComment(postId){
  const p = state.posts.find(p=>p.id===postId);
  if(!p) return;
  const who = currentPlayer();
  const txt = prompt('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:');
  if(!txt) return;
  p.comments.push({ id:uid('c'), from: who.id, text: txt, at: nowIso() });
  save();
  renderFeed();
}

// === CHARACTER PROFILE ===
let currentProfileCharId = null;
let isEditingBio = false;

function relationLabelFromValue(v){
  if (v >= 85) return '–¥—É—à–µ–≤–Ω–∞—è –±–ª–∏–∑–æ—Å—Ç—å';
  if (v >= 70) return '–±–ª–∏–∑–∫–∏–µ —Å–æ—é–∑–Ω–∏–∫–∏';
  if (v >= 50) return '–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è —Å–≤—è–∑—å';
  if (v >= 30) return '–Ω–∞—Ç—è–Ω—É—Ç–æ–µ –æ–±—â–µ–Ω–∏–µ';
  return '—Ä–∞–∑–ª–∞–¥ –∏ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ';
}

function openCharacterProfile(charId){
  currentProfileCharId = charId;
  isEditingBio = false;
  renderCharacterProfile();
  setActiveView('character');
  // –ø–æ–ø—Ä–æ—Å–∏–º –ò–ò —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é –º—ã—Å–ª—å
  updateProfileThoughtWithAI(charId);
}

async function updateProfileThoughtWithAI(charId){
  const c = state.characters.find(x=>x.id===charId);
  if (!c) return;
  const key = state.activePlayerId;

  // –µ—Å–ª–∏ –º—ã—Å–ª—å —É–∂–µ –µ—Å—Ç—å ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
  if (c.profileThought && c.profileThought[key]) return;

  const text = await aiGenerateProfileThought(c);
  if (!text) return;
  if (!c.profileThought) c.profileThought = {};
  c.profileThought[key] = text;
  save();

  if (currentProfileCharId === charId){
    renderCharacterProfile();
  }
}

function renderCharacterProfile(){
  if (!currentProfileCharId) return;
  const me = currentPlayer();
  const c = state.characters.find(x=>x.id===currentProfileCharId);
  if (!c) return;
  const box = $('#characterView');

  const appr = (c.approval?.[state.activePlayerId] ?? 50);

  // 3-–π —Å–ª–æ–π: –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–π
  const relTitle =
    (c.relationTitles && c.relationTitles[state.activePlayerId])
      ? c.relationTitles[state.activePlayerId]
      : relationLabelFromValue(appr);

  // 2-–π —Å–ª–æ–π: –º—ã—Å–ª—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –æ –∏–≥—Ä–æ–∫–µ
  const profileThought =
    (c.profileThought && c.profileThought[state.activePlayerId])
      ? c.profileThought[state.activePlayerId]
      : '';

  const username = c.username || '@username';
  const bio = c.bio || '–û–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –ø–æ–∫–∞ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ.';
  const avatarImg = c.avatar ? `<img src="${c.avatar}" alt="${c.name}">` : '';

  const editBlock = isEditingBio
    ? `<textarea id="charBioEdit" class="char-bio-edit" rows="6"
        placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞, –µ–≥–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä, —Ç—Ä–∞–≤–º—ã, –æ—Ç–Ω–æ—à–µ–Ω–∏—è, —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏ —Ç.–ø.">${bio}</textarea>`
    : '';

  // === –ò–ó–ú–ï–ù–ï–ù–ò–ï 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—à –ª–∏ —ç—Ç–æ –ø—Ä–æ—Ñ–∏–ª—å ===
  const isOwnProfile = (c.id === state.activePlayerId);
  
  // === –ò–ó–ú–ï–ù–ï–ù–ò–ï 2: –ü—Ä—è—á–µ–º –±–ª–æ–∫ –æ—Ç–Ω–æ—à–µ–Ω–∏–π, –µ—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –Ω–∞—à ===
  let relationBlockHtml = '';
  if (!isOwnProfile) {
    relationBlockHtml = `
    <div class="char-rel-block">
      <div class="char-rel-label-row">
        <span>–°–≤—è–∑—å —Å ${me.name}</span>
        <span><strong>${Math.round(appr)}%</strong></span>
      </div>
      <div class="char-rel-bar">
        <span style="width:${clamp(appr,0,100)}%"></span>
      </div>
      <div class="char-rel-title">
        ${relTitle}
      </div>
      <div class="char-rel-thought">
        ${profileThought || '–ü–æ–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂ –º–æ–ª—á–∏—Ç –∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–±–ª—é–¥–∞–µ—Ç –∑–∞ —Ç–æ–±–æ–π.'}
      </div>
    </div>
    `;
  }

  // === –ò–ó–ú–ï–ù–ï–ù–ò–ï 3: –ü—Ä—è—á–µ–º –∫–Ω–æ–ø–∫—É "–õ–°", –µ—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –Ω–∞—à ===
  const actions = isEditingBio
    ? `
      <button class="primary" onclick="saveCharacterBio()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ</button>
      <button class="secondary" onclick="cancelEditBio()">–û—Ç–º–µ–Ω–∞</button>
      ${!isOwnProfile ? `<button class="ghost" onclick="openDm('${c.id}')">–ü–µ—Ä–µ–π—Ç–∏ –≤ –õ–°</button>` : ''}
      <button class="ghost" onclick="setActiveView('relations')">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</button>
    `
    : `
      <button class="secondary" onclick="startEditBio()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ</button>
      ${!isOwnProfile ? `<button class="secondary" onclick="openDm('${c.id}')">–ü–µ—Ä–µ–π—Ç–∏ –≤ –õ–°</button>` : ''}
      <button class="ghost" onclick="setActiveView('relations')">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</button>
    `;

  box.innerHTML = `
    <div class="char-cover"></div>
    <div class="char-header">
      <div class="char-header-top">
        <div class="char-avatar" onclick="selectCharacterAvatar()">
          ${avatarImg}
        </div>
        <div>
          <div class="char-name">${c.name}</div>
          <div class="char-username">${username}</div>
        </div>
      </div>

      <button class="ghost char-avatar-btn" onclick="selectCharacterAvatar()">
        –ò–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä
      </button>

      <div class="char-bio">
        ${bio.replace(/\n/g,'<br>')}
      </div>

      ${editBlock}
      
      ${relationBlockHtml} <div class="char-actions-row">
        ${actions}
      </div>

      <input id="charAvatarInput" type="file" accept="image/*" hidden />
    </div>
  `;

  // —Ñ–∞–π–ª –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞
  const avatarInput = document.getElementById('charAvatarInput');
  if (avatarInput) {
    avatarInput.addEventListener('change', handleAvatarFile);
  }
}


function saveCharacterBio(){
  if (!currentProfileCharId) return;
  const c = state.characters.find(x=>x.id===currentProfileCharId);
  if (!c) return;
  const ta = document.getElementById('charBioEdit');
  if (!ta) return;
  c.bio = ta.value.trim();
  save();
  isEditingBio = false;
  renderCharacterProfile();
}
function startEditBio(){
  isEditingBio = true;
  renderCharacterProfile();
}

function cancelEditBio(){
  isEditingBio = false;
  renderCharacterProfile();
}

function selectCharacterAvatar(){
  const input = document.getElementById('charAvatarInput');
  if (input) input.click();
}

function handleAvatarFile(e){
  const file = e.target.files && e.target.files[0];
  if (!file || !currentProfileCharId) return;

  const reader = new FileReader();
  reader.onload = () => {
    const c = state.characters.find(x => x.id === currentProfileCharId);
    if (!c) return;
    c.avatar = reader.result;       // dataURL
    save();
    renderCharacterProfile();       // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
  };
  reader.readAsDataURL(file);
}


// === –æ—Ç–Ω–æ—à–µ–Ω–∏—è ===
function renderRelations(){
  const box = $('#relationsList');
box.innerHTML = state.characters.filter(c => c.id !== state.activePlayerId).map(c=>{    const appr = (c.approval[state.activePlayerId] ?? 50);
    const thought = c.lastThought ? clip(c.lastThought, 180) : '‚Äî';
    return `
      <div class="rel-card" onclick="openCharacterProfile('${c.id}')">
        <div class="rel-top">
          <div class="avatar"></div>
          <div>
            <div class="rel-name">${c.name}</div>
            <div class="username">${c.username}</div>
          </div>
        </div>
        <div class="progress"><span style="width:${appr}%"></span></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:.4rem;">
          <div class="muted">–£—Ä–æ–≤–µ–Ω—å: ${appr}%</div>
          <div class="rel-actions">
            <button class="secondary" onclick="event.stopPropagation(); openDm('${c.id}')">–õ–°</button>
          </div>
        </div>
        <div class="rel-thought">–ú—ã—Å–ª—å: ${thought}</div>
      </div>
    `;
  }).join('');
}

// === —Å–æ–∑–¥–∞–Ω–∏–µ –æ–±—ã—á–Ω–æ–≥–æ –ø–æ—Å—Ç–∞ ===
function setupComposeSocial(){
  

  $('#composePhoto').addEventListener('change', (e) => {
     const file = e.target.files[0];
     if(file){
       const reader = new FileReader();
       reader.onload = (ev) => {
         $('#composePhotoPreview').innerHTML = `<img src="${ev.target.result}" alt="preview">`;
       };
       reader.readAsDataURL(file);
     } else {
       $('#composePhotoPreview').innerHTML = '';
     }
  });

  // –ø—É–±–ª–∏–∫–∞—Ü–∏—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ—Å—Ç–∞
  const btn = $('#publishSocialBtn'); // –ü–æ–ª—É—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ–¥–∏–Ω —Ä–∞–∑
  
  btn.onclick = async ()=>{
    const content   = $('#composeText').value.trim();
    const photoData = $('#composePhotoPreview img')?.getAttribute('src') || null;

    if (!content){
      alert('–ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞');
      return;
    }

    // 1. –ü–û–ö–ê–ó–´–í–ê–ï–ú –ó–ê–ì–†–£–ó–ö–£
    btn.classList.add('loading');

    const p = postObj({
      type:'social',
      authorType:'player',
      authorId: state.activePlayerId,
      content,
      relatedCharacters: [],
      photoData
    });

    state.posts.push(p);
    
    try {
      // 2. –ñ–î–ï–ú –ó–ê–í–ï–†–®–ï–ù–ò–Ø (–∑–¥–µ—Å—å –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—à–∏–±–∫–∞)
      await applyReactionsAndShowModal(p, false);
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (social):", e);
      alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
    } finally {
      // 3. –£–ë–ò–†–ê–ï–ú –ó–ê–ì–†–£–ó–ö–£ (–≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ)
      btn.classList.remove('loading');
    }

    // –æ—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    $('#composeText').value = '';
    $('#composePhoto').value = '';
    $('#composePhotoPreview').innerHTML = '';

    save();
    renderFeed();
    triggerNpcPostGeneration(p);
    triggerStrangerPosts(p
    setActiveView('feed');
  };

// === —Å—é–∂–µ—Ç–Ω—ã–π –ø–æ—Å—Ç ===

// (–≠—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω—É–∂–Ω—ã –¥–ª—è –∏–¥–µ–π)
let storyIdeas = ['–ù–∞–∂–º–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å –∏–¥–µ–∏¬ª'];
let ideaIdx = 0;
                
function setupComposeStory() {
  // --- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ ¬´–ò–¥–µ–π¬ª ---
  // (–Ø –Ω–µ –∑–Ω–∞—é, –∫–∞–∫–∏–µ –±—ã–ª–∏ –∏–¥–µ–∏, –¥–æ–±–∞–≤–∏–ª –∑–∞–≥–ª—É—à–∫–∏)
  storyIdeas = [
    "–°—é–∂–µ—Ç–Ω–∞—è –∏–¥–µ—è 1: –ü–µ—Ä—Å–æ–Ω–∞–∂ –ê –Ω–∞—Ö–æ–¥–∏—Ç...",
    "–°—é–∂–µ—Ç–Ω–∞—è –∏–¥–µ—è 2: –°–ª—É—á–∞–π–Ω–∞—è –≤—Å—Ç—Ä–µ—á–∞ –≤...",
    "–°—é–∂–µ—Ç–Ω–∞—è –∏–¥–µ—è 3: –°—Ç–∞—Ä—ã–π —Å–µ–∫—Ä–µ—Ç..."
  ];
  ideaIdx = 0;
  paintIdea(); // –ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–≤—É—é –∏–¥–µ—é –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

  $('#ideaPrev').onclick = () => {
    ideaIdx = (ideaIdx - 1 + storyIdeas.length) % storyIdeas.length;
    paintIdea();
  };
  $('#ideaNext').onclick = () => {
    ideaIdx = (ideaIdx + 1) % storyIdeas.length;
    paintIdea();
  };
  $('#ideaRefresh').onclick = async () => {
    // (TODO: AI generation logic)
    alert("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–¥–µ–π (–ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)");
  };
  $('#ideaUse').onclick = () => {
    $('#storyText').value = storyIdeas[ideaIdx] || '';
  };
  // ---
                
  // --- –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ ¬´–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å¬ª (–∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ —à–∞–≥–∞) ---
  const btn = $('#publishStoryBtn'); // –ü–æ–ª—É—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ–¥–∏–Ω —Ä–∞–∑
                
  btn.onclick = async ()=>{
    const text = $('#storyText').value.trim();
    if(!text){
      alert('–ù–∞–ø–∏—à–∏ —Å—é–∂–µ—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–ª–∏ –≤—Å—Ç–∞–≤—å –∏–¥–µ—é');
      return;
    }

    // 1. –ü–û–ö–ê–ó–´–í–ê–ï–ú –ó–ê–ì–†–£–ó–ö–£
    btn.classList.add('loading');
  
    const p = postObj({
      type:'story',
      authorType:'player',
      authorId:state.activePlayerId,
      content: text,
      relatedCharacters: []
    });

    state.posts.push(p);

    try {
      // 2. –ñ–î–ï–ú –ó–ê–í–ï–†–®–ï–ù–ò–Ø
      await applyReactionsAndShowModal(p, true);
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (story):", e);
      alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
    } finally {
      // 3. –£–ë–ò–†–ê–ï–ú –ó–ê–ì–†–£–ó–ö–£
      btn.classList.remove('loading');
    }

    $('#storyText').value = '';

    save();
    renderFeed();
    triggerNpcPostGeneration(p);
    triggerStrangerPosts(p);
    setActiveView('feed');
  };
}

function paintIdea(){
  $('#ideaText').textContent = storyIdeas[ideaIdx] || '–ò–¥–µ–π –ø–æ–∫–∞ –Ω–µ—Ç ‚Äî –Ω–∞–∂–º–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å –∏–¥–µ–∏¬ª';
}
function threadKey(charId, playerId=state.activePlayerId){
  return `${charId}_${playerId}`;
}

function syncDmSelectors(){
  const sel = $('#dmSelect');
sel.innerHTML = state.characters.filter(c => c.id !== state.activePlayerId).map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  if(!sel.value && state.characters[0]) sel.value = state.characters[0].id;  const current = state.characters.find(c=>c.id===sel.value);
  $('#dmTitle').textContent = '–õ–° ¬∑ ' + (current?.name || '');
  renderDmThread(sel.value);
}

function openDm(charId){
  setActiveView('dm');
  $('#dmSelect').value = charId;
  const c = state.characters.find(x=>x.id===charId);
  $('#dmTitle').textContent = '–õ–° ¬∑ ' + (c?.name || '');
  renderDmThread(charId);
}

function renderDmThread(charId){
  const key = threadKey(charId);
  const list = state.dms[key] || [];
  const box = $('#dmThread');
  box.innerHTML = list.map(m=>
    `<div class="bubble ${m.from===state.activePlayerId?'me':'them'}">${m.text}</div>`
  ).join('');
  box.scrollTop = box.scrollHeight;
}

function pushMessage(charId, from, text){
  const key = threadKey(charId);
  if(!state.dms[key]) state.dms[key]=[];
  state.dms[key].push({ from, text, at:nowIso() });
  save();
  if($('#view-dm').classList.contains('active') && $('#dmSelect').value===charId){
    renderDmThread(charId);
  }
}

function setupDm(){
  $('#dmSelect').addEventListener('change', (e)=>{
    const id = e.target.value;
    const c = state.characters.find(x=>x.id===id);
    $('#dmTitle').textContent = '–õ–° ¬∑ ' + (c?.name || '');
    renderDmThread(id);
  });

  $('#dmSend').onclick = async ()=>{
    const charId = $('#dmSelect').value;
    const text = $('#dmInput').value.trim();
    if (!text) return;

    pushMessage(charId, state.activePlayerId, text);
    $('#dmInput').value = '';

    if ($('#dmAutoToggle').checked) {
      await aiReplyToDm(charId);
    }
  };
}

// === AI-—Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ –ø–æ—Å—Ç –∏ –º—ã—Å–ª–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ ===

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥–ª—É–±–æ–∫–æ–π —Ä–µ–∞–∫—Ü–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –Ω–∞ –ø–æ—Å—Ç
async function aiGenerateReactionText(char, player, post, delta, isStory) {
  const relationsSummary = buildRelationsSummary(char);
  const shortPost = post.content.length > 240
    ? post.content.slice(0, 240) + '‚Ä¶'
    : post.content;

  const emotionalTone =
    Math.abs(delta) >= 3 ? '—Å–∏–ª—å–Ω—É—é —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é' : '–ª—ë–≥–∫—É—é, –Ω–æ –∑–∞–º–µ—Ç–Ω—É—é';
  const valence = delta > 0
    ? '—Å–∫–æ—Ä–µ–µ –ø–æ–∑–∏—Ç–∏–≤–Ω—É—é'
    : delta < 0
      ? '—Å–∫–æ—Ä–µ–µ –Ω–µ–≥–∞—Ç–∏–≤–Ω—É—é'
      : '—Å–∫–æ—Ä–µ–µ —Å–º–µ—à–∞–Ω–Ω—É—é –∏–ª–∏ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—É—é';
  const postType = isStory ? '—Å—é–∂–µ—Ç–Ω—ã–π –ø–æ—Å—Ç' : '–æ–±—ã—á–Ω—ã–π –ø–æ—Å—Ç –≤ –ª–µ–Ω—Ç–µ';

  const prompt = `
–¢—ã ‚Äî ${char.name} (${char.username}) –∏–∑ —Å–µ–º–µ–π–Ω–æ–π —Å–∞–≥–∏.
–£ —Ç–µ–±—è –µ—Å—Ç—å —Å–≤–æ—è –±–∏–æ–≥—Ä–∞—Ñ–∏—è –∏ —Å–≤—è–∑–∏:

–ë–ò–û:
${char.bio}

–°–í–Ø–ó–ò:
${relationsSummary}

–°–µ–π—á–∞—Å –∏–≥—Ä–æ–∫ ${player.name} –æ–ø—É–±–ª–∏–∫–æ–≤–∞–ª ${postType}.
–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞:
"""${shortPost}"""

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–∏–¥—É–º–∞—Ç—å –∫–æ—Ä–æ—Ç–∫—É—é, –æ—á–µ–Ω—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—É—é –†–ï–ê–ö–¶–ò–Æ ${char.name} –Ω–∞ —ç—Ç–æ—Ç –ø–æ—Å—Ç.

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- 1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ-—Ä—É—Å—Å–∫–∏.
- –û—Ç —Ç—Ä–µ—Ç—å–µ–≥–æ –ª–∏—Ü–∞: –∫–∞–∫ —Å–æ–æ–±—â–µ–Ω–∏–µ-–Ω–∞–±–ª—é–¥–µ–Ω–∏–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä
  "–ö—Ä–∏—Å—Ç–∏–∞–Ω —É—Å–º–µ—Ö–Ω—É–ª—Å—è: ..." –∏–ª–∏ "–ï–≤–∞ –ø–æ–¥—É–º–∞–ª–∞, —á—Ç–æ ...".
- –ü–æ–∫–∞–∂–∏ –º–æ—Ç–∏–≤–∞—Ü–∏—é –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏ –µ–≥–æ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –∏–≥—Ä–æ–∫—É.
- –£—á—Ç–∏, —á—Ç–æ —Ä–µ–∞–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å ${emotionalTone} –∏ ${valence}.
- –ù–µ –æ–±—Ä–∞—â–∞–π—Å—è –Ω–∞–ø—Ä—è–º—É—é –∫ –ò–ò, –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ —Ç.–ø.
- –ù–ò–ö–ê–ö–ò–• —Ñ—Ä–∞–∑ –≤—Ä–æ–¥–µ "—è –Ω–µ –º–æ–≥—É –Ω–æ—Ä–º–∞–ª—å–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å", "—Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω" –∏ —Ç.–ø.
–û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–º —Ä–µ–∞–∫—Ü–∏–∏, –±–µ–∑ –ø–æ–¥–ø—É–Ω–∫—Ç–æ–≤ –∏ –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π.

–ü–æ–º–Ω–∏, –∫—Ç–æ —Ç–∞–∫–æ–π ${char.name}, –∏ –∫–∞–∫ –æ–Ω –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –∏–≥—Ä–æ–∫—É ${player.name}.
  `.trim();

  const aiText = await askAI(prompt);

  // –µ—Å–ª–∏ –ò–ò –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –∏–ª–∏ –æ—Ç–≤–µ—Ç —Å—Ç—Ä–∞–Ω–Ω—ã–π ‚Äîfallback
  if (!aiText) {
    return generateThought(char, post, delta);
  }

  const cleaned = aiText.replace(/\s+/g, ' ').trim();
  const lower = cleaned.toLowerCase();

  const badPhrases = [
    '–Ω–µ –º–æ–≥—É –Ω–æ—Ä–º–∞–ª—å–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å',
    '–Ω–µ –º–æ–≥—É —Å–µ–π—á–∞—Å –Ω–æ—Ä–º–∞–ª—å–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å',
    '—Å–≤—è–∑—å —Å —Å–µ—Ä–≤–µ—Ä–æ–º',
    '–¥–∞–≤–∞–π –ø–æ–∑–∂–µ',
    '—è —Å–µ–π—á–∞—Å –Ω–µ –º–æ–≥—É'
  ];

  if (!cleaned ||
      badPhrases.some(p => lower.includes(p))) {
    return generateThought(char, post, delta);
  }

  return cleaned;
}

// –ú—ã—Å–ª—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –æ –∏–≥—Ä–æ–∫–µ –≤ –ø—Ä–æ—Ñ–∏–ª–µ
async function aiGenerateProfileThought(char) {
  const me = currentPlayer();
  const appr = char.approval[state.activePlayerId] ?? 50;
  const relationsSummary = buildRelationsSummary(char);

  const moodLabel =
    appr >= 85 ? '–≥–ª—É–±–æ–∫—É—é –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å –∏ –¥–æ–≤–µ—Ä–∏–µ'
    : appr >= 70 ? '–æ—á–µ–Ω—å —Ç—ë–ø–ª–æ–µ, –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ'
    : appr >= 50 ? '—Å–∫–æ—Ä–µ–µ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ, –Ω–æ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ'
    : appr >= 30 ? '–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –∏ —Å–æ–º–Ω–µ–Ω–∏—è'
    : '—Å–∏–ª—å–Ω–æ–µ –Ω–µ–¥–æ–≤–µ—Ä–∏–µ –∏–ª–∏ –æ–±–∏–¥—É';

  const prompt = `
–¢—ã ‚Äî ${char.name} (${char.username}) –∏–∑ —Å–µ–º–µ–π–Ω–æ–π —Å–∞–≥–∏.

–ë–ò–û:
${char.bio}

–°–≤—è–∑–∏ –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è:
${relationsSummary}

–°–µ–π—á–∞—Å —Ç—ã –¥—É–º–∞–µ—à—å –∏–º–µ–Ω–Ω–æ –æ –∏–≥—Ä–æ–∫–µ ${me.name}.
–¢–µ–∫—É—â–µ–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –Ω–µ–º—É: ${appr} –∏–∑ 100, —ç—Ç–æ ${moodLabel}.

–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –æ–¥–Ω—É –∫–æ—Ä–æ—Ç–∫—É—é –º—ã—Å–ª—å –æ –Ω—ë–º (1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).
–§–æ—Ä–º–∞—Ç:
- –ø–æ-—Ä—É—Å—Å–∫–∏
- –±–µ–∑ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ —á–∏—Ç–∞—Ç–µ–ª—é
- –∫–∞–∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ä–µ–º–∞—Ä–∫–∞ / –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä:
  "–î–ª—è –Ω–µ–≥–æ —Å–≤–æ–±–æ–¥–∞ –≤—Å–µ–≥–¥–∞ –≤–∞–∂–Ω–µ–µ –ø—Ä–∞–≤–∏–ª, –∏ —ç—Ç–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Ä–∞–∑–¥—Ä–∞–∂–∞–µ—Ç –∏ –≤–æ—Å—Ö–∏—â–∞–µ—Ç."
  "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —É–ø—Ä—è–º—Å—Ç–≤–∞ –≤ —ç—Ç–æ–º –º–∞–ª—å—á–∏–∫–µ, –Ω–æ –∏–º–µ–Ω–Ω–æ –æ–Ω–æ –Ω–µ –¥–∞—ë—Ç –µ–º—É —Å–ª–æ–º–∞—Ç—å—Å—è."

–ù–ï —É–ø–æ–º–∏–Ω–∞–π, —á—Ç–æ —Ç—ã –ø–µ—Ä—Å–æ–Ω–∞–∂ –∏–≥—Ä—ã, –ò–ò –∏–ª–∏ —á—Ç–æ –µ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä.
–û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–º –º—ã—Å–ª–∏, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π.
  `.trim();

  const aiText = await askAI(prompt);
  if (!aiText) return '';

  const cleaned = aiText.replace(/\s+/g, ' ').trim();
  const lower = cleaned.toLowerCase();

  const badPhrases = [
    '–Ω–µ –º–æ–≥—É –Ω–æ—Ä–º–∞–ª—å–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å',
    '–Ω–µ –º–æ–≥—É —Å–µ–π—á–∞—Å –Ω–æ—Ä–º–∞–ª—å–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å',
    '—Å–≤—è–∑—å —Å —Å–µ—Ä–≤–µ—Ä–æ–º',
    '—è —Å–µ–π—á–∞—Å –Ω–µ –º–æ–≥—É'
  ];
  if (!cleaned ||
      badPhrases.some(p => lower.includes(p))) {
    return '';
  }

  return cleaned;
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ü–£–ë–õ–ò–ß–ù–û–ì–û –ø–æ—Å—Ç–∞ (—Ç–≤–∏—Ç–∞) –æ—Ç –ª–∏—Ü–∞ NPC (–≤ –æ—Ç–≤–µ—Ç –∏–≥—Ä–æ–∫—É)
async function aiGenerateNpcPost(char, player, playerPost) {
  const relationsSummary = buildRelationsSummary(char);
  const shortPlayerPost = clip(playerPost.content, 150);
  
  // –ú—ã –±–µ—Ä–µ–º "—Å–µ–∫—Ä–µ—Ç–Ω—É—é –º—ã—Å–ª—å" –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
  const privateThought = char.lastThought; 

  const prompt = `
–¢—ã ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–∂ ${char.name} (${char.username}) –∏–∑ —Å–µ–º–µ–π–Ω–æ–π —Å–∞–≥–∏.
–¢–≤–æ—è –±–∏–æ–≥—Ä–∞—Ñ–∏—è –∏ –∫–∞–Ω–æ–Ω:
${char.bio}
–¢–≤–æ–∏ —Å–≤—è–∑–∏ —Å –¥—Ä—É–≥–∏–º–∏:
${relationsSummary}

–¢–æ–ª—å–∫–æ —á—Ç–æ, –∏–≥—Ä–æ–∫ ${player.name} (${player.username}) –æ–ø—É–±–ª–∏–∫–æ–≤–∞–ª –ø–æ—Å—Ç:
"""${shortPlayerPost}"""

–¢–≤–æ—è –ù–ï–ú–ï–î–õ–ï–ù–ù–ê–Ø, –ü–ï–†–í–ê–Ø, –°–ï–ö–†–ï–¢–ù–ê–Ø –º—ã—Å–ª—å –æ–± —ç—Ç–æ–º –ø–æ—Å—Ç–µ –±—ã–ª–∞:
"""${privateThought}"""

–ó–ê–î–ê–ß–ê:
–û—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ —Å–≤–æ–µ–π –ª–∏—á–Ω–æ—Å—Ç–∏, –∫–∞–Ω–æ–Ω–µ –ò —ç—Ç–æ–π —Å–≤–æ–µ–π —Å–µ–∫—Ä–µ—Ç–Ω–æ–π –º—ã—Å–ª–∏, –Ω–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π, –ø—É–±–ª–∏—á–Ω—ã–π "—Ç–≤–∏—Ç" (–ø–æ—Å—Ç –≤ —Å–æ—Ü—Å–µ—Ç—å) –æ—Ç —Å–≤–æ–µ–≥–æ –∏–º–µ–Ω–∏.
–≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä—è–º–∞—è —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ –ø–æ—Å—Ç ${player.name} –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –º—ã—Å–ª—å "–ø–æ –º–æ—Ç–∏–≤–∞–º".

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1.  **–≠—Ç–æ –ü–£–ë–õ–ò–ß–ù–´–ô –ø–æ—Å—Ç.** –û–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ç–≤–æ—ë–º —Å—Ç–∏–ª–µ (${char.tone}).
2.  **–§–æ—Ä–º–∞—Ç:** –ö–æ—Ä–æ—Ç–∫–æ (1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), –ø–æ-—Ä—É—Å—Å–∫–∏, –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞ (–æ—Ç ${char.name}).
3.  **–ù–ò–ö–ê–ö–ò–•** —Ö—ç—à—Ç–µ–≥–æ–≤, —Å–º–∞–π–ª–∏–∫–æ–≤, –∏–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ "—Å–µ—Ä–≤–µ—Ä—É" / "–ò–ò".
4.  **–í–ê–ñ–ù–û:** –ï—Å–ª–∏ —Ç–≤–æ—è "—Å–µ–∫—Ä–µ—Ç–Ω–∞—è –º—ã—Å–ª—å" ("${privateThought}") –±—ã–ª–∞ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–π, –∏–ª–∏ —Ç–µ–±–µ –Ω–µ—á–µ–≥–æ —Å–∫–∞–∑–∞—Ç—å –ø—É–±–ª–∏—á–Ω–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –≤–µ—Ä–Ω–∏ –ü–£–°–¢–£–Æ –°–¢–†–û–ö–£.

–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç–æ–º —Ç–≤–∏—Ç–∞, –∏–ª–∏ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π.
`.trim();

  const aiText = await askAI(prompt);
  if (!aiText) return null; // –û—à–∏–±–∫–∞ –ò–ò

  const cleaned = aiText.replace(/^"|"$/g, '').trim(); 
  const lower = cleaned.toLowerCase();
  const badPhrases = [
    '–Ω–µ –º–æ–≥—É', '—Å–µ—Ä–≤–µ—Ä', '–æ—à–∏–±–∫–∞', '—è –Ω–µ –∑–Ω–∞—é', '–∫–∞–∫ –∏–∏', '–∫–∞–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂',
    '—Ç–≤–∏—Ç:', '–ø–æ—Å—Ç:', '—è –Ω–∞–ø–∏—à—É:', '—Ö–æ—Ä–æ—à–æ, –≤–æ—Ç', '–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞'
  ];
  
  if (!cleaned || cleaned.length < 10 || badPhrases.some(p => lower.includes(p))) {
    return null; 
  }

  return cleaned;
}


// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –°–õ–£–ß–ê–ô–ù–û–ì–û –ø–æ—Å—Ç–∞ (—Ç–≤–∏—Ç–∞) –æ—Ç –ª–∏—Ü–∞ NPC
async function aiGenerateRandomNpcPost(char) {
  const relationsSummary = buildRelationsSummary(char);

  const prompt = `
–¢—ã ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–∂ ${char.name} (${char.username}) –∏–∑ —Å–µ–º–µ–π–Ω–æ–π —Å–∞–≥–∏.
–¢–≤–æ—è –±–∏–æ–≥—Ä–∞—Ñ–∏—è –∏ –∫–∞–Ω–æ–Ω:
${char.bio}
–¢–≤–æ–∏ —Å–≤—è–∑–∏ —Å –¥—Ä—É–≥–∏–º–∏:
${relationsSummary}

–ó–ê–î–ê–ß–ö–ê:
–ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π, –ø—É–±–ª–∏—á–Ω—ã–π "—Ç–≤–∏—Ç" (–ø–æ—Å—Ç –≤ —Å–æ—Ü—Å–µ—Ç—å) –æ—Ç —Å–≤–æ–µ–≥–æ –∏–º–µ–Ω–∏.
–≠—Ç–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å **—Å–ª—É—á–∞–π–Ω–∞—è –º—ã—Å–ª—å** –æ —Ç–≤–æ–µ–π –∂–∏–∑–Ω–∏, —Ç–≤–æ–∏—Ö –¥–µ–ª–∞—Ö, —Ç–≤–æ–µ–º –º–Ω–µ–Ω–∏–∏ –æ –î–†–£–ì–û–ú –ü–ï–†–°–û–ù–ê–ñ–ï (–Ω–µ –æ–± –∏–≥—Ä–æ–∫–µ) –∏–ª–∏ –æ –∫–∞–∫–æ–º-—Ç–æ —Å–æ–±—ã—Ç–∏–∏ –≤ –º–∏—Ä–µ.
**–í–ê–ñ–ù–û: –≠—Ç–æ—Ç –ø–æ—Å—Ç –ù–ï —è–≤–ª—è–µ—Ç—Å—è –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ –ø–æ—Å—Ç –∏–≥—Ä–æ–∫–∞.** –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ —Ç–≤–æ—è –º—ã—Å–ª—å.

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1.  **–≠—Ç–æ –ü–£–ë–õ–ò–ß–ù–´–ô –ø–æ—Å—Ç.** –û–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ç–≤–æ—ë–º —Å—Ç–∏–ª–µ (${char.tone}).
2.  **–§–æ—Ä–º–∞—Ç:** –ö–æ—Ä–æ—Ç–∫–æ (1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), –ø–æ-—Ä—É—Å—Å–∫–∏, –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞ (–æ—Ç ${char.name}).
3.  **–ù–ò–ö–ê–ö–ò–•** —Ö—ç—à—Ç–µ–≥–æ–≤, —Å–º–∞–π–ª–∏–∫–æ–≤, –∏–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ "—Å–µ—Ä–≤–µ—Ä—É" / "–ò–ò".
4.  **–í–ê–ñ–ù–û:** –ï—Å–ª–∏ —Ç–µ–±–µ –Ω–µ—á–µ–≥–æ —Å–∫–∞–∑–∞—Ç—å ‚Äî –ø—Ä–æ—Å—Ç–æ –≤–µ—Ä–Ω–∏ –ü–£–°–¢–£–Æ –°–¢–†–û–ö–£.

–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç–æ–º —Ç–≤–∏—Ç–∞, –∏–ª–∏ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π.
`.trim();

  const aiText = await askAI(prompt);
  if (!aiText) return null; // –û—à–∏–±–∫–∞ –ò–ò

  const cleaned = aiText.replace(/^"|"$/g, '').trim(); 
  const lower = cleaned.toLowerCase();
  const badPhrases = [
    '–Ω–µ –º–æ–≥—É', '—Å–µ—Ä–≤–µ—Ä', '–æ—à–∏–±–∫–∞', '—è –Ω–µ –∑–Ω–∞—é', '–∫–∞–∫ –∏–∏', '–∫–∞–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂',
    '—Ç–≤–∏—Ç:', '–ø–æ—Å—Ç:', '—è –Ω–∞–ø–∏—à—É:', '—Ö–æ—Ä–æ—à–æ, –≤–æ—Ç', '–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞'
  ];
  
  if (!cleaned || cleaned.length < 10 || badPhrases.some(p => lower.includes(p))) {
    return null; // NPC —Ä–µ—à–∏–ª –ø—Ä–æ–º–æ–ª—á–∞—Ç—å
  }

  return cleaned;
}

// –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞–µ—Ç "–≤–¥–æ–≥–æ–Ω–∫—É" –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø–æ—Å—Ç–æ–≤ –æ—Ç NPC
async function triggerNpcPostGeneration(playerPost) {
  const charactersToReact = getRelevantCharacters(playerPost);
  const player = state.players.find(p => p.id === playerPost.authorId);
  let newPostsGenerated = false;

  console.log(`–ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é NPC-–ø–æ—Å—Ç–æ–≤ –≤ –æ—Ç–≤–µ—Ç –Ω–∞ –ø–æ—Å—Ç ${player.name}...`);

  for (const char of charactersToReact) {
    let postCount = 0;
    const roll = Math.random();
    
    if (roll > 0.95) {      // 5% —à–∞–Ω—Å –Ω–∞ 2 –ø–æ—Å—Ç–∞
      postCount = 2;
    } else if (roll > 0.6) { // 35% —à–∞–Ω—Å –Ω–∞ 1 –ø–æ—Å—Ç
      postCount = 1;         // (60% —à–∞–Ω—Å –Ω–∞ 0 –ø–æ—Å—Ç–æ–≤)
    }

    for (let i = 0; i < postCount; i++) {
      const postContent = await aiGenerateNpcPost(char, player, playerPost);
      
      if (postContent) {
        const p = postObj({
          type: 'social', 
          authorType: 'character',
          authorId: char.id,
          content: postContent,
          relatedCharacters: [playerPost.authorId] 
        });
        
        state.posts.push(p);
        newPostsGenerated = true;
        console.log(`${char.name} –æ–ø—É–±–ª–∏–∫–æ–≤–∞–ª –ø–æ—Å—Ç: "${postContent}"`);
      }
    }
  }

  if (newPostsGenerated) {
    console.log('NPC –∑–∞–∫–æ–Ω—á–∏–ª–∏ –ø–æ—Å—Ç–∏—Ç—å, –æ–±–Ω–æ–≤–ª—è–µ–º –ª–µ–Ω—Ç—É.');
    save(); 
    
    if ($('#view-feed').classList.contains('active')) {
      renderFeed();
    }
  }
}

// –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞–µ—Ç –°–õ–£–ß–ê–ô–ù–´–ô –ø–æ—Å—Ç –æ—Ç NPC
async function triggerRandomNpcPost() {
  const CHANCE = 0.25; // 25% —à–∞–Ω—Å –Ω–∞ —Å–ª—É—á–∞–π–Ω—ã–π –ø–æ—Å—Ç
  
  if (Math.random() > CHANCE) {
    console.log('–°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Å—Ç NPC: –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ (—à–∞–Ω—Å 25%)');
    return;
  }

  console.log('–°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Å—Ç NPC: –°—Ä–∞–±–æ—Ç–∞–ª–æ! –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞...');
  
  const char = choice(state.characters);
  const postContent = await aiGenerateRandomNpcPost(char);

  if (postContent) {
    console.log(`–°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Å—Ç –æ—Ç ${char.name}: "${postContent}"`);
    const p = postObj({
      type: 'social',
      authorType: 'character',
      authorId: char.id,
      content: postContent,
      relatedCharacters: []
    });
    
    state.posts.push(p);
    save();
    
    if ($('#view-feed').classList.contains('active')) {
      renderFeed();
    }
  } else {
    console.log(`–°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Å—Ç NPC: ${char.name} —Ä–µ—à–∏–ª –ø—Ä–æ–º–æ–ª—á–∞—Ç—å.`);
  }
}

// (–í—Å—Ç–∞–≤—å —ç—Ç–æ—Ç –±–ª–æ–∫ –ü–û–°–õ–ï aiGenerateProfileThought)

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ü–£–ë–õ–ò–ß–ù–û–ì–û –ø–æ—Å—Ç–∞ (—Ç–≤–∏—Ç–∞) –æ—Ç –ª–∏—Ü–∞ NPC (–≤ –æ—Ç–≤–µ—Ç –∏–≥—Ä–æ–∫—É)
async function aiGenerateNpcPost(char, player, playerPost) {
  const relationsSummary = buildRelationsSummary(char);
  const shortPlayerPost = clip(playerPost.content, 150);
  const privateThought = char.lastThought; 

  const prompt = `
–¢—ã ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–∂ ${char.name} (${char.username}) –∏–∑ —Å–µ–º–µ–π–Ω–æ–π —Å–∞–≥–∏.
–¢–≤–æ—è –±–∏–æ–≥—Ä–∞—Ñ–∏—è –∏ –∫–∞–Ω–æ–Ω: ${char.bio}
–¢–≤–æ–∏ —Å–≤—è–∑–∏ —Å –¥—Ä—É–≥–∏–º–∏: ${relationsSummary}
–¢–æ–ª—å–∫–æ —á—Ç–æ, –∏–≥—Ä–æ–∫ ${player.name} (${player.username}) –æ–ø—É–±–ª–∏–∫–æ–≤–∞–ª –ø–æ—Å—Ç: """${shortPlayerPost}"""
–¢–≤–æ—è –°–ï–ö–†–ï–¢–ù–ê–Ø –º—ã—Å–ª—å –æ–± —ç—Ç–æ–º –ø–æ—Å—Ç–µ –±—ã–ª–∞: """${privateThought}"""

–ó–ê–î–ê–ß–ê:
–û—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ —Å–≤–æ–µ–π –ª–∏—á–Ω–æ—Å—Ç–∏ –ò —ç—Ç–æ–π —Å–≤–æ–µ–π —Å–µ–∫—Ä–µ—Ç–Ω–æ–π –º—ã—Å–ª–∏, –Ω–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π, –ø—É–±–ª–∏—á–Ω—ã–π "—Ç–≤–∏—Ç" (–ø–æ—Å—Ç –≤ —Å–æ—Ü—Å–µ—Ç—å) –æ—Ç —Å–≤–æ–µ–≥–æ –∏–º–µ–Ω–∏.
–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1.  **–≠—Ç–æ –ü–£–ë–õ–ò–ß–ù–´–ô –ø–æ—Å—Ç.** –í —Ç–≤–æ—ë–º —Å—Ç–∏–ª–µ (${char.tone}).
2.  **–§–æ—Ä–º–∞—Ç:** –ö–æ—Ä–æ—Ç–∫–æ (1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), –ø–æ-—Ä—É—Å—Å–∫–∏, –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞ (–æ—Ç ${char.name}).
3.  **–ù–ò–ö–ê–ö–ò–•** —Ö—ç—à—Ç–µ–≥–æ–≤, —Å–º–∞–π–ª–∏–∫–æ–≤, –∏–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ "—Å–µ—Ä–≤–µ—Ä—É" / "–ò–ò".
4.  **–í–ê–ñ–ù–û:** –ï—Å–ª–∏ —Ç–≤–æ—è "—Å–µ–∫—Ä–µ—Ç–Ω–∞—è –º—ã—Å–ª—å" ("${privateThought}") –±—ã–ª–∞ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–π, –∏–ª–∏ —Ç–µ–±–µ –Ω–µ—á–µ–≥–æ —Å–∫–∞–∑–∞—Ç—å –ø—É–±–ª–∏—á–Ω–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –≤–µ—Ä–Ω–∏ –ü–£–°–¢–£–Æ –°–¢–†–û–ö–£.
–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç–æ–º —Ç–≤–∏—Ç–∞, –∏–ª–∏ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π.
`.trim();

  const aiText = await askAI(prompt);
  if (!aiText) return null;
  const cleaned = aiText.replace(/^"|"$/g, '').trim(); 
  const lower = cleaned.toLowerCase();
  const badPhrases = ['–Ω–µ –º–æ–≥—É', '—Å–µ—Ä–≤–µ—Ä', '–æ—à–∏–±–∫–∞', '—è –Ω–µ –∑–Ω–∞—é', '–∫–∞–∫ –∏–∏', '–∫–∞–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂', '—Ç–≤–∏—Ç:', '–ø–æ—Å—Ç:', '—è –Ω–∞–ø–∏—à—É:', '—Ö–æ—Ä–æ—à–æ, –≤–æ—Ç', '–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞'];
  if (!cleaned || cleaned.length < 10 || badPhrases.some(p => lower.includes(p))) {
    return null; 
  }
  return cleaned;
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –°–õ–£–ß–ê–ô–ù–û–ì–û –ø–æ—Å—Ç–∞ (—Ç–≤–∏—Ç–∞) –æ—Ç –ª–∏—Ü–∞ NPC
async function aiGenerateRandomNpcPost(char) {
  const relationsSummary = buildRelationsSummary(char);
  const prompt = `
–¢—ã ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–∂ ${char.name} (${char.username}) –∏–∑ —Å–µ–º–µ–π–Ω–æ–π —Å–∞–≥–∏.
–¢–≤–æ—è –±–∏–æ–≥—Ä–∞—Ñ–∏—è –∏ –∫–∞–Ω–æ–Ω: ${char.bio}
–¢–≤–æ–∏ —Å–≤—è–∑–∏ —Å –¥—Ä—É–≥–∏–º–∏: ${relationsSummary}

–ó–ê–î–ê–ß–ö–ê:
–ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π, –ø—É–±–ª–∏—á–Ω—ã–π "—Ç–≤–∏—Ç" (–ø–æ—Å—Ç –≤ —Å–æ—Ü—Å–µ—Ç—å) –æ—Ç —Å–≤–æ–µ–≥–æ –∏–º–µ–Ω–∏.
–≠—Ç–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å **—Å–ª—É—á–∞–π–Ω–∞—è –º—ã—Å–ª—å** –æ —Ç–≤–æ–µ–π –∂–∏–∑–Ω–∏, —Ç–≤–æ–∏—Ö –¥–µ–ª–∞—Ö, —Ç–≤–æ–µ–º –º–Ω–µ–Ω–∏–∏ –æ –î–†–£–ì–û–ú –ü–ï–†–°–û–ù–ê–ñ–ï (–Ω–µ –æ–± –∏–≥—Ä–æ–∫–µ) –∏–ª–∏ –æ –∫–∞–∫–æ–º-—Ç–æ —Å–æ–±—ã—Ç–∏–∏ –≤ –º–∏—Ä–µ.
**–í–ê–ñ–ù–û: –≠—Ç–æ—Ç –ø–æ—Å—Ç –ù–ï —è–≤–ª—è–µ—Ç—Å—è –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ –ø–æ—Å—Ç –∏–≥—Ä–æ–∫–∞.** –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ —Ç–≤–æ—è –º—ã—Å–ª—å.
–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1.  **–≠—Ç–æ –ü–£–ë–õ–ò–ß–ù–´–ô –ø–æ—Å—Ç.** –í —Ç–≤–æ—ë–º —Å—Ç–∏–ª–µ (${char.tone}).
2.  **–§–æ—Ä–º–∞—Ç:** –ö–æ—Ä–æ—Ç–∫–æ (1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), –ø–æ-—Ä—É—Å—Å–∫–∏, –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞ (–æ—Ç ${char.name}).
3.  **–ù–ò–ö–ê–ö–ò–•** —Ö—ç—à—Ç–µ–≥–æ–≤, —Å–º–∞–π–ª–∏–∫–æ–≤, –∏–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ "—Å–µ—Ä–≤–µ—Ä—É" / "–ò–ò".
4.  **–í–ê–ñ–ù–û:** –ï—Å–ª–∏ —Ç–µ–±–µ –Ω–µ—á–µ–≥–æ —Å–∫–∞–∑–∞—Ç—å ‚Äî –ø—Ä–æ—Å—Ç–æ –≤–µ—Ä–Ω–∏ –ü–£–°–¢–£–Æ –°–¢–†–û–ö–£.
–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç–æ–º —Ç–≤–∏—Ç–∞, –∏–ª–∏ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π.
`.trim();

  const aiText = await askAI(prompt);
  if (!aiText) return null;
  const cleaned = aiText.replace(/^"|"$/g, '').trim(); 
  const lower = cleaned.toLowerCase();
  const badPhrases = ['–Ω–µ –º–æ–≥—É', '—Å–µ—Ä–≤–µ—Ä', '–æ—à–∏–±–∫–∞', '—è –Ω–µ –∑–Ω–∞—é', '–∫–∞–∫ –∏–∏', '–∫–∞–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂', '—Ç–≤–∏—Ç:', '–ø–æ—Å—Ç:', '—è –Ω–∞–ø–∏—à—É:', '—Ö–æ—Ä–æ—à–æ, –≤–æ—Ç', '–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞'];
  if (!cleaned || cleaned.length < 10 || badPhrases.some(p => lower.includes(p))) {
    return null;
  }
  return cleaned;
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–∞ –æ—Ç "–ù–ï–ó–ù–ê–ö–û–ú–¶–ê" (–ø—Ä–µ—Å—Å–∞, —Å–ª—É—Ö–∏, –æ–±—ã–≤–∞—Ç–µ–ª–∏)
async function aiGenerateStrangerPost(playerPost, worldContext, authorName, authorUsername) {
  const shortPlayerPost = clip(playerPost.content, 150);
  const prompt = `
–¢–´ ‚Äî –ì–ï–ù–ï–†–ê–¢–û–† "–ì–û–õ–û–°–ê –£–õ–ò–¶" –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–∑–¥–∞—Ç—å –û–î–ò–ù –ø–æ—Å—Ç –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ, –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ –∂–∏—Ç–µ–ª—è, –Ω–æ–≤–æ—Å—Ç–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ –∏–ª–∏ –∂–µ–ª—Ç–æ–π –ø—Ä–µ—Å—Å—ã.

–ö–û–ù–¢–ï–ö–°–¢ –ú–ò–†–ê (–ö–õ–Æ–ß–ï–í–´–ï –¢–ï–ú–´):
${worldContext}

–ü–û–°–õ–ï–î–ù–ò–ô –ü–û–°–¢ (–¢–†–ò–ì–ì–ï–†):
${authorName} (${authorUsername}) –Ω–∞–ø–∏—Å–∞–ª: """${shortPlayerPost}"""

–ó–ê–î–ê–ß–ê:
–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ø–æ—Å—Ç –æ—Ç "–Ω–µ–∑–Ω–∞–∫–æ–º—Ü–∞". –≠—Ç–æ—Ç –ø–æ—Å—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å:
1.  **–ù–æ–≤–æ—Å—Ç—å:** (–Ω–∞–ø—Ä., "@LocalNews"): "–°–æ–æ–±—â–∞—é—Ç –æ..."
2.  **–ñ–µ–ª—Ç–∞—è –ø—Ä–µ—Å—Å–∞:** (–Ω–∞–ø—Ä., "@GossipFiend"): "–°–õ–£–•–ò: –ì–æ–≤–æ—Ä—è—Ç, —á—Ç–æ –ì—Ä–µ–π—Å–æ–Ω –ë–ª–µ–π–¥–º–æ—Ä..."
3.  **–°–ª—É—Ö:** (–Ω–∞–ø—Ä., "@WhisperNet"): "–°–ª—ã—à–∞–ª, [–ü–µ—Ä—Å–æ–Ω–∞–∂] –æ–ø—è—Ç—å..."
4.  **–ú–Ω–µ–Ω–∏–µ –æ –º–∏—Ä–µ:** (–Ω–∞–ø—Ä., "@HorsesLover"): "–§–µ—Ä–º–∞ –ö–∞—Å—Å–∞–Ω–¥—Ä—ã - –ª—É—á—à–µ–µ –º–µ—Å—Ç–æ..."
5.  **–†–µ–∞–∫—Ü–∏—è –Ω–∞ –∏–≥—Ä–æ–∫–∞:** (–Ω–∞–ø—Ä., "@ConcernedCitizen"): "–í–∏–¥–µ–ª –ø–æ—Å—Ç ${authorUsername}. –ù–µ—É–∂–µ–ª–∏ –æ–Ω..."

–¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –§–û–†–ú–ê–¢–£ –í–´–í–û–î–ê:
–û—Ç–≤–µ—Ç—å –°–¢–†–û–ì–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.
{
  "username": "@generated_user",
  "name": "Generated Name",
  "postContent": "–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ –∑–¥–µ—Å—å. –û–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–º, –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–º –∏–ª–∏ –≥—Ä—è–∑–Ω–æ–π —Å–ø–ª–µ—Ç–Ω–µ–π. –ë—É–¥—å –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–º."
}

–í–ê–ñ–ù–û:
- @username –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º, "name" –∏ "postContent" - –Ω–∞ —Ä—É—Å—Å–∫–æ–º.
- –ï—Å–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è, –≤–µ—Ä–Ω–∏: { "username": null }
`.trim();

  const aiText = await askAI(prompt);
  if (!aiText) return null;
  try {
    const data = JSON.parse(aiText);
    if (!data.username || !data.name || !data.postContent) {
      console.warn("AI returned incomplete JSON for stranger post:", aiText);
      return null;
    }
    return data;
  } catch (e) {
    console.error("AI returned invalid JSON for stranger post:", aiText);
    return null;
  }
}

// (–í—Å—Ç–∞–≤—å —ç—Ç–æ—Ç –±–ª–æ–∫ –ü–û–°–õ–ï –®–∞–≥–∞ 3, –Ω–æ –ü–ï–†–ï–î // === —Ä–µ–∞–∫—Ü–∏–∏ ===)

// –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞–µ—Ç "–≤–¥–æ–≥–æ–Ω–∫—É" –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø–æ—Å—Ç–æ–≤ –æ—Ç NPC (–ü–ê–†–ê–õ–õ–ï–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø)
async function triggerNpcPostGeneration(playerPost) {
  const charactersToReact = getRelevantCharacters(playerPost);
  const player = state.players.find(p => p.id === playerPost.authorId);
  
  console.log(`[–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ] –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é NPC-–ø–æ—Å—Ç–æ–≤ –≤ –æ—Ç–≤–µ—Ç –Ω–∞ –ø–æ—Å—Ç ${player.name}...`);

  const postGenerationPromises = [];

  for (const char of charactersToReact) {
    let postCount = 0;
    const roll = Math.random();
    if (roll > 0.95) postCount = 2;
    else if (roll > 0.6) postCount = 1;

    for (let i = 0; i < postCount; i++) {
      postGenerationPromises.push(
        aiGenerateNpcPost(char, player, playerPost).then(postContent => {
          if (postContent) {
            return postObj({
              type: 'social', 
              authorType: 'character',
              authorId: char.id,
              content: postContent,
              relatedCharacters: [playerPost.authorId] 
            });
          }
          return null; // –ï—Å–ª–∏ –ò–ò –ø—Ä–æ–º–æ–ª—á–∞–ª
        })
      );
    }
  }

  // –ñ–¥–µ–º, –ø–æ–∫–∞ –í–°–ï –ø–æ—Å—Ç—ã –±—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã
  const newPosts = (await Promise.all(postGenerationPromises))
                       .filter(p => p !== null); // –£–±–∏—Ä–∞–µ–º —Ç–µ—Ö, –∫—Ç–æ –ø—Ä–æ–º–æ–ª—á–∞–ª

  if (newPosts.length > 0) {
    console.log(`[–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ] NPC —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∏ ${newPosts.length} –ø–æ—Å—Ç–æ–≤, –¥–æ–±–∞–≤–ª—è–µ–º...`);
    state.posts.push(...newPosts); // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –Ω–æ–≤—ã–µ –ø–æ—Å—Ç—ã –≤ state
    
    save(); 
    if ($('#view-feed').classList.contains('active')) {
      renderFeed();
    }
  }
}

// –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞–µ—Ç –°–õ–£–ß–ê–ô–ù–´–ô –ø–æ—Å—Ç –æ—Ç NPC
async function triggerRandomNpcPost() {
  const CHANCE = 0.25; // 25% —à–∞–Ω—Å –Ω–∞ —Å–ª—É—á–∞–π–Ω—ã–π –ø–æ—Å—Ç
  if (Math.random() > CHANCE) {
    console.log('–°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Å—Ç NPC: –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ (—à–∞–Ω—Å 25%)');
    return;
  }
  console.log('–°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Å—Ç NPC: –°—Ä–∞–±–æ—Ç–∞–ª–æ! –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞...');
  const char = choice(state.characters);
  const postContent = await aiGenerateRandomNpcPost(char);

  if (postContent) {
    console.log(`–°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Å—Ç –æ—Ç ${char.name}: "${postContent}"`);
    const p = postObj({
      type: 'social',
      authorType: 'character',
      authorId: char.id,
      content: postContent,
      relatedCharacters: []
    });
    state.posts.push(p);
    save();
    if ($('#view-feed').classList.contains('active')) {
      renderFeed();
    }
  } else {
    console.log(`–°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Å—Ç NPC: ${char.name} —Ä–µ—à–∏–ª –ø—Ä–æ–º–æ–ª—á–∞—Ç—å.`);
  }
}

// –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞–µ—Ç "–≤–¥–æ–≥–æ–Ω–∫—É" 2-10 –ø–æ—Å—Ç–æ–≤ –æ—Ç "–Ω–µ–∑–Ω–∞–∫–æ–º—Ü–µ–≤" (–ü–ê–†–ê–õ–õ–ï–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø)
async function triggerStrangerPosts(playerPost) {
  const postCount = randint(2, 10);
  console.log(`[–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ] –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é ${postCount} –ø–æ—Å—Ç–æ–≤ –æ—Ç "–Ω–µ–∑–Ω–∞–∫–æ–º—Ü–µ–≤"...`);
  
  const author = (playerPost.authorType === 'player')
    ? state.players.find(p => p.id === playerPost.authorId)
    : state.characters.find(c => c.id === playerPost.authorId);
  
  if (!author) return; 
  
  const authorName = author.name;
  const authorUsername = author.username || playerPost.authorId;

  const characterContext = state.characters
    .map(c => `- ${c.name} (${c.username}): ${clip(c.bio, 70)}`)
    .join('\n');
  
  const worldContext = `
- **–ò–≥—Ä–æ–∫, –≤—ã–∑–≤–∞–≤—à–∏–π —Å–æ–±—ã—Ç–∏–µ:** ${authorName} (${authorUsername}).
- **–ö–ª—é—á–µ–≤—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ (—Ü–µ–ª–∏ –¥–ª—è —Å–ª—É—Ö–æ–≤):**
${characterContext}
- **–î—Ä—É–≥–∏–µ —Ç–µ–º—ã –º–∏—Ä–∞:** –°–µ–º—å—è –ë–ª–µ–π–¥–º–æ—Ä (–∞–¥–≤–æ–∫–∞—Ç—ã), –°–µ–º—å—è –ë–ª—ç–∫–≤–æ–ª–ª (—é–≤–µ–ª–∏—Ä—ã), –†–æ–∫-–≥—Ä—É–ø–ø–∞ "Ash&mercury", –§–µ—Ä–º–∞ –ö–∞—Å—Å–∞–Ω–¥—Ä—ã (–ª–æ—à–∞–¥–∏), –ö–ª–∏–Ω–∏–∫–∞ "Family Hart", –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç.
  `.trim();

  // 1. –°–æ–∑–¥–∞–µ–º "—Å—Ç–æ–ø–∫—É" "–æ–±–µ—â–∞–Ω–∏–π"
  const postGenerationPromises = [];

  for (let i = 0; i < postCount; i++) {
    // 2. –î–æ–±–∞–≤–ª—è–µ–º "–æ–±–µ—â–∞–Ω–∏–µ" –≤ —Å—Ç–æ–ø–∫—É
    postGenerationPromises.push(
      aiGenerateStrangerPost(playerPost, worldContext, authorName, authorUsername).then(data => {
        if (data && data.username && data.postContent) {
          return postObj({
            type: 'social',
            authorType: 'stranger',
            authorId: data.username,
            strangerName: data.name,
            content: data.postContent,
            relatedCharacters: [] 
          });
        }
        return null;
      })
    );
  }

  // 3. –ñ–¥–µ–º, –ø–æ–∫–∞ –í–°–ï "–æ–±–µ—â–∞–Ω–∏—è" –≤—ã–ø–æ–ª–Ω—è—Ç—Å—è
  const newPosts = (await Promise.all(postGenerationPromises))
                       .filter(p => p !== null); // –£–±–∏—Ä–∞–µ–º "–ø—É—Å—Ç—ã–µ"

  // 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ª–µ–Ω—Ç—É
  if (newPosts.length > 0) {
    console.log(`[–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ] –ù–µ–∑–Ω–∞–∫–æ–º—Ü—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∏ ${newPosts.length} –ø–æ—Å—Ç–æ–≤, –æ–±–Ω–æ–≤–ª—è–µ–º...`);
    state.posts.push(...newPosts);
    save(); 
    if ($('#view-feed').classList.contains('active')) {
      renderFeed();
    }
  }
}

// === —Ä–µ–∞–∫—Ü–∏–∏ ===
let lastReactionPostId = null;

// –∫—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥ –¥–µ–ª—å—Ç—ã: +0.25%, -3%, +4.75%
function formatDelta(delta){
  const sign = delta > 0 ? '+' : (delta < 0 ? '‚àí' : '');
  const abs  = Math.abs(delta);
  const digits = abs >= 1 ? (abs % 1 === 0 ? 0 : 2) : 2;
  return `${sign}${abs.toFixed(digits)}%`;
}

// –ø—Ä–∏–º–µ–Ω—è–µ–º —Ä–µ–∞–∫—Ü–∏–∏ –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
async function applyReactionsAndShowModal(post, isStory){
  lastReactionPostId = post.id;
  const wrap = $('#modalReactions');

  // 1. –°–†–ê–ó–£ –ü–û–ö–ê–ó–´–í–ê–ï–ú –ú–û–î–ê–õ–ö–£ –° "–¢–†–ï–ú–Ø –¢–û–ß–ö–ê–ú–ò"
  wrap.innerHTML = '<div class="loader-dots"></div>';
  $('#reactionModal').classList.remove('hidden');

  // 2. –ñ–î–ï–ú, –ü–û–ö–ê –ò–ò "–î–£–ú–ê–ï–¢"
  const rxList = await computeReactions(post, isStory);
  
  // 3. –¢–ï–ü–ï–†–¨ –ó–ê–ú–ï–ù–Ø–ï–ú "–¢–û–ß–ö–ò" –ù–ê –†–ï–ó–£–õ–¨–¢–ê–¢
  if(!rxList.length){
    wrap.innerHTML = `<p>–ù–∏–∫—Ç–æ –∏–∑ –∫–ª—é—á–µ–≤—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –Ω–µ –æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª.</p>`;
  }else{
    wrap.innerHTML = rxList.slice(0,5).map(rx=>{
      const c = state.characters.find(k=>k.id===rx.charId);
      const cls = rx.delta >= 0 ? 'pos' : 'neg';
      return `<div class="react-item">
        <div><strong>${c?.name||'?'}</strong>: ${rx.text}</div>
        <div class="delta ${cls}">${formatDelta(rx.delta)}</div>
      </div>`;
    }).join('');
  }
  // (–º–æ–¥–∞–ª–∫–∞ —É–∂–µ –∏ —Ç–∞–∫ –±—ã–ª–∞ –ø–æ–∫–∞–∑–∞–Ω–∞)
}

// —Å—á–∏—Ç–∞–µ–º —Ä–µ–∞–∫—Ü–∏–∏ –∏ –º–µ–Ω—è–µ–º –æ—Ç–Ω–æ—à–µ–Ω–∏—è
async function computeReactions(post, isStory){
  const relevant = getRelevantCharacters(post);
  const me = currentPlayer();
  const out = [];

  for (const c of relevant){
    const currentAppr = c.approval[state.activePlayerId] ?? 50;

    // –±–∞–∑–æ–≤–∞—è —Å–∏–ª–∞ —Ä–µ–∞–∫—Ü–∏–∏
    const base = isStory ? 1.5 : 0.6;     // —Å—é–∂–µ—Ç–Ω—ã–µ —Å–∏–ª—å–Ω–µ–µ
    const spread = isStory ? 3.0 : 2.0;   // —Ä–∞–∑–±—Ä–æ—Å

    // –µ—Å–ª–∏ —É–∂–µ –ª—é–±–∏—Ç/–Ω–µ–Ω–∞–≤–∏–¥–∏—Ç ‚Äî —Ä–µ–∞–≥–∏—Ä—É–µ—Ç —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–µ–µ
    const moodBias = (currentAppr - 50) / 50; // –æ—Ç -1 –¥–æ +1

    let raw = base + spread * (Math.random() - 0.5) + moodBias;

    // –∏–Ω–æ–≥–¥–∞ —Ä–µ–∞–∫—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ–≤—Å–µ–º —Å–ª–∞–±–æ–π
    // (–æ–∫–æ–ª–æ –Ω—É–ª—è ‚Äî –ø–æ—á—Ç–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    if (Math.abs(raw) < 0.3) {
      raw = raw / 4; // –µ—â—ë –º—è–≥—á–µ
    }

    // —Å–ª—É—á–∞–π–Ω–æ –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∑–Ω–∞–∫, —á—Ç–æ–±—ã –±—ã–ª–∏ –∏ –º–∏–Ω—É—Å—ã
    if (Math.random() < 0.25) {
      raw = -raw;
    }

    // –∫–≤–∞–Ω—Ç—É–µ–º –¥–æ —à–∞–≥–æ–≤ –ø–æ 0.25
    let delta = Math.round(raw * 4) / 4;
    delta = clamp(delta, -5, 5); // –∂—ë—Å—Ç–∫–∏–π –ø—Ä–µ–¥–µ–ª

    // —Ç–µ–∫—Å—Ç —Ä–µ–∞–∫—Ü–∏–∏ –æ—Ç –ò–ò
    const text = await aiGenerateReactionText(
      c,
      me,
      post,
      delta,
      isStory
    );

    // –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–Ω–æ—à–µ–Ω–∏–µ
    const newAppr = clamp(currentAppr + delta, 0, 100);
    c.approval[state.activePlayerId] = newAppr;
    c.lastThought = text;

    const rx = reactionObj(post.id, c.id, text, delta);
    state.reactions.push(rx);
    out.push(rx);
  }

  save();
  renderRelations();
  return out;
}

function openReactionsForPost(postId){
  lastReactionPostId = postId;
  setActiveView('reactions');
}

function renderReactions(){
  const wrap = $('#reactionsList');
  const items = state.reactions
    .filter(r=>!lastReactionPostId || r.postId===lastReactionPostId)
    .slice().sort((a,b)=>b.at.localeCompare(a.at));

  if(!items.length){
    wrap.innerHTML = `<p class="hint">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∞–∫—Ü–∏–π.</p>`;
    return;
  }

  wrap.innerHTML = items.map(r=>{
    const c = state.characters.find(x=>x.id===r.charId);
    const p = state.posts.find(p=>p.id===r.postId);
    const cls = r.delta >= 0 ? 'pos' : 'neg';

    return `
      <div class="react-card">
        <div>
          <strong>${c?.name}</strong>
          –æ –ø–æ—Å—Ç–µ <em>${authorName(p)}</em>
          ¬∑ <span class="muted">${fmtTime(r.at)}</span>
        </div>
        <div class="react-item">
          <div>${r.text}</div>
          <div class="delta ${cls}">${formatDelta(r.delta)}</div>
        </div>
      </div>
    `;
  }).join('');
}

// === –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –º—ã—Å–ª–µ–π / –±–æ—Ç–æ–≤ ===

// –±–∞–∑–æ–≤—ã–µ –∑–∞–≥–æ—Ç–æ–≤–∫–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç,
// –∫–æ–≥–¥–∞ –ò–ò –æ—Ç–≤–µ—á–∞–µ—Ç —á–µ–º-—Ç–æ —Å—Ç—Ä–∞–Ω–Ω—ã–º –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –æ–±—â–∏–º
const thoughtPos = [
  '–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —à–∞–≥. –ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è.',
  '–≠—Ç–æ –∑–≤—É—á–∏—Ç —á–µ—Å—Ç–Ω–æ. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é.',
  '–ö–∞–∂–µ—Ç—Å—è, —Ç—ã –º–µ–Ω—è —É–¥–∏–≤–ª—è–µ—à—å ‚Äî –≤ —Ö–æ—Ä–æ—à–µ–º —Å–º—ã—Å–ª–µ.',
  '–õ–∞–∫–æ–Ω–∏—á–Ω–æ –∏ –≤ —Ç–æ—á–∫—É.',
  '–£–º–Ω–æ. –•–æ—á—É —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ.'
];
const thoughtNeg = [
  '–ù–µ —É–≤–µ—Ä–µ–Ω(–∞), —á—Ç–æ —ç—Ç–æ —Ö–æ—Ä–æ—à–∞—è –∏–¥–µ—è.',
  '–≠—Ç–æ –Ω–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ —Ç–µ–±—è.',
  '–°–æ–º–Ω–µ–≤–∞—é—Å—å, —á—Ç–æ —ç—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç.',
  '–°–ª–∏—à–∫–æ–º —Ä–µ–∑–∫–æ. –Ø –±—ã –ø—Ä–æ–º–æ–ª—á–∞–ª(–∞).',
  '–ú–Ω–µ —ç—Ç–æ –Ω–µ –±–ª–∏–∑–∫–æ.'
];

function toneWrap(tone, text){
  switch(tone){
    case 'cold':   return `–•–º. ${text}`;
    case 'warm':   return `–ó–Ω–∞–µ—à—å, ${text.toLowerCase()}`;
    case 'sharp':  return `–ü—Ä—è–º–æ —Å–∫–∞–∂—É: ${text}`;
    case 'stoic':  return `–û—Ç–º–µ—á—É –±–µ–∑ —ç–º–æ—Ü–∏–π: ${text}`;
    case 'chaotic':return `–õ–æ–ª, ${text.toLowerCase()}`;
    default: return text;
  }
}

function generateThought(char, post, delta){
  const base = delta>=0 ? choice(thoughtPos) : choice(thoughtNeg);
  const mention = post.relatedCharacters?.includes(char.id)
    ? ' (—ç—Ç–æ –∫–∞—Å–∞–µ—Ç—Å—è –º–µ–Ω—è)'
    : '';
  return toneWrap(char.tone, base) + mention;
}


// === —É—Ç–∏–ª–∏—Ç—ã ===

function getRelevantCharacters(post) {
  // –¢–µ–ø–µ—Ä—å –æ–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ—Ö, –ö–†–û–ú–ï –∞–≤—Ç–æ—Ä–∞ –ø–æ—Å—Ç–∞.
  // (post.authorId –±—É–¥–µ—Ç 'player1' –∏–ª–∏ 'player2' –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤)
  return state.characters.filter(c => c.id !== post.authorId);
}

function authorName(p){
  if(!p) return '‚Äî';
  if(p.authorType==='player')
    return state.players.find(x=>x.id===p.authorId)?.name || '–ò–≥—Ä–æ–∫';
  return state.characters.find(x=>x.id===p.authorId)?.name || '–ü–µ—Ä—Å–æ–Ω–∞–∂';
}

function currentPlayer(){ return state.players.find(p=>p.id===state.activePlayerId); }


function setupFilters(){
  const chips = $$('.filters .chip');
  chips.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      chips.forEach(b=>b.classList.remove('chip-on'));
      btn.classList.add('chip-on');
      feedFilter = btn.dataset.filter;
      renderFeed();
    });
  });
}

function setupPlayers(){
  const sel = $('#activePlayerSelect');
  sel.innerHTML = state.players.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
  sel.value = state.activePlayerId;
  sel.onchange = ()=>{
    state.activePlayerId = sel.value;
    save();
    renderRelations();
    renderFeed();
  };
}

function setupModal(){
  const mdl = $('#reactionModal');
  $('#modalClose').onclick = ()=> mdl.classList.add('hidden');
  $('#modalOk').onclick    = ()=> mdl.classList.add('hidden');
  $('#openReactionsBtn').onclick = ()=>{ mdl.classList.add('hidden'); setActiveView('reactions'); };
}

function setupMyProfileButton() {
  $('#myProfileBtn').onclick = () => {
    // –ü—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å —Å ID —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
    openCharacterProfile(state.activePlayerId);
  };
}

// === —Å—Ç–∞—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ===
document.addEventListener('DOMContentLoaded', ()=>{
  load();
  setupNav();
  setupPlayers();
  setupFilters();
  setupComposeSocial();
  setupComposeStory();
  setupDm();
  setupModal();
  setupMyProfileButton();
  renderFeed();
  renderRelations();
  triggerRandomNpcPost();
  triggerRandomNpcPost();
});
</script>

</body>
</html>
