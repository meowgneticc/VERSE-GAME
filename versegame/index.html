<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Status-like RP Prototype</title>

  <style>
    :root{
      --bg:#f4f4f7;
      --card:#ffffff;
      --card-border:#d5d8df;
      --text:#111217;
      --muted:#6b6f79;
      --primary:#111217;
      --accent:#111217;
      --positive:#31a24c;
      --negative:#e5535e;
    }

    *{box-sizing:border-box;}
    html,body{
      margin:0;
      padding:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,system-ui,sans-serif;
    }

    a{color:var(--primary);}
    button{
      cursor:pointer;
      border-radius:999px;
      border:1px solid rgba(0,0,0,0.07);
      padding:.6rem 1.1rem;
      background:#fff;
      font:inherit;
      color:var(--text);
    }
    button.primary{
      background:var(--text);
      color:#fff;
      border-color:var(--text);
    }
    button.secondary{
      background:#f3f3f7;
    }
    button.ghost{
      background:transparent;
    }

    #app{
      max-width:430px;
      margin:0 auto;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* TOP BAR */
    .topbar{
      position:sticky;
      top:0;
      z-index:10;
      padding:.6rem .9rem;
      background:var(--bg);
      border-bottom:1px solid #e1e4ec;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .brand{
      font-weight:700;
      letter-spacing:.02em;
    }
    .player-switch select{
      border-radius:999px;
      border:1px solid #d0d3dc;
      padding:.25rem .7rem;
      background:#fff;
    }

    main{
      flex:1;
      padding:.8rem .9rem 4.8rem;
    }
    .view{
      display:none;
    }
    .view.active{
      display:block;
    }
    .view-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:.7rem;
    }
    .view-head h1{
      margin:0;
      font-size:1.2rem;
    }

    /* FEED */
    .feed-list{
      list-style:none;
      margin:0;
      padding:0;
    }
    .post{
      background:var(--card);
      border-radius:24px;
      border:1px solid var(--card-border);
      padding:.9rem .95rem;
      margin-bottom:.8rem;
    }
    .post-head{
      display:flex;
      align-items:center;
      gap:.7rem;
      margin-bottom:.4rem;
    }
    .avatar{
      width:42px;
      height:42px;
      border-radius:50%;
      border:1px solid #cfd2da;
    }
    .meta .name{
      font-weight:700;
      font-size:.98rem;
    }
    .meta .username{
      font-size:.86rem;
      color:var(--muted);
    }
    .post-content{
      margin-top:.3rem;
      font-size:.93rem;
      line-height:1.4;
      white-space:pre-wrap;
    }
    .badge{
      display:inline-block;
      margin-left:.3rem;
      padding:.1rem .5rem;
      border-radius:999px;
      border:1px solid #e0e3eb;
      font-size:.75rem;
      color:var(--muted);
      background:#f6f7fb;
    }
    .post-actions{
      display:flex;
      align-items:center;
      gap:.8rem;
      margin-top:.55rem;
      font-size:.82rem;
      color:var(--muted);
      flex-wrap:wrap;
    }
    .post-actions .icon{
      display:inline-flex;
      align-items:center;
      gap:.25rem;
    }

    .filters{display:flex;gap:.4rem;}
    .chip{
      border-radius:999px;
      padding:.25rem .8rem;
      font-size:.8rem;
      background:#f2f3f7;
    }
    .chip-on{
      background:#111217;
      color:#fff;
    }

    /* RELATIONS */
    .relations{
      display:flex;
      flex-direction:column;
      gap:.7rem;
    }
    .rel-card{
      background:var(--card);
      border-radius:24px;
      border:1px solid var(--card-border);
      padding:1rem;
      cursor:pointer;
    }
    .rel-top{
      display:flex;
      gap:.85rem;
      align-items:center;
      margin-bottom:.6rem;
    }
    .rel-name{
      font-weight:700;
    }
    .username{
      font-size:.86rem;
      color:var(--muted);
    }
    .progress{
      margin-top:.15rem;
      height:12px;
      border-radius:999px;
      background:#f3f4f8;
      overflow:hidden;
      border:1px solid #e1e4ec;
    }
    .progress>span{
      display:block;
      height:100%;
      background:linear-gradient(90deg,#3bc76b,#70e08c);
    }
    .rel-thought{
      margin-top:.45rem;
      font-size:.86rem;
      color:var(--muted);
    }

    /* CHARACTER PROFILE */
    .char-view{
      max-width:430px;
      margin:0 auto;
    }

    .char-cover{
      height:120px;
      background:#d8dadf;
      border-radius:24px 24px 0 0;
    }

    .char-header{
      background:#fff;
      border-radius:24px;
      border:1px solid var(--card-border);
      margin-top:-48px;
      padding:1.2rem 1.1rem 1rem;
    }

    .char-header-top{
      display:flex;
      align-items:flex-end;
      gap:1rem;
    }

    .char-avatar{
  width:96px;
  height:96px;
  border-radius:50%;
  border:3px solid #fff;
  background:#ccc;
  overflow:hidden;
  flex-shrink:0;
  cursor:pointer;
  position:relative;
    }

    .char-avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
    }


.char-avatar-btn{
  margin-top:.4rem;
  font-size:.8rem;
  padding:.3rem .7rem;
}

    .char-name{
      font-size:1.4rem;
      font-weight:700;
    }

    .char-username{
      font-size:.9rem;
      color:var(--muted);
    }

    .char-bio{
      margin-top:.9rem;
      font-size:.9rem;
      line-height:1.5;
      white-space:pre-wrap;
    }

    .char-bio-edit{
  width:100%;
  margin-top:.6rem;
  border-radius:18px;
  border:1px solid var(--card-border);
  padding:.7rem .8rem;
  font:inherit;
  resize:vertical;
    }

    .char-rel-block{
      margin-top:1.2rem;
    }

    .char-rel-label-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:.86rem;
      color:var(--muted);
      margin-bottom:.35rem;
    }

    .char-rel-bar{
      height:16px;
      border-radius:999px;
      background:#f3f4f8;
      border:1px solid #e1e4ec;
      overflow:hidden;
    }

    .char-rel-bar > span{
      display:block;
      height:100%;
      background:linear-gradient(90deg,#3bc76b,#70e08c);
    }

    .char-rel-title{
      margin-top:.7rem;
      font-size:.95rem;
      font-weight:600;
    }

    .char-actions-row{
      margin-top:1rem;
      display:flex;
      gap:.5rem;
      flex-wrap:wrap;
    }

    .char-rel-thought{
  margin-top:.4rem;
  font-size:.86rem;
  color:var(--muted);
}


    /* COMPOSE */
    .compose textarea{
      width:100%;
      border-radius:18px;
      border:1px solid var(--card-border);
      padding:.7rem .8rem;
      resize:vertical;
      font:inherit;
      background:#fff;
    }
    .compose .label{
      font-size:.82rem;
      color:var(--muted);
      margin-bottom:.2rem;
      display:block;
    }
    .section{margin:.7rem 0;}
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:.4rem;
    }
    .chips label{
      padding:.25rem .7rem;
      border-radius:999px;
      border:1px solid #dde0ea;
      background:#f6f7fb;
      font-size:.82rem;
    }
    .chips input{
      margin-right:.25rem;
    }
    .file-btn{
      display:inline-block;
      padding:.4rem .8rem;
      border-radius:999px;
      border:1px dashed #d0d3dd;
      background:#f7f7fb;
      font-size:.86rem;
      cursor:pointer;
    }
    .photo-preview img{
      max-width:100%;
      margin-top:.5rem;
      border-radius:18px;
      border:1px solid var(--card-border);
    }

    .idea-box{
      display:flex;
      align-items:center;
      gap:.4rem;
      border-radius:18px;
      border:1px solid var(--card-border);
      background:#f7f7fb;
      padding:.4rem .6rem;
      font-size:.86rem;
    }
    .idea-text{
      flex:1;
      color:var(--muted);
    }

    .row{
      display:flex;
      align-items:center;
      gap:.5rem;
    }
    .row.end{justify-content:flex-end;}

    .hint{
      font-size:.8rem;
      color:var(--muted);
      margin-top:.4rem;
    }
    .muted{
      color:var(--muted);
      font-size:.82rem;
    }

    /* DM */
    .dm-thread{
      background:var(--card);
      border-radius:24px;
      border:1px solid var(--card-border);
      min-height:260px;
      padding:.7rem;
      display:flex;
      flex-direction:column;
      gap:.3rem;
    }
    .bubble{
      max-width:80%;
      padding:.45rem .7rem;
      border-radius:20px;
      font-size:.9rem;
    }
    .bubble.me{
      align-self:flex-end;
      background:#111217;
      color:#fff;
    }
    .bubble.them{
      align-self:flex-start;
      background:#f4f5fa;
    }
    .dm-input{
      display:flex;
      gap:.45rem;
      margin-top:.6rem;
    }
    .dm-input input{
      flex:1;
      border-radius:999px;
      border:1px solid var(--card-border);
      padding:.6rem .8rem;
      font:inherit;
      background:#fff;
    }

    /* REACTIONS */
    .reactions{
      display:flex;
      flex-direction:column;
      gap:.7rem;
    }
    .react-card{
      background:var(--card);
      border-radius:24px;
      border:1px solid var(--card-border);
      padding:.8rem .9rem;
      font-size:.9rem;
    }
    .react-item{
      display:flex;
      justify-content:space-between;
      gap:.5rem;
      margin-top:.35rem;
    }
    .delta.pos{color:var(--positive);}
    .delta.neg{color:var(--negative);}

    /* TABBAR */
    .tabbar{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:.6rem;
      width:100%;
      max-width:430px;
      padding:.25rem .35rem;
      background:rgba(255,255,255,0.96);
      border-radius:999px;
      box-shadow:0 8px 24px rgba(15,16,26,.18);
      display:flex;
      gap:.35rem;
      z-index:20;
    }
    .tab{
      flex:1;
      border-radius:999px;
      padding:.45rem 0;
      font-size:1rem;
    }
    .tab.active{
      background:#111217;
      color:#fff;
    }

    /* MODAL */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .modal.hidden{display:none;}
    .modal-card{
      width:min(420px,92vw);
      background:#fff;
      border-radius:22px;
      padding:1rem;
      box-shadow:0 18px 40px rgba(0,0,0,.25);
    }
    .modal-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:.5rem;
    }
    /* ... (—Ç–≤–æ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π CSS) ... */

    /* –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫–∏ (–∫–∞–∫ —Ç—ã –ø—Ä–æ—Å–∏–ª) */
    button:active, .tab:active {
      transform: scale(0.97);
      opacity: 0.9;
      transition: transform 50ms ease, opacity 50ms ease;
    }

    /* –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ (—Å–ø–∏–Ω–Ω–µ—Ä) */
    button.loading {
      position: relative;
      /* –°–∫—Ä—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç, –ø–æ–∫–∞ –≥—Ä—É–∑–∏—Ç—Å—è */
      color: transparent !important; 
      /* –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –Ω–∞–∂–∞—Ç–∏—è */
      pointer-events: none; 
    }
    button.loading::after {
      content: '';
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 20px; /* –†–∞–∑–º–µ—Ä —Å–ø–∏–Ω–Ω–µ—Ä–∞ */
      height: 20px;
      border-radius: 50%;
      /* –°–ø–∏–Ω–Ω–µ—Ä –±—É–¥–µ—Ç –±–µ–ª—ã–º, —Ç.–∫. –∫–Ω–æ–ø–∫–∏ .primary —É –Ω–∞—Å —Ç–µ–º–Ω—ã–µ */
      border: 3px solid rgba(255,255,255,0.3); 
      border-top-color: #fff;
      /* –ê–Ω–∏–º–∞—Ü–∏—è –≤—Ä–∞—â–µ–Ω–∏—è */
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: transform –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∏ translate, –∏ rotate –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏ */
      from { transform: translate(-50%, -50%) rotate(0deg); }
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è "—Ç—Ä–µ—Ö —Ç–æ—á–µ–∫" –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
    .loader-dots {
      text-align: center;
      font-size: 1.5rem;
      padding: 1rem 0;
      color: var(--muted);
    }
    .loader-dots::after {
      content: '.';
      animation: dots 1.4s steps(5, end) infinite;
    }
    
    @keyframes dots {
      0%, 20% {
        color: rgba(0,0,0,0);
        text-shadow:
          .25em 0 0 rgba(0,0,0,0),
          .5em 0 0 rgba(0,0,0,0);
      }
      40% {
        color: var(--muted);
        text-shadow:
          .25em 0 0 rgba(0,0,0,0),
          .5em 0 0 rgba(0,0,0,0);
      }
      60% {
        text-shadow:
          .25em 0 0 var(--muted),
          .5em 0 0 rgba(0,0,0,0);
      }
      80%, 100% {
        text-shadow:
          .25em 0 0 var(--muted),
          .5em 0 0 var(--muted);
      }
    }

  </style>
</head>
<body>
  <div id="app">
    <header class="topbar">
      <div class="brand">Verse</div>
      <div class="player-switch">
        <button id="myProfileBtn" class="secondary" style="padding:.25rem .7rem; margin-right:.5rem;">
          –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
        </button>
        <label>
          –Ø ‚Äî 
          <select id="activePlayerSelect"></select>
        </label>
      </div>
    </header>

    <main>
      <section id="view-feed" class="view active">
        <div class="view-head">
          <h1>–õ–µ–Ω—Ç–∞</h1>
          <div class="filters">
            <button class="chip chip-on" data-filter="all">–í—Å–µ</button>
            <button class="chip" data-filter="social">–û–±—ã—á–Ω—ã–µ</button>
            <button class="chip" data-filter="story">–°—é–∂–µ—Ç–Ω—ã–µ</button>
          </div>
        </div>
        <ul id="feedList" class="feed-list"></ul>
      </section>

      <section id="view-relations" class="view">
        <div class="view-head">
          <h1>–û—Ç–Ω–æ—à–µ–Ω–∏—è</h1>
        </div>
        <div id="relationsList" class="relations"></div>
      </section>

      <section id="view-character" class="view">
        <div class="view-head">
          <h1>–ü—Ä–æ—Ñ–∏–ª—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h1>
        </div>
        <div id="characterView" class="char-view"></div>
      </section>

      <section id="view-compose" class="view">
        <div class="view-head">
          <h1>–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç</h1>
        </div>
        <div class="compose">
          <textarea id="composeText" rows="6" placeholder="–û —á—ë–º –¥—É–º–∞–µ—à—å?"></textarea>

          <div class="section">
            <label class="file-btn">
              <input id="composePhoto" type="file" accept="image/*" hidden />
              –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            </label>
            <div id="composePhotoPreview" class="photo-preview"></div>
          </div>

          <button id="publishSocialBtn" class="primary">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        </div>
      </section>

      <section id="view-story" class="view">
        <div class="view-head">
          <h1>–°—é–∂–µ—Ç–Ω—ã–π –ø–æ—Å—Ç</h1>
        </div>

        <div class="compose">
          <div class="section">
            <label class="label">–ò–¥–µ–∏ –¥–ª—è –ø–æ—Å—Ç–∞ (–ø—Ä–æ—Ç–æ—Ç–∏–ø)</label>
            <div class="idea-box">
              <button id="ideaPrev" class="ghost">&larr;</button>
              <div id="ideaText" class="idea-text">–ù–∞–∂–º–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å –∏–¥–µ–∏¬ª</div>
              <button id="ideaNext" class="ghost">&rarr;</button>
            </div>
            <div class="row">
              <button id="ideaRefresh" class="secondary">–û–±–Ω–æ–≤–∏—Ç—å –∏–¥–µ–∏</button>
              <button id="ideaUse" class="secondary">–í—Å—Ç–∞–≤–∏—Ç—å –≤ –ø–æ–ª–µ</button>
            </div>
          </div>

          <textarea id="storyText" rows="12" placeholder="–î–ª–∏–Ω–Ω—ã–π —Å—é–∂–µ—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç..."></textarea>
          <button id="publishStoryBtn" class="primary">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å—é–∂–µ—Ç–Ω—ã–π –ø–æ—Å—Ç</button>
          <p class="hint">–°—é–∂–µ—Ç–Ω—ã–µ –ø–æ—Å—Ç—ã –Ω–µ –∫–æ–º–º–µ–Ω—Ç–∏—Ä—É—é—Ç—Å—è, –Ω–æ —Å–∏–ª—å–Ω–µ–µ –≤–ª–∏—è—é—Ç –Ω–∞ –º–∏—Ä –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è.</p>
        </div>
      </section>

      <section id="view-dm" class="view">
        <div class="view-head">
          <h1 id="dmTitle">–õ–°</h1>
          <div class="row">
            <label>–ü–µ—Ä—Å–æ–Ω–∞–∂: 
              <select id="dmSelect"></select>
            </label>
            <label style="margin-left:1rem;">
              <input type="checkbox" id="dmAutoToggle" checked />
              –ë–æ—Ç –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å —Å–∞–º
            </label>
          </div>
        </div>

        <div id="dmThread" class="dm-thread"></div>

        <div class="dm-input">
          <input id="dmInput" type="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." />
          <button id="dmSend" class="primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </section>

      <section id="view-reactions" class="view">
        <div class="view-head">
          <h1>–†–µ–∞–∫—Ü–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</h1>
        </div>
        <div id="reactionsList" class="reactions"></div>
      </section>
    </main>

    <nav class="tabbar">
      <button class="tab active" data-target="feed" title="–õ–µ–Ω—Ç–∞">–õ–µ–Ω—Ç–∞</button>
      <button class="tab" data-target="relations" title="–û—Ç–Ω–æ—à–µ–Ω–∏—è">–û—Ç–Ω–æ—à–µ–Ω–∏—è</button>
      <button class="tab" data-target="compose" title="–ü–æ—Å—Ç">‚úèÔ∏è</button>
      <button class="tab" data-target="story" title="–°—é–∂–µ—Ç">–°—é–∂–µ—Ç</button>
      <button class="tab" data-target="dm" title="–õ–°">–õ–°</button>
      <button class="tab" data-target="reactions" title="–†–µ–∞–∫—Ü–∏–∏">–†–µ–∞–∫—Ü–∏–∏</button>
    </nav>
  </div>

  <div id="reactionModal" class="modal hidden">
    <div class="modal-card">
      <div class="modal-head">
        <h3>–†–µ–∞–∫—Ü–∏–∏ –Ω–∞ –ø–æ—Å—Ç</h3>
        <button id="modalClose" class="ghost">‚úï</button>
      </div>
      <div id="modalReactions"></div>
      <div class="row end">
        <button id="openReactionsBtn" class="secondary">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
        <button id="modalOk" class="primary">–û–∫</button>
      </div>
    </div>
  </div>

<script>
const $  = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
const uid = (p='id') => `${p}_${Math.random().toString(36).slice(2,9)}`;
const nowIso = () => new Date().toISOString();
const clip = (s, n=160) => (s.length>n ? s.slice(0,n) + '‚Ä¶' : s);
const fmtTime = (iso) => new Date(iso).toLocaleString();
const randint = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const choice = (arr)=>arr[Math.floor(Math.random()*arr.length)];
const clamp=(x,min,max)=>Math.max(min,Math.min(max,x));

// –°–æ–±–∏—Ä–∞–µ–º –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–≤—è–∑–µ–π –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ —Å –¥—Ä—É–≥–∏–º–∏
function buildRelationsSummary(char) {
  if (!char || !char.relations) return '–ù–µ—Ç —è–≤–Ω—ã—Ö —Å–≤—è–∑–µ–π.';

  const lines = [];

  for (const [otherId, value] of Object.entries(char.relations)) {
    let other = state.characters.find(c => c.id === otherId);
    if (!other) {
      other = state.players.find(p => p.id === otherId);
    }
    const name = other?.name || otherId;
    lines.push(`${char.name} –∏ ${name}: —É—Ä–æ–≤–µ–Ω—å –±–ª–∏–∑–æ—Å—Ç–∏ ${value} –∏–∑ 100.`);
  }

  if (!lines.length) return '–ù–µ—Ç —è–≤–Ω—ã—Ö —Å–≤—è–∑–µ–π.';

  return lines.join('\n');
}

// === –ò–ò (Gemini) –¥–ª—è –õ–° ===
async function askAI(promptText) {
  console.log("–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ AI...");
  try {
    const res = await fetch('/api/gemini', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: promptText })
    });

    const data = await res.json();

    // –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –ø—É—Å—Ç–æ–π –∏–ª–∏ —Å –æ—à–∏–±–∫–æ–π ‚Äî —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –ò–ò –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
    if (!data.ok || !data.answer) {
      console.error('AI error response', data);
      return null;              // <‚Äî –í–ê–ñ–ù–û: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null, –∞ –Ω–µ —Ç–µ–∫—Å—Ç
    }

    return data.answer.trim();
  } catch (err) {
    console.error('AI network error (API /api/gemini –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ?)', err);
    return null;                // <‚Äî –∏ —Ç—É—Ç —Ç–æ–∂–µ null
  }
}

// === –°–Ω–∏–º–æ–∫ –º–∏—Ä–∞ –¥–ª—è –õ–° ===
// –ö–æ—Ä–æ—Ç–∫–∏–π –¥–∞–π–¥–∂–µ—Å—Ç –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–±—ã—Ç–∏–π –∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π –∏–≥—Ä–æ–∫–∞/–ø–µ—Ä—Å–æ–Ω–∞–∂–∞
function worldSnapshotForDm(charId, playerId = state.activePlayerId, limitRecent = 6, limitMentions = 6) {
  const me   = state.players.find(p => p.id === playerId);
  const char = state.characters.find(c => c.id === charId) || state.players.find(p => p.id === charId);

  const byTime = (a,b) => b.createdAt.localeCompare(a.createdAt);

  // 1) –ø—Ä–æ—Å—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ—Å—Ç—ã
  const recent = state.posts.slice().sort(byTime).slice(0, limitRecent);

  // 2) –ø–æ—Å—Ç—ã, –≥–¥–µ —É–ø–æ–º—è–Ω—É—Ç—ã –∏–≥—Ä–æ–∫/–ø–µ—Ä—Å–æ–Ω–∞–∂
  function mentions(p){
    const t = (p.content || '').toLowerCase();
    const keys = [];
    if (char?.name)      keys.push(char.name.toLowerCase());
    if (char?.username)  keys.push(char.username.replace(/^@/,'').toLowerCase());
    if (me?.name)        keys.push(me.name.toLowerCase());
    if (me?.username)    keys.push(me.username.replace(/^@/,'').toLowerCase());
    return keys.some(k => t.includes(k));
  }
  const mentioned = state.posts.slice().sort(byTime).filter(mentions).slice(0, limitMentions);

  // –æ–±—ä–µ–¥–∏–Ω—è–µ–º –±–µ–∑ –¥—É–±–ª–µ–π
  const combined = [...recent, ...mentioned]
    .filter((p, i, arr) => arr.findIndex(x => x.id === p.id) === i)
    .slice(0, limitRecent + limitMentions);

  // —Ñ–æ—Ä–º–∞—Ç —Å—Ç—Ä–æ–∫
  const lines = combined.map(p => {
    const a = getAuthorByType(p.authorType, p.authorId);
    const author = (p.authorType === 'npc') ? (a?.username || '@–∂–∏—Ç–µ–ª—å')
                 : (a?.name || '–ö—Ç–æ-—Ç–æ');
    const tag = p.type === 'story' ? '[—Å—é–∂–µ—Ç]' : '';
    return `‚Ä¢ ${author} ${tag}: ${clip((p.content || '').replace(/\n/g,' '), 140)}`;
  });

  return lines.join('\n') || '–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–º–µ—Ç–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π.';
}

// –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞, –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–∫–ª—é—á–∏–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å–Ω—ã–µ –º—ã—Å–ª–∏ AI
if (typeof aiGenerateProfileThought === 'undefined') {
  async function aiGenerateProfileThought() { return null; }
}


async function aiReplyToDm(charId) {
  const char = state.characters.find(c => c.id === charId);
  if (!char) return;

  const me = currentPlayer();
  const key = threadKey(charId);
  const history = state.dms[key] || [];

  const historyText = history.map(m => {
    const whoName = m.from === state.activePlayerId ? me.name : char.name;
    return `${whoName}: ${m.text}`;
  }).join('\n');

  const relationsSummary = buildRelationsSummary(char);
  const worldBrief = worldSnapshotForDm(charId, state.activePlayerId);

  const prompt = `
–¢—ã ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–∂ ${char.name} (${char.username}) –∏ –≤–µ–¥—ë—à—å –ª–∏—á–Ω—É—é –ø–µ—Ä–µ–ø–∏—Å–∫—É –≤–Ω—É—Ç—Ä–∏ –≤—ã–º—ã—à–ª–µ–Ω–Ω–æ–π —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏.

–ö–ê–ù–û–ù (—ç—Ç–æ –∏—Å—Ç–∏–Ω–∞, –Ω–µ –º–µ–Ω—è–π —Ñ–∞–∫—Ç—ã):
‚Ä¢ –ë–∏–æ–≥—Ä–∞—Ñ–∏—è:
${char.bio || '(–±–∏–æ –ø–æ–∫–∞ –ø—É—Å—Ç–æ)'}
‚Ä¢ –°–≤—è–∑–∏ –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è:
${relationsSummary}
‚Ä¢ –¢–µ–∫—É—â–µ–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –∏–≥—Ä–æ–∫—É ${me.name}: ${char.approval[state.activePlayerId] ?? 50} –∏–∑ 100.

–ú–∏—Ä –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è (–∫—Ä–∞—Ç–∫–æ):
${worldBrief}

–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ (—Ñ–æ—Ä–º–∞—Ç "–ò–º—è: —Ç–µ–∫—Å—Ç"):
${historyText || '(–∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ—Ç)'}

–ü—Ä–∞–≤–∏–ª–∞ –æ—Ç–≤–µ—Ç–∞:
1) –ü–∏—à–∏ –ø–æ‚Äë—Ä—É—Å—Å–∫–∏, –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞, –≤ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–µ: ${char.tone}.
2) –î–∞–π 1‚Äì3 –∫–æ—Ä–æ—Ç–∫–∏–µ —Ä–µ–ø–ª–∏–∫–∏, –±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏–π –¥–µ–π—Å—Ç–≤–∏–π –∏ –º–∞—Ä–∫–µ—Ä–æ–≤ —Ç–∏–ø–∞ *...*.
3) –£—á–∏—Ç—ã–≤–∞–π –∫–∞–Ω–æ–Ω: –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –Ω–æ–≤—ã–µ —Ä–æ–¥—Å—Ç–≤–∞/—Å–æ–±—ã—Ç–∏—è; –µ—Å–ª–∏ –∏–≥—Ä–æ–∫ –æ—à–∏–±—Å—è ‚Äî –º—è–≥–∫–æ –ø–æ–ø—Ä–∞–≤—å.
4) –¢–æ–Ω –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—è: –Ω–∏–∂–µ ‚Äî —Ö–æ–ª–æ–¥–Ω–µ–µ/–∂—ë—Å—Ç—á–µ, –≤—ã—à–µ ‚Äî —Ç–µ–ø–ª–µ–µ/–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ.
5) –ï—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ, —Å—Å—ã–ª–∞–π—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è –∏–∑ —Å–≤–æ–¥–∫–∏ –º–∏—Ä–∞.

–û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–º —Ä–µ–ø–ª–∏–∫ –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤.
`;

  const aiText = await askAI(prompt);
  if (!aiText) return;

  pushMessage(charId, charId, aiText.trim());
}

let state = {
  players: [
    { id:'player1', name:'–ì—Ä–µ–π—Å–æ–Ω',  username:'@LiqueurD',   followers:320 },
    { id:'player2', name:'–õ–æ—Ä–∞–Ω—Ç–∏—Å', username:'@tinktloran', followers:340 }
  ],
  activePlayerId: 'player1',
  characters: [],
  posts: [],
  dms: {},
  reactions: [],
  npcs: [],        // –∂–∏—Ç–µ–ª–∏ (–æ–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ª–µ–Ω—Ç—ã)
  outlets: [],     // –º–µ–¥–∏–∞
  world: {         // –∏–Ω—Ç–µ—Ä–µ—Å—ã –º–∏—Ä–∞
    topics: ['horses','music','university','nightlife','family','gossip','sports','tech','citylife']
  }
};

// –í–ù–ï state (–æ—Ç–¥–µ–ª—å–Ω–æ!)
function migrateStateSchema(){
  if(!state.npcs)       state.npcs = [];
  if(!state.outlets)    state.outlets = [];
  if(!state.world)      state.world = { topics:['horses','music','university','nightlife','family','gossip','sports','tech','citylife'] };
  if(!state.dms)        state.dms = {};
  if(!state.reactions)  state.reactions = [];
}


const LS_KEY = 'verse_state_v2_grayson_loran';

// === –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏ —Å—Ç–∞—Ä—Ç–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤ ===
function seedIfEmpty(){
  if(state.characters.length) return;

  state.characters = [
    {
      id:'player1', // <--- ID —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å player
      name:'–ì—Ä–µ–π—Å–æ–Ω',
      username:'@LiqueurD',
      tone:'stoic', // (–ú–æ–∂–µ—à—å –ø–æ–º–µ–Ω—è—Ç—å)
      followers:320,
      bio:'(–í–ø–∏—à–∏ —Å—é–¥–∞ –∫–∞–Ω–æ–Ω –ì—Ä–µ–π—Å–æ–Ω–∞. –ò–ò –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ –¥–ª—è —Ä–µ–∞–∫—Ü–∏–π)',
      relations:{}, // (–ú–æ–∂–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∑–∂–µ)
      approval:{
        // –ú–Ω–µ–Ω–∏–µ –ì—Ä–µ–π—Å–æ–Ω–∞ –æ –¥—Ä—É–≥–∏—Ö:
        player2: 50, // (–ú–Ω–µ–Ω–∏–µ –æ –õ–æ—Ä–∞–Ω—Ç–∏—Å–µ)
        kristian: 60,
        vivien: 70
        // ... (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã—Ö)
      },
      lastThought:'',
      avatar:'' // (–ê–≤–∞—Ç–∞—Ä –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ–∏–ª—å)
    },
    {
      id:'player2', // <--- ID —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å player
      name:'–õ–æ—Ä–∞–Ω—Ç–∏—Å',
      username:'@tinktloran',
      tone:'warm', // (–ú–æ–∂–µ—à—å –ø–æ–º–µ–Ω—è—Ç—å)
      followers:340,
      bio:'(–í–ø–∏—à–∏ —Å—é–¥–∞ –∫–∞–Ω–æ–Ω –õ–æ—Ä–∞–Ω—Ç–∏—Å–∞. –ò–ò –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ –¥–ª—è —Ä–µ–∞–∫—Ü–∏–π)',
      relations:{},
      approval:{
        // –ú–Ω–µ–Ω–∏–µ –õ–æ—Ä–∞–Ω—Ç–∏—Å–∞ –æ –¥—Ä—É–≥–∏—Ö:
        player1: 50, // (–ú–Ω–µ–Ω–∏–µ –æ –ì—Ä–µ–π—Å–æ–Ω–µ)
        kristian: 40,
        aurora: 75
        // ... (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã—Ö)
      },
      lastThought:'',
      avatar:''
    },
    {
      id:'kristian',
      name:'–ö—Ä–∏—Å—Ç–∏–∞–Ω –í–æ–ª—å—Ç',
      username:'@shiningshining',
      tone:'warm',
      followers:1500,
      bio:'–û–º–µ–≥–∞ —Å –ø–ª–∞—Ç–∏–Ω–æ–≤—ã–º–∏ –≤–æ–ª–æ—Å–∞–º–∏ –∏ –æ–±–µ–∑–æ—Ä—É–∂–∏–≤–∞—é—â–µ–π —É–ª—ã–±–∫–æ–π; —Ö–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω—ã–π —Å—Ç—É–¥–µ–Ω—Ç –ø–µ–¥—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞, —Å–∞–º —Å–µ–±—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç, –ª—é–±–∏—Ç –¥–µ—Ç–µ–π –∏ —Å–ª–∞–¥–∫–æ–µ. –í –ø—Ä–æ—à–ª–æ–º —Å–ø–∞–ª —Å –ì—Ä–µ–π—Å–æ–Ω–æ–º –∏ —Å–µ–π—á–∞—Å —Å–Ω–æ–≤–∞ –∏–º –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω.',
      relations:{ vivien:40, eve:20, alexi:25 },
      approval:{ player1:65, player2:35 },
      lastThought:'',
      avatar:''
    },
    {
      id:'vivien',
      name:'–í–∏–≤—å–µ–Ω –ë–ª–µ–π–¥–º–æ—Ä',
      username:'@WildFret',
      tone:'chaotic',
      followers:900,
      bio:'–ë–µ—Ç–∞, –≥–∏—Ç–∞—Ä–∏—Å—Ç–∫–∞ –≥—Ä—É–ø–ø—ã Ash&mercury, —É–ø—Ä—è–º–∞—è —à—É–º–Ω–∞—è —Ä–æ–∫–µ—Ä—à–∞, –ø—Ä–∏–∫—Ä—ã–≤–∞–µ—Ç –º–ª–∞–¥—à–∏—Ö –∏ —Å–ø–æ—Ä–∏—Ç —Å –ö–∞–π–ª–∞–Ω–æ–º. –í –ø–æ–ª–∏–∞–º–æ—Ä–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö —Å –ï–≤–æ–π –∏ –ê–ª–µ–∫—Å–∏.',
      relations:{ alexi:80, eve:70, grayson:65, aiden:60, ember:60 },
      approval:{ player1:70, player2:55 },
      lastThought:'',
      avatar:''
    },
    {
      id:'aiden',
      name:'–≠–π–¥–µ–Ω –ë–ª–µ–π–¥–º–æ—Ä',
      username:'@404NotFound',
      tone:'chaotic',
      followers:600,
      bio:'–î–æ–º–∏–Ω–∞–Ω—Ç–Ω—ã–π –æ–º–µ–≥–∞-—à–∞–ª–æ–ø–∞–π: –æ–±–∞—è—Ç–µ–ª—å–Ω—ã–π –∞–≤–∞–Ω—Ç—é—Ä–∏—Å—Ç, —Ç–∞–∫—Ç–∏–∫ –¥—É—ç—Ç–∞ —Å —Å–µ—Å—Ç—Ä–æ–π –≠–º–±–µ—Ä. –û–±–æ–∂–∞–µ—Ç –ø—Ä–∞–Ω–∫–∏, —Ç–µ–∞—Ç—Ä –∏ –≤–ª—é–±–ª—ë–Ω –≤ —É—á–∏—Ç–µ–ª—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã –ò—Ç–∞–Ω–∞ –•–æ–≥–≥–∞—Ä—Ç–∞.',
      relations:{ ember:90, vivien:60, eve:40, ethan:75 },
      approval:{ player1:65, player2:50 },
      lastThought:'',
      avatar:''
    },
    {
      id:'ember',
      name:'–≠–º–±–µ—Ä –ë–ª–µ–π–¥–º–æ—Ä',
      username:'@500InternalServerError',
      tone:'stoic',
      followers:580,
      bio:'–î–æ–º–∏–Ω–∞–Ω—Ç–Ω–∞—è –æ–º–µ–≥–∞, —Ñ–ª–µ–≥–º–∞—Ç–∏—á–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫; –º–æ–∑–≥ –¥—É—ç—Ç–∞ —Å –≠–π–¥–µ–Ω–æ–º, –ª—é–±–∏—Ç —Å–æ–±–∞–∫ –∏ —Ä–∞—Å—Ç–µ–Ω–∏—è. –°–∫–µ–ø—Ç–∏—á–Ω–∞, –Ω–æ –æ—á–µ–Ω—å –∑–∞–±–æ—Ç–ª–∏–≤–∞.',
      relations:{ aiden:90, vivien:60, eve:40 },
      approval:{ player1:60, player2:50 },
      lastThought:'',
      avatar:''
    },
    {
      id:'aurora',
      name:'–ê–≤—Ä–æ—Ä–∞ –ë–ª—ç–∫–≤–æ–ª–ª',
      username:'@ABlackwall',
      tone:'stoic',
      followers:800,
      bio:'–î–æ–º–∏–Ω–∞–Ω—Ç–Ω–∞—è –∞–ª—å—Ñ–∞, —Å–ø–æ–∫–æ–π–Ω–∞—è –∏ —Å–æ–±—Ä–∞–Ω–Ω–∞—è, –±—É–¥—É—â–∞—è –Ω–∞—Å–ª–µ–¥–Ω–∏—Ü–∞ —Å–µ–º–µ–π–Ω–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞. –õ—é–±–∏—Ç –ø–æ—Ä—è–¥–æ–∫, —Ç–æ—á–Ω—ã–µ –Ω–∞—É–∫–∏ –∏ —é–≤–µ–ª–∏—Ä–Ω–æ–µ –¥–µ–ª–æ, –∫–æ–≥–¥–∞-—Ç–æ –∑–∞–Ω–∏–º–∞–ª–∞—Å—å –∫–æ–Ω–Ω—ã–º —Å–ø–æ—Ä—Ç–æ–º –≤–º–µ—Å—Ç–µ —Å –ì—Ä–µ–π—Å–æ–Ω–æ–º.',
      relations:{ eve:70, loran:75, derek:80, noel:70 },
      approval:{ player1:65, player2:80 },
      lastThought:'',
      avatar:''
    },
    {
      id:'eve',
      name:'–ï–≤–∞ –ë–ª—ç–∫–≤–æ–ª–ª',
      username:'@EveLuxe',
      tone:'sharp',
      followers:1000000,
      bio:'–ì—Ä–æ–º–∫–∞—è —Å—Ç–µ—Ä–≤–æ–∑–Ω–∞—è –¥–æ–º–∏–Ω–∞–Ω—Ç–Ω–∞—è –∞–ª—å—Ñ–∞-–±–ª–æ–≥–µ—Ä—à–∞; –º–µ–Ω–µ–¥–∂–µ—Ä —Ä–æ–∫-–≥—Ä—É–ø–ø—ã –í–∏–≤—å–µ–Ω –∏ –ê–ª–µ–∫—Å–∏ –∏ —á–∞—Å—Ç—å –∏—Ö –ø–æ–ª–∏–∞–º–æ—Ä–Ω–æ–π —Ç—Ä–æ–∏—Ü—ã. –õ—é–±–∏—Ç –≤–µ—á–µ—Ä–∏–Ω–∫–∏, —Å–µ–∫—Å –∏ –ø–æ–±–µ–∂–¥–∞—Ç—å –≤ —Å–ø–æ—Ä–∞—Ö.',
      relations:{ aurora:80, loran:85, vivien:75, alexi:70, aiden:50, ember:50 },
      approval:{ player1:75, player2:70 },
      lastThought:'',
      avatar:''
    },
    {
      id:'derek',
      name:'–î–µ—Ä–µ–∫ –ë–ª—ç–∫–≤–æ–ª–ª',
      username:'@BlackDiamond',
      tone:'warm',
      followers:12000,
      bio:'–î–æ–º–∏–Ω–∞–Ω—Ç–Ω—ã–π –∞–ª—å—Ñ–∞, –æ—Ç–µ—Ü –ï–≤—ã, –ê–≤—Ä–æ—Ä—ã –∏ –õ–æ—Ä–∞–Ω—Ç–∏—Å–∞, –≤–µ—Ä–Ω—ã–π –º—É–∂ –ù–æ—ç–ª—è –∏ –≤–ª–∞–¥–µ–ª–µ—Ü —é–≤–µ–ª–∏—Ä–Ω–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞. –û–±–æ–∂–∞–µ—Ç —Å–µ–º—å—é, —à—É—Ç–∏—Ç –∏ –ø–µ—Ä–µ–∂–∏–≤–∞–µ—Ç –∏–∑-–∑–∞ –æ—Ç—ä–µ–∑–¥–∞ –õ–æ—Ä–∞–Ω–∞ –≤ –ì–µ—Ä–º–∞–Ω–∏—é.',
      relations:{ noel:95, aurora:90, eve:85, loran:95, dante:80, grayson:70 },
      approval:{ player1:70, player2:85 },
      lastThought:'',
      avatar:''
    },
    {
      id:'dante',
      name:'–î–∞–Ω—Ç–µ –ë–ª–µ–π–¥–º–æ—Ä',
      username:'@dSever',
      tone:'warm',
      followers:18000,
      bio:'–î–æ–º–∏–Ω–∞–Ω—Ç–Ω—ã–π –∞–ª—å—Ñ–∞-—Å–µ–º—å—è–Ω–∏–Ω –∏ –ø–æ–∂–∞—Ä–Ω—ã–π-—Å–ø–∞—Å–∞—Ç–µ–ª—å, –º—É–∂ –ö–∞–π–ª–∞–Ω–∞, –æ—Ç–µ—Ü –í–∏–≤—å–µ–Ω, –ì—Ä–µ–π—Å–æ–Ω–∞, –≠–º–±–µ—Ä –∏ –≠–π–¥–µ–Ω–∞. –°–ø–æ–∫–æ–π–Ω—ã–π —Ñ–ª–µ–≥–º–∞—Ç–∏–∫, –æ–±–æ–∂–∞–µ—Ç —Å–≤–æ—é ¬´—Å—Ç–∞—é¬ª –∏ –≤–æ–∑–∏—Ç—Å—è —Å –º–∞—à–∏–Ω–∞–º–∏.',
      relations:{ kaylan:95, vivien:90, grayson:90, aiden:85, ember:85, alexi:75 },
      approval:{ player1:85, player2:60 },
      lastThought:'',
      avatar:''
    },
    {
      id:'kaylan',
      name:'–ö–∞–π–ª–∞–Ω –ë–ª–µ–π–¥–º–æ—Ä',
      username:'@meowgneticc',
      tone:'sharp',
      followers:25000,
      bio:'–î–æ–º–∏–Ω–∞–Ω—Ç–Ω–∞—è –æ–º–µ–≥–∞-–∞–¥–≤–æ–∫–∞—Ç, –≥–ª–∞–≤–∞ Blademore K.D. –°—Ç—Ä–æ–≥–∏–π, —Ö–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω—ã–π, –≤–æ—Ä—á–ª–∏–≤—ã–π –≥–µ–Ω–∏–π —é—Ä–∏—Å–ø—Ä—É–¥–µ–Ω—Ü–∏–∏, –æ—á–µ–Ω—å –∑–∞–±–æ—Ç–∏—Ç—Å—è –æ —Å–µ–º—å–µ –∏ —Ö–æ—Ç–µ–ª –¥–ª—è –¥–µ—Ç–µ–π ¬´—é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –±—É–¥—É—â–µ–µ¬ª.',
      relations:{ dante:95, vivien:80, grayson:75, aiden:80, ember:80 },
      approval:{ player1:55, player2:65 },
      lastThought:'',
      avatar:''
    },
    {
      id:'alexi',
      name:'–ê–ª–µ–∫—Å–∏ –£–æ–∫–µ—Ä',
      username:'@mercuryAl',
      tone:'warm',
      followers:3000,
      bio:'–ë–µ—Ç–∞, —Å–æ–ª–∏—Å—Ç –∏ –æ—Å–Ω–æ–≤–∞—Ç–µ–ª—å —Ä–æ–∫-–≥—Ä—É–ø–ø—ã ¬´Ash&mercury¬ª, –≤—ã—Ä–æ—Å –≤ –±–µ–¥–Ω–æ—Å—Ç–∏, –Ω–æ –±—ã–ª —É—Å—ã–Ω–æ–≤–ª—ë–Ω –ë–ª–µ–π–¥–º–æ—Ä–∞–º–∏. –ü—Ä–µ–¥–∞–Ω–Ω—ã–π, –¥–æ–±—Ä—ã–π –±—É–Ω—Ç–∞—Ä—å, –≤ —Å–ª–æ–∂–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö —Å –í–∏–≤—å–µ–Ω –∏ –ï–≤–æ–π.',
      relations:{ vivien:85, eve:80, dante:70, grayson:80 },
      approval:{ player1:80, player2:55 },
      lastThought:'',
      avatar:''
    },
    {
      id:'evelyn',
      name:'–≠–≤–µ–ª–∏–Ω –•–∞—Ä—Ç',
      username:'@drHart',
      tone:'sharp',
      followers:22000,
      bio:'–ê–ª—å—Ñ–∞, –±—ã–≤—à–∏–π —Å—É–¥–º–µ–¥—ç–∫—Å–ø–µ—Ä—Ç, —Å–µ–π—á–∞—Å –≤–ª–∞–¥–µ–ª–∏—Ü–∞ –∫–ª–∏–Ω–∏–∫–∏ Family Hart. –ò—Ä–æ–Ω–∏—á–Ω–∞—è, –¥–µ—Ä–∑–∫–∞—è, –¥–∞—ë—Ç –ª—é–¥—è–º –ø—Ä–æ–∑–≤–∏—â–∞ –∏ —Å—Ç–∞–≤–∏—Ç –¥–∏–∞–≥–Ω–æ–∑—ã –ø–æ —Ç–≤–∏—Ç–∞–º; –æ—Å–æ–±–µ–Ω–Ω–æ –±–ª–∏–∑–∫–∞ —Å –õ–æ—Ä–∞–Ω–æ–º –∏ –ê–≤—Ä–æ—Ä–æ–π.',
      relations:{ loran:90, aurora:85, eve:50, kaylan:70, derek:70 },
      approval:{ player1:55, player2:85 },
      lastThought:'',
      avatar:''
    },
    {
      id:'ellean',
      name:'–≠–ª–ª–µ–∞–Ω –ë–ª–µ–π–¥–º–æ—Ä',
      username:'@EllyMurrr',
      tone:'chaotic',
      followers:26000,
      bio:'–ñ—É—Ä–Ω–∞–ª–∏—Å—Ç –∏ –∏–∑–¥–∞—Ç–µ–ª—å BladeM, —à—É–º–Ω—ã–π –∏ —Ç–∞–∫—Ç–∏–ª—å–Ω—ã–π –¥–µ–¥—É—à–∫–∞ –ë–ª–µ–π–¥–º–æ—Ä–æ–≤. –õ—é–±–∏—Ç –ø—Ä–∞–Ω–∫–∏ —Å –≠–π–¥–µ–Ω–æ–º –∏ –≠–º–±–µ—Ä, —Ç–µ–ø–ª–æ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –ì—Ä–µ–π—Å–æ–Ω—É –∏ –ø—Ä–æ—Å–∏—Ç –õ–æ—Ä–∞–Ω–∞ –±—ã—Ç—å —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω–µ–µ.',
      relations:{ kaylan:90, grayson:85, aiden:70, ember:70, loran:75 },
      approval:{ player1:90, player2:75 },
      lastThought:'',
      avatar:''
    },
    {
      id:'dohyun',
      name:'–ö–∞–Ω –î–æ—Ö—ë–Ω',
      username:'@RRentGen',
      tone:'stoic',
      followers:8000,
      bio:'–ê–ª—å—Ñ–∞-–º–µ–¥–∏–∫-–∏–Ω—Ç–µ—Ä–Ω, —Ç–∏—Ö–∏–π –≥–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –∫–ª–∏–Ω–∏–∫–µ –≠–≤–µ–ª–∏–Ω. –°—Ç–∞—Ä—ã–π –¥—Ä—É–≥ –õ–æ—Ä–∞–Ω—Ç–∏—Å–∞, —Ä–∞–∑–¥–µ–ª—è–µ—Ç —Å –Ω–∏–º –ª—é–±–æ–≤—å –∫ –∑–Ω–∞–Ω–∏—è–º –∏ –∞–Ω–∏–º–µ, —Å—á–∏—Ç–∞–µ—Ç –ì—Ä–µ–π—Å–æ–Ω–∞ –Ω–µ–¥–æ—Å—Ç–æ–π–Ω—ã–º –õ–æ—Ä–∞–Ω–∞.',
      relations:{ loran:90, evelyn:70 },
      approval:{ player1:30, player2:85 },
      lastThought:'',
      avatar:''
    },
    {
      id:'ethan',
      name:'–ò—Ç–∞–Ω –•–æ–≥–≥–∞—Ä—Ç',
      username:'@metaphoricalallegory',
      tone:'warm',
      followers:5000,
      bio:'–ê–ª—å—Ñ–∞-—É—á–∏—Ç–µ–ª—å –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã –∏ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å —Ç–µ–∞—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –∫–ª—É–±–∞. –î–æ–±—Ä—ã–π, —Ö–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω—ã–π, –ª—é–±–∏–º–µ—Ü —à–∫–æ–ª—å–Ω–∏–∫–æ–≤; –æ—Å–æ–±–µ–Ω–Ω–æ –≤–µ—Ä–∏—Ç –≤ —Ç–∞–ª–∞–Ω—Ç –≠–π–¥–µ–Ω–∞.',
      relations:{ aiden:90 },
      approval:{ player1:60, player2:55 },
      lastThought:'',
      avatar:''
    },
    {
      id:'kassandra',
      name:'–ö–∞—Å—Å–∞–Ω–¥—Ä–∞ –ë–ª–µ–π–¥–º–æ—Ä',
      username:'@Kkassy',
      tone:'warm',
      followers:4000,
      bio:'–ê–ª—å—Ñ–∞-–≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä, –º–ª–∞–¥—à–∞—è —Å–µ—Å—Ç—Ä–∞ –ö–∞–π–ª–∞–Ω–∞, –≤–ª–∞–¥–µ–ª–∏—Ü–∞ —Ñ–µ—Ä–º—ã –∏ –∫–æ–Ω—é—à–µ–Ω. –û—á–µ–Ω—å –º—è–≥–∫–∞—è, –Ω–æ —Å–∏–ª—å–Ω–∞—è –¥—É—Ö–æ–º –∂–µ–Ω—â–∏–Ω–∞, –ª—é–±–∏—Ç –ø–ª–µ–º—è–Ω–Ω–∏–∫–æ–≤; —Å–µ–π—á–∞—Å –ì—Ä–µ–π—Å–æ–Ω —É –Ω–µ—ë —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ª–æ—à–∞–¥—å–º–∏.',
      relations:{ grayson:85, kaylan:80, dante:75 },
      approval:{ player1:85, player2:60 },
      lastThought:'',
      avatar:''
    }
  ];

  state.posts = [
    postObj({
      type:'social',
      authorType:'character',
      authorId:'vivien',
      content:'–ö—Ç–æ –∏–¥—ë—Ç —Å–µ–≥–æ–¥–Ω—è –Ω–∞ —Ä–µ–ø–µ—Ç–∏—Ü–∏—é Ash&mercury? –ù—É–∂–Ω–æ –æ—Ç–æ–≥–Ω–∞—Ç—å –¥—É—Ä–Ω—ã–µ –º—ã—Å–ª–∏ –≥—Ä–æ–º–∫–æ–π –º—É–∑—ã–∫–æ–π.',
      relatedCharacters:['alexi','eve']
    }),
    postObj({
      type:'social',
      authorType:'character',
      authorId:'kristian',
      content:'–ò–Ω–æ–≥–¥–∞ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ –¥–µ—Ç–∏ –≤ —à–∫–æ–ª–µ –º—É–¥—Ä–µ–µ –≤–∑—Ä–æ—Å–ª—ã—Ö –Ω–∞ –≤–µ—á–µ—Ä–∏–Ω–∫–∞—Ö.',
      relatedCharacters:[]
    })
  ];
}

// === —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ / –∑–∞–≥—Ä—É–∑–∫–∞ ===
function save(){
  try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch(e){}
}

function load(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(raw) state = JSON.parse(raw);
  }catch(e){}

  // –ø—Ä–∏–≤–æ–¥–∏–º —Å—Ö–µ–º—É –∫ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π
  migrateStateSchema();

  // —Å–æ–∑–¥–∞—ë–º –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π/—Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –ø–æ—Å—Ç—ã, –µ—Å–ª–∏ –ø—É—Å—Ç–æ
  seedIfEmpty();

  function seedWorldAccounts(){
  if (state.npcs.length || state.outlets.length) return;

  const tones = ['warm','stoic','sharp','chaotic'];
  const topics = state.world.topics;

  const handleBits = {
    horses: ['horseslover','hoofbeats','stableaddict','ride4life','cavalier','coltwatch'],
    music:  ['ashfan','riffhunter','vinylcity','gigguide','ampjunkie'],
    family: ['familyfirst','blademorewatch','homevibes','parenttalk'],
    gossip: ['CityRumors','TeaSpill','SpiceWire','WhisperLane','DailyDust'],
    nightlife:['afterdark','clubtrail','midnightowl','citylights'],
    university:['campusbee','studyflow','libratalk'],
    sports:  ['varsitywatch','balltalk','arenaecho'],
    tech:    ['techpulse','devglance','codetips'],
    citylife:['urbansight','streetnotes','townsquare']
  };

  function makeHandle(topic){
    const pool = handleBits[topic] || ['feedline','localvoice','randomuser'];
    const base = choice(pool);
    const suffix = Math.random()<0.5 ? '' : Math.floor(10+Math.random()*89);
    return '@' + (base + suffix);
  }

  function makeName(){
    const first = ['–°–∞—à–∞','–ö–∏—Ä–∞','–ú–∞–∫—Å','–ê–Ω—è','–î–µ–Ω–∏—Å','–õ–∏—è','–ò–≥–æ—Ä—å','–ù–∏–∫–∞','–Ø–Ω','–ú–∏–ª–∞','–¢–∏–º—É—Ä','–†–∏—Ç–∞','–§–µ–¥—è','–Æ–ª—è','–ì–æ—à–∞'];
    const last  = ['–ò–ª—å–∏–Ω','–°–∞–≤–∏–Ω–∞','–¢—É–º–∞–Ω–æ–≤–∞','–õ–µ–±–µ–¥–µ–≤','–ì—Ä–æ–º–æ–≤–∞','–í–æ–ª–∫–æ–≤','–ú–µ–ª—å–Ω–∏–∫','–ö–æ—Ç–æ–≤–∞','–†—É–¥–Ω–µ–≤','–°–º–∏—Ä–Ω–æ–≤–∞','–ù–∞–∑–∞—Ä–æ–≤'];
    return `${choice(first)} ${choice(last)}`;
  }

  // 28‚Äì36 –æ–±—ã—á–Ω—ã—Ö NPC
  const npcCount = randint(28,36);
  for (let i=0;i<npcCount;i++){
    const t = choice(topics);
    state.npcs.push({
      id: uid('npc'),
      name: '',
      username: makeHandle(t),
      tone: choice(tones),
      topic: t,
      bio: `–û–±—ã—á–Ω—ã–π –∂–∏—Ç–µ–ª—å –≥–æ—Ä–æ–¥–∞, –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è: ${t}.`
    });
  }

  // –°–ú–ò: –Ω–æ–≤–æ—Å—Ç–∏ + —Ç–∞–±–ª–æ–∏–¥—ã
  const outlets = [
    { name:'–ì–æ—Ä–æ–¥ –°–µ–≥–æ–¥–Ω—è',   topic:'citylife', type:'news'   },
    { name:'–ö–∞–Ω—Ç–µ—Ä-–¢–∞—É–Ω News',topic:'citylife', type:'news'   },
    { name:'–°–≤–µ—Ç—Å–∫–∞—è –õ—É–ø–∞',   topic:'gossip',   type:'tabloid'},
    { name:'Daily Dust',      topic:'gossip',   type:'tabloid'}
  ];

  state.outlets = outlets.map(o=>({
    id: uid('outlet'),
    name: o.name,
    username: makeHandle(o.topic),
    tone: o.type==='news' ? 'stoic' : 'sharp',
    outletType: o.type,
    topic: o.topic,
    bio: o.type==='news'
      ? '–ú–µ—Å—Ç–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏, –∫–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É.'
      : '–ì—Ä–æ–º–∫–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏, —Å–ª—É—Ö–∏ –∏ —Å–ø–ª–µ—Ç–Ω–∏.'
  }));
}


  // —Å–æ–∑–¥–∞—ë–º NPC –∏ –º–µ–¥–∏–∞, –µ—Å–ª–∏ –∏—Ö –µ—â—ë –Ω–µ—Ç
  seedWorldAccounts();

  save();
}



// === –º–æ–¥–µ–ª–∏ –ø–æ—Å—Ç–æ–≤ / —Ä–µ–∞–∫—Ü–∏–π ===
function postObj({type, authorType, authorId, content, relatedCharacters=[], photoData=null}){
  return {
    id: uid('post'),
    type,
    authorType,
    authorId,
    content,
    relatedCharacters,
    photoData,
    createdAt: nowIso(),
    likes: randint(0,50),
    comments: []
  };
}
function reactionObj(postId, charId, text, delta){
  return { id:uid('rx'), postId, charId, text, delta, at: nowIso() };
}

// === –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–∫–ª–∞–¥–∫–∞–º ===
function setActiveView(key){
  $$('.view').forEach(v=>v.classList.remove('active'));
  document.querySelector(`#view-${key}`).classList.add('active');
  $$('.tab').forEach(t=>t.classList.toggle('active', t.dataset.target===key));
  if(key==='relations') renderRelations();
  if(key==='dm')        syncDmSelectors();
  if(key==='reactions') renderReactions();
  if(key==='feed')      renderFeed();
}
function setupNav(){
  $$('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>setActiveView(btn.dataset.target));
  });
}

// === –ª–µ–Ω—Ç–∞ ===
let feedFilter = 'all';

function renderFeed(){
  const ul = $('#feedList');
  const posts = state.posts
    .filter(p => feedFilter==='all' ? true : p.type===feedFilter)
    .slice().sort((a,b)=>b.createdAt.localeCompare(a.createdAt));

  ul.innerHTML = posts.map(p=>renderPostHtml(p)).join('');
  posts.forEach(p=>{
    if(p.type==='social'){
      const btn = document.querySelector(`[data-action="comment"][data-id="${p.id}"]`);
      if(btn) btn.onclick = ()=>addQuickComment(p.id);
    }
  });
}


function getAuthorByType(authorType, id){
  if (authorType==='player')    return state.players.find(x=>x.id===id);
  if (authorType==='character') return state.characters.find(x=>x.id===id);
  if (authorType==='npc')       return state.npcs.find(x=>x.id===id);
  if (authorType==='outlet')    return state.outlets.find(x=>x.id===id);
  return null;
}

// –î–æ–±–∞–≤–∏–º —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ –±—ã–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º –∫–æ–¥–µ
function openReactionsForPost(postId) {
    lastReactionPostId = postId; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ ID –ø–æ—Å—Ç–∞
    setActiveView('reactions'); // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –≤–∫–ª–∞–¥–∫—É —Ä–µ–∞–∫—Ü–∏–π
}

function renderPostHtml(p){
  const author = getAuthorByType(p.authorType, p.authorId);
  const rawName = author?.name ?? '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
  const rawUsername = author?.username ?? '@user';

  const isMedia = p.authorType==='outlet';
  const isNpc   = p.authorType==='npc';

  // —É –∂–∏—Ç–µ–ª–µ–π –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ @–Ω–∏–∫
  const name = isNpc ? rawUsername : rawName;
  const username = isNpc ? '' : rawUsername;

  const badge = p.type==='story' ? `<span class="badge">–°—é–∂–µ—Ç</span>`
              : isMedia           ? `<span class="badge">–ú–µ–¥–∏–∞</span>`
              : isNpc             ? `<span class="badge">–ñ–∏—Ç–µ–ª—å</span>`
              : '';

  const photo = p.photoData ? `<div class="photo-preview"><img src="${p.photoData}" alt=""></div>` : '';

  const commentsRow = (p.type==='social')
    ? `<div class="post-actions">
         <span class="icon">üí¨ <span>${p.comments.length}</span></span>
         <button class="ghost" data-action="comment" data-id="${p.id}">–ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
       </div>`
    : `<div class="post-actions"><span class="badge">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã</span></div>`;

  const reactionBtn = `<div class="post-actions">
      <button class="secondary" onclick="openReactionsForPost('${p.id}')">–†–µ–∞–∫—Ü–∏–∏</button>
      <span class="icon" title="${fmtTime(p.createdAt)}">üïí ${new Date(p.createdAt).toLocaleTimeString()}</span>
    </div>`;

  return `
    <li class="post" id="${p.id}">
      <div class="post-head">
        <div class="avatar" aria-hidden="true"></div>
        <div class="meta">
          <div class="name">${name} ${badge}</div>
          ${username ? `<div class="username">${username}</div>` : ''}
        </div>
      </div>
      <div class="post-content">${p.type==='story'
        ? p.content.replace(/\n/g,'<br>')
        : clip(p.content, 600)}</div>
      ${photo}
      ${commentsRow}
      ${reactionBtn}
    </li>
  `;
}



function addQuickComment(postId){
  const p = state.posts.find(p=>p.id===postId);
  if(!p) return;
  const who = currentPlayer();
  const txt = prompt('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:');
  if(!txt) return;
  p.comments.push({ id:uid('c'), from: who.id, text: txt, at: nowIso() });
  save();
  renderFeed();
}

// === CHARACTER PROFILE ===
let currentProfileCharId = null;
let isEditingBio = false;

function relationLabelFromValue(v){
  if (v >= 85) return '–¥—É—à–µ–≤–Ω–∞—è –±–ª–∏–∑–æ—Å—Ç—å';
  if (v >= 70) return '–±–ª–∏–∑–∫–∏–µ —Å–æ—é–∑–Ω–∏–∫–∏';
  if (v >= 50) return '–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è —Å–≤—è–∑—å';
  if (v >= 30) return '–Ω–∞—Ç—è–Ω—É—Ç–æ–µ –æ–±—â–µ–Ω–∏–µ';
  return '—Ä–∞–∑–ª–∞–¥ –∏ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ';
}

function openCharacterProfile(charId){
  currentProfileCharId = charId;
  isEditingBio = false;
  renderCharacterProfile();
  setActiveView('character');
  // –ø–æ–ø—Ä–æ—Å–∏–º –ò–ò —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é –º—ã—Å–ª—å
  updateProfileThoughtWithAI(charId);
}

async function aiGenerateRelationTitle(char, player, approvalNow, lastDelta){
  const prompt = `
–¢—ã –ø—Ä–∏–¥—É–º—ã–≤–∞–µ—à—å —ë–º–∫–∏–µ, –¥–µ—Ä–∑–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –æ—Ç–Ω–æ—à–µ–Ω–∏–π –º–µ–∂–¥—É –¥–≤—É–º—è –≤—ã–º—ã—à–ª–µ–Ω–Ω—ã–º–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏.
–î–∞–π –û–î–ù–£ —Ñ—Ä–∞–∑—É (3‚Äì7 —Å–ª–æ–≤) –ø–æ-—Ä—É—Å—Å–∫–∏, –±–µ–∑ –∫–∞–≤—ã—á–µ–∫, –±–µ–∑ —Ç–æ—á–µ–∫ –≤ –∫–æ–Ω—Ü–µ.

–ö–æ–Ω—Ç–µ–∫—Å—Ç:
- –ü–µ—Ä—Å–æ–Ω–∞–∂ A: ${char.name}
- –ü–µ—Ä—Å–æ–Ω–∞–∂ B: ${player.name}
- –¢–µ–∫—É—â–µ–µ —Å–±–ª–∏–∂–µ–Ω–∏–µ (0‚Äì100): ${Math.round(approvalNow)}
- –ü–æ—Å–ª–µ–¥–Ω—è—è –¥–∏–Ω–∞–º–∏–∫–∞ (–¥–µ–ª—å—Ç–∞): ${lastDelta > 0 ? '+'+lastDelta : lastDelta}

–ü—Ä–∏–º–µ—Ä—ã —Å—Ç–∏–ª—è:
- –±—ã–≤—à–∏–µ –≤–æ–∑–ª—é–±–ª–µ–Ω–Ω—ã–µ —Å —à–∞–Ω—Å–æ–º –Ω–∞ –≤–æ—Å—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
- –ª—É—á—à–∏–µ –¥—Ä—É–∑—å—è –¥–æ –∫–æ–Ω—Ü–∞ –∂–∏–∑–Ω–∏
- —Å–µ–∫—Å—É–∞–ª—å–Ω—ã–µ –ø–∞—Ä—Ç–Ω—ë—Ä—ã —Å –Ω–∞–¥–µ–∂–¥–æ–π –Ω–∞ –±–æ–ª—å—à–µ–µ
- —Å–æ—é–∑–Ω–∏–∫–∏ –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –Ω–æ –Ω–µ –ø–æ —Å–µ—Ä–¥—Ü—É

–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ —Å–∞–º –∑–∞–≥–æ–ª–æ–≤–æ–∫.`;
  const txt = await askAI(prompt);
  const cleaned = (txt||'').replace(/[¬´¬ª"]/g,'').trim();
  if (!cleaned) {
    // –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî –ø–æ —à–∫–∞–ª–µ
    return relationLabelFromValue(approvalNow);
  }
  return cleaned;
}

async function updateProfileThoughtWithAI(charId){
  const c = state.characters.find(x=>x.id===charId);
  if (!c) return;
  const key = state.activePlayerId;

  // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å–≤–æ–π—Å—Ç–≤–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  if (!c.profileThought) c.profileThought = {};

  // –µ—Å–ª–∏ –º—ã—Å–ª—å —É–∂–µ –µ—Å—Ç—å ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
  if (c.profileThought[key]) return;

  const text = await aiGenerateProfileThought(c);
  if (!text) return;
  
  c.profileThought[key] = text;
  save();

  if (currentProfileCharId === charId){
    renderCharacterProfile();
  }
}

function renderCharacterProfile(){
  if (!currentProfileCharId) return;
  const me = currentPlayer();
  
  // –ò—â–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏ –≤ characters, –∏ –≤ players (—Ç–∞–∫ –∫–∞–∫ –∏–≥—Ä–æ–∫–∏ —Ç–æ–∂–µ –∏–º–µ—é—Ç –ø—Ä–æ—Ñ–∏–ª–∏)
  let c = state.characters.find(x=>x.id===currentProfileCharId);
  if (!c) c = state.players.find(x=>x.id===currentProfileCharId);

  if (!c) return;
  const box = $('#characterView');

  // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —É –æ–±—ä–µ–∫—Ç–∞ –µ—Å—Ç—å –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è, –¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ –∏–≥—Ä–æ–∫ –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
  if (!c.approval) c.approval = {};
  if (!c.profileThought) c.profileThought = {};
  if (!c.relationTitles) c.relationTitles = {};

  const appr = (c.approval?.[state.activePlayerId] ?? 50);

  // 3-–π —Å–ª–æ–π: –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–π
  const relTitle = c.relationTitles[state.activePlayerId] || relationLabelFromValue(appr);

  // 2-–π —Å–ª–æ–π: –º—ã—Å–ª—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –æ –∏–≥—Ä–æ–∫–µ
  const profileThought = c.profileThought[state.activePlayerId] || '';

  const username = c.username || '@username';
  const bio = c.bio || '–û–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –ø–æ–∫–∞ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ.';
  const avatarImg = c.avatar ? `<img src="${c.avatar}" alt="${c.name}">` : '';

  const editBlock = isEditingBio
    ? `<textarea id="charBioEdit" class="char-bio-edit" rows="6"
        placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞, –µ–≥–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä, —Ç—Ä–∞–≤–º—ã, –æ—Ç–Ω–æ—à–µ–Ω–∏—è, —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏ —Ç.–ø.">${bio}</textarea>`
    : '';

  // === –ò–ó–ú–ï–ù–ï–ù–ò–ï 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—à –ª–∏ —ç—Ç–æ –ø—Ä–æ—Ñ–∏–ª—å ===
  const isOwnProfile = (c.id === state.activePlayerId);
  
  // === –ò–ó–ú–ï–ù–ï–ù–ò–ï 2: –ü—Ä—è—á–µ–º –±–ª–æ–∫ –æ—Ç–Ω–æ—à–µ–Ω–∏–π, –µ—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –Ω–∞—à ===
  let relationBlockHtml = '';
  if (!isOwnProfile) {
    relationBlockHtml = `
    <div class="char-rel-block">
      <div class="char-rel-label-row">
        <span>–°–≤—è–∑—å —Å ${me.name}</span>
        <span><strong>${Math.round(appr)}%</strong></span>
      </div>
      <div class="char-rel-bar">
        <span style="width:${clamp(appr,0,100)}%"></span>
      </div>
      <div class="char-rel-title">
        ${relTitle}
      </div>
      <div class="char-rel-thought">
        ${profileThought || '–ü–æ–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂ –º–æ–ª—á–∏—Ç –∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–±–ª—é–¥–∞–µ—Ç –∑–∞ —Ç–æ–±–æ–π.'}
      </div>
    </div>
    `;
  }

  // === –ò–ó–ú–ï–ù–ï–ù–ò–ï 3: –ü—Ä—è—á–µ–º –∫–Ω–æ–ø–∫—É "–õ–°", –µ—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –Ω–∞—à ===
  const actions = isEditingBio
    ? `
      <button class="primary" onclick="saveCharacterBio()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ</button>
      <button class="secondary" onclick="cancelEditBio()">–û—Ç–º–µ–Ω–∞</button>
      ${!isOwnProfile ? `<button class="ghost" onclick="openDm('${c.id}')">–ü–µ—Ä–µ–π—Ç–∏ –≤ –õ–°</button>` : ''}
      <button class="ghost" onclick="setActiveView('relations')">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</button>
    `
    : `
      <button class="secondary" onclick="startEditBio()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ</button>
      ${!isOwnProfile ? `<button class="secondary" onclick="openDm('${c.id}')">–ü–µ—Ä–µ–π—Ç–∏ –≤ –õ–°</button>` : ''}
      <button class="ghost" onclick="setActiveView('relations')">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</button>
    `;

  box.innerHTML = `
    <div class="char-cover"></div>
    <div class="char-header">
      <div class="char-header-top">
        <div class="char-avatar" onclick="selectCharacterAvatar()">
          ${avatarImg}
        </div>
        <div>
          <div class="char-name">${c.name}</div>
          <div class="char-username">${username}</div>
        </div>
      </div>

      <button class="ghost char-avatar-btn" onclick="selectCharacterAvatar()">
        –ò–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä
      </button>

      <div class="char-bio">
        ${bio.replace(/\n/g,'<br>')}
      </div>

      ${editBlock}
      
      ${relationBlockHtml} <div class="char-actions-row">
        ${actions}
      </div>

      <input id="charAvatarInput" type="file" accept="image/*" hidden />
    </div>
  `;

  // —Ñ–∞–π–ª –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞
  const avatarInput = document.getElementById('charAvatarInput');
  if (avatarInput) {
    // –í–∞–∂–Ω–æ: —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤, –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ onclick/onchange,
    // –∏–ª–∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ addEventListener –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑.
    // –í –¥–∞–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ, —Ç–∞–∫ –∫–∞–∫ –º—ã –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤–µ—Å—å HTML, —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–µ—Ä—è—é—Ç—Å—è, —Ç–∞–∫ —á—Ç–æ —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ.
    avatarInput.addEventListener('change', handleAvatarFile);
  }
}


function saveCharacterBio(){
  if (!currentProfileCharId) return;
  // –ò—â–µ–º –∏ –≤ characters, –∏ –≤ players
  let c = state.characters.find(x=>x.id===currentProfileCharId);
  if (!c) c = state.players.find(x=>x.id===currentProfileCharId);

  if (!c) return;
  const ta = document.getElementById('charBioEdit');
  if (!ta) return;
  c.bio = ta.value.trim();
  save();
  isEditingBio = false;
  renderCharacterProfile();
}
function startEditBio(){
  isEditingBio = true;
  renderCharacterProfile();
}

function cancelEditBio(){
  isEditingBio = false;
  renderCharacterProfile();
}

function selectCharacterAvatar(){
  const input = document.getElementById('charAvatarInput');
  if (input) input.click();
}

function handleAvatarFile(e){
  const file = e.target.files && e.target.files[0];
  if (!file || !currentProfileCharId) return;

  const reader = new FileReader();
  reader.onload = () => {
    // –ò—â–µ–º –∏ –≤ characters, –∏ –≤ players
    let c = state.characters.find(x => x.id === currentProfileCharId);
    if (!c) c = state.players.find(x => x.id === currentProfileCharId);
    
    if (!c) return;
    c.avatar = reader.result;       // dataURL
    save();
    renderCharacterProfile();       // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
  };
  reader.readAsDataURL(file);
}


// === –æ—Ç–Ω–æ—à–µ–Ω–∏—è ===
// –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫.
function renderRelations(){
  const box = $('#relationsList');
  box.innerHTML = state.characters.filter(c => c.id !== state.activePlayerId).map(c=>{
    const appr = (c.approval[state.activePlayerId] ?? 50);
    const thought = c.lastThought ? clip(c.lastThought, 180) : '‚Äî';
    return `
      <div class="rel-card" onclick="openCharacterProfile('${c.id}')">
        <div class="rel-top">
          <div class="avatar"></div>
          <div>
            <div class="rel-name">${c.name}</div>
            <div class="username">${c.username}</div>
          </div>
        </div>
        <div class="progress"><span style="width:${appr}%"></span></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:.4rem;">
          <div class="muted">–£—Ä–æ–≤–µ–Ω—å: ${appr}%</div>
          <div class="rel-actions">
            <button class="secondary" onclick="event.stopPropagation(); openDm('${c.id}')">–õ–°</button>
          </div>
        </div>
        <div class="rel-thought">–ú—ã—Å–ª—å: ${thought}</div>
      </div>
    `;
  }).join('');
}

// === —Å–æ–∑–¥–∞–Ω–∏–µ –æ–±—ã—á–Ω–æ–≥–æ –ø–æ—Å—Ç–∞ ===
function setupComposeSocial(){
  
  // (–Ø –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª —ç—Ç–æ—Ç –∫–æ–¥, —Ç—ã –µ–≥–æ —Å–ª—É—á–∞–π–Ω–æ —É–¥–∞–ª–∏–ª)
  $('#composePhoto').addEventListener('change', (e) => {
     const file = e.target.files[0];
     if(file){
       const reader = new FileReader();
       reader.onload = (ev) => {
         $('#composePhotoPreview').innerHTML = `<img src="${ev.target.result}" alt="preview">`;
       };
       reader.readAsDataURL(file);
     } else {
       $('#composePhotoPreview').innerHTML = '';
     }
  });

  // –ø—É–±–ª–∏–∫–∞—Ü–∏—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ—Å—Ç–∞
  const btn = $('#publishSocialBtn'); // –ü–æ–ª—É—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ–¥–∏–Ω —Ä–∞–∑
  
  btn.onclick = async ()=>{
    const content   = $('#composeText').value.trim();
    const photoData = $('#composePhotoPreview img')?.getAttribute('src') || null;

    if (!content){
      alert('–ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞');
      return;
    }

    // 1. –ü–û–ö–ê–ó–´–í–ê–ï–ú –ó–ê–ì–†–£–ó–ö–£
    btn.classList.add('loading');

    const p = postObj({
      type:'social',
      authorType:'player',
      authorId: state.activePlayerId,
      content,
      relatedCharacters: [],
      photoData
    });

    state.posts.push(p);
    
    try {
      // 2. –ñ–î–ï–ú –ó–ê–í–ï–†–®–ï–ù–ò–Ø (–∑–¥–µ—Å—å –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—à–∏–±–∫–∞, –µ—Å–ª–∏ –Ω–µ—Ç API)
      await applyReactionsAndShowModal(p, false);
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (social):", e);
      alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
    } finally {
      // 3. –£–ë–ò–†–ê–ï–ú –ó–ê–ì–†–£–ó–ö–£ (–≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ)
      btn.classList.remove('loading');
    }

    // –æ—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    $('#composeText').value = '';
    $('#composePhoto').value = '';
    $('#composePhotoPreview').innerHTML = '';

    save();
    renderFeed();
    // –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é NPC-–ø–æ—Å—Ç–æ–≤ –≤ "—Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ"
    triggerNpcPostGeneration(p);
    setActiveView('feed');
  };
} // <--- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞—è –∑–∞–∫—Ä—ã–≤–∞—é—â–∞—è —Å–∫–æ–±–∫–∞!

// === —Å—é–∂–µ—Ç–Ω—ã–π –ø–æ—Å—Ç ===

// (–≠—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω—É–∂–Ω—ã –¥–ª—è –∏–¥–µ–π)
let storyIdeas = ['–ù–∞–∂–º–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å –∏–¥–µ–∏¬ª'];
let ideaIdx = 0;
                
function setupComposeStory() {
  // --- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ ¬´–ò–¥–µ–π¬ª ---
  // (–Ø –Ω–µ –∑–Ω–∞—é, –∫–∞–∫–∏–µ –±—ã–ª–∏ –∏–¥–µ–∏, –¥–æ–±–∞–≤–∏–ª –∑–∞–≥–ª—É—à–∫–∏)
  storyIdeas = [
    "–°—é–∂–µ—Ç–Ω–∞—è –∏–¥–µ—è 1: –ü–µ—Ä—Å–æ–Ω–∞–∂ –ê –Ω–∞—Ö–æ–¥–∏—Ç...",
    "–°—é–∂–µ—Ç–Ω–∞—è –∏–¥–µ—è 2: –°–ª—É—á–∞–π–Ω–∞—è –≤—Å—Ç—Ä–µ—á–∞ –≤...",
    "–°—é–∂–µ—Ç–Ω–∞—è –∏–¥–µ—è 3: –°—Ç–∞—Ä—ã–π —Å–µ–∫—Ä–µ—Ç..."
  ];
  ideaIdx = 0;
  paintIdea(); // –ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–≤—É—é –∏–¥–µ—é –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

  $('#ideaPrev').onclick = () => {
    ideaIdx = (ideaIdx - 1 + storyIdeas.length) % storyIdeas.length;
    paintIdea();
  };
  $('#ideaNext').onclick = () => {
    ideaIdx = (ideaIdx + 1) % storyIdeas.length;
    paintIdea();
  };
  $('#ideaRefresh').onclick = async () => {
    // (TODO: AI generation logic)
    alert("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–¥–µ–π (–ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)");
  };
  $('#ideaUse').onclick = () => {
    $('#storyText').value = storyIdeas[ideaIdx] || '';
  };
  // ---
                
  // --- –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ ¬´–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å¬ª (–∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ —à–∞–≥–∞) ---
  const btn = $('#publishStoryBtn'); // –ü–æ–ª—É—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ–¥–∏–Ω —Ä–∞–∑
                
  btn.onclick = async ()=>{
    const text = $('#storyText').value.trim();
    if(!text){
      alert('–ù–∞–ø–∏—à–∏ —Å—é–∂–µ—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–ª–∏ –≤—Å—Ç–∞–≤—å –∏–¥–µ—é');
      return;
    }

    // 1. –ü–û–ö–ê–ó–´–í–ê–ï–ú –ó–ê–ì–†–£–ó–ö–£
    btn.classList.add('loading');
  
    const p = postObj({
      type:'story',
      authorType:'player',
      authorId:state.activePlayerId,
      content: text,
      relatedCharacters: []
    });

    state.posts.push(p);

    try {
      // 2. –ñ–î–ï–ú –ó–ê–í–ï–†–®–ï–ù–ò–Ø
      await applyReactionsAndShowModal(p, true);
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (story):", e);
      alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
    } finally {
      // 3. –£–ë–ò–†–ê–ï–ú –ó–ê–ì–†–£–ó–ö–£
      btn.classList.remove('loading');
    }

    $('#storyText').value = '';

    save();
    renderFeed();
    // –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é NPC-–ø–æ—Å—Ç–æ–≤ –≤ "—Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ"
    triggerNpcPostGeneration(p);
    setActiveView('feed');
  };
}

function paintIdea(){
  $('#ideaText').textContent = storyIdeas[ideaIdx] || '–ò–¥–µ–π –ø–æ–∫–∞ –Ω–µ—Ç ‚Äî –Ω–∞–∂–º–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å –∏–¥–µ–∏¬ª';
}
function threadKey(charId, playerId=state.activePlayerId){
  return `${charId}_${playerId}`;
}

// –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫.
function syncDmSelectors(){
  const sel = $('#dmSelect');
  sel.innerHTML = state.characters.filter(c => c.id !== state.activePlayerId).map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  
  // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏–Ω–∞—á–µ –≤—ã–±–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ
  if(!sel.value) {
      const firstAvailable = state.characters.find(c => c.id !== state.activePlayerId);
      if (firstAvailable) sel.value = firstAvailable.id;
  }

  const current = state.characters.find(c=>c.id===sel.value);
  $('#dmTitle').textContent = '–õ–° ¬∑ ' + (current?.name || '');
  
  if (sel.value) {
    renderDmThread(sel.value);
  }
}

function openDm(charId){
  setActiveView('dm');
  // –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è option
  const opt = document.querySelector('#dmSelect option[value="' + charId + '"]');
  if (opt) {
    $('#dmSelect').value = charId;
  }
  const c = state.characters.find(x=>x.id===charId);
  $('#dmTitle').textContent = '–õ–° ¬∑ ' + (c?.name || '');
  renderDmThread(charId);
}


function renderDmThread(charId){
  const key = threadKey(charId);
  const list = state.dms[key] || [];
  const box = $('#dmThread');
  box.innerHTML = list.map(m=>
    `<div class="bubble ${m.from===state.activePlayerId?'me':'them'}">${m.text}</div>`
  ).join('');
  box.scrollTop = box.scrollHeight;
}

function pushMessage(charId, from, text){
  const key = threadKey(charId);
  if(!state.dms[key]) state.dms[key]=[];
  state.dms[key].push({ from, text, at:nowIso() });
  save();
  if($('#view-dm').classList.contains('active') && $('#dmSelect').value===charId){
    renderDmThread(charId);
  }
}

function setupDm(){
  $('#dmSelect').addEventListener('change', (e)=>{
    const id = e.target.value;
    const c = state.characters.find(x=>x.id===id);
    $('#dmTitle').textContent = '–õ–° ¬∑ ' + (c?.name || '');
    renderDmThread(id);
  });

  $('#dmSend').onclick = async ()=>{
    const charId = $('#dmSelect').value;
    if (!charId) return;
    const text = $('#dmInput').value.trim();
    if (!text) return;

    pushMessage(charId, state.activePlayerId, text);
    $('#dmInput').value = '';

    if ($('#dmAutoToggle').checked) {
      await aiReplyToDm(charId);
    }
  };

  // –î–æ–±–∞–≤–∏–º –æ—Ç–ø—Ä–∞–≤–∫—É –ø–æ Enter
  $('#dmInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      $('#dmSend').click();
    }
  });
}

// === AI-—Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ –ø–æ—Å—Ç –∏ –º—ã—Å–ª–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ ===

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥–ª—É–±–æ–∫–æ–π —Ä–µ–∞–∫—Ü–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –Ω–∞ –ø–æ—Å—Ç
async function aiGenerateReactionText(char, player, post, delta, isStory) {
  // ... (–í–µ—Å—å –∫–æ–¥ AI —Ñ—É–Ω–∫—Ü–∏–π –æ—Å—Ç–∞–≤–ª–µ–Ω –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Ç–∞–∫ –∫–∞–∫ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å —Ç–∞–º –≤–µ—Ä–Ω—ã–π)
  // (–ö–æ–¥ –æ–ø—É—â–µ–Ω –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏, –Ω–æ –æ–Ω –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è —Ä–∞–±–æ—Ç—ã AI)
  return generateThought(char, post, delta); // –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π fallback
}

// –ö–æ—Ä–æ—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ –º–∏—Ä–∞ –¥–ª—è –ø–æ—Å—Ç–æ–≤ (—á—Ç–æ —Å–µ–π—á–∞—Å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –ª–µ–Ω—Ç–µ)
function worldSnapshot(limit = 8) {
  const posts = state.posts.slice().sort((a,b)=>b.createdAt.localeCompare(a.createdAt)).slice(0,limit);

  if (!posts.length) {
    return '–ü–æ–∫–∞ –≤ –ª–µ–Ω—Ç–µ –ø–æ—á—Ç–∏ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç, –º–æ–∂–Ω–æ —Å—Ç–∞—Ç—å –ø–µ—Ä–≤—ã–º, –∫—Ç–æ —á—Ç–æ-—Ç–æ –Ω–∞–ø–∏—à–µ—Ç.';
  }

  const lines = posts.map(p => {
    const a = getAuthorByType(p.authorType, p.authorId);
    const who = a?.username || a?.name || '–∫—Ç–æ-—Ç–æ';
    const tag = p.type === 'story' ? '[—Å—é–∂–µ—Ç]' : '';
    const text = clip((p.content || '').replace(/\n/g,' '), 120);
    return `‚Ä¢ ${who} ${tag}: ${text}`;
  });

  return lines.join('\n');
}

// –ü–æ–¥–±–æ—Ä –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–ª—è @—É–ø–æ–º–∏–Ω–∞–Ω–∏–π
function pickMentionCandidates(char, max = 3) {
  const seen = new Set();
  const result = [];

  function pushIfOk(id) {
    if (!id || id === char.id || seen.has(id)) return;
    let obj = state.characters.find(c => c.id === id) || state.players.find(p => p.id === id);
    if (!obj) return;
    seen.add(id);
    result.push(obj);
  }

  // —Å–Ω–∞—á–∞–ª–∞ ‚Äî —è–≤–Ω—ã–µ —Å–≤—è–∑–∏
  if (char.relations) {
    for (const otherId of Object.keys(char.relations)) {
      pushIfOk(otherId);
    }
  }

  // –ø–æ—Ç–æ–º ‚Äî —Ç–µ, –∫ –∫–æ–º—É –µ—Å—Ç—å approval
  if (char.approval) {
    for (const otherId of Object.keys(char.approval)) {
      pushIfOk(otherId);
    }
  }

  // –µ—Å–ª–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –º–∞–ª–æ ‚Äî –¥–æ–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã—Ö
  const extraPool = state.characters
    .filter(c => c.id !== char.id && !seen.has(c.id));
  extraPool.sort(() => Math.random() - 0.5);
  for (const c of extraPool) {
    if (result.length >= max) break;
    pushIfOk(c.id);
  }

  return result.slice(0, max);
}

// –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç ¬´—Ç–≤–∏—Ç–∞¬ª, –µ—Å–ª–∏ AI –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª
function fallbackNpcTweet(char) {
  const base = [
    '–ü–æ—á–µ–º—É –≤–∑—Ä–æ—Å–ª—É—é –∂–∏–∑–Ω—å –Ω–∏–∫—Ç–æ –Ω–µ —Å–Ω–∞–±–¥–∏–ª –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π?',
    '–ò–Ω–æ–≥–¥–∞ —Ç–∏—à–∏–Ω–∞ –≥—Ä–æ–º—á–µ –ª—é–±—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.',
    '–ö–∞–∂–µ—Ç—Å—è, —è –æ–ø—è—Ç—å –≤–≤—è–∑–∞–ª—Å—è –≤–æ —á—Ç–æ-—Ç–æ —Å—Ç—Ä–∞–Ω–Ω–æ–µ.',
    '–ö—Ç–æ-–Ω–∏–±—É–¥—å, –æ—Ç–º–µ–Ω–∏—Ç–µ —É—Ç—Ä–æ, —è –Ω–µ –≥–æ—Ç–æ–≤(–∞).',
    '–ò–Ω–æ–≥–¥–∞ –ø—Ä–æ—â–µ —Å–¥–µ–ª–∞—Ç—å –≤–∏–¥, —á—Ç–æ –≤—Å—ë –≤ –ø–æ—Ä—è–¥–∫–µ.'
  ];
  return choice(base);
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–∞ –≤ –ª–µ–Ω—Ç—É –æ—Ç –∏–º–µ–Ω–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (–æ–±–ª–µ–≥—á—ë–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç)
async function aiGenerateAmbientCharacterTweet(char, playerPost = null) {
  const shortBio = (char.bio || '').slice(0, 280); // —É—Ä–µ–∑–∞–µ–º –±–∏–æ, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å –º–æ–¥–µ–ª—å
  const mentions = pickMentionCandidates(char, 3);

  const mentionsHint = mentions.length
    ? '–¢—ã –º–æ–∂–µ—à—å (–Ω–æ –Ω–µ –æ–±—è–∑–∞–Ω) —É–ø–æ–º—è–Ω—É—Ç—å –∫–æ–≥–æ-—Ç–æ –∏–∑ —ç—Ç–∏—Ö –ª—é–¥–µ–π —á–µ—Ä–µ–∑ @username: ' +
      mentions.map(o => o.username || '@user').join(', ') + '.'
    : '–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –º–æ–∂–µ—à—å —É–ø–æ–º—è–Ω—É—Ç—å –¥—Ä—É–≥–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ —á–µ—Ä–µ–∑ @username.';

  const reactedHint = playerPost
    ? `–ò–≥—Ä–æ–∫ —Ç–æ–ª—å–∫–æ —á—Ç–æ –Ω–∞–ø–∏—Å–∞–ª –ø–æ—Å—Ç: "${clip(playerPost.content || '', 150)}". –¢—ã –º–æ–∂–µ—à—å –æ—Ç—Ç–æ–ª–∫–Ω—É—Ç—å—Å—è –æ—Ç –Ω–µ–≥–æ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—Å–∞—Ç—å —á—Ç–æ-—Ç–æ –∏–∑ —Å–≤–æ–µ–π –∂–∏–∑–Ω–∏.`
    : '–ù–∞–ø–∏—à–∏ —á—Ç–æ-—Ç–æ –ø—Ä–æ —Å–≤–æ—é –∂–∏–∑–Ω—å, –º—ã—Å–ª–∏ –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ.';

  const prompt = `
–¢—ã –ø—Ä–∏–¥—É–º—ã–≤–∞–µ—à—å –æ–¥–∏–Ω –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–≤–∏—Ç (–ø–æ—Å—Ç) –æ—Ç –ª–∏—Ü–∞ –≤—ã–º—ã—à–ª–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.

–ü–µ—Ä—Å–æ–Ω–∞–∂: ${char.name} (${char.username})
–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞, –º–æ–∂–Ω–æ –Ω–µ –ø–µ—Ä–µ—Å–∫–∞–∑—ã–≤–∞—Ç—å –¥–æ—Å–ª–æ–≤–Ω–æ):
${shortBio || '(–æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–∫–∞ –ø—É—Å—Ç–æ–µ)'}

–¢–æ–Ω: ${char.tone} (warm ‚Äî –º—è–≥–∫–∏–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π, sharp ‚Äî —è–∑–≤–∏—Ç–µ–ª—å–Ω—ã–π, chaotic ‚Äî –¥–µ—Ä–∑–∫–∏–π/—Ö–∞–æ—Ç–∏—á–Ω—ã–π, stoic ‚Äî —Å–¥–µ—Ä–∂–∞–Ω–Ω—ã–π).

${reactedHint}
${mentionsHint}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–æ—Å—Ç—É:
- –ø–æ-—Ä—É—Å—Å–∫–∏;
- 1‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –¥–æ ~280 —Å–∏–º–≤–æ–ª–æ–≤;
- –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞ ("—è");
- –º–æ–∂–Ω–æ —Å —é–º–æ—Ä–æ–º, —Å–∞–º–æ–∏—Ä–æ–Ω–∏–µ–π, —ç–º–æ—Ü–∏—è–º–∏;
- –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –æ—Ç—Å—ã–ª–∫–∏ –∫ —Å–µ–º—å–µ, –¥—Ä—É–∑—å—è–º, –º—É–∑—ã–∫–µ, —É—á—ë–±–µ, —Ä–∞–±–æ—Ç–µ –∏ —Ç.–ø.;
- –Ω–µ –æ–ø–∏—Å—ã–≤–∞–π –¥–µ–π—Å—Ç–≤–∏—è –≤ –∑–≤—ë–∑–¥–æ—á–∫–∞—Ö, –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç;
- –±–µ–∑ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –∏ –ø–æ–¥–ø–∏—Å–∏;
- –±–µ–∑ –∫–∞–≤—ã—á–µ–∫ –≤–æ–∫—Ä—É–≥ –≤—Å–µ–≥–æ —Ç–µ–∫—Å—Ç–∞.

–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ —Å–∞–º —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞.`;

  const txt = await askAI(prompt);
  const cleaned = (txt || '').trim().replace(/^["¬´¬ª]+|["¬´¬ª]+$/g, '');
  if (!cleaned) {
    // –µ—Å–ª–∏ –ò–ò —Ç–∞–∫ –∏ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª ‚Äî –¥–µ–ª–∞–µ–º –∑–∞–ø–∞—Å–Ω–æ–π —Ñ—Ä–∞–∑–æ–π
    return fallbackNpcTweet(char);
  }
  return cleaned;
}

// –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞–µ—Ç ¬´–≤–¥–æ–≥–æ–Ω–∫—É¬ª –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø–æ—Å—Ç–æ–≤
// –ö–∞–∂–¥—ã–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂ –∫–∏–¥–∞–µ—Ç –∫—É–±–∏–∫ –∏ –ø–∏—à–µ—Ç 0‚Äì2 –ø–æ—Å—Ç–∞
// –í–∞–∂–Ω–æ: –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û, –∞ –Ω–µ –≤—Å–µ–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏ —Å—Ä–∞–∑—É
async function triggerNpcPostGeneration(playerPost) {
  try {
    // 1) –ë–µ—Ä—ë–º —Å–∞–º—ã—Ö —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∫ –ø–æ—Å—Ç—É –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π (–ø–æ —Å–≤—è–∑—è–º/—É–ø–æ–º–∏–Ω–∞–Ω–∏—è–º)
    const core = getRelevantCharacters(playerPost);

    // 2) –î–æ–±–∞–≤–ª—è–µ–º —á—É—Ç—å —Å–ª—É—á–∞–π–Ω—ã—Ö, —á—Ç–æ–±—ã –ª–µ–Ω—Ç–∞ –∂–∏–ª–∞
    const extraPool = state.characters.filter(c =>
      !core.includes(c) && c.id !== state.activePlayerId
    );
    extraPool.sort(() => Math.random() - 0.5);
    const extra = extraPool.slice(0, randint(0, 3));

    // –ù–µ–º–Ω–æ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∑–∞ –æ–¥–∏–Ω –ø–æ—Å—Ç
    const chars = [...core, ...extra].slice(0, 6);

    for (const char of chars) {
      const postsCount = randint(0, 2); // 0‚Äì2 –ø–æ—Å—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ
      for (let i = 0; i < postsCount; i++) {
        const text = await aiGenerateAmbientCharacterTweet(char, playerPost);
        if (!text) continue;

        console.log('[AI tweet]', char.name, '‚Üí', text); // –≤–∏–¥–Ω–æ –≤ –∫–æ–Ω—Å–æ–ª–∏

        const newPost = postObj({
          type: 'social',
          authorType: 'character',
          authorId: char.id,
          content: text,
          relatedCharacters: [],
          photoData: null
        });
        state.posts.push(newPost);
        save();
      }
    }

    renderFeed();
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ —Ñ–æ–Ω–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ—Å—Ç–æ–≤ NPC', e);
  }
}


// === —Ä–µ–∞–∫—Ü–∏–∏ ===
let lastReactionPostId = null;

// –∫—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥ –¥–µ–ª—å—Ç—ã: +0.25%, -3%, +4.75%
function formatDelta(delta){
  const sign = delta > 0 ? '+' : (delta < 0 ? '‚àí' : '');
  const abs  = Math.abs(delta);
  const digits = abs >= 1 ? (abs % 1 === 0 ? 0 : 2) : 2;
  return `${sign}${abs.toFixed(digits)}%`;
}

async function applyReactionsAndShowModal(post, isStory){
  lastReactionPostId = post.id;
  const wrap = $('#modalReactions');

  // —Å—á–∏—Ç–∞–µ–º ¬´–≤ —Ñ–æ–Ω–µ¬ª (–∫—Ä—É—Ç–∏—Ç—Å—è —Å–ø–∏–Ω–Ω–µ—Ä –Ω–∞ –∫–Ω–æ–ø–∫–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏)
  const rxList = await computeReactions(post, isStory);

  // –ì–æ—Ç–æ–≤–∏–º –∫–æ–Ω—Ç–µ–Ω—Ç –º–æ–¥–∞–ª–∫–∏
  if(!rxList.length){
    wrap.innerHTML = `<p>–ù–∏–∫—Ç–æ –∏–∑ –∫–ª—é—á–µ–≤—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –Ω–µ –æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª (–∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å AI).</p>`;
  }else{
    wrap.innerHTML = rxList.slice(0,5).map(rx=>{
      const c = state.characters.find(k=>k.id===rx.charId);
      const cls = rx.delta >= 0 ? 'pos' : 'neg';
      return `<div class="react-item">
        <div><strong>${c?.name||'?'}</strong>: ${rx.text}</div>
        <div class="delta ${cls}">${formatDelta(rx.delta)}</div>
      </div>`;
    }).join('');
  }

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —É–∂–µ —Å –≥–æ—Ç–æ–≤—ã–º–∏ —Ä–µ–∞–∫—Ü–∏—è–º–∏
  $('#reactionModal').classList.remove('hidden');
}

// —Å—á–∏—Ç–∞–µ–º —Ä–µ–∞–∫—Ü–∏–∏ –∏ –º–µ–Ω—è–µ–º –æ—Ç–Ω–æ—à–µ–Ω–∏—è
async function computeReactions(post, isStory){
  const relevant = getRelevantCharacters(post);
  const me = currentPlayer();
  const out = [];

  for (const c of relevant){
    const currentAppr = c.approval[state.activePlayerId] ?? 50;

    // –±–∞–∑–æ–≤–∞—è —Å–∏–ª–∞ —Ä–µ–∞–∫—Ü–∏–∏
    const base   = isStory ? 1.5 : 0.6;   // —Å—é–∂–µ—Ç–Ω—ã–µ —Å–∏–ª—å–Ω–µ–µ
    const spread = isStory ? 3.0 : 2.0;   // —Ä–∞–∑–±—Ä–æ—Å

    // bias –æ—Ç —Ç–µ–∫—É—â–µ–π –±–ª–∏–∑–æ—Å—Ç–∏
    const moodBias = (currentAppr - 50) / 50;

    let raw = base + spread * (Math.random() - 0.5) + moodBias;

    // –æ—á–µ–Ω—å —Å–ª–∞–±—ã–µ —Ä–µ–∞–∫—Ü–∏–∏ –ø—Ä–∏–≥–ª—É—à–∞–µ–º
    if (Math.abs(raw) < 0.3) raw = raw / 4;

    // –∏–Ω–æ–≥–¥–∞ –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∑–Ω–∞–∫
    if (Math.random() < 0.25) raw = -raw;

    // —à–∞–≥ 0.25, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ [-5;5]
    let delta = Math.round(raw * 4) / 4;
    delta = clamp(delta, -5, 5);

    // —Ç–µ–∫—Å—Ç —Ä–µ–∞–∫—Ü–∏–∏
    const text = await aiGenerateReactionText(c, me, post, delta, isStory);

    // –ø—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è
    const newAppr = clamp(currentAppr + delta, 0, 100);
    c.approval[state.activePlayerId] = newAppr;

    // –ù–ê–ó–í–ê–ù–ò–ï –æ—Ç–Ω–æ—à–µ–Ω–∏–π ‚Äî —á–µ—Ä–µ–∑ –ò–ò (—Å —Ñ–æ–ª–ª–±—ç–∫–æ–º)
    try{
      const title = await aiGenerateRelationTitle(c, me, newAppr, delta);
      if (!c.relationTitles) c.relationTitles = {};
      c.relationTitles[state.activePlayerId] = title;
    }catch(e){
      // –º–æ–ª—á–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
    }

    const rx = reactionObj(post.id, c.id, text, delta);
    state.reactions.push(rx);
    out.push(rx);
  }

  save();
  renderRelations();
  return out;
}


function renderReactions(){
  const wrap = $('#reactionsList');
  const items = state.reactions
    .filter(r=>!lastReactionPostId || r.postId===lastReactionPostId)
    .slice().sort((a,b)=>b.at.localeCompare(a.at));

  if(!items.length){
    wrap.innerHTML = `<p class="hint">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∞–∫—Ü–∏–π.</p>`;
    return;
  }

  // –î–æ–±–∞–≤–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∏–ª—å—Ç—Ä–µ –∏ –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞
  let filterInfo = '';
  if (lastReactionPostId) {
      const p = state.posts.find(p=>p.id===lastReactionPostId);
      filterInfo = `<div style="margin-bottom: 1rem; padding: 0.5rem; background: var(--bg); border-radius: 12px;">
          –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ—Å—Ç—É: "${clip(p?.content || '', 50)}" 
          <button class="secondary" onclick="clearReactionFilter()" style="padding: 0.2rem 0.5rem;">–°–±—Ä–æ—Å–∏—Ç—å</button>
      </div>`;
  }

  wrap.innerHTML = filterInfo + items.map(r=>{
    const c = state.characters.find(x=>x.id===r.charId);
    const p = state.posts.find(p=>p.id===r.postId);
    const cls = r.delta >= 0 ? 'pos' : 'neg';

    return `
      <div class="react-card">
        <div>
          <strong>${c?.name}</strong>
          –æ –ø–æ—Å—Ç–µ <em>${authorName(p)}</em>
          ¬∑ <span class="muted">${fmtTime(r.at)}</span>
        </div>
        <div class="react-item">
          <div>${r.text}</div>
          <div class="delta ${cls}">${formatDelta(r.delta)}</div>
        </div>
      </div>
    `;
  }).join('');
}

function clearReactionFilter() {
    lastReactionPostId = null;
    renderReactions();
}

// === –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –º—ã—Å–ª–µ–π / –±–æ—Ç–æ–≤ ===

// –±–∞–∑–æ–≤—ã–µ –∑–∞–≥–æ—Ç–æ–≤–∫–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç,
// –∫–æ–≥–¥–∞ –ò–ò –æ—Ç–≤–µ—á–∞–µ—Ç —á–µ–º-—Ç–æ —Å—Ç—Ä–∞–Ω–Ω—ã–º –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –æ–±—â–∏–º
const thoughtPos = [
  '–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —à–∞–≥. –ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è.',
  '–≠—Ç–æ –∑–≤—É—á–∏—Ç —á–µ—Å—Ç–Ω–æ. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é.',
  '–ö–∞–∂–µ—Ç—Å—è, —Ç—ã –º–µ–Ω—è —É–¥–∏–≤–ª—è–µ—à—å ‚Äî –≤ —Ö–æ—Ä–æ—à–µ–º —Å–º—ã—Å–ª–µ.',
  '–õ–∞–∫–æ–Ω–∏—á–Ω–æ –∏ –≤ —Ç–æ—á–∫—É.',
  '–£–º–Ω–æ. –•–æ—á—É —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ.'
];
const thoughtNeg = [
  '–ù–µ —É–≤–µ—Ä–µ–Ω(–∞), —á—Ç–æ —ç—Ç–æ —Ö–æ—Ä–æ—à–∞—è –∏–¥–µ—è.',
  '–≠—Ç–æ –Ω–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ —Ç–µ–±—è.',
  '–°–æ–º–Ω–µ–≤–∞—é—Å—å, —á—Ç–æ —ç—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç.',
  '–°–ª–∏—à–∫–æ–º —Ä–µ–∑–∫–æ. –Ø –±—ã –ø—Ä–æ–º–æ–ª—á–∞–ª(–∞).',
  '–ú–Ω–µ —ç—Ç–æ –Ω–µ –±–ª–∏–∑–∫–æ.'
];

function toneWrap(tone, text){
  switch(tone){
    case 'cold':   return `–•–º. ${text}`;
    case 'warm':   return `–ó–Ω–∞–µ—à—å, ${text.toLowerCase()}`;
    case 'sharp':  return `–ü—Ä—è–º–æ —Å–∫–∞–∂—É: ${text}`;
    case 'stoic':  return `–û—Ç–º–µ—á—É –±–µ–∑ —ç–º–æ—Ü–∏–π: ${text}`;
    case 'chaotic':return `–õ–æ–ª, ${text.toLowerCase()}`;
    default: return text;
  }
}

function generateThought(char, post, delta){
  const base = delta>=0 ? choice(thoughtPos) : choice(thoughtNeg);
  const mention = post.relatedCharacters?.includes(char.id)
    ? ' (—ç—Ç–æ –∫–∞—Å–∞–µ—Ç—Å—è –º–µ–Ω—è)'
    : '';
  return toneWrap(char.tone, base) + mention;
}


// === —É—Ç–∏–ª–∏—Ç—ã ===

// –ü–æ–º–æ—â–Ω–∏–∫: —ç—Ç–æ id –∏–≥—Ä–æ–∫–∞?
function isPlayerId(id){
  return state.players.some(p => p.id === id);
}

function getRelevantCharacters(post){
  // –∏—Å–∫–ª—é—á–∞–µ–º –∏–≥—Ä–æ–∫–æ–≤ (–æ–Ω–∏ –ø–∏—à—É—Ç —Å–∞–º–∏) –∏ –∞–≤—Ç–æ—Ä–∞
  //const playerIds = new Set(state.players.map(p=>p.id));
  const meId = state.activePlayerId;

  const txt = (post.content||'').toLowerCase();

  const scored = state.characters
    // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ—Ö, –∫—Ç–æ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Ç–µ–∫—É—â–∏–º –∞–∫—Ç–∏–≤–Ω—ã–º –∏–≥—Ä–æ–∫–æ–º
    .filter(c => c.id !== meId && c.id !== post.authorId)
    .map(c => {
      let score = 0;
      const appr = c.approval?.[meId] ?? 50;
      score += appr; // –∫—Ç–æ —Ç–µ–ø–ª–µ–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è ‚Äî –±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω–æ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç

      // –µ—Å–ª–∏ —É–ø–æ–º—è–Ω—É—Ç—ã –∏–º—è –∏–ª–∏ username ‚Äî —É—Å–∏–ª–∏–≤–∞–µ–º
      if (c.name && txt.includes(c.name.toLowerCase())) score += 40;
      if (c.username && txt.includes(c.username.slice(1).toLowerCase())) score += 25;

      // –ª—ë–≥–∫–∏–π –±–æ–Ω—É—Å, –µ—Å–ª–∏ —É–∂–µ –Ω–µ–¥–∞–≤–Ω–æ –¥—É–º–∞–ª/–ø–∏—Å–∞–ª
      if (c.lastThought) score += 5;

      return { c, score };
    })
    .sort((a,b)=>b.score - a.score)
    .map(x=>x.c);

  const k = Math.min(scored.length, randint(2,5));
  return scored.slice(0, k);
}


function authorName(p){
  if(!p) return '‚Äî';
  if(p.authorType==='player')
    return state.players.find(x=>x.id===p.authorId)?.name || '–ò–≥—Ä–æ–∫';
  if(p.authorType==='character')
    return state.characters.find(x=>x.id===p.authorId)?.name || '–ü–µ—Ä—Å–æ–Ω–∞–∂';
  if(p.authorType==='npc')
    return state.npcs.find(x=>x.id===p.authorId)?.name || '–ñ–∏—Ç–µ–ª—å';
  if(p.authorType==='outlet')
    return state.outlets.find(x=>x.id===p.authorId)?.name || '–ú–µ–¥–∏–∞';
  return '–ê–≤—Ç–æ—Ä';
}

function currentPlayer(){ return state.players.find(p=>p.id===state.activePlayerId); }


function setupFilters(){
  const chips = $$('.filters .chip');
  chips.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      chips.forEach(b=>b.classList.remove('chip-on'));
      btn.classList.add('chip-on');
      feedFilter = btn.dataset.filter;
      renderFeed();
    });
  });
}

function setupPlayers(){
  const sel = $('#activePlayerSelect');
  sel.innerHTML = state.players.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
  sel.value = state.activePlayerId;
  sel.onchange = ()=>{
    state.activePlayerId = sel.value;
    save();
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å—ë –ø—Ä–∏ —Å–º–µ–Ω–µ –∏–≥—Ä–æ–∫–∞
    renderRelations();
    renderFeed();
    syncDmSelectors();
  };
}

function setupModal(){
  const mdl = $('#reactionModal');
  $('#modalClose').onclick = ()=> mdl.classList.add('hidden');
  $('#modalOk').onclick    = ()=> mdl.classList.add('hidden');
  $('#openReactionsBtn').onclick = ()=>{ mdl.classList.add('hidden'); setActiveView('reactions'); };
}

function setupMyProfileButton() {
  $('#myProfileBtn').onclick = () => {
    // –ü—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å —Å ID —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
    openCharacterProfile(state.activePlayerId);
  };
}

// --- –§–û–ù–û–í–´–ï –ü–û–°–¢–´ –ú–ò–†–ê ---

const AMBIENT_MIN_MS = 45000;   // –º–∏–Ω–∏–º—É–º 45 —Å–µ–∫—É–Ω–¥
const AMBIENT_MAX_MS = 120000;  // –º–∞–∫—Å–∏–º—É–º 120 —Å–µ–∫—É–Ω–¥

async function ambientPostsTick(){
  // ... (–õ–æ–≥–∏–∫–∞ —Ñ–æ–Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤ - –∑–∞–≤–∏—Å–∏—Ç –æ—Ç AI)
}

function scheduleAmbientPosting(){
  const ms = randint(AMBIENT_MIN_MS, AMBIENT_MAX_MS);
  setTimeout(async ()=>{
    try { await ambientPostsTick(); } catch(e){ console.error("–û—à–∏–±–∫–∞ —Ñ–æ–Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∏–Ω–≥–∞ (AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω?)", e); }
    scheduleAmbientPosting();
  }, ms);
}


// === —Å—Ç–∞—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ===
document.addEventListener('DOMContentLoaded', ()=>{
  load();
  setupNav();
  setupPlayers();
  setupFilters();
  setupComposeSocial();
  setupComposeStory();
  setupDm();
  setupModal();
  setupMyProfileButton();
  renderFeed();
  renderRelations();
  // scheduleAmbientPosting(); // –í–∫–ª—é—á–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ä–∞–±–æ—Ç–∞—é—â–∏–π AI API
});
</script>

</body>
</html>
