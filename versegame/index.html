<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Status-like RP Prototype</title>

  <style>
    :root{
      --bg:#f4f4f7;
      --card:#ffffff;
      --card-border:#d5d8df;
      --text:#111217;
      --muted:#6b6f79;
      --primary:#111217;
      --accent:#111217;
      --positive:#31a24c;
      --negative:#e5535e;
    }

    *{box-sizing:border-box;}
    html,body{
      margin:0;
      padding:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,system-ui,sans-serif;
    }

    a{color:var(--primary);}
    button{
      cursor:pointer;
      border-radius:999px;
      border:1px solid rgba(0,0,0,0.07);
      padding:.6rem 1.1rem;
      background:#fff;
      font:inherit;
      color:var(--text);
    }
    button.primary{
      background:var(--text);
      color:#fff;
      border-color:var(--text);
    }
    button.secondary{
      background:#f3f3f7;
    }
    button.ghost{
      background:transparent;
    }

    #app{
      max-width:430px;
      margin:0 auto;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* TOP BAR */
    .topbar{
      position:sticky;
      top:0;
      z-index:10;
      padding:.6rem .9rem;
      background:var(--bg);
      border-bottom:1px solid #e1e4ec;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .brand{
      font-weight:700;
      letter-spacing:.02em;
    }
    .player-switch select{
      border-radius:999px;
      border:1px solid #d0d3dc;
      padding:.25rem .7rem;
      background:#fff;
    }

    main{
      flex:1;
      padding:.8rem .9rem 4.8rem;
    }
    .view{
      display:none;
    }
    .view.active{
      display:block;
    }
    .view-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:.7rem;
    }
    .view-head h1{
      margin:0;
      font-size:1.2rem;
    }

    /* FEED */
    .feed-list{
      list-style:none;
      margin:0;
      padding:0;
    }
    .post{
      background:var(--card);
      border-radius:24px;
      border:1px solid var(--card-border);
      padding:.9rem .95rem;
      margin-bottom:.8rem;
    }
    .post-head{
      display:flex;
      align-items:center;
      gap:.7rem;
      margin-bottom:.4rem;
    }
    .avatar{
      width:42px;
      height:42px;
      border-radius:50%;
      border:1px solid #cfd2da;
    }
    .meta .name{
      font-weight:700;
      font-size:.98rem;
    }
    .meta .username{
      font-size:.86rem;
      color:var(--muted);
    }
    .post-content{
      margin-top:.3rem;
      font-size:.93rem;
      line-height:1.4;
      white-space:pre-wrap;
    }
    .badge{
      display:inline-block;
      margin-left:.3rem;
      padding:.1rem .5rem;
      border-radius:999px;
      border:1px solid #e0e3eb;
      font-size:.75rem;
      color:var(--muted);
      background:#f6f7fb;
    }
    .post-actions{
      display:flex;
      align-items:center;
      gap:.8rem;
      margin-top:.55rem;
      font-size:.82rem;
      color:var(--muted);
      flex-wrap:wrap;
    }
    .post-actions .icon{
      display:inline-flex;
      align-items:center;
      gap:.25rem;
    }

    .filters{display:flex;gap:.4rem;}
    .chip{
      border-radius:999px;
      padding:.25rem .8rem;
      font-size:.8rem;
      background:#f2f3f7;
    }
    .chip-on{
      background:#111217;
      color:#fff;
    }

    /* RELATIONS */
    .relations{
      display:flex;
      flex-direction:column;
      gap:.7rem;
    }
    .rel-card{
      background:var(--card);
      border-radius:24px;
      border:1px solid var(--card-border);
      padding:1rem;
      cursor:pointer;
    }
    .rel-top{
      display:flex;
      gap:.85rem;
      align-items:center;
      margin-bottom:.6rem;
    }
    .rel-name{
      font-weight:700;
    }
    .username{
      font-size:.86rem;
      color:var(--muted);
    }
    .progress{
      margin-top:.15rem;
      height:12px;
      border-radius:999px;
      background:#f3f4f8;
      overflow:hidden;
      border:1px solid #e1e4ec;
    }
    .progress>span{
      display:block;
      height:100%;
      background:linear-gradient(90deg,#3bc76b,#70e08c);
    }
    .rel-thought{
      margin-top:.45rem;
      font-size:.86rem;
      color:var(--muted);
    }

    /* CHARACTER PROFILE */
    .char-view{
      max-width:430px;
      margin:0 auto;
    }

    .char-cover{
      height:120px;
      background:#d8dadf;
      border-radius:24px 24px 0 0;
    }

    .char-header{
      background:#fff;
      border-radius:24px;
      border:1px solid var(--card-border);
      margin-top:-48px;
      padding:1.2rem 1.1rem 1rem;
    }

    .char-header-top{
      display:flex;
      align-items:flex-end;
      gap:1rem;
    }

    .char-avatar{
  width:96px;
  height:96px;
  border-radius:50%;
  border:3px solid #fff;
  background:#ccc;
  overflow:hidden;
  flex-shrink:0;
  cursor:pointer;
  position:relative;
    }

    .char-avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
    }


.char-avatar-btn{
  margin-top:.4rem;
  font-size:.8rem;
  padding:.3rem .7rem;
}

    .char-name{
      font-size:1.4rem;
      font-weight:700;
    }

    .char-username{
      font-size:.9rem;
      color:var(--muted);
    }

    .char-bio{
      margin-top:.9rem;
      font-size:.9rem;
      line-height:1.5;
      white-space:pre-wrap;
    }

    .char-bio-edit{
  width:100%;
  margin-top:.6rem;
  border-radius:18px;
  border:1px solid var(--card-border);
  padding:.7rem .8rem;
  font:inherit;
  resize:vertical;
    }

    .char-rel-block{
      margin-top:1.2rem;
    }

    .char-rel-label-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:.86rem;
      color:var(--muted);
      margin-bottom:.35rem;
    }

    .char-rel-bar{
      height:16px;
      border-radius:999px;
      background:#f3f4f8;
      border:1px solid #e1e4ec;
      overflow:hidden;
    }

    .char-rel-bar > span{
      display:block;
      height:100%;
      background:linear-gradient(90deg,#3bc76b,#70e08c);
    }

    .char-rel-title{
      margin-top:.7rem;
      font-size:.95rem;
      font-weight:600;
    }

    .char-actions-row{
      margin-top:1rem;
      display:flex;
      gap:.5rem;
      flex-wrap:wrap;
    }

    .char-rel-thought{
  margin-top:.4rem;
  font-size:.86rem;
  color:var(--muted);
}


    /* COMPOSE */
    .compose textarea{
      width:100%;
      border-radius:18px;
      border:1px solid var(--card-border);
      padding:.7rem .8rem;
      resize:vertical;
      font:inherit;
      background:#fff;
    }
    .compose .label{
      font-size:.82rem;
      color:var(--muted);
      margin-bottom:.2rem;
      display:block;
    }
    .section{margin:.7rem 0;}
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:.4rem;
    }
    .chips label{
      padding:.25rem .7rem;
      border-radius:999px;
      border:1px solid #dde0ea;
      background:#f6f7fb;
      font-size:.82rem;
    }
    .chips input{
      margin-right:.25rem;
    }
    .file-btn{
      display:inline-block;
      padding:.4rem .8rem;
      border-radius:999px;
      border:1px dashed #d0d3dd;
      background:#f7f7fb;
      font-size:.86rem;
      cursor:pointer;
    }
    .photo-preview img{
      max-width:100%;
      margin-top:.5rem;
      border-radius:18px;
      border:1px solid var(--card-border);
    }

    .idea-box{
      display:flex;
      align-items:center;
      gap:.4rem;
      border-radius:18px;
      border:1px solid var(--card-border);
      background:#f7f7fb;
      padding:.4rem .6rem;
      font-size:.86rem;
    }
    .idea-text{
      flex:1;
      color:var(--muted);
    }

    .row{
      display:flex;
      align-items:center;
      gap:.5rem;
    }
    .row.end{justify-content:flex-end;}

    .hint{
      font-size:.8rem;
      color:var(--muted);
      margin-top:.4rem;
    }
    .muted{
      color:var(--muted);
      font-size:.82rem;
    }

    /* DM */
    .dm-thread{
      background:var(--card);
      border-radius:24px;
      border:1px solid var(--card-border);
      min-height:260px;
      padding:.7rem;
      display:flex;
      flex-direction:column;
      gap:.3rem;
    }
    .bubble{
      max-width:80%;
      padding:.45rem .7rem;
      border-radius:20px;
      font-size:.9rem;
    }
    .bubble.me{
      align-self:flex-end;
      background:#111217;
      color:#fff;
    }
    .bubble.them{
      align-self:flex-start;
      background:#f4f5fa;
    }
    .dm-input{
      display:flex;
      gap:.45rem;
      margin-top:.6rem;
    }
    .dm-input input{
      flex:1;
      border-radius:999px;
      border:1px solid var(--card-border);
      padding:.6rem .8rem;
      font:inherit;
      background:#fff;
    }

    /* REACTIONS */
    .reactions{
      display:flex;
      flex-direction:column;
      gap:.7rem;
    }
    .react-card{
      background:var(--card);
      border-radius:24px;
      border:1px solid var(--card-border);
      padding:.8rem .9rem;
      font-size:.9rem;
    }
    .react-item{
      display:flex;
      justify-content:space-between;
      gap:.5rem;
      margin-top:.35rem;
    }
    .delta.pos{color:var(--positive);}
    .delta.neg{color:var(--negative);}

    /* TABBAR */
    .tabbar{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:.6rem;
      width:100%;
      max-width:430px;
      padding:.25rem .35rem;
      background:rgba(255,255,255,0.96);
      border-radius:999px;
      box-shadow:0 8px 24px rgba(15,16,26,.18);
      display:flex;
      gap:.35rem;
      z-index:20;
    }
    .tab{
      flex:1;
      border-radius:999px;
      padding:.45rem 0;
      font-size:1rem;
    }
    .tab.active{
      background:#111217;
      color:#fff;
    }

    /* MODAL */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .modal.hidden{display:none;}
    .modal-card{
      width:min(420px,92vw);
      background:#fff;
      border-radius:22px;
      padding:1rem;
      box-shadow:0 18px 40px rgba(0,0,0,.25);
    }
    .modal-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:.5rem;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Top bar -->
    <header class="topbar">
      <div class="brand">Verse</div>
      <div class="player-switch">
        <label>
          –Ø ‚Äî 
          <select id="activePlayerSelect"></select>
        </label>
      </div>
    </header>

    <!-- Views -->
    <main>
      <!-- FEED (–≠–∫—Ä–∞–Ω 1) -->
      <section id="view-feed" class="view active">
        <div class="view-head">
          <h1>–õ–µ–Ω—Ç–∞</h1>
          <div class="filters">
            <button class="chip chip-on" data-filter="all">–í—Å–µ</button>
            <button class="chip" data-filter="social">–û–±—ã—á–Ω—ã–µ</button>
            <button class="chip" data-filter="story">–°—é–∂–µ—Ç–Ω—ã–µ</button>
          </div>
        </div>
        <ul id="feedList" class="feed-list"></ul>
      </section>

      <!-- RELATIONS (–≠–∫—Ä–∞–Ω 2) -->
      <section id="view-relations" class="view">
        <div class="view-head">
          <h1>–û—Ç–Ω–æ—à–µ–Ω–∏—è</h1>
        </div>
        <div id="relationsList" class="relations"></div>
      </section>

      <!-- CHARACTER PROFILE (–≠–∫—Ä–∞–Ω 2.5) -->
      <section id="view-character" class="view">
        <div class="view-head">
          <h1>–ü—Ä–æ—Ñ–∏–ª—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h1>
        </div>
        <div id="characterView" class="char-view"></div>
      </section>

      <!-- COMPOSE SOCIAL (–≠–∫—Ä–∞–Ω 3) -->
      <section id="view-compose" class="view">
        <div class="view-head">
          <h1>–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç</h1>
        </div>
        <div class="compose">
          <textarea id="composeText" rows="6" placeholder="–û —á—ë–º –¥—É–º–∞–µ—à—å?"></textarea>

          <div class="section">
            <label class="file-btn">
              <input id="composePhoto" type="file" accept="image/*" hidden />
              –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            </label>
            <div id="composePhotoPreview" class="photo-preview"></div>
          </div>

          <button id="publishSocialBtn" class="primary">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        </div>
      </section>

      <!-- COMPOSE STORY (–≠–∫—Ä–∞–Ω 4) -->
      <section id="view-story" class="view">
        <div class="view-head">
          <h1>–°—é–∂–µ—Ç–Ω—ã–π –ø–æ—Å—Ç</h1>
        </div>

        <div class="compose">
          <div class="section">
            <label class="label">–ò–¥–µ–∏ –¥–ª—è –ø–æ—Å—Ç–∞ (–ø—Ä–æ—Ç–æ—Ç–∏–ø)</label>
            <div class="idea-box">
              <button id="ideaPrev" class="ghost">&larr;</button>
              <div id="ideaText" class="idea-text">–ù–∞–∂–º–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å –∏–¥–µ–∏¬ª</div>
              <button id="ideaNext" class="ghost">&rarr;</button>
            </div>
            <div class="row">
              <button id="ideaRefresh" class="secondary">–û–±–Ω–æ–≤–∏—Ç—å –∏–¥–µ–∏</button>
              <button id="ideaUse" class="secondary">–í—Å—Ç–∞–≤–∏—Ç—å –≤ –ø–æ–ª–µ</button>
            </div>
          </div>

          <textarea id="storyText" rows="12" placeholder="–î–ª–∏–Ω–Ω—ã–π —Å—é–∂–µ—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç..."></textarea>
          <button id="publishStoryBtn" class="primary">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å—é–∂–µ—Ç–Ω—ã–π –ø–æ—Å—Ç</button>
          <p class="hint">–°—é–∂–µ—Ç–Ω—ã–µ –ø–æ—Å—Ç—ã –Ω–µ –∫–æ–º–º–µ–Ω—Ç–∏—Ä—É—é—Ç—Å—è, –Ω–æ —Å–∏–ª—å–Ω–µ–µ –≤–ª–∏—è—é—Ç –Ω–∞ –º–∏—Ä –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è.</p>
        </div>
      </section>

      <!-- DIRECT MESSAGES (–≠–∫—Ä–∞–Ω 5) -->
      <section id="view-dm" class="view">
        <div class="view-head">
          <h1 id="dmTitle">–õ–°</h1>
          <div class="row">
            <label>–ü–µ—Ä—Å–æ–Ω–∞–∂: 
              <select id="dmSelect"></select>
            </label>
            <label style="margin-left:1rem;">
              <input type="checkbox" id="dmAutoToggle" checked />
              –ë–æ—Ç –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å —Å–∞–º
            </label>
          </div>
        </div>

        <div id="dmThread" class="dm-thread"></div>

        <div class="dm-input">
          <input id="dmInput" type="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." />
          <button id="dmSend" class="primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </section>

      <!-- REACTIONS HISTORY (–≠–∫—Ä–∞–Ω 6) -->
      <section id="view-reactions" class="view">
        <div class="view-head">
          <h1>–†–µ–∞–∫—Ü–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</h1>
        </div>
        <div id="reactionsList" class="reactions"></div>
      </section>
    </main>

    <!-- Tabbar -->
    <nav class="tabbar">
      <button class="tab active" data-target="feed" title="–õ–µ–Ω—Ç–∞">–õ–µ–Ω—Ç–∞</button>
      <button class="tab" data-target="relations" title="–û—Ç–Ω–æ—à–µ–Ω–∏—è">–û—Ç–Ω–æ—à–µ–Ω–∏—è</button>
      <button class="tab" data-target="compose" title="–ü–æ—Å—Ç">‚úèÔ∏è</button>
      <button class="tab" data-target="story" title="–°—é–∂–µ—Ç">–°—é–∂–µ—Ç</button>
      <button class="tab" data-target="dm" title="–õ–°">–õ–°</button>
      <button class="tab" data-target="reactions" title="–†–µ–∞–∫—Ü–∏–∏">–†–µ–∞–∫—Ü–∏–∏</button>
    </nav>
  </div>

  <!-- Modal: reactions after publish -->
  <div id="reactionModal" class="modal hidden">
    <div class="modal-card">
      <div class="modal-head">
        <h3>–†–µ–∞–∫—Ü–∏–∏ –Ω–∞ –ø–æ—Å—Ç</h3>
        <button id="modalClose" class="ghost">‚úï</button>
      </div>
      <div id="modalReactions"></div>
      <div class="row end">
        <button id="openReactionsBtn" class="secondary">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
        <button id="modalOk" class="primary">–û–∫</button>
      </div>
    </div>
  </div>

<script>
const $  = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
const uid = (p='id') => `${p}_${Math.random().toString(36).slice(2,9)}`;
const nowIso = () => new Date().toISOString();
const clip = (s, n=160) => (s.length>n ? s.slice(0,n) + '‚Ä¶' : s);
const fmtTime = (iso) => new Date(iso).toLocaleString();
const randint = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const choice = (arr)=>arr[Math.floor(Math.random()*arr.length)];
const clamp=(x,min,max)=>Math.max(min,Math.min(max,x));

// –°–æ–±–∏—Ä–∞–µ–º –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–≤—è–∑–µ–π –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ —Å –¥—Ä—É–≥–∏–º–∏
function buildRelationsSummary(char) {
  if (!char.relations) return '–ù–µ—Ç —è–≤–Ω—ã—Ö —Å–≤—è–∑–µ–π.';

  const lines = [];

  for (const [otherId, value] of Object.entries(char.relations)) {
    let other = state.characters.find(c => c.id === otherId);
    if (!other) {
      other = state.players.find(p => p.id === otherId);
    }
    const name = other?.name || otherId;
    lines.push(`${char.name} –∏ ${name}: —É—Ä–æ–≤–µ–Ω—å –±–ª–∏–∑–æ—Å—Ç–∏ ${value} –∏–∑ 100.`);
  }

  if (!lines.length) return '–ù–µ—Ç —è–≤–Ω—ã—Ö —Å–≤—è–∑–µ–π.';

  return lines.join('\n');
}

// === –ò–ò (Gemini) –¥–ª—è –õ–° ===
async function askAI(promptText) {
  try {
    const res = await fetch('/api/gemini', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: promptText })
    });

    const data = await res.json();

    // –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –ø—É—Å—Ç–æ–π –∏–ª–∏ —Å –æ—à–∏–±–∫–æ–π ‚Äî —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –ò–ò –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
    if (!data.ok || !data.answer) {
      console.error('AI error response', data);
      return null;              // <‚Äî –í–ê–ñ–ù–û: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null, –∞ –Ω–µ —Ç–µ–∫—Å—Ç
    }

    return data.answer.trim();
  } catch (err) {
    console.error('AI network error', err);
    return null;                // <‚Äî –∏ —Ç—É—Ç —Ç–æ–∂–µ null
  }
}


async function aiReplyToDm(charId) {
  const char = state.characters.find(c => c.id === charId);
  if (!char) return;

  const me = currentPlayer();
  const key = threadKey(charId);
  const history = state.dms[key] || [];

  const historyText = history.map(m => {
    const whoName = m.from === state.activePlayerId ? me.name : char.name;
    return `${whoName}: ${m.text}`;
  }).join('\n');

  const relationsSummary = buildRelationsSummary(char);

  const prompt = `
–¢—ã ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–∂ ${char.name} (${char.username}) –≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –≤—ã–º—ã—à–ª–µ–Ω–Ω–æ–π —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏.

–ö–ê–ù–û–ù–ò–ß–ï–°–ö–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–ï–†–°–û–ù–ê–ñ–ï:
- –ë–∏–æ–≥—Ä–∞—Ñ–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (–∏—Å–ø–æ–ª—å–∑—É–π –∫–∞–∫ –±–∞–∑—É, –æ–Ω–∞ –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∞–≤—Ç–æ—Ä–æ–º):
${char.bio}

- –°–≤—è–∑–∏ –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏:
${relationsSummary}

–≠—Ç–∏ —Ñ–∞–∫—Ç—ã –æ —Å–≤—è–∑—è—Ö —Å—á–∏—Ç–∞—é—Ç—Å—è –∏—Å—Ç–∏–Ω–æ–π. 
–ù–ï –ü–ï–†–ï–ü–£–¢–´–í–ê–ô, –∫—Ç–æ –∫–æ–º—É –∫–µ–º –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è, –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π –Ω–æ–≤—ã–µ —Ä–æ–¥—Å—Ç–≤–∞ –∏ –Ω–µ –º–µ–Ω—è–π —Ä–æ–ª–∏.
–ï—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –∏–≥—Ä–æ–∫–∞ –µ—Å—Ç—å –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ —ç—Ç–∏–º —Ñ–∞–∫—Ç–∞–º ‚Äî –º—è–≥–∫–æ –ø–æ–ø—Ä–∞–≤—å –µ–≥–æ –∏–ª–∏ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –Ω–∞–º–µ–∫–Ω–∏, –Ω–æ —Å–∞–º –∫–∞–Ω–æ–Ω –ù–ï –º–µ–Ω—è–π.

–¢–æ–Ω –æ–±—â–µ–Ω–∏—è: ${char.tone}.
–¢–µ–∫—É—â–µ–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –∏–≥—Ä–æ–∫—É ${me.name}: ${char.approval[state.activePlayerId] ?? 50} –∏–∑ 100.

–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –º–µ–∂–¥—É —Ç–æ–±–æ–π –∏ –∏–≥—Ä–æ–∫–æ–º:
${historyText}

–°–µ–π—á–∞—Å, –æ—Ç –ª–∏—Ü–∞ ${char.name}, –æ—Ç–≤–µ—Ç—å –Ω–∞ –ü–û–°–õ–ï–î–ù–ï–ï —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞.
–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
- –ø–æ-—Ä—É—Å—Å–∫–∏
- –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞
- 1‚Äì3 –∫–æ—Ä–æ—Ç–∫–∏–µ —Ä–µ–ø–ª–∏–∫–∏
- –±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π, —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
- —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä—É –∏ –∫–∞–Ω–æ–Ω–∏—á–Ω—ã–º —Å–≤—è–∑—è–º.
`;

  const aiText = await askAI(prompt);
  if (!aiText) return;

  pushMessage(charId, charId, aiText);
}

let state = {
  players: [
    { id:'player1', name:'–ì—Ä–µ–π—Å–æ–Ω',  username:'@LiqueurD',   followers:320 },
    { id:'player2', name:'–õ–æ—Ä–∞–Ω—Ç–∏—Å', username:'@tinktloran', followers:340 }
  ],
  activePlayerId: 'player1',
  characters: [],
  posts: [],
  dms: {},
  reactions: []
};

const LS_KEY = 'verse_state_v2_grayson_loran';

// === –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏ —Å—Ç–∞—Ä—Ç–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤ ===
function seedIfEmpty(){
  if(state.characters.length) return;

  state.characters = [
    {
      id:'kristian',
      name:'–ö—Ä–∏—Å—Ç–∏–∞–Ω –í–æ–ª—å—Ç',
      username:'@shiningshining',
      tone:'warm',
      followers:1500,
      bio:'–û–º–µ–≥–∞ —Å –ø–ª–∞—Ç–∏–Ω–æ–≤—ã–º–∏ –≤–æ–ª–æ—Å–∞–º–∏ –∏ –æ–±–µ–∑–æ—Ä—É–∂–∏–≤–∞—é—â–µ–π —É–ª—ã–±–∫–æ–π; —Ö–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω—ã–π —Å—Ç—É–¥–µ–Ω—Ç –ø–µ–¥—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞, —Å–∞–º —Å–µ–±—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç, –ª—é–±–∏—Ç –¥–µ—Ç–µ–π –∏ —Å–ª–∞–¥–∫–æ–µ. –í –ø—Ä–æ—à–ª–æ–º —Å–ø–∞–ª —Å –ì—Ä–µ–π—Å–æ–Ω–æ–º –∏ —Å–µ–π—á–∞—Å —Å–Ω–æ–≤–∞ –∏–º –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω.',
      relations:{ vivien:40, eve:20, alexi:25 },
      approval:{ player1:65, player2:35 },
      lastThought:'',
      avatar:''
    },
    {
      id:'vivien',
      name:'–í–∏–≤—å–µ–Ω –ë–ª–µ–π–¥–º–æ—Ä',
      username:'@WildFret',
      tone:'chaotic',
      followers:900,
      bio:'–ë–µ—Ç–∞, –≥–∏—Ç–∞—Ä–∏—Å—Ç–∫–∞ –≥—Ä—É–ø–ø—ã Ash&mercury, —É–ø—Ä—è–º–∞—è —à—É–º–Ω–∞—è —Ä–æ–∫–µ—Ä—à–∞, –ø—Ä–∏–∫—Ä—ã–≤–∞–µ—Ç –º–ª–∞–¥—à–∏—Ö –∏ —Å–ø–æ—Ä–∏—Ç —Å –ö–∞–π–ª–∞–Ω–æ–º. –í –ø–æ–ª–∏–∞–º–æ—Ä–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö —Å –ï–≤–æ–π –∏ –ê–ª–µ–∫—Å–∏.',
      relations:{ alexi:80, eve:70, grayson:65, aiden:60, ember:60 },
      approval:{ player1:70, player2:55 },
      lastThought:'',
      avatar:''
    },
    {
      id:'aiden',
      name:'–≠–π–¥–µ–Ω –ë–ª–µ–π–¥–º–æ—Ä',
      username:'@404NotFound',
      tone:'chaotic',
      followers:600,
      bio:'–î–æ–º–∏–Ω–∞–Ω—Ç–Ω—ã–π –æ–º–µ–≥–∞-—à–∞–ª–æ–ø–∞–π: –æ–±–∞—è—Ç–µ–ª—å–Ω—ã–π –∞–≤–∞–Ω—Ç—é—Ä–∏—Å—Ç, —Ç–∞–∫—Ç–∏–∫ –¥—É—ç—Ç–∞ —Å —Å–µ—Å—Ç—Ä–æ–π –≠–º–±–µ—Ä. –û–±–æ–∂–∞–µ—Ç –ø—Ä–∞–Ω–∫–∏, —Ç–µ–∞—Ç—Ä –∏ –≤–ª—é–±–ª—ë–Ω –≤ —É—á–∏—Ç–µ–ª—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã –ò—Ç–∞–Ω–∞ –•–æ–≥–≥–∞—Ä—Ç–∞.',
      relations:{ ember:90, vivien:60, eve:40, ethan:75 },
      approval:{ player1:65, player2:50 },
      lastThought:'',
      avatar:''
    },
    {
      id:'ember',
      name:'–≠–º–±–µ—Ä –ë–ª–µ–π–¥–º–æ—Ä',
      username:'@500InternalServerError',
      tone:'stoic',
      followers:580,
      bio:'–î–æ–º–∏–Ω–∞–Ω—Ç–Ω–∞—è –æ–º–µ–≥–∞, —Ñ–ª–µ–≥–º–∞—Ç–∏—á–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫; –º–æ–∑–≥ –¥—É—ç—Ç–∞ —Å –≠–π–¥–µ–Ω–æ–º, –ª—é–±–∏—Ç —Å–æ–±–∞–∫ –∏ —Ä–∞—Å—Ç–µ–Ω–∏—è. –°–∫–µ–ø—Ç–∏—á–Ω–∞, –Ω–æ –æ—á–µ–Ω—å –∑–∞–±–æ—Ç–ª–∏–≤–∞.',
      relations:{ aiden:90, vivien:60, eve:40 },
      approval:{ player1:60, player2:50 },
      lastThought:'',
      avatar:''
    },
    {
      id:'aurora',
      name:'–ê–≤—Ä–æ—Ä–∞ –ë–ª—ç–∫–≤–æ–ª–ª',
      username:'@ABlackwall',
      tone:'stoic',
      followers:800,
      bio:'–î–æ–º–∏–Ω–∞–Ω—Ç–Ω–∞—è –∞–ª—å—Ñ–∞, —Å–ø–æ–∫–æ–π–Ω–∞—è –∏ —Å–æ–±—Ä–∞–Ω–Ω–∞—è, –±—É–¥—É—â–∞—è –Ω–∞—Å–ª–µ–¥–Ω–∏—Ü–∞ —Å–µ–º–µ–π–Ω–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞. –õ—é–±–∏—Ç –ø–æ—Ä—è–¥–æ–∫, —Ç–æ—á–Ω—ã–µ –Ω–∞—É–∫–∏ –∏ —é–≤–µ–ª–∏—Ä–Ω–æ–µ –¥–µ–ª–æ, –∫–æ–≥–¥–∞-—Ç–æ –∑–∞–Ω–∏–º–∞–ª–∞—Å—å –∫–æ–Ω–Ω—ã–º —Å–ø–æ—Ä—Ç–æ–º –≤–º–µ—Å—Ç–µ —Å –ì—Ä–µ–π—Å–æ–Ω–æ–º.',
      relations:{ eve:70, loran:75, derek:80, noel:70 },
      approval:{ player1:65, player2:80 },
      lastThought:'',
      avatar:''
    },
    {
      id:'eve',
      name:'–ï–≤–∞ –ë–ª—ç–∫–≤–æ–ª–ª',
      username:'@EveLuxe',
      tone:'sharp',
      followers:1000000,
      bio:'–ì—Ä–æ–º–∫–∞—è —Å—Ç–µ—Ä–≤–æ–∑–Ω–∞—è –¥–æ–º–∏–Ω–∞–Ω—Ç–Ω–∞—è –∞–ª—å—Ñ–∞-–±–ª–æ–≥–µ—Ä—à–∞; –º–µ–Ω–µ–¥–∂–µ—Ä —Ä–æ–∫-–≥—Ä—É–ø–ø—ã –í–∏–≤—å–µ–Ω –∏ –ê–ª–µ–∫—Å–∏ –∏ —á–∞—Å—Ç—å –∏—Ö –ø–æ–ª–∏–∞–º–æ—Ä–Ω–æ–π —Ç—Ä–æ–∏—Ü—ã. –õ—é–±–∏—Ç –≤–µ—á–µ—Ä–∏–Ω–∫–∏, —Å–µ–∫—Å –∏ –ø–æ–±–µ–∂–¥–∞—Ç—å –≤ —Å–ø–æ—Ä–∞—Ö.',
      relations:{ aurora:80, loran:85, vivien:75, alexi:70, aiden:50, ember:50 },
      approval:{ player1:75, player2:70 },
      lastThought:'',
      avatar:''
    },
    {
      id:'derek',
      name:'–î–µ—Ä–µ–∫ –ë–ª—ç–∫–≤–æ–ª–ª',
      username:'@BlackDiamond',
      tone:'warm',
      followers:12000,
      bio:'–î–æ–º–∏–Ω–∞–Ω—Ç–Ω—ã–π –∞–ª—å—Ñ–∞, –æ—Ç–µ—Ü –ï–≤—ã, –ê–≤—Ä–æ—Ä—ã –∏ –õ–æ—Ä–∞–Ω—Ç–∏—Å–∞, –≤–µ—Ä–Ω—ã–π –º—É–∂ –ù–æ—ç–ª—è –∏ –≤–ª–∞–¥–µ–ª–µ—Ü —é–≤–µ–ª–∏—Ä–Ω–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞. –û–±–æ–∂–∞–µ—Ç —Å–µ–º—å—é, —à—É—Ç–∏—Ç –∏ –ø–µ—Ä–µ–∂–∏–≤–∞–µ—Ç –∏–∑-–∑–∞ –æ—Ç—ä–µ–∑–¥–∞ –õ–æ—Ä–∞–Ω–∞ –≤ –ì–µ—Ä–º–∞–Ω–∏—é.',
      relations:{ noel:95, aurora:90, eve:85, loran:95, dante:80, grayson:70 },
      approval:{ player1:70, player2:85 },
      lastThought:'',
      avatar:''
    },
    {
      id:'dante',
      name:'–î–∞–Ω—Ç–µ –ë–ª–µ–π–¥–º–æ—Ä',
      username:'@dSever',
      tone:'warm',
      followers:18000,
      bio:'–î–æ–º–∏–Ω–∞–Ω—Ç–Ω—ã–π –∞–ª—å—Ñ–∞-—Å–µ–º—å—è–Ω–∏–Ω –∏ –ø–æ–∂–∞—Ä–Ω—ã–π-—Å–ø–∞—Å–∞—Ç–µ–ª—å, –º—É–∂ –ö–∞–π–ª–∞–Ω–∞, –æ—Ç–µ—Ü –í–∏–≤—å–µ–Ω, –ì—Ä–µ–π—Å–æ–Ω–∞, –≠–º–±–µ—Ä –∏ –≠–π–¥–µ–Ω–∞. –°–ø–æ–∫–æ–π–Ω—ã–π —Ñ–ª–µ–≥–º–∞—Ç–∏–∫, –æ–±–æ–∂–∞–µ—Ç —Å–≤–æ—é ¬´—Å—Ç–∞—é¬ª –∏ –≤–æ–∑–∏—Ç—Å—è —Å –º–∞—à–∏–Ω–∞–º–∏.',
      relations:{ kaylan:95, vivien:90, grayson:90, aiden:85, ember:85, alexi:75 },
      approval:{ player1:85, player2:60 },
      lastThought:'',
      avatar:''
    },
    {
      id:'kaylan',
      name:'–ö–∞–π–ª–∞–Ω –ë–ª–µ–π–¥–º–æ—Ä',
      username:'@meowgneticc',
      tone:'sharp',
      followers:25000,
      bio:'–î–æ–º–∏–Ω–∞–Ω—Ç–Ω–∞—è –æ–º–µ–≥–∞-–∞–¥–≤–æ–∫–∞—Ç, –≥–ª–∞–≤–∞ Blademore K.D. –°—Ç—Ä–æ–≥–∏–π, —Ö–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω—ã–π, –≤–æ—Ä—á–ª–∏–≤—ã–π –≥–µ–Ω–∏–π —é—Ä–∏—Å–ø—Ä—É–¥–µ–Ω—Ü–∏–∏, –æ—á–µ–Ω—å –∑–∞–±–æ—Ç–∏—Ç—Å—è –æ —Å–µ–º—å–µ –∏ —Ö–æ—Ç–µ–ª –¥–ª—è –¥–µ—Ç–µ–π ¬´—é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –±—É–¥—É—â–µ–µ¬ª.',
      relations:{ dante:95, vivien:80, grayson:75, aiden:80, ember:80 },
      approval:{ player1:55, player2:65 },
      lastThought:'',
      avatar:''
    },
    {
      id:'alexi',
      name:'–ê–ª–µ–∫—Å–∏ –£–æ–∫–µ—Ä',
      username:'@mercuryAl',
      tone:'warm',
      followers:3000,
      bio:'–ë–µ—Ç–∞, —Å–æ–ª–∏—Å—Ç –∏ –æ—Å–Ω–æ–≤–∞—Ç–µ–ª—å —Ä–æ–∫-–≥—Ä—É–ø–ø—ã ¬´Ash&mercury¬ª, –≤—ã—Ä–æ—Å –≤ –±–µ–¥–Ω–æ—Å—Ç–∏, –Ω–æ –±—ã–ª —É—Å—ã–Ω–æ–≤–ª—ë–Ω –ë–ª–µ–π–¥–º–æ—Ä–∞–º–∏. –ü—Ä–µ–¥–∞–Ω–Ω—ã–π, –¥–æ–±—Ä—ã–π –±—É–Ω—Ç–∞—Ä—å, –≤ —Å–ª–æ–∂–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö —Å –í–∏–≤—å–µ–Ω –∏ –ï–≤–æ–π.',
      relations:{ vivien:85, eve:80, dante:70, grayson:80 },
      approval:{ player1:80, player2:55 },
      lastThought:'',
      avatar:''
    },
    {
      id:'evelyn',
      name:'–≠–≤–µ–ª–∏–Ω –•–∞—Ä—Ç',
      username:'@drHart',
      tone:'sharp',
      followers:22000,
      bio:'–ê–ª—å—Ñ–∞, –±—ã–≤—à–∏–π —Å—É–¥–º–µ–¥—ç–∫—Å–ø–µ—Ä—Ç, —Å–µ–π—á–∞—Å –≤–ª–∞–¥–µ–ª–∏—Ü–∞ –∫–ª–∏–Ω–∏–∫–∏ Family Hart. –ò—Ä–æ–Ω–∏—á–Ω–∞—è, –¥–µ—Ä–∑–∫–∞—è, –¥–∞—ë—Ç –ª—é–¥—è–º –ø—Ä–æ–∑–≤–∏—â–∞ –∏ —Å—Ç–∞–≤–∏—Ç –¥–∏–∞–≥–Ω–æ–∑—ã –ø–æ —Ç–≤–∏—Ç–∞–º; –æ—Å–æ–±–µ–Ω–Ω–æ –±–ª–∏–∑–∫–∞ —Å –õ–æ—Ä–∞–Ω–æ–º –∏ –ê–≤—Ä–æ—Ä–æ–π.',
      relations:{ loran:90, aurora:85, eve:50, kaylan:70, derek:70 },
      approval:{ player1:55, player2:85 },
      lastThought:'',
      avatar:''
    },
    {
      id:'ellean',
      name:'–≠–ª–ª–µ–∞–Ω –ë–ª–µ–π–¥–º–æ—Ä',
      username:'@EllyMurrr',
      tone:'chaotic',
      followers:26000,
      bio:'–ñ—É—Ä–Ω–∞–ª–∏—Å—Ç –∏ –∏–∑–¥–∞—Ç–µ–ª—å BladeM, —à—É–º–Ω—ã–π –∏ —Ç–∞–∫—Ç–∏–ª—å–Ω—ã–π –¥–µ–¥—É—à–∫–∞ –ë–ª–µ–π–¥–º–æ—Ä–æ–≤. –õ—é–±–∏—Ç –ø—Ä–∞–Ω–∫–∏ —Å –≠–π–¥–µ–Ω–æ–º –∏ –≠–º–±–µ—Ä, —Ç–µ–ø–ª–æ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –ì—Ä–µ–π—Å–æ–Ω—É –∏ –ø—Ä–æ—Å–∏—Ç –õ–æ—Ä–∞–Ω–∞ –±—ã—Ç—å —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω–µ–µ.',
      relations:{ kaylan:90, grayson:85, aiden:70, ember:70, loran:75 },
      approval:{ player1:90, player2:75 },
      lastThought:'',
      avatar:''
    },
    {
      id:'dohyun',
      name:'–ö–∞–Ω –î–æ—Ö—ë–Ω',
      username:'@RRentGen',
      tone:'stoic',
      followers:8000,
      bio:'–ê–ª—å—Ñ–∞-–º–µ–¥–∏–∫-–∏–Ω—Ç–µ—Ä–Ω, —Ç–∏—Ö–∏–π –≥–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –∫–ª–∏–Ω–∏–∫–µ –≠–≤–µ–ª–∏–Ω. –°—Ç–∞—Ä—ã–π –¥—Ä—É–≥ –õ–æ—Ä–∞–Ω—Ç–∏—Å–∞, —Ä–∞–∑–¥–µ–ª—è–µ—Ç —Å –Ω–∏–º –ª—é–±–æ–≤—å –∫ –∑–Ω–∞–Ω–∏—è–º –∏ –∞–Ω–∏–º–µ, —Å—á–∏—Ç–∞–µ—Ç –ì—Ä–µ–π—Å–æ–Ω–∞ –Ω–µ–¥–æ—Å—Ç–æ–π–Ω—ã–º –õ–æ—Ä–∞–Ω–∞.',
      relations:{ loran:90, evelyn:70 },
      approval:{ player1:30, player2:85 },
      lastThought:'',
      avatar:''
    },
    {
      id:'ethan',
      name:'–ò—Ç–∞–Ω –•–æ–≥–≥–∞—Ä—Ç',
      username:'@metaphoricalallegory',
      tone:'warm',
      followers:5000,
      bio:'–ê–ª—å—Ñ–∞-—É—á–∏—Ç–µ–ª—å –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã –∏ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å —Ç–µ–∞—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –∫–ª—É–±–∞. –î–æ–±—Ä—ã–π, —Ö–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω—ã–π, –ª—é–±–∏–º–µ—Ü —à–∫–æ–ª—å–Ω–∏–∫–æ–≤; –æ—Å–æ–±–µ–Ω–Ω–æ –≤–µ—Ä–∏—Ç –≤ —Ç–∞–ª–∞–Ω—Ç –≠–π–¥–µ–Ω–∞.',
      relations:{ aiden:90 },
      approval:{ player1:60, player2:55 },
      lastThought:'',
      avatar:''
    },
    {
      id:'kassandra',
      name:'–ö–∞—Å—Å–∞–Ω–¥—Ä–∞ –ë–ª–µ–π–¥–º–æ—Ä',
      username:'@Kkassy',
      tone:'warm',
      followers:4000,
      bio:'–ê–ª—å—Ñ–∞-–≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä, –º–ª–∞–¥—à–∞—è —Å–µ—Å—Ç—Ä–∞ –ö–∞–π–ª–∞–Ω–∞, –≤–ª–∞–¥–µ–ª–∏—Ü–∞ —Ñ–µ—Ä–º—ã –∏ –∫–æ–Ω—é—à–µ–Ω. –û—á–µ–Ω—å –º—è–≥–∫–∞—è, –Ω–æ —Å–∏–ª—å–Ω–∞—è –¥—É—Ö–æ–º –∂–µ–Ω—â–∏–Ω–∞, –ª—é–±–∏—Ç –ø–ª–µ–º—è–Ω–Ω–∏–∫–æ–≤; —Å–µ–π—á–∞—Å –ì—Ä–µ–π—Å–æ–Ω —É –Ω–µ—ë —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ª–æ—à–∞–¥—å–º–∏.',
      relations:{ grayson:85, kaylan:80, dante:75 },
      approval:{ player1:85, player2:60 },
      lastThought:'',
      avatar:''
    }
  ];

  state.posts = [
    postObj({
      type:'social',
      authorType:'character',
      authorId:'vivien',
      content:'–ö—Ç–æ –∏–¥—ë—Ç —Å–µ–≥–æ–¥–Ω—è –Ω–∞ —Ä–µ–ø–µ—Ç–∏—Ü–∏—é Ash&mercury? –ù—É–∂–Ω–æ –æ—Ç–æ–≥–Ω–∞—Ç—å –¥—É—Ä–Ω—ã–µ –º—ã—Å–ª–∏ –≥—Ä–æ–º–∫–æ–π –º—É–∑—ã–∫–æ–π.',
      relatedCharacters:['alexi','eve']
    }),
    postObj({
      type:'social',
      authorType:'character',
      authorId:'kristian',
      content:'–ò–Ω–æ–≥–¥–∞ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ –¥–µ—Ç–∏ –≤ —à–∫–æ–ª–µ –º—É–¥—Ä–µ–µ –≤–∑—Ä–æ—Å–ª—ã—Ö –Ω–∞ –≤–µ—á–µ—Ä–∏–Ω–∫–∞—Ö.',
      relatedCharacters:[]
    })
  ];
}

// === —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ / –∑–∞–≥—Ä—É–∑–∫–∞ ===
function save(){
  try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch(e){}
}
function load(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(raw) state = JSON.parse(raw);
  }catch(e){}
  seedIfEmpty();
  save();
}

// === –º–æ–¥–µ–ª–∏ –ø–æ—Å—Ç–æ–≤ / —Ä–µ–∞–∫—Ü–∏–π ===
function postObj({type, authorType, authorId, content, relatedCharacters=[], photoData=null}){
  return {
    id: uid('post'),
    type,
    authorType,
    authorId,
    content,
    relatedCharacters,
    photoData,
    createdAt: nowIso(),
    likes: randint(0,50),
    comments: []
  };
}
function reactionObj(postId, charId, text, delta){
  return { id:uid('rx'), postId, charId, text, delta, at: nowIso() };
}

// === –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–∫–ª–∞–¥–∫–∞–º ===
function setActiveView(key){
  $$('.view').forEach(v=>v.classList.remove('active'));
  document.querySelector(`#view-${key}`).classList.add('active');
  $$('.tab').forEach(t=>t.classList.toggle('active', t.dataset.target===key));
  if(key==='relations') renderRelations();
  if(key==='dm')        syncDmSelectors();
  if(key==='reactions') renderReactions();
  if(key==='feed')      renderFeed();
}
function setupNav(){
  $$('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>setActiveView(btn.dataset.target));
  });
}

// === –ª–µ–Ω—Ç–∞ ===
let feedFilter = 'all';

function renderFeed(){
  const ul = $('#feedList');
  const posts = state.posts
    .filter(p => feedFilter==='all' ? true : p.type===feedFilter)
    .slice().sort((a,b)=>b.createdAt.localeCompare(a.createdAt));

  ul.innerHTML = posts.map(p=>renderPostHtml(p)).join('');
  posts.forEach(p=>{
    if(p.type==='social'){
      const btn = document.querySelector(`[data-action="comment"][data-id="${p.id}"]`);
      if(btn) btn.onclick = ()=>addQuickComment(p.id);
    }
  });
}

function renderPostHtml(p){
  const author = p.authorType==='player'
    ? state.players.find(pl=>pl.id===p.authorId)
    : state.characters.find(c=>c.id===p.authorId);

  const name = author?.name ?? '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
  const username = author?.username ?? '@user';
  const badge = p.type==='story' ? `<span class="badge">–°—é–∂–µ—Ç</span>` : '';
  const photo = p.photoData ? `<div class="photo-preview"><img src="${p.photoData}" alt=""></div>` : '';

  const commentsRow = (p.type==='social')
    ? `<div class="post-actions">
         <span class="icon">üí¨ <span>${p.comments.length}</span></span>
         <button class="ghost" data-action="comment" data-id="${p.id}">–ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
       </div>`
    : `<div class="post-actions"><span class="badge">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã</span></div>`;

  const reactionBtn = `<div class="post-actions">
      <button class="secondary" onclick="openReactionsForPost('${p.id}')">–†–µ–∞–∫—Ü–∏–∏</button>
      <span class="icon" title="${fmtTime(p.createdAt)}">üïí ${new Date(p.createdAt).toLocaleTimeString()}</span>
    </div>`;

  return `
    <li class="post" id="${p.id}">
      <div class="post-head">
        <div class="avatar" aria-hidden="true"></div>
        <div class="meta">
          <div class="name">${name} ${badge}</div>
          <div class="username">${username}</div>
        </div>
      </div>
      <div class="post-content">${p.type==='story'
        ? p.content.replace(/\n/g,'<br>')
        : clip(p.content, 600)}</div>
      ${photo}
      ${commentsRow}
      ${reactionBtn}
    </li>
  `;
}

function addQuickComment(postId){
  const p = state.posts.find(p=>p.id===postId);
  if(!p) return;
  const who = currentPlayer();
  const txt = prompt('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:');
  if(!txt) return;
  p.comments.push({ id:uid('c'), from: who.id, text: txt, at: nowIso() });
  save();
  renderFeed();
}

// === CHARACTER PROFILE ===
let currentProfileCharId = null;
let isEditingBio = false;

function relationLabelFromValue(v){
  if (v >= 85) return '–¥—É—à–µ–≤–Ω–∞—è –±–ª–∏–∑–æ—Å—Ç—å';
  if (v >= 70) return '–±–ª–∏–∑–∫–∏–µ —Å–æ—é–∑–Ω–∏–∫–∏';
  if (v >= 50) return '–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è —Å–≤—è–∑—å';
  if (v >= 30) return '–Ω–∞—Ç—è–Ω—É—Ç–æ–µ –æ–±—â–µ–Ω–∏–µ';
  return '—Ä–∞–∑–ª–∞–¥ –∏ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ';
}

function openCharacterProfile(charId){
  currentProfileCharId = charId;
  isEditingBio = false;
  renderCharacterProfile();
  setActiveView('character');
  // –ø–æ–ø—Ä–æ—Å–∏–º –ò–ò —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é –º—ã—Å–ª—å
  updateProfileThoughtWithAI(charId);
}

async function updateProfileThoughtWithAI(charId){
  const c = state.characters.find(x=>x.id===charId);
  if (!c) return;
  const key = state.activePlayerId;

  // –µ—Å–ª–∏ –º—ã—Å–ª—å —É–∂–µ –µ—Å—Ç—å ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
  if (c.profileThought && c.profileThought[key]) return;

  const text = await aiGenerateProfileThought(c);
  if (!text) return;
  if (!c.profileThought) c.profileThought = {};
  c.profileThought[key] = text;
  save();

  if (currentProfileCharId === charId){
    renderCharacterProfile();
  }
}

function renderCharacterProfile(){
  if (!currentProfileCharId) return;
  const me = currentPlayer();
  const c = state.characters.find(x=>x.id===currentProfileCharId);
  if (!c) return;

  const box = document.getElementById('characterView');
  const appr = (c.approval?.[state.activePlayerId] ?? 50);

  // 3-–π —Å–ª–æ–π: –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–π
  const relTitle =
    (c.relationTitles && c.relationTitles[state.activePlayerId])
      ? c.relationTitles[state.activePlayerId]
      : relationLabelFromValue(appr);

  // 2-–π —Å–ª–æ–π: –º—ã—Å–ª—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –æ –∏–≥—Ä–æ–∫–µ
  const profileThought =
    (c.profileThought && c.profileThought[state.activePlayerId])
      ? c.profileThought[state.activePlayerId]
      : '';

  const username = c.username || '@username';
  const bio = c.bio || '–û–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –ø–æ–∫–∞ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ.';
  const avatarImg = c.avatar ? `<img src="${c.avatar}" alt="${c.name}">` : '';

  const editBlock = isEditingBio
    ? `<textarea id="charBioEdit" class="char-bio-edit" rows="6"
        placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞, –µ–≥–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä, —Ç—Ä–∞–≤–º—ã, –æ—Ç–Ω–æ—à–µ–Ω–∏—è, —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏ —Ç.–ø.">${bio}</textarea>`
    : '';

  const actions = isEditingBio
    ? `
      <button class="primary" onclick="saveCharacterBio()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ</button>
      <button class="secondary" onclick="cancelEditBio()">–û—Ç–º–µ–Ω–∞</button>
      <button class="ghost" onclick="openDm('${c.id}')">–ü–µ—Ä–µ–π—Ç–∏ –≤ –õ–°</button>
      <button class="ghost" onclick="setActiveView('relations')">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</button>
    `
    : `
      <button class="secondary" onclick="startEditBio()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ</button>
      <button class="secondary" onclick="openDm('${c.id}')">–ü–µ—Ä–µ–π—Ç–∏ –≤ –õ–°</button>
      <button class="ghost" onclick="setActiveView('relations')">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</button>
    `;

  box.innerHTML = `
    <div class="char-cover"></div>
    <div class="char-header">
      <div class="char-header-top">
        <div class="char-avatar" onclick="selectCharacterAvatar()">
          ${avatarImg}
        </div>
        <div>
          <div class="char-name">${c.name}</div>
          <div class="char-username">${username}</div>
        </div>
      </div>

      <button class="ghost char-avatar-btn" onclick="selectCharacterAvatar()">
        –ò–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä
      </button>

      <div class="char-bio">
        ${bio.replace(/\n/g,'<br>')}
      </div>

      ${editBlock}

      <div class="char-rel-block">
        <div class="char-rel-label-row">
          <span>–°–≤—è–∑—å —Å ${me.name}</span>
          <span><strong>${Math.round(appr)}%</strong></span>
        </div>
        <div class="char-rel-bar">
          <span style="width:${clamp(appr,0,100)}%"></span>
        </div>
        <div class="char-rel-title">
          ${relTitle}
        </div>
        <div class="char-rel-thought">
          ${profileThought || '–ü–æ–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂ –º–æ–ª—á–∏—Ç –∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–±–ª—é–¥–∞–µ—Ç –∑–∞ —Ç–æ–±–æ–π.'}
        </div>
      </div>

      <div class="char-actions-row">
        ${actions}
      </div>

      <input id="charAvatarInput" type="file" accept="image/*" hidden />
    </div>
  `;

  // —Ñ–∞–π–ª –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞
  const avatarInput = document.getElementById('charAvatarInput');
  if (avatarInput) {
    avatarInput.addEventListener('change', handleAvatarFile);
  }
}


function saveCharacterBio(){
  if (!currentProfileCharId) return;
  const c = state.characters.find(x=>x.id===currentProfileCharId);
  if (!c) return;
  const ta = document.getElementById('charBioEdit');
  if (!ta) return;
  c.bio = ta.value.trim();
  save();
  isEditingBio = false;
  renderCharacterProfile();
}
function startEditBio(){
  isEditingBio = true;
  renderCharacterProfile();
}

function cancelEditBio(){
  isEditingBio = false;
  renderCharacterProfile();
}

function selectCharacterAvatar(){
  const input = document.getElementById('charAvatarInput');
  if (input) input.click();
}

function handleAvatarFile(e){
  const file = e.target.files && e.target.files[0];
  if (!file || !currentProfileCharId) return;

  const reader = new FileReader();
  reader.onload = () => {
    const c = state.characters.find(x => x.id === currentProfileCharId);
    if (!c) return;
    c.avatar = reader.result;       // dataURL
    save();
    renderCharacterProfile();       // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
  };
  reader.readAsDataURL(file);
}


// === –æ—Ç–Ω–æ—à–µ–Ω–∏—è ===
function renderRelations(){
  const box = $('#relationsList');
  box.innerHTML = state.characters.map(c=>{
    const appr = (c.approval[state.activePlayerId] ?? 50);
    const thought = c.lastThought ? clip(c.lastThought, 180) : '‚Äî';
    return `
      <div class="rel-card" onclick="openCharacterProfile('${c.id}')">
        <div class="rel-top">
          <div class="avatar"></div>
          <div>
            <div class="rel-name">${c.name}</div>
            <div class="username">${c.username}</div>
          </div>
        </div>
        <div class="progress"><span style="width:${appr}%"></span></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:.4rem;">
          <div class="muted">–£—Ä–æ–≤–µ–Ω—å: ${appr}%</div>
          <div class="rel-actions">
            <button class="secondary" onclick="event.stopPropagation(); openDm('${c.id}')">–õ–°</button>
          </div>
        </div>
        <div class="rel-thought">–ú—ã—Å–ª—å: ${thought}</div>
      </div>
    `;
  }).join('');
}

// === —Å–æ–∑–¥–∞–Ω–∏–µ –æ–±—ã—á–Ω–æ–≥–æ –ø–æ—Å—Ç–∞ ===
function setupComposeSocial(){
  // –ø—Ä–µ–≤—å—é —Ñ–æ—Ç–∫–∏
  $('#composePhoto').addEventListener('change', (e)=>{
    const file = e.target.files?.[0];
    if(!file){
      $('#composePhotoPreview').innerHTML = '';
      return;
    }
    const reader = new FileReader();
    reader.onload = () => {
      $('#composePhotoPreview').innerHTML = `<img src="${reader.result}" alt="preview">`;
    };
    reader.readAsDataURL(file);
  });

  // –ø—É–±–ª–∏–∫–∞—Ü–∏—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ—Å—Ç–∞
  $('#publishSocialBtn').onclick = async ()=>{
    const content   = $('#composeText').value.trim();
    const photoData = $('#composePhotoPreview img')?.getAttribute('src') || null;

    if (!content){
      alert('–ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞');
      return;
    }

    const p = postObj({
      type:'social',
      authorType:'player',
      authorId: state.activePlayerId,
      content,
      relatedCharacters: [],
      photoData
    });

    state.posts.push(p);
    await applyReactionsAndShowModal(p, false);

    // –æ—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    $('#composeText').value = '';
    $('#composePhoto').value = '';
    $('#composePhotoPreview').innerHTML = '';

    save();
    renderFeed();
    setActiveView('feed');
  };

}

// === —Å—é–∂–µ—Ç–Ω—ã–π –ø–æ—Å—Ç ===
let storyIdeas = [];
let ideaIdx = 0;

function setupComposeStory(){
  const refresh = ()=>{
    storyIdeas = generateStoryIdeas();
    ideaIdx = 0;
    paintIdea();
  };

  $('#ideaRefresh').onclick = refresh;
  $('#ideaPrev').onclick = ()=>{
    if(!storyIdeas.length) return;
    ideaIdx = (ideaIdx - 1 + storyIdeas.length) % storyIdeas.length;
    paintIdea();
  };
  $('#ideaNext').onclick = ()=>{
    if(!storyIdeas.length) return;
    ideaIdx = (ideaIdx + 1) % storyIdeas.length;
    paintIdea();
  };
  $('#ideaUse').onclick = ()=>{
    if(storyIdeas.length) $('#storyText').value = storyIdeas[ideaIdx];
  };

 $('#publishStoryBtn').onclick = async ()=>{
  const text = $('#storyText').value.trim();
  if(!text){
    alert('–ù–∞–ø–∏—à–∏ —Å—é–∂–µ—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–ª–∏ –≤—Å—Ç–∞–≤—å –∏–¥–µ—é');
    return;
  }

  const p = postObj({
    type:'story',
    authorType:'player',
    authorId:state.activePlayerId,
    content: text,
    relatedCharacters: []
  });

  state.posts.push(p);
  await applyReactionsAndShowModal(p, true);

  $('#storyText').value = '';

  save();
  renderFeed();
  setActiveView('feed');
};
}

function paintIdea(){
  $('#ideaText').textContent = storyIdeas[ideaIdx] || '–ò–¥–µ–π –ø–æ–∫–∞ –Ω–µ—Ç ‚Äî –Ω–∞–∂–º–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å –∏–¥–µ–∏¬ª';
}

// === –õ–° ===
function threadKey(charId, playerId=state.activePlayerId){
  return `${charId}_${playerId}`;
}

function syncDmSelectors(){
  const sel = $('#dmSelect');
  sel.innerHTML = state.characters.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  if(!sel.value && state.characters[0]) sel.value = state.characters[0].id;
  const current = state.characters.find(c=>c.id===sel.value);
  $('#dmTitle').textContent = '–õ–° ¬∑ ' + (current?.name || '');
  renderDmThread(sel.value);
}

function openDm(charId){
  setActiveView('dm');
  $('#dmSelect').value = charId;
  const c = state.characters.find(x=>x.id===charId);
  $('#dmTitle').textContent = '–õ–° ¬∑ ' + (c?.name || '');
  renderDmThread(charId);
}

function renderDmThread(charId){
  const key = threadKey(charId);
  const list = state.dms[key] || [];
  const box = $('#dmThread');
  box.innerHTML = list.map(m=>
    `<div class="bubble ${m.from===state.activePlayerId?'me':'them'}">${m.text}</div>`
  ).join('');
  box.scrollTop = box.scrollHeight;
}

function pushMessage(charId, from, text){
  const key = threadKey(charId);
  if(!state.dms[key]) state.dms[key]=[];
  state.dms[key].push({ from, text, at:nowIso() });
  save();
  if($('#view-dm').classList.contains('active') && $('#dmSelect').value===charId){
    renderDmThread(charId);
  }
}

function setupDm(){
  $('#dmSelect').addEventListener('change', (e)=>{
    const id = e.target.value;
    const c = state.characters.find(x=>x.id===id);
    $('#dmTitle').textContent = '–õ–° ¬∑ ' + (c?.name || '');
    renderDmThread(id);
  });

  $('#dmSend').onclick = async ()=>{
    const charId = $('#dmSelect').value;
    const text = $('#dmInput').value.trim();
    if (!text) return;

    pushMessage(charId, state.activePlayerId, text);
    $('#dmInput').value = '';

    if ($('#dmAutoToggle').checked) {
      await aiReplyToDm(charId);
    }
  };
}

// === —Ä–µ–∞–∫—Ü–∏–∏ ===
let lastReactionPostId = null;

// –∫—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥ –¥–µ–ª—å—Ç—ã: +0.25%, -3%, +4.75%
function formatDelta(delta){
  const sign = delta > 0 ? '+' : (delta < 0 ? '‚àí' : '');
  const abs  = Math.abs(delta);
  const digits = abs >= 1 ? (abs % 1 === 0 ? 0 : 2) : 2;
  return `${sign}${abs.toFixed(digits)}%`;
}

// –ø—Ä–∏–º–µ–Ω—è–µ–º —Ä–µ–∞–∫—Ü–∏–∏ –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
async function applyReactionsAndShowModal(post, isStory){
  const rxList = await computeReactions(post, isStory);
  lastReactionPostId = post.id;

  const wrap = $('#modalReactions');
  if(!rxList.length){
    wrap.innerHTML = `<p>–ù–∏–∫—Ç–æ –∏–∑ –∫–ª—é—á–µ–≤—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –Ω–µ –æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª.</p>`;
  }else{
    wrap.innerHTML = rxList.slice(0,5).map(rx=>{
      const c = state.characters.find(k=>k.id===rx.charId);
      const cls = rx.delta >= 0 ? 'pos' : 'neg';
      return `<div class="react-item">
        <div><strong>${c?.name||'?'}</strong>: ${rx.text}</div>
        <div class="delta ${cls}">${formatDelta(rx.delta)}</div>
      </div>`;
    }).join('');
  }
  $('#reactionModal').classList.remove('hidden');
}

// —Å—á–∏—Ç–∞–µ–º —Ä–µ–∞–∫—Ü–∏–∏ –∏ –º–µ–Ω—è–µ–º –æ—Ç–Ω–æ—à–µ–Ω–∏—è
async function computeReactions(post, isStory){
  const relevant = getRelevantCharacters(post);
  const me = currentPlayer();
  const out = [];

  for (const c of relevant){
    const currentAppr = c.approval[state.activePlayerId] ?? 50;

    // –±–∞–∑–æ–≤–∞—è —Å–∏–ª–∞ —Ä–µ–∞–∫—Ü–∏–∏
    const base = isStory ? 1.5 : 0.6;     // —Å—é–∂–µ—Ç–Ω—ã–µ —Å–∏–ª—å–Ω–µ–µ
    const spread = isStory ? 3.0 : 2.0;   // —Ä–∞–∑–±—Ä–æ—Å

    // –µ—Å–ª–∏ —É–∂–µ –ª—é–±–∏—Ç/–Ω–µ–Ω–∞–≤–∏–¥–∏—Ç ‚Äî —Ä–µ–∞–≥–∏—Ä—É–µ—Ç —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–µ–µ
    const moodBias = (currentAppr - 50) / 50; // –æ—Ç -1 –¥–æ +1

    let raw = base + spread * (Math.random() - 0.5) + moodBias;

    // –∏–Ω–æ–≥–¥–∞ —Ä–µ–∞–∫—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ–≤—Å–µ–º —Å–ª–∞–±–æ–π
    // (–æ–∫–æ–ª–æ –Ω—É–ª—è ‚Äî –ø–æ—á—Ç–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    if (Math.abs(raw) < 0.3) {
      raw = raw / 4; // –µ—â—ë –º—è–≥—á–µ
    }

    // —Å–ª—É—á–∞–π–Ω–æ –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∑–Ω–∞–∫, —á—Ç–æ–±—ã –±—ã–ª–∏ –∏ –º–∏–Ω—É—Å—ã
    if (Math.random() < 0.25) {
      raw = -raw;
    }

    // –∫–≤–∞–Ω—Ç—É–µ–º –¥–æ —à–∞–≥–æ–≤ –ø–æ 0.25
    let delta = Math.round(raw * 4) / 4;
    delta = clamp(delta, -5, 5); // –∂—ë—Å—Ç–∫–∏–π –ø—Ä–µ–¥–µ–ª

    // —Ç–µ–∫—Å—Ç —Ä–µ–∞–∫—Ü–∏–∏ –æ—Ç –ò–ò
    const text = await aiGenerateReactionText(
      c,
      me,
      post,
      delta,
      isStory
    );

    // –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–Ω–æ—à–µ–Ω–∏–µ
    const newAppr = clamp(currentAppr + delta, 0, 100);
    c.approval[state.activePlayerId] = newAppr;
    c.lastThought = text;

    const rx = reactionObj(post.id, c.id, text, delta);
    state.reactions.push(rx);
    out.push(rx);
  }

  save();
  renderRelations();
  return out;
}

function openReactionsForPost(postId){
  lastReactionPostId = postId;
  setActiveView('reactions');
}

function renderReactions(){
  const wrap = $('#reactionsList');
  const items = state.reactions
    .filter(r=>!lastReactionPostId || r.postId===lastReactionPostId)
    .slice().sort((a,b)=>b.at.localeCompare(a.at));

  if(!items.length){
    wrap.innerHTML = `<p class="hint">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∞–∫—Ü–∏–π.</p>`;
    return;
  }

  wrap.innerHTML = items.map(r=>{
    const c = state.characters.find(x=>x.id===r.charId);
    const p = state.posts.find(p=>p.id===r.postId);
    const cls = r.delta >= 0 ? 'pos' : 'neg';

    return `
      <div class="react-card">
        <div>
          <strong>${c?.name}</strong>
          –æ –ø–æ—Å—Ç–µ <em>${authorName(p)}</em>
          ¬∑ <span class="muted">${fmtTime(r.at)}</span>
        </div>
        <div class="react-item">
          <div>${r.text}</div>
          <div class="delta ${cls}">${formatDelta(r.delta)}</div>
        </div>
      </div>
    `;
  }).join('');
}

// === –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –º—ã—Å–ª–µ–π / –±–æ—Ç–æ–≤ ===

// –±–∞–∑–æ–≤—ã–µ –∑–∞–≥–æ—Ç–æ–≤–∫–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç,
// –∫–æ–≥–¥–∞ –ò–ò –æ—Ç–≤–µ—á–∞–µ—Ç —á–µ–º-—Ç–æ —Å—Ç—Ä–∞–Ω–Ω—ã–º –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –æ–±—â–∏–º
const thoughtPos = [
  '–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —à–∞–≥. –ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è.',
  '–≠—Ç–æ –∑–≤—É—á–∏—Ç —á–µ—Å—Ç–Ω–æ. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é.',
  '–ö–∞–∂–µ—Ç—Å—è, —Ç—ã –º–µ–Ω—è —É–¥–∏–≤–ª—è–µ—à—å ‚Äî –≤ —Ö–æ—Ä–æ—à–µ–º —Å–º—ã—Å–ª–µ.',
  '–õ–∞–∫–æ–Ω–∏—á–Ω–æ –∏ –≤ —Ç–æ—á–∫—É.',
  '–£–º–Ω–æ. –•–æ—á—É —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ.'
];
const thoughtNeg = [
  '–ù–µ —É–≤–µ—Ä–µ–Ω(–∞), —á—Ç–æ —ç—Ç–æ —Ö–æ—Ä–æ—à–∞—è –∏–¥–µ—è.',
  '–≠—Ç–æ –Ω–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ —Ç–µ–±—è.',
  '–°–æ–º–Ω–µ–≤–∞—é—Å—å, —á—Ç–æ —ç—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç.',
  '–°–ª–∏—à–∫–æ–º —Ä–µ–∑–∫–æ. –Ø –±—ã –ø—Ä–æ–º–æ–ª—á–∞–ª(–∞).',
  '–ú–Ω–µ —ç—Ç–æ –Ω–µ –±–ª–∏–∑–∫–æ.'
];

function toneWrap(tone, text){
  switch(tone){
    case 'cold':   return `–•–º. ${text}`;
    case 'warm':   return `–ó–Ω–∞–µ—à—å, ${text.toLowerCase()}`;
    case 'sharp':  return `–ü—Ä—è–º–æ —Å–∫–∞–∂—É: ${text}`;
    case 'stoic':  return `–û—Ç–º–µ—á—É –±–µ–∑ —ç–º–æ—Ü–∏–π: ${text}`;
    case 'chaotic':return `–õ–æ–ª, ${text.toLowerCase()}`;
    default: return text;
  }
}

function generateThought(char, post, delta){
  const base = delta>=0 ? choice(thoughtPos) : choice(thoughtNeg);
  const mention = post.relatedCharacters?.includes(char.id)
    ? ' (—ç—Ç–æ –∫–∞—Å–∞–µ—Ç—Å—è –º–µ–Ω—è)'
    : '';
  return toneWrap(char.tone, base) + mention;
}


// === —É—Ç–∏–ª–∏—Ç—ã ===
function authorName(p){
  if(!p) return '‚Äî';
  if(p.authorType==='player')
    return state.players.find(x=>x.id===p.authorId)?.name || '–ò–≥—Ä–æ–∫';
  return state.characters.find(x=>x.id===p.authorId)?.name || '–ü–µ—Ä—Å–æ–Ω–∞–∂';
}

function currentPlayer(){ return state.players.find(p=>p.id===state.activePlayerId); }

function setupFilters(){
  const chips = $$('.filters .chip');
  chips.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      chips.forEach(b=>b.classList.remove('chip-on'));
      btn.classList.add('chip-on');
      feedFilter = btn.dataset.filter;
      renderFeed();
    });
  });
}

function formatDelta(delta){
  const sign = delta > 0 ? '+' : '';
  return sign + delta.toFixed(2) + '%';
}


function setupPlayers(){
  const sel = $('#activePlayerSelect');
  sel.innerHTML = state.players.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
  sel.value = state.activePlayerId;
  sel.onchange = ()=>{
    state.activePlayerId = sel.value;
    save();
    renderRelations();
    renderFeed();
  };
}

function setupModal(){
  const mdl = $('#reactionModal');
  $('#modalClose').onclick = ()=> mdl.classList.add('hidden');
  $('#modalOk').onclick    = ()=> mdl.classList.add('hidden');
  $('#openReactionsBtn').onclick = ()=>{ mdl.classList.add('hidden'); setActiveView('reactions'); };
}

// === —Å—Ç–∞—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ===
document.addEventListener('DOMContentLoaded', ()=>{
  load();
  setupNav();
  setupPlayers();
  setupFilters();
  setupComposeSocial();
  setupComposeStory();
  setupDm();
  setupModal();
  renderFeed();
  renderRelations();
});
</script>

</body>
</html>
